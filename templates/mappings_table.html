<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Mappings</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; vertical-align: top; }
        th { background: #fafafa; position: sticky; top: 0; cursor: pointer; user-select: none; }
        tr:nth-child(even) { background: #fcfcfd; }
        .toolbar { margin: 12px 0; display: flex; gap: 8px; align-items: center; }
        .pill { font-size: 12px; padding: 2px 8px; background: #eef2ff; color: #4338ca; border-radius: 999px; }
        code { background: #f6f7fb; padding: 2px 4px; border-radius: 4px; }
        ul { margin: 4px 0 0 16px; }
    </style>
</head>
<body>
    {% include "_nav.html" %}
    <div class="toolbar">
        <span class="pill">{{ rows|length }} rule(s)</span>
    </div>
    <h2>Mapping Rules</h2>
    <div class="toolbar">
        <input id="searchPat" type="text" placeholder="Search pattern..." style="padding:6px 8px;border:1px solid #ddd;border-radius:6px;" />
        <button id="applySearch" type="button">Search</button>
    </div>
    <table>
        <thead>
            <tr><th>ID</th><th>Pattern</th><th>Mode</th><th>Priority</th><th>Active</th><th>Outputs</th><th>Actions</th></tr>
        </thead>
        <tbody>
            {% for r, outs in rows %}
            <tr>
                <td>{{ r.id }}</td>
                <td><input data-id="{{ r.id }}" data-field="source_pattern" value="{{ r.source_pattern }}" style="width:220px" /></td>
                <td>
                    <select data-id="{{ r.id }}" data-field="match_mode">
                        <option value="exact" {% if r.match_mode=='exact' %}selected{% endif %}>exact</option>
                        <option value="icontains" {% if r.match_mode=='icontains' %}selected{% endif %}>icontains</option>
                        <option value="regex" {% if r.match_mode=='regex' %}selected{% endif %}>regex</option>
                    </select>
                </td>
                <td><input type="number" data-id="{{ r.id }}" data-field="priority" value="{{ r.priority }}" style="width:80px" /></td>
                <td><input type="checkbox" data-id="{{ r.id }}" data-field="is_active" {% if r.is_active %}checked{% endif %} /></td>
                <td>
                    <ul data-rule-id="{{ r.id }}">
                        {% for o in outs %}
                        <li>
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                                <span>#{{ o.id }}</span>
                                <label>Product</label>
                                <select class="prodSel" data-output-id="{{ o.id }}">
                                    <option value="">— none —</option>
                                    {% for p in products %}
                                        <option value="{{ p.id }}" {% if o.product_id==p.id %}selected{% endif %}>{{ p.name }} (#{{ p.id }})</option>
                                    {% endfor %}
                                </select>
                                <label>size</label>
                                <input class="outSize" type="text" value="{{ o.size }}" placeholder="size" style="width:70px" />
                                <label>color</label>
                                <input class="outColor" type="text" value="{{ o.color }}" placeholder="color" style="width:90px" />
                                <label>qty</label>
                                <input class="outQty" type="number" value="{{ o.quantity }}" min="1" style="width:64px" />
                                <label>price</label>
                                <input class="outPrice" type="number" step="0.01" value="{{ o.unit_price }}" style="width:90px" />
                                <button class="updOutBtn" data-output-id="{{ o.id }}">Save</button>
                                <button class="removeOutBtn" data-output-id="{{ o.id }}">Remove</button>
                                <button class="ensureVarBtn" data-output-id="{{ o.id }}">Ensure variant</button>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </td>
                <td>
                    <button class="saveRule" data-id="{{ r.id }}">Save</button>
                    <button class="editOutputs" data-id="{{ r.id }}">Edit outputs</button>
                    <button class="addOutput" data-id="{{ r.id }}">Add output</button>
                    <button class="ensureRuleVars" data-id="{{ r.id }}">Ensure all variants</button>
                    <button class="deleteRule" data-id="{{ r.id }}" style="color:#b91c1c">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    document.getElementById('applySearch').addEventListener('click', ()=>{
        const v = document.getElementById('searchPat').value || '';
        const q = v ? ('?pattern=' + encodeURIComponent(v)) : '';
        location.href = '/mappings/table' + q;
    });
    for (const btn of document.querySelectorAll('.saveRule')){
        btn.addEventListener('click', async (e)=>{
            const id = e.target.getAttribute('data-id');
            const root = e.target.closest('tr');
            const body = {};
            for (const el of root.querySelectorAll('[data-id][data-field]')){
                const fld = el.getAttribute('data-field');
                let val = el.type==='checkbox' ? el.checked : el.value;
                if (el.type==='number') val = Number(val||0);
                body[fld] = val;
            }
            try {
                const r = await fetch('/mappings/rules/' + id, { method: 'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
                if (!r.ok) throw new Error(await r.text());
                alert('Saved');
            } catch (err) { alert('Save error'); }
        });
    }

    for (const btn of document.querySelectorAll('.editOutputs')){
        btn.addEventListener('click', async (e)=>{
            const id = e.target.getAttribute('data-id');
            try {
                // fetch current rule to get existing outputs
                const rs = await fetch('/mappings/rules?pattern=' + encodeURIComponent(e.target.closest('tr').querySelector('[data-field="source_pattern"]').value));
                let outputs = [];
                if (rs.ok) {
                    const jr = await rs.json();
                    const rules = jr.rules||[];
                    if (rules.length) outputs = rules[0].outputs||[];
                }
                const tpl = '[\n  {"product_id": null, "item_id": null, "size": null, "color": null, "quantity": 1, "unit_price": null}\n]';
                const text = prompt('Edit outputs as JSON array (product_id/item_id, size, color, quantity, unit_price):', JSON.stringify(outputs.length?outputs:JSON.parse(tpl)));
                if (!text) return;
                let arr = [];
                try { arr = JSON.parse(text); } catch (e) { alert('Invalid JSON'); return; }
                const r = await fetch('/mappings/rules/' + id + '/outputs', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(arr) });
                if (!r.ok) throw new Error(await r.text());
                alert('Outputs saved');
                location.reload();
            } catch (err) { alert('Edit outputs error'); }
        });
    }

    // inline output update (product + attributes)
    for (const btn of document.querySelectorAll('.updOutBtn')){
        btn.addEventListener('click', async (e)=>{
            const outId = e.target.getAttribute('data-output-id');
            const root = e.target.closest('li');
            const sel = root.querySelector('select.prodSel');
            const pid = sel ? sel.value : '';
            const size = (root.querySelector('.outSize')?.value || '').trim();
            const color = (root.querySelector('.outColor')?.value || '').trim();
            const qtyRaw = root.querySelector('.outQty')?.value;
            const priceRaw = root.querySelector('.outPrice')?.value;
            const body = {
                product_id: pid ? Number(pid) : null,
                size: size || null,
                color: color || null,
                quantity: qtyRaw ? Number(qtyRaw) : undefined,
                unit_price: (priceRaw === '' || priceRaw === null || priceRaw === undefined) ? null : Number(priceRaw),
            };
            try {
                const r = await fetch('/mappings/outputs/' + outId, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
                if (!r.ok) throw new Error(await r.text());
                e.target.textContent = 'Saved';
                setTimeout(()=>{ e.target.textContent = 'Save'; }, 800);
            } catch (err) { alert('Update failed'); }
        });
    }

    // remove output via replace-outputs
    for (const btn of document.querySelectorAll('.removeOutBtn')){
        btn.addEventListener('click', async (e)=>{
            const outId = Number(e.target.getAttribute('data-output-id'));
            const tr = e.target.closest('tr');
            const ruleId = Number(tr.querySelector('.saveRule').getAttribute('data-id'));
            const pattern = tr.querySelector('[data-field="source_pattern"]').value;
            if (!confirm('Remove output #' + outId + '?')) return;
            try {
                const rs = await fetch('/mappings/rules?pattern=' + encodeURIComponent(pattern));
                if (!rs.ok) throw new Error(await rs.text());
                const jr = await rs.json();
                const rule = (jr.rules||[])[0];
                const kept = (rule?.outputs||[]).filter(o => Number(o.id) !== outId).map(o => ({
                    item_id: o.item_id ?? null,
                    product_id: o.product_id ?? null,
                    size: o.size ?? null,
                    color: o.color ?? null,
                    quantity: o.quantity ?? 1,
                    unit_price: o.unit_price ?? null,
                }));
                const r = await fetch('/mappings/rules/' + ruleId + '/outputs', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(kept) });
                if (!r.ok) throw new Error(await r.text());
                location.reload();
            } catch (err) { alert('Remove failed'); }
        });
    }

    // ensure single output variant
    for (const btn of document.querySelectorAll('.ensureVarBtn')){
        btn.addEventListener('click', async (e)=>{
            const outId = e.target.getAttribute('data-output-id');
            try {
                const r = await fetch('/mappings/outputs/' + outId + '/ensure-variant', { method:'POST' });
                if (!r.ok) throw new Error(await r.text());
                const j = await r.json();
                alert('Variant ensured. item_id=' + j.item_id);
            } catch (err) { alert('Ensure variant failed'); }
        });
    }

    // ensure all variants for rule
    for (const btn of document.querySelectorAll('.ensureRuleVars')){
        btn.addEventListener('click', async (e)=>{
            const id = e.target.getAttribute('data-id');
            try {
                const r = await fetch('/mappings/rules/' + id + '/ensure-variants', { method:'POST' });
                if (!r.ok) throw new Error(await r.text());
                const j = await r.json();
                alert('Ensured ' + (j.count||0) + ' variant(s).');
            } catch (err) { alert('Ensure all variants failed'); }
        });
    }

    // add output inline form (inputs with datalist suggestions)
    function buildAddRow(products){
        const li = document.createElement('li');
        li.className = 'addOutRow';
        const sizeListId = 'sizeList-' + Date.now() + '-' + Math.random().toString(36).slice(2);
        const colorListId = 'colorList-' + Date.now() + '-' + Math.random().toString(36).slice(2);
        li.innerHTML = `
            <div style=\"display:flex; gap:6px; align-items:center; flex-wrap:wrap;\">
                <label>Product</label>
                <select class=\"newProd\">
                    <option value=\"\">— select —</option>
                    ${products.map(p=>`<option value=\"${p.id}\">${p.name} (#${p.id})</option>`).join('')}
                </select>
                <label>size</label>
                <input class=\"newSize\" type=\"text\" list=\"${sizeListId}\" placeholder=\"size\" style=\"width:90px\" />
                <datalist id=\"${sizeListId}\"></datalist>
                <label>color</label>
                <input class=\"newColor\" type=\"text\" list=\"${colorListId}\" placeholder=\"color\" style=\"width:110px\" />
                <datalist id=\"${colorListId}\"></datalist>
                <label>qty</label>
                <input class=\"newQty\" type=\"number\" min=\"1\" value=\"1\" style=\"width:64px\" />
                <label>price</label>
                <input class=\"newPrice\" type=\"number\" step=\"0.01\" style=\"width:90px\" />
                <button class=\"confirmAdd\">Add</button>
                <button class=\"cancelAdd\">Cancel</button>
            </div>
        `;
        return li;
    }

    async function fetchAttributes(productId){
        const r = await fetch('/inventory/attributes?product_id=' + productId);
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
    }

    async function fetchAllProducts(){
        try{
            const r = await fetch('/products');
            if (!r.ok) return [];
            const j = await r.json();
            return (j.products||[]).map(p=>({id: p.id, name: p.name}));
        }catch(_e){ return []; }
    }

    for (const btn of document.querySelectorAll('.addOutput')){
        btn.addEventListener('click', async (e)=>{
            const tr = e.target.closest('tr');
            const ul = tr.querySelector('td:nth-child(6) ul');
            if (ul.querySelector('.addOutRow')) return; // one form at a time per rule
            // build add row
            let products = Array.from(tr.querySelectorAll('select.prodSel option'))
                .filter(opt=>opt.value)
                .reduce((acc, opt)=>{ acc.push({id:Number(opt.value), name: opt.textContent.replace(/\s*\(#\d+\)$/, '')}); return acc; }, [])
                .filter((v,i,a)=> a.findIndex(x=>x.id===v.id)===i);
            if (!products.length) {
                products = await fetchAllProducts();
            }
            const li = buildAddRow(products);
            ul.appendChild(li);
            const prodSel = li.querySelector('.newProd');
            const sizeInput = li.querySelector('.newSize');
            const colorInput = li.querySelector('.newColor');
            const sizeList = li.querySelector('datalist[id^="sizeList-"]');
            const colorList = li.querySelector('datalist[id^="colorList-"]');
            const qtyEl = li.querySelector('.newQty');
            const priceEl = li.querySelector('.newPrice');
            prodSel.addEventListener('change', async ()=>{
                const pid = prodSel.value;
                sizeList.innerHTML = '';
                colorList.innerHTML = '';
                if (!pid) return;
                try{
                    const attrs = await fetchAttributes(Number(pid));
                    for (const s of (attrs.sizes||[])){
                        const o = document.createElement('option'); o.value = s; sizeList.appendChild(o);
                    }
                    for (const c of (attrs.colors||[])){
                        const o = document.createElement('option'); o.value = c; colorList.appendChild(o);
                    }
                }catch(err){ /* ignore */ }
            });
            li.querySelector('.cancelAdd').addEventListener('click', ()=>{ li.remove(); });
            li.querySelector('.confirmAdd').addEventListener('click', async ()=>{
                const ruleId = Number(tr.querySelector('.saveRule').getAttribute('data-id'));
                const pattern = tr.querySelector('[data-field="source_pattern"]').value;
                const pid = prodSel.value ? Number(prodSel.value) : null;
                const size = (sizeInput.value || '').trim() || null;
                const color = (colorInput.value || '').trim() || null;
                const qty = Number(qtyEl.value||1);
                const priceVal = priceEl.value;
                const unit_price = (priceVal === '' || priceVal === null || priceVal === undefined) ? null : Number(priceVal);
                if (!pid){ alert('Select a product'); return; }
                try {
                    // load current outputs
                    const rs = await fetch('/mappings/rules?pattern=' + encodeURIComponent(pattern));
                    let outputs = [];
                    if (rs.ok){
                        const jr = await rs.json();
                        outputs = ((jr.rules||[])[0]?.outputs)||[];
                    }
                    const clean = outputs.map(o => ({
                        item_id: o.item_id ?? null,
                        product_id: o.product_id ?? null,
                        size: o.size ?? null,
                        color: o.color ?? null,
                        quantity: o.quantity ?? 1,
                        unit_price: o.unit_price ?? null,
                    }));
                    clean.push({ item_id: null, product_id: pid, size, color, quantity: qty, unit_price });
                    const r = await fetch('/mappings/rules/' + ruleId + '/outputs', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(clean) });
                    if (!r.ok) throw new Error(await r.text());
                    location.reload();
                } catch (err) { alert('Add output failed'); }
            });
        });
    }

    // delete mapping rule
    for (const btn of document.querySelectorAll('.deleteRule')){
        btn.addEventListener('click', async (e)=>{
            const id = e.target.getAttribute('data-id');
            const pat = e.target.closest('tr').querySelector('[data-field="source_pattern"]').value;
            if (!confirm('Delete rule #' + id + ' for pattern\n"' + pat + '" ?')) return;
            try {
                const r = await fetch('/mappings/rules/' + id, { method:'DELETE' });
                if (!r.ok) throw new Error(await r.text());
                location.reload();
            } catch (err) { alert('Delete failed'); }
        });
    }
    </script>
</body>
</html>
