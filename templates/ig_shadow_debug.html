<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Shadow Draft #{{ draft.id }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      h1, h2, h3 { margin: 0 0 8px 0; }
      .meta { color:#6b7280; font-size:13px; margin:4px 0; }
      pre { background:#0b1021; color:#e5e7eb; padding:12px; border-radius:8px; white-space:pre-wrap; max-height:320px; overflow:auto; }
      a { color:#2563eb; text-decoration:none; }
      .section { margin-top:16px; padding:12px; border-radius:10px; border:1px solid #e5e7eb; background:#f9fafb; }
      .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #d1d5db; font-size:12px; margin-left:4px; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <a href="/ig/inbox/{{ conversation_id }}">â† KonuÅŸmaya geri dÃ¶n</a>
    <h1>Shadow Draft #{{ draft.id }}</h1>
    <div class="meta">
      KonuÅŸma: <a href="/ig/inbox/{{ conversation_id }}">{{ conversation_id }}</a>
      {% if draft.status %}<span class="pill">{{ draft.status }}</span>{% endif %}
    </div>
    <div class="meta">
      Model: {{ draft.model or '-' }}
      {% if draft.confidence is not none %} Â· GÃ¼ven: {{ '%.2f' % draft.confidence }}{% endif %}
      {% if draft.reason %} Â· Sebep: {{ draft.reason }}{% endif %}
      {% if draft.created_at %} Â· OluÅŸturulma: {{ draft.created_at }}{% endif %}
    </div>

    {% if conversation_info %}
    <div class="section">
      <h3>KonuÅŸma Bilgisi</h3>
      <div class="meta">
        KullanÄ±cÄ±: {% if conversation_info.username %}@{{ conversation_info.username }}{% else %}(username yok){% endif %}
        {% if conversation_info.name %} Â· {{ conversation_info.name }}{% endif %}
      </div>
      <div class="meta">
        IG User ID: {{ conversation_info.ig_user_id or '-' }}
        {% if conversation_info.is_mock %}
          <span class="pill">Mock</span>
        {% endif %}
      </div>
      {% if conversation_info.last_message_at %}
      <div class="meta">Son mesaj: {{ conversation_info.last_message_at }}</div>
      {% endif %}
    </div>
    {% endif %}

    {% if history_preview %}
    <div class="section">
      <h3>AI'ya AktarÄ±lan GeÃ§miÅŸ (Ã–zet)</h3>
      <ul style="padding-left:16px; margin:0;">
        {% for msg in history_preview %}
          <li style="margin-bottom:6px;">
            <strong>{{ (msg.dir or msg.direction or 'in')|upper }}</strong>
            {% if msg.timestamp_ms %} Â· {{ msg.timestamp_ms }}{% endif %}
            Â· {{ msg.text or '(boÅŸ)' }}
          </li>
        {% endfor %}
      </ul>
      <div class="meta">Not: Bu liste mevcut kurallara gÃ¶re yeniden oluÅŸturulmuÅŸtur.</div>
    </div>
    {% endif %}

    {% if actions %}
    <div class="section">
      <h3>Planlanan Aksiyonlar</h3>
      <ul>
        {% for action in actions %}
          <li style="margin-bottom:8px;">
            <strong>{{ action.type }}</strong>
            {% if action.trigger %} Â· tetikleyici: {{ action.trigger }}{% endif %}
            {% if action.image_count %} Â· {{ action.image_count }} gÃ¶rsel{% endif %}
            {% if action.product_name %} Â· Ã¼rÃ¼n: {{ action.product_name }}{% elif action.product_slug %} Â· Ã¼rÃ¼n: {{ action.product_slug }}{% endif %}
            {% if action.type == 'send_product_images' and action.image_urls %}
              <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
                {% for img_url in action.image_urls %}
                  <a href="{{ img_url }}" target="_blank" rel="noopener" style="display:inline-block; border:1px solid #e5e7eb; border-radius:6px; overflow:hidden;">
                    <img src="{{ img_url }}" alt="product" style="width:90px; height:90px; object-fit:cover;" />
                  </a>
                {% endfor %}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    {% if debug_meta %}
    <div class="section" style="border-color: {% if debug_meta.user_payload and debug_meta.user_payload.matching_qas %}#10b981{% else %}#e5e7eb{% endif %}; background: {% if debug_meta.user_payload and debug_meta.user_payload.matching_qas %}#f0fdf4{% else %}#f9fafb{% endif %};">
      <h3>ğŸ” EÅŸleÅŸen Q&A'lar (Embeddings)</h3>
      
      {% if debug_meta.qa_search_metadata %}
        {% set qa_meta = debug_meta.qa_search_metadata %}
        <div style="margin-bottom: 12px; padding: 8px; background: #fff; border-radius: 6px; border: 1px solid #e5e7eb;">
          <div class="meta" style="margin-bottom: 4px;">
            <strong>Arama Durumu:</strong>
            {% if qa_meta.attempted %}
              <span style="color: #059669;">âœ“ Arama yapÄ±ldÄ±</span>
            {% else %}
              <span style="color: #dc2626;">âœ— Arama yapÄ±lmadÄ±</span>
            {% endif %}
          </div>
          {% if qa_meta.query %}
            <div class="meta" style="margin-bottom: 4px;">
              <strong>Aranan Metin:</strong> <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">{{ qa_meta.query }}</code>
            </div>
          {% endif %}
          {% if qa_meta.product_id %}
            <div class="meta" style="margin-bottom: 4px;">
              <strong>ÃœrÃ¼n ID:</strong> {{ qa_meta.product_id }}
            </div>
          {% endif %}
          {% if qa_meta.reason %}
            <div class="meta" style="margin-bottom: 4px; color: #dc2626;">
              <strong>Neden yapÄ±lmadÄ±:</strong> {{ qa_meta.reason }}
            </div>
          {% endif %}
          {% if qa_meta.error %}
            <div class="meta" style="margin-bottom: 4px; color: #dc2626;">
              <strong>Hata:</strong> <code style="background: #fee2e2; padding: 2px 6px; border-radius: 4px; color: #991b1b;">{{ qa_meta.error }}</code>
            </div>
          {% endif %}
          {% if qa_meta.result_count is defined %}
            <div class="meta" style="margin-bottom: 4px;">
              <strong>Bulunan SonuÃ§:</strong> {{ qa_meta.result_count }} eÅŸleÅŸme
            </div>
          {% endif %}
          {% if qa_meta.limit and qa_meta.min_similarity %}
            <div class="meta" style="font-size: 11px; color: #6b7280;">
              Arama parametreleri: limit={{ qa_meta.limit }}, min_similarity={{ qa_meta.min_similarity }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% if debug_meta.user_payload and debug_meta.user_payload.matching_qas and debug_meta.user_payload.matching_qas|length > 0 %}
        <div class="meta" style="margin-bottom: 12px;">
          MÃ¼ÅŸteri mesajÄ±na gÃ¶re bulunan <strong>{{ debug_meta.user_payload.matching_qas|length }}</strong> eÅŸleÅŸen Q&A:
        </div>
        {% for qa in debug_meta.user_payload.matching_qas %}
          <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #d1fae5; border-radius: 8px; background: #fff;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
              <div style="font-weight: 600; color: #065f46; flex: 1;">S: {{ qa.question }}</div>
              <span class="pill" style="background: #d1fae5; color: #065f46; border-color: #a7f3d0; margin-left: 12px;">
                {{ '%.1f' % (qa.similarity * 100) }}%
              </span>
            </div>
            <div style="color: #374151; white-space: pre-wrap; padding-left: 12px; border-left: 3px solid #10b981;">C: {{ qa.answer }}</div>
          </div>
        {% endfor %}
        <div class="meta" style="margin-top: 12px;">
          Bu Q&A'lar AI'ya context olarak verilir ve mÃ¼ÅŸteri sorusuna uygun cevap oluÅŸturmasÄ±nda kullanÄ±lÄ±r.
        </div>
      {% elif debug_meta.qa_search_metadata and debug_meta.qa_search_metadata.attempted %}
        <div class="meta" style="color: #6b7280;">
          Arama yapÄ±ldÄ± ancak eÅŸleÅŸen Q&A bulunamadÄ± (min_similarity={{ debug_meta.qa_search_metadata.min_similarity }} eÅŸiÄŸini geÃ§en sonuÃ§ yok).
        </div>
      {% elif not debug_meta.qa_search_metadata or not debug_meta.qa_search_metadata.attempted %}
        <div class="meta" style="color: #6b7280;">
          {% if debug_meta.qa_search_metadata and debug_meta.qa_search_metadata.reason %}
            Arama yapÄ±lmadÄ±: {{ debug_meta.qa_search_metadata.reason }}
          {% else %}
            Bu shadow draft iÃ§in embedding aramasÄ± yapÄ±lmadÄ± (eski kayÄ±t veya metadata eksik).
          {% endif %}
        </div>
      {% endif %}
    </div>
    {% endif %}

    <div class="section">
      <h3>AI CevabÄ± (reply_text)</h3>
      <pre>{{ (draft.reply_text or '') }}</pre>
    </div>

    <div class="section">
      <h3>System Prompt</h3>
      {% if debug_meta and debug_meta.system_prompt %}
        <pre>{{ debug_meta.system_prompt }}</pre>
      {% else %}
        <div class="meta">System prompt kaydÄ± yok.</div>
      {% endif %}
    </div>

    <div class="section">
      <h3>User Payload (Prompt JSON)</h3>
      {% if debug_meta and debug_meta.user_payload %}
        <pre>{{ debug_meta.user_payload_pretty }}</pre>
      {% else %}
        <div class="meta">user_payload kaydÄ± yok.</div>
      {% endif %}
    </div>

    <div class="section">
      <h3>Ham Model CevabÄ± (raw_response)</h3>
      {% if debug_meta and debug_meta.raw_response %}
        <pre>{{ debug_meta.raw_response_pretty }}</pre>
      {% else %}
        <div class="meta">raw_response kaydÄ± yok.</div>
      {% endif %}
    </div>

    <div class="section" style="border-color: #3b82f6; background: #eff6ff;">
      <h3>ğŸ“¡ OpenAI API Ä°steÄŸi (api_request_payload)</h3>
      {% if debug_meta and debug_meta.api_request_payload %}
        <div class="meta" style="margin-bottom: 12px;">
          Bu, OpenAI API'ye gÃ¶nderilen tam istek payload'Ä±dÄ±r. Model, mesajlar, parametreler ve diÄŸer ayarlarÄ± iÃ§erir.
        </div>
        <pre style="max-height: 600px;">{{ debug_meta.api_request_payload_pretty }}</pre>
      {% else %}
        <div class="meta">API request payload kaydÄ± yok. (Eski shadow draft'lerde bu bilgi bulunmayabilir)</div>
      {% endif %}
    </div>
  </body>
</html>


