<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Order Edit</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
        .card { border:1px solid #e5e7eb; border-radius:10px; padding:16px; background:#fff; max-width: 1000px; }
        .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        label { display:block; font-size:12px; color:#6b7280; margin-bottom:4px; }
        input, select, textarea { width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; }
        textarea { min-height: 80px; }
        .toolbar { display:flex; gap:8px; margin-bottom:12px; }
        table { width:100%; border-collapse: collapse; }
        th, td { padding:8px 10px; border-bottom:1px solid #f0f0f0; text-align:left; font-size: 13px; }
    </style>
</head>
<body>
    {% include "_nav.html" %}
    <h2>Order #{{ order.id }} Düzenle</h2>
    <div class="card">
        <form method="post" action="/orders/{{ order.id }}/edit">
            <div class="row">
                <div>
                    <label>Müşteri</label>
                    <input name="client" list="clients" value="{{ client_disp or order.client_id }}" />
                    <datalist id="clients">
                        {% for c in clients %}
                        <option value="{{ c.id }} | {{ c.name }} | {{ c.phone }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div>
                    <label>Takip No</label>
                    <input name="tracking_no" value="{{ order.tracking_no or '' }}" />
                </div>
                <div>
                    <label>Ürün (Item)</label>
                    <input name="item" list="items" value="{{ item_disp or (order.item_id or '') }}" />
                    <datalist id="items">
                        {% for it in items %}
                        <option value="{{ it.id }} | {{ it.sku }} | {{ it.name }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div>
                    <label>Adet</label>
                    <input name="quantity" type="number" step="1" value="{{ order.quantity or 1 }}" />
                </div>
                <div>
                    <label>Toplam</label>
                    <input name="total_amount" type="number" step="0.01" value="{{ order.total_amount or 0 }}" />
                </div>
                <div>
                    <label>Durum</label>
                    <select name="status">
                        {% set st = order.status or '' %}
                        <option value="" {{ 'selected' if st=='' else '' }}>(boş)</option>
                        <option value="paid" {{ 'selected' if st=='paid' else '' }}>paid</option>
                        <option value="unpaid" {{ 'selected' if st=='unpaid' else '' }}>unpaid</option>
                        <option value="refunded" {{ 'selected' if st=='refunded' else '' }}>refunded</option>
                        <option value="switched" {{ 'selected' if st=='switched' else '' }}>switched</option>
                    </select>
                </div>
                <div>
                    <label>Kanal</label>
                    <select name="source">
                        {% set src = order.source or '' %}
                        <option value="bizim" {{ 'selected' if src=='bizim' else '' }}>bizim</option>
                        <option value="kargo" {{ 'selected' if src=='kargo' else '' }}>kargo</option>
                    </select>
                </div>
                <div>
                    <label>Kargo Tarihi</label>
                    <input name="shipment_date" type="date" value="{{ order.shipment_date }}" />
                </div>
                <div>
                    <label>Data Tarihi</label>
                    <input name="data_date" type="date" value="{{ order.data_date }}" />
                </div>
                <div style="grid-column:1/-1;">
                    <label>Notlar</label>
                    <textarea name="notes">{{ order.notes or '' }}</textarea>
                </div>
            </div>

            <h3 style="margin-top:16px;">Sipariş Kalemleri</h3>
            <div>
                <table id="orderItemsTbl">
                    <thead>
                        <tr><th>Item</th><th>Adet</th><th></th></tr>
                    </thead>
                    <tbody>
                        {% for row in (order_items or []) %}
                        <tr>
                            <td><input name="item_display" list="items_all" value="{{ (row.item.id ~ ' | ' ~ row.item.sku ~ ' | ' ~ row.item.name) if row.item else '' }}" /></td>
                            <td><input name="item_qty" type="number" step="1" min="1" value="{{ row.quantity }}" /></td>
                            <td><button type="button" onclick="removeRow(this)">Sil</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="toolbar">
                    <button type="button" onclick="addRow()">Satır Ekle</button>
                    <span style="color:#6b7280;">Toplam tutar elle girilir, otomatik hesaplanmaz.</span>
                </div>
                <datalist id="items_all">
                    {% for it in (items_all or []) %}
                    <option value="{{ it.id }} | {{ it.sku }} | {{ it.name }}"></option>
                    {% endfor %}
                </datalist>
            </div>
            <div class="toolbar">
                <button type="submit">Kaydet</button>
                <a href="/orders/table" class="btn">Geri</a>
            </div>
        </form>
    </div>

    <h3>Eşleştirme (Mapping) Seçenekleri</h3>
    <div class="card">
        <form method="get" action="/orders/{{ order.id }}/edit" style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
            <input type="hidden" name="id" value="{{ order.id }}" />
            <label>Temel İsim:
                <input type="text" name="base" value="{{ mapping_base or '' }}" />
            </label>
            <button type="submit">Bul</button>
            {% if mapping_base %}
                <a href="/mappings/table?pattern={{ mapping_base }}" style="margin-left:8px;">Haritalandırmayı Düzenle</a>
            {% endif %}
        </form>
        {% if mapping_outs and mapping_outs|length %}
            <table>
                <thead>
                    <tr><th>Ürün/Item</th><th>Beden</th><th>Renk</th><th>Önerilen Adet</th><th></th></tr>
                </thead>
                <tbody>
                    {% for o in mapping_outs %}
                    <tr>
                        <td>
                            {% if o.item_id %}
                                Item #{{ o.item_id }}
                            {% elif o.product_id %}
                                Product #{{ o.product_id }}
                            {% else %}
                                (boş)
                            {% endif %}
                        </td>
                        <td>{{ o.size or '-' }}</td>
                        <td>{{ o.color or '-' }}</td>
                        <td>{{ o.quantity or 1 }}</td>
                        <td>
                            <button type="button" onclick="appendFromMapping({ id: {{ o.id }}, item_id: {{ o.item_id or 'null' }}, product_id: {{ o.product_id or 'null' }}, size: '{{ o.size or '' }}', color: '{{ o.color or '' }}', quantity: {{ o.quantity or 1 }} })">Ekle</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div>Öneri bulunamadı. Temel ismi düzenleyip tekrar deneyin.</div>
        {% endif %}
    </div>

    <h3>Değişiklik Günlüğü</h3>
    <div class="card">
        <table>
            <thead>
                <tr><th>Zaman</th><th>Kullanıcı</th><th>Aksiyon</th><th>Değişiklikler</th></tr>
            </thead>
            <tbody>
            {% for lg in logs %}
                <tr>
                    <td>{{ lg.created_at }}</td>
                    <td>{{ lg.editor_user_id or '-' }}</td>
                    <td>{{ lg.action }}</td>
                    <td><pre style="margin:0; white-space: pre-wrap;">{{ lg.changes_json }}</pre></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
    const form = document.querySelector('form[action="/orders/{{ order.id }}/edit"]');
    function addRow(itemDisplay='', qty=1){
        const tb = document.querySelector('#orderItemsTbl tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input name="item_display" list="items_all" value="${itemDisplay}" /></td>
            <td><input name="item_qty" type="number" step="1" min="1" value="${qty}" /></td>
            <td><button type="button" onclick="removeRow(this)">Sil</button></td>
        `;
        tb.appendChild(tr);
    }
    function removeRow(btn){
        const tr = btn.closest('tr');
        tr && tr.remove();
    }
    function clearHidden(form){
        for (const el of Array.from(form.querySelectorAll('input[name="item_ids[]"], input[name="qtys[]"]'))){ el.remove(); }
    }
    function serializeOrderItems(form){
        clearHidden(form);
        const rows = document.querySelectorAll('#orderItemsTbl tbody tr');
        for (const r of rows){
            const disp = r.querySelector('input[name="item_display"]').value.trim();
            const qty = parseInt(r.querySelector('input[name="item_qty"]').value || '0', 10);
            if (!disp || !isFinite(qty) || qty <= 0) continue;
            const hid1 = document.createElement('input');
            hid1.type = 'hidden'; hid1.name = 'item_ids[]'; hid1.value = disp;
            const hid2 = document.createElement('input');
            hid2.type = 'hidden'; hid2.name = 'qtys[]'; hid2.value = String(qty);
            form.appendChild(hid1); form.appendChild(hid2);
        }
    }
    if (form){
        form.addEventListener('submit', (e)=>{ serializeOrderItems(form); });
    }
    async function appendFromMapping(o){
        try{
            let itemId = o.item_id;
            if (!itemId){
                const res = await fetch(`/mappings/outputs/${o.id}/ensure-variant`, { method: 'POST' });
                if (!res.ok){ alert('Varyant olusturma hatasi'); return; }
                const j = await res.json();
                itemId = j.item_id;
            }
            addRow(`${itemId} | `, o.quantity || 1);
        }catch(err){ alert('Mapping ekleme hatasi'); }
    }
    </script>
</body>
</html>


