<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>İçe Aktarım Sonuçları</title>
		<style>
			body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
			h1 { margin-bottom: 12px; }
			.card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; margin-bottom: 16px; }
			.card h2 { margin: 0; padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
			.grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
			@media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
			table { width: 100%; border-collapse: collapse; }
			th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
			th { background: #fafafa; position: sticky; top: 0; }
			.badge { display:inline-block; padding:3px 6px; border-radius:6px; font-size:12px; background:#eef2ff; color:#1d4ed8; }
		</style>
	</head>
	<body>
		{% include "_nav.html" %}
		<h1>İçe Aktarım Sonuçları</h1>
		<div class="card">
			<h2>Özet</h2>
			<div style="padding:12px 16px; display:flex; flex-wrap:wrap; gap:10px;">
				<div><strong>Toplam Satır:</strong> {{ totals.row_count }}</div>
				<div><strong>Başarılı Satırlar:</strong> {{ totals.rows_created }}</div>
				<div><strong>Hatalı:</strong> {{ totals.rows_error }}</div>
				<div><strong>Eşleşmeyen:</strong> {{ totals.rows_unmatched }}</div>
				<div><strong>Atlanan:</strong> {{ totals.rows_skipped }}</div>
				<div><strong>Kopya:</strong> {{ totals.rows_duplicates }}</div>
			</div>
		</div>
		<div class="grid">
			<div class="card">
				<h2>Oluşturulan Varlıklar</h2>
				<table>
					<tbody>
						<tr><th>Müşteriler</th><td>{{ totals.created_clients }}</td></tr>
						<tr><th>Ürünler</th><td>{{ totals.created_items }}</td></tr>
						<tr><th>Siparişler</th><td>{{ totals.created_orders }}</td></tr>
						<tr><th>Ödemeler</th><td>{{ totals.created_payments }}</td></tr>
					</tbody>
				</table>
			</div>
			<div class="card">
				<h2>Çalıştırmalar</h2>
				<table>
					<thead>
						<tr><th>ID</th><th>Kaynak</th><th>Dosya</th><th>Satır</th><th>Müşteri</th><th>Ürün</th><th>Sipariş</th><th>Ödeme</th><th>Eşleşmeyen</th></tr>
					</thead>
					<tbody>
						{% for r in runs %}
						<tr>
							<td>{{ r.id }}</td>
							<td>{{ r.source }}</td>
							<td>{{ r.filename }}</td>
							<td>{{ r.row_count }}</td>
							<td>{{ r.created_clients }}</td>
							<td>{{ r.created_items }}</td>
							<td>{{ r.created_orders }}</td>
							<td>{{ r.created_payments }}</td>
							<td>{{ r.unmatched }}</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
		<div class="card">
			<h2>Başarısız Satırlar (ilk {{ failures|length }})</h2>
			<table>
				<thead>
					<tr><th>Run</th><th>Satır #</th><th>Durum</th><th>Mesaj</th><th>Client</th><th>Order</th><th>Detay</th></tr>
				</thead>
				<tbody>
					{% for f in failures %}
					<tr>
						<td>{{ f.run_id }}</td>
						<td>{{ f.row_index }}</td>
						<td><span class="badge">{{ f.status }}</span></td>
						<td>{{ f.message }}</td>
						<td>{{ f.matched_client_id or '' }}</td>
						<td>{{ f.matched_order_id or '' }}</td>
						<td style="max-width:520px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="{{ f.mapped_json }}">{{ f.mapped_json }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<div class="card">
			<h2>Tüm Satırlar (durum ve eşleşmeler)</h2>
			<p style="padding:8px 16px; font-size:13px; color:#6b7280;">
				Her çalışma için ilk 1000 satır gösterilir. Bu tablo, kopya ve atlanan satırlar dahil her satırın nasıl işlendiğini incelemek içindir.
			</p>
			{% for run in runs %}
			<div style="margin:8px 16px 16px;">
				<h3 style="margin:4px 0 8px; font-size:14px;">
					Run #{{ run.id }} – {{ run.source }} – {{ run.filename }}
				</h3>
				<table>
					<thead>
						<tr>
							<th style="width:60px;">Satır #</th>
							<th style="width:90px;">Durum</th>
							<th style="width:120px;">Mesaj</th>
							<th style="width:90px;">Client ID</th>
							<th style="width:90px;">Order ID</th>
							<th>Detay (mapped_json)</th>
							<th style="width:130px;">Ödeme Düzelt</th>
						</tr>
					</thead>
					<tbody>
						{% for r in rows_by_run.get(run.id, []) %}
						<tr>
							<td>{{ r.row_index }}</td>
							<td><span class="badge">{{ r.status }}</span></td>
							<td>{{ r.message }}</td>
							<td>{{ r.matched_client_id or '' }}</td>
							<td>{{ r.matched_order_id or '' }}</td>
							<td style="max-width:600px; white-space:pre-wrap; word-wrap:break-word; word-break:break-all; font-family:monospace; font-size:12px; line-height:1.4;">{{ r.mapped_json }}</td>
							<td>
								{% if r.reconcile_url and r.payment_amount %}
									<a href="{{ r.reconcile_url }}" style="font-size:12px; text-decoration:none; padding:4px 8px; border-radius:6px; border:1px solid #d1d5db; background:#f9fafb;">
										Ödemeyi Düzelt<br />
										<span style="font-size:11px; color:#4b5563;">{{ '%.2f'|format(r.payment_amount or 0.0) }} · {{ r.payment_date or '' }}</span>
									</a>
								{% endif %}
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
			{% endfor %}
		</div>
		<div style="margin-top:16px;">
			<a href="/dashboard" style="text-decoration:none; padding:8px 12px; border:1px solid #ddd; border-radius:6px;">Panoya Dön</a>
		</div>
	</body>
</html>


