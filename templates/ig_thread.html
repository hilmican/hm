<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Conversation {{ conversation_id }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .toolbar { display:flex; gap:8px; margin-bottom:12px; }
      .msg { margin:8px 0; display:flex; }
      .bubble { max-width: 70%; padding:10px 12px; border-radius:12px; }
      .in .bubble { background:#f3f4f6; margin-right:auto; }
      .out .bubble { background:#dbeafe; margin-left:auto; }
      .meta { color:#6b7280; font-size:12px; margin-top:4px; }
      button { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
      a { color:#2563eb; text-decoration:none; }
      .toolbar .action { border:1px solid #2563eb; border-radius:6px; padding:6px 10px; font-size:13px; }
      .template-card-grid { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
      .template-card { border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff; }
      .template-card img { width:100%; max-width:320px; display:block; object-fit:cover; }
      .template-card-body { padding:10px; }
      .template-card-title { font-weight:600; color:#111827; }
      .template-card-subtitle { color:#4b5563; font-size:13px; margin-top:4px; white-space:pre-wrap; }
      .template-card-buttons { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
      .template-card-buttons a { background:#2563eb; color:#fff; padding:4px 10px; border-radius:999px; font-size:12px; text-decoration:none; }
      .template-card-buttons span { background:#e5e7eb; color:#374151; padding:4px 10px; border-radius:999px; font-size:12px; }
      .inline-grid-2 { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:12px; }
      .brand-card, .assignment-card { border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:#fff; }
      .brand-card img { width:56px; height:56px; border-radius:999px; object-fit:cover; border:1px solid #e5e7eb; }
      .brand-stats { display:flex; gap:16px; margin-top:10px; font-size:13px; color:#4b5563; }
      .brand-stat-label { display:block; font-weight:600; color:#111827; font-size:14px; }
      .assignment-card label { font-size:13px; color:#4b5563; display:block; margin-bottom:4px; }
      .assignment-card select, .assignment-card textarea, .assignment-card input { width:100%; border:1px solid #d1d5db; border-radius:8px; padding:8px; font-size:14px; }
      .assignment-actions { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
      .pill-button { background:#f3f4f6; border:1px solid #d1d5db; border-radius:999px; padding:4px 10px; font-size:12px; cursor:pointer; }
      .pill-button.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
      .modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,0.55); display:none; align-items:center; justify-content:center; z-index:50; }
      .modal { background:#fff; border-radius:12px; padding:20px; width:min(500px,90vw); max-height:90vh; overflow:auto; box-shadow:0 20px 60px rgba(15,23,42,0.2); }
      .modal h3 { margin-top:0; color:#111827; }
      .hidden { display:none !important; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    {% set lc = link_context or {} %}
    {% set uc = user_context or {} %}
    {% set ai_state = ai_state or {} %}
    <div class="toolbar">
      <a href="/ig/inbox">‚Üê Back to Inbox</a>
      <a class="action" href="/ig/inbox/{{ conversation_id }}/debug" title="AI Debug">AI Debug</a>
      <button id="refresh">Refresh</button>
    </div>
    <div style="display:grid; gap:12px; margin-bottom:16px;">
      <div style="border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
        <h3 style="margin:0 0 8px 0; color:#111827;">Konu≈üma √ñzeti</h3>
        <div class="meta">IG Kullanƒ±cƒ±sƒ±:
          {% if uc.username %}@{{ uc.username }}
          {% elif other_label %}{{ other_label }}
          {% else %}-{% endif %}
          {% if uc.ig_user_id %} ¬∑ id: {{ uc.ig_user_id }}{% endif %}
        </div>
        {% if uc.contact_name or uc.contact_phone or uc.contact_address %}
          <div class="meta">
            {% if uc.contact_name %}Ad: {{ uc.contact_name }}{% endif %}
            {% if uc.contact_name and uc.contact_phone %} ¬∑ {% endif %}
            {% if uc.contact_phone %}Tel: {{ uc.contact_phone }}{% endif %}
            {% if (uc.contact_name or uc.contact_phone) and uc.contact_address %} ¬∑ {% endif %}
            {% if uc.contact_address %}Adres: {{ uc.contact_address }}{% endif %}
          </div>
        {% endif %}
        {% if uc.linked_order_id %}
          <div class="meta">Baƒülƒ± Sipari≈ü: <a href="/orders/{{ uc.linked_order_id }}/edit" style="color:#2563eb;">#{{ uc.linked_order_id }}</a></div>
        {% endif %}
        {% if lc.product_name %}
          <div class="meta">Baƒülƒ± √úr√ºn: {{ lc.product_name }}
            {% if lc.product_slug %}
              <a class="meta" href="/ig/ai/products?focus={{ lc.product_slug }}" target="_blank" rel="noopener">(AI talimatlarƒ±nƒ± d√ºzenle)</a>
            {% endif %}
          </div>
        {% elif lc.has_link %}
          <div class="meta">
            Baƒülƒ± {{ lc.link_type or 'ad' }}: {{ lc.link_id or lc.ad_id }}
            {% if lc.ad_edit_url %}
              <a class="meta" href="{{ lc.ad_edit_url }}" target="_blank" rel="noopener">d√ºzenle ‚Üó</a>
            {% endif %}
          </div>
        {% else %}
          <div class="meta" style="color:#b91c1c;">Hen√ºz reklama/√ºr√ºne baƒülanmadƒ±.</div>
        {% endif %}
        {% if ai_state.label %}
          <div class="meta">AI Durumu: {{ ai_state.label }}{% if ai_state.description %} ‚Äî {{ ai_state.description }}{% endif %}</div>
        {% endif %}
        {% if ai_state.needs_link %}
          {% if lc.product_slug %}
            <button id="aiRetryBtn" class="action" style="margin-top:8px; font-size:13px;">√úr√ºn baƒülandƒ±, AI'yi sƒ±raya al</button>
          {% else %}
            <div class="meta" style="color:#b91c1c;">√ñnce ilgili reklamƒ±/postu √ºr√ºne baƒülayƒ±n.</div>
          {% endif %}
        {% endif %}
      </div>
      <div class="inline-grid-2">
        {% if brand_profile %}
          {% include "components/ig_brand_snapshot.html" %}
        {% endif %}
        {% include "components/ig_assignment_panel.html" %}
      </div>
    </div>
    {% if shadow and shadow.text and not inline_drafts %}
      {% set shadow_status = shadow.status or 'suggested' %}
      {% if shadow_status == 'sent' %}
      <div style="margin:12px 0; padding:12px; border:1px solid #10b981; background:#d1fae5; border-radius:10px;">
        <div style="font-weight:600; color:#059669; margin-bottom:6px;">‚úì AI Mesajƒ± G√∂nderildi</div>
      {% elif shadow_status == 'error' %}
      <div style="margin:12px 0; padding:12px; border:1px solid #f59e0b; background:#fef3c7; border-radius:10px;">
        <div style="font-weight:600; color:#d97706; margin-bottom:6px;">‚ö† AI Mesajƒ± G√∂nderilemedi</div>
      {% else %}
      <div style="margin:12px 0; padding:12px; border:1px dashed #93c5fd; background:#eff6ff; border-radius:10px;">
        <div style="font-weight:600; color:#1e40af; margin-bottom:6px;">AI √ñneri (g√∂nderilmedi)</div>
      {% endif %}
        {% if shadow.text_lines and shadow.text_lines|length > 0 %}
          <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
            {% for line in shadow.text_lines %}
              <div class="msg out" style="margin:0;">
                <div class="bubble" style="margin-left:auto; margin-right:0;">{{ line }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div style="white-space:pre-wrap; color:#111827;">{{ shadow.text }}</div>
        {% endif %}
        {% if shadow.timestamp_ms %}
          <div class="meta"><span class="ts" data-ts="{{ shadow.timestamp_ms }}">{{ shadow.timestamp_ms }}</span></div>
        {% endif %}
        <div class="meta" style="margin-top:6px;">
          model={{ shadow.model or '-' }} ¬∑ g√ºven={{ ('%.2f' % shadow.confidence) if shadow.confidence is not none else '-' }} ¬∑ sebep={{ shadow.reason or '-' }}
        </div>
        {% if shadow.actions %}
          <div style="margin-top:8px;">
            <div class="meta" style="font-weight:600; color:#1f2937;">ü§ñ Planlanan Aksiyonlar</div>
            {% for action in shadow.actions %}
              <div class="meta" style="margin-top:4px;">
                ‚Ä¢ {{ action.type }}
                {% if action.trigger %} ¬∑ tetikleyici: {{ action.trigger }}{% endif %}
                {% if action.image_count %} ¬∑ {{ action.image_count }} g√∂rsel{% endif %}
                {% if action.product_name %} ¬∑ √ºr√ºn: {{ action.product_name }}{% elif action.product_slug %} ¬∑ √ºr√ºn: {{ action.product_slug }}{% endif %}
              </div>
              {% if action.type == 'send_product_images' and action.image_urls %}
                <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                  {% for img_url in action.image_urls %}
                    <a href="{{ img_url }}" target="_blank" rel="noopener" style="display:inline-block; border:1px solid #e5e7eb; border-radius:6px; overflow:hidden;">
                      <img src="{{ img_url }}" alt="AI product" style="width:80px; height:80px; object-fit:cover;" />
                    </a>
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
        {% if shadow.state %}
        <div class="meta" style="margin-top:8px; white-space:pre-wrap;">üìå Durum: {{ shadow.state }}</div>
        {% endif %}
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="useShadow" class="action" type="button">Metni kutuya al</button>
          <button id="dismissShadow" class="action" type="button" style="border-color:#ef4444;color:#ef4444">Gizle</button>
        </div>
      </div>
    {% endif %}
  <div style="margin-top:18px">
    <h3>AI √áƒ±ktƒ±sƒ±</h3>
    {% if ai_status %}<div class="meta">Durum: {{ ai_status }}</div>{% endif %}
    <pre id="aiBox" style="background:#0b1021;color:#e5e7eb; padding:12px; border-radius:8px; max-height:300px; overflow:auto; white-space:pre-wrap;">{{ ai_json or 'Hen√ºz AI verisi yok.' }}</pre>
    <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h4 style="margin:0; color:#111827;">√úr√ºn AI Talimatlarƒ±
          {% if focus_product and focus_product.id %}
            <a href="/ig/ai/products?focus={{ focus_product.slug or focus_product.name }}" target="_blank" rel="noopener" class="meta" style="margin-left:6px;">(d√ºzenle)</a>
          {% endif %}
        </h4>
        {% if focus_product %}
          <button id="toggleAiInstructions" type="button" class="action" style="font-size:12px; padding:4px 8px;">G√∂ster</button>
        {% endif %}
      </div>
      {% if focus_product %}
        <div id="aiInstructionsContent" style="display:none;">
          <div class="meta">
            √úr√ºn: {{ focus_product.name or '-' }}
            {% if focus_product.price %} ¬∑ fiyat: {{ '%.0f' % focus_product.price }}‚Ç∫{% endif %}
            {% if focus_product.confidence is not none %} ¬∑ g√ºven: {{ '%.2f' % focus_product.confidence }}{% endif %}
          </div>
          {% if focus_product.system %}
            <div style="margin-top:8px; white-space:pre-wrap; font-size:13px;"><strong>System:</strong> {{ focus_product.system }}</div>
          {% endif %}
          {% if focus_product.prompt %}
            <div style="margin-top:8px; white-space:pre-wrap; font-size:13px;"><strong>Prompt:</strong> {{ focus_product.prompt }}</div>
          {% endif %}
        </div>
      {% else %}
        <div class="meta" style="color:#b91c1c;">
          Bu konu≈üma hen√ºz √ºr√ºne baƒülanmadƒ±. ƒ∞lgili reklamƒ± √ºr√ºne e≈üledikten sonra AI talimatlarƒ±nƒ± d√ºzenleyebilirsiniz.
        </div>
      {% endif %}
    </div>
    <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
      <h4 style="margin:0 0 8px 0; color:#111827;">Zenginle≈ütirme Durumu</h4>
      {% if enrich %}
        <div class="meta">Kullanƒ±cƒ±: {{ enrich.username or '-' }} {% if enrich.name %} ({{ enrich.name }}){% endif %}</div>
        <div class="meta">Durum: {{ enrich.fetch_status or 'bilinmiyor' }} {% if enrich.fetched_at %}¬∑ fetched_at: {{ enrich.fetched_at }}{% endif %}</div>
        {% if enrich.fetch_error %}<div class="meta">Hata: {{ enrich.fetch_error }}</div>{% endif %}
        <div class="meta">Kuyruk (enrich_user) uzunluƒüu: {{ enrich.queue_depth if enrich.queue_depth is not none else '-' }}</div>
        {% if enrich.job and enrich.job.id %}
          <div class="meta">Bekleyen i≈ü: #{{ enrich.job.id }} ¬∑ attempts={{ enrich.job.attempts or 0 }} {% if enrich.job.run_after %}¬∑ run_after={{ enrich.job.run_after }}{% endif %}</div>
        {% else %}
          <div class="meta">Bekleyen enrich_user i≈üi yok.</div>
        {% endif %}
      {% else %}
        <div class="meta">Zenginle≈ütirme bilgisi mevcut deƒüil.</div>
      {% endif %}
      <div style="margin-top:8px;">
        <button id="enrichNow" class="action" style="margin-right:6px">≈ûimdi Zenginle≈ütir</button>
        <button id="hydrateNow" class="action" style="margin-right:6px">Hydrate Now</button>
        <button id="statusRefresh" class="action">Durumu Yenile</button>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnMergeGraph" class="action" title="dm:<id> ‚Üí Graph CID'e ta≈üƒ±" style="background:#0ea5e9">Graph CID'e Birle≈ütir</button>
        <button id="btnNormalizeDm" class="action" title="Eski mesajlarda dm:&lt;id&gt; conversation_id d√ºzelt" style="background:#10b981">dm:&lt;id&gt; Normalize</button>
        <button id="btnBackfillAi" class="action" title="ai_conversations son mesaj alanlarƒ±nƒ± geri doldur" style="background:#6366f1">AI √ñzetlerini Geri Doldur</button>
      </div>
    </div>
    {% if contact_name or contact_phone or contact_address or linked_order_id %}
      <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
        <h4 style="margin:0 0 8px 0; color:#111827;">√áƒ±karƒ±lan Bilgiler</h4>
        <ul style="list-style:none; padding:0; margin:0; color:#374151; font-size:13px; display:grid; gap:6px;">
          {% if contact_name %}<li><strong>Ad:</strong> {{ contact_name }}</li>{% endif %}
          {% if contact_phone %}<li><strong>Telefon:</strong> <a href="tel:{{ contact_phone }}" style="color:#2563eb;">{{ contact_phone }}</a></li>{% endif %}
          {% if contact_address %}<li><strong>Adres:</strong> {{ contact_address }}</li>{% endif %}
          {% if linked_order_id %}<li><strong>Baƒülƒ± Sipari≈ü:</strong> <a href="/orders/{{ linked_order_id }}/edit" style="color:#2563eb;">#{{ linked_order_id }}</a></li>{% endif %}
        </ul>
      </div>
    {% endif %}
  </div>
    <h2>
      Conversation {{ other_label or conversation_id }}
      {% if other_label %}<a class="meta" target="_blank" rel="noopener" href="https://instagram.com/{{ other_label[1:] }}">profile ‚Üó</a>{% endif %}
      {% if contact_name or contact_phone or contact_address %}
        <div class="meta">{{ contact_name or '' }}{% if contact_name and contact_phone %} ¬∑ {% endif %}{{ contact_phone or '' }}{% if (contact_name or contact_phone) and contact_address %} ¬∑ {% endif %}{{ contact_address or '' }}</div>
      {% endif %}
    </h2>
    <div id="thread">
      {% for m in messages %}
        <div class="msg {{ m.direction or 'in' }}">
          <div class="bubble" {% if m.is_ai_draft %}
            {% if m.ai_decision_status == 'sent' %}style="border:1px solid #10b981; background:#d1fae5;"
            {% elif m.ai_decision_status == 'error' %}style="border:1px solid #f59e0b; background:#fef3c7;"
            {% elif m.ai_decision_status == 'no_reply' %}style="border:1px dashed #f59e0b; background:#fef3c7;"
            {% else %}style="border:1px dashed #93c5fd; background:#eff6ff;"{% endif %}
            {% endif %}>
            <div>
              {% set u_map = usernames if usernames is defined else {} %}
              {% set uname = m.sender_username or (u_map.get(m.ig_sender_id or '')) %}
              {% if uname %}
                <span class="meta">@{{ uname }}</span><br/>
              {% elif m.ig_sender_id %}
                <span class="meta">id: {{ m.ig_sender_id }}</span><br/>
              {% endif %}
              {{ m.text or '' }}
              {% if m.is_ai_draft %}
                <div class="meta" style="margin-top:4px">
                  {% if m.ai_decision_status == 'sent' %}
                    <span style="color:#059669; font-weight:600;">‚úì AI Mesajƒ± G√∂nderildi</span>
                  {% elif m.ai_decision_status == 'error' %}
                    <span style="color:#d97706; font-weight:600;">‚ö† AI Mesajƒ± G√∂nderilemedi</span>
                  {% elif m.ai_decision_status == 'no_reply' %}
                    <span style="color:#f59e0b; font-weight:600;">‚ö†Ô∏è AI Kararƒ±: Cevap verilmeyecek</span>
                  {% elif m.ai_decision_status == 'suggested' %}
                    <span style="color:#3b82f6; font-weight:600;">üí¨ AI √ñnerisi</span>
                  {% elif m.ai_decision_status == 'dismissed' %}
                    <span style="color:#6b7280; font-weight:600;">‚ùå AI √ñnerisi (Reddedildi)</span>
                  {% else %}
                    <span style="color:#6366f1; font-weight:600;">ü§ñ AI Aksiyonu</span>
                  {% endif %}
                  {% if m.ai_model %} ¬∑ model: {{ m.ai_model }}{% endif %}
                  {% if m.ai_reason %} ¬∑ {{ m.ai_reason }}{% endif %}
                  {% if m.draft_id %}
                    ¬∑ <a href="/ig/inbox/shadow/{{ m.draft_id }}" target="_blank" rel="noopener">Detaylarƒ± g√∂r</a>
                  {% endif %}
                </div>
                {% if m.ai_decision_status != 'no_reply' %}
                <div style="margin-top:6px">
                  {% set draft_slug = m.product_slug or (focus_product.slug if focus_product else None) %}
                  {% if draft_slug %}
                    <a class="action" href="/ig/ai/products?focus={{ draft_slug }}" target="_blank" rel="noopener">√úr√ºn AI mesajlarƒ±nƒ± d√ºzenle ‚Üó</a>
                  {% else %}
                    <span class="meta" style="color:#b91c1c;">√úr√ºn baƒülantƒ±sƒ± yok (AI talimatƒ± d√ºzenlenemez)</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if m.ai_actions %}
                  <div style="margin-top:8px;">
                    <div class="meta" style="font-weight:600; color:#1f2937;">ü§ñ Planlanan Aksiyonlar</div>
                    {% for action in m.ai_actions %}
                      <div class="meta" style="margin-top:4px;">
                        ‚Ä¢ {{ action.type }}
                        {% if action.trigger %} ¬∑ tetikleyici: {{ action.trigger }}{% endif %}
                        {% if action.image_count %} ¬∑ {{ action.image_count }} g√∂rsel{% endif %}
                        {% if action.product_name %} ¬∑ √ºr√ºn: {{ action.product_name }}{% elif action.product_slug %} ¬∑ √ºr√ºn: {{ action.product_slug }}{% endif %}
                      </div>
                      {% if action.type == 'send_product_images' and action.image_urls %}
                        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                          {% for img_url in action.image_urls %}
                            <a href="{{ img_url }}" target="_blank" rel="noopener" style="display:inline-block; border:1px solid #e5e7eb; border-radius:6px; overflow:hidden;">
                              <img src="{{ img_url }}" alt="AI product" style="width:80px; height:80px; object-fit:cover;" />
                            </a>
                          {% endfor %}
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              {% if m.ai_state %}
              <div class="meta" style="margin-top:4px;">üìå Durum: {{ m.ai_state }}</div>
              {% endif %}
              {% endif %}
            </div>
            {% set cards = template_cards.get(m.ig_message_id or '') %}
            {% if cards %}
              <div class="template-card-grid">
                {% for card in cards %}
                  <div class="template-card">
                    {% if card.image_url %}
                      <img src="{{ card.image_url }}" alt="card" loading="lazy" />
                    {% endif %}
                    <div class="template-card-body">
                      {% if card.title %}<div class="template-card-title">{{ card.title }}</div>{% endif %}
                      {% if card.subtitle %}<div class="template-card-subtitle">{{ card.subtitle }}</div>{% endif %}
                      {% set action = card.default_action %}
                      {% if action and action.url %}
                        <div class="template-card-buttons">
                          <a href="{{ action.url }}" target="_blank" rel="noopener">{{ action.title or 'View' }}</a>
                        </div>
                      {% endif %}
                      {% if card.buttons %}
                        <div class="template-card-buttons">
                          {% for btn in card.buttons %}
                            {% if btn.url %}
                              <a href="{{ btn.url }}" target="_blank" rel="noopener">{{ btn.title or 'Link' }}</a>
                            {% else %}
                              <span>{{ btn.title or 'Action' }}</span>
                            {% endif %}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
            {% set local_ids = att_ids_map.get(m.ig_message_id or '') %}
            {% if local_ids %}
              {% for aid in local_ids %}
                <div style="margin-top:8px">
                  <img src="/ig/media/local/{{ aid }}" alt="attachment" style="max-width:280px;border-radius:8px;border:1px solid #e5e7eb" />
                </div>
              {% endfor %}
            {% elif att_map.get(m.ig_message_id) %}
              {% for idx in att_map.get(m.ig_message_id) %}
                <div style="margin-top:8px">
                  <img src="/ig/media/{{ m.ig_message_id }}/{{ idx }}" alt="attachment" style="max-width:280px;border-radius:8px;border:1px solid #e5e7eb" />
                </div>
              {% endfor %}
            {% endif %}
            <div class="meta"><span class="ts" data-ts="{{ m.timestamp_ms or '' }}">{{ m.timestamp_ms }}</span>
              {% if m.ad_id or m.ad_link or m.ad_title %}
                ¬∑ Replied to an ad{% if m.ad_title or m.ad_id %}: {{ m.ad_title or m.ad_id }}{% endif %}
                {% set ad_url = m.ad_link or (('https://www.facebook.com/ads/library/?id=' ~ m.ad_id) if m.ad_id else None) %}
                {% if ad_url %} (<a target="_blank" rel="noopener" href="{{ ad_url }}">link</a>){% endif %}
                {% set ad = (ads_cache.get(m.ad_id|string) if (ads_cache is defined and m.ad_id) else None) %}
                {% set ap = (ad_products.get(m.ad_id|string) if (ad_products is defined and m.ad_id) else None) %}
                {% if ap and ap.product_name %}
                  ¬∑ √úr√ºn: {{ ap.product_name }}
                  {% if m.ad_id %}
                    <a class="meta" href="/ads/{{ m.ad_id }}/edit" title="√úr√ºn baƒülantƒ±sƒ±nƒ± d√ºzenle">(d√ºzenle)</a>
                  {% endif %}
                {% elif m.ad_id %}
                  ¬∑ <a class="meta" href="/ads/{{ m.ad_id }}/edit" title="Reklamƒ± √ºr√ºne baƒüla">Reklamƒ± Baƒüla</a>
                {% endif %}
                {% if ad and ad.image_url %}
                  <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
                    <img src="{{ ad.image_url }}" alt="ad" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb" />
                    <div class="meta">{{ ad.name or '' }}</div>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
      {% if inline_drafts and shadow and shadow.text %}
        <div class="msg out">
          <div class="bubble" style="border:1px dashed #93c5fd; background:#eff6ff;">
            <div style="font-weight:600; color:#1e40af; margin-bottom:6px;">AI √ñneri (g√∂nderilmedi)</div>
            {% if shadow.text_lines and shadow.text_lines|length > 0 %}
              <div style="display:flex; flex-direction:column; gap:4px; margin-top:4px;">
                {% for line in shadow.text_lines %}
                  <div>{{ line }}</div>
                {% endfor %}
              </div>
            {% else %}
              <div style="white-space:pre-wrap; color:#111827;">{{ shadow.text }}</div>
            {% endif %}
            <div class="meta" style="margin-top:6px;">
              model={{ shadow.model or '-' }} ¬∑ g√ºven={{ ('%.2f' % shadow.confidence) if shadow.confidence is not none else '-' }} ¬∑ sebep={{ shadow.reason or '-' }}
            </div>
            {% if shadow.actions %}
              <div style="margin-top:8px;">
                <div class="meta" style="font-weight:600; color:#1f2937;">ü§ñ Planlanan Aksiyonlar</div>
                {% for action in shadow.actions %}
                  <div class="meta" style="margin-top:4px;">
                    ‚Ä¢ {{ action.type }}
                    {% if action.trigger %} ¬∑ tetikleyici: {{ action.trigger }}{% endif %}
                    {% if action.image_count %} ¬∑ {{ action.image_count }} g√∂rsel{% endif %}
                    {% if action.product_name %} ¬∑ √ºr√ºn: {{ action.product_name }}{% elif action.product_slug %} ¬∑ √ºr√ºn: {{ action.product_slug }}{% endif %}
                  </div>
                  {% if action.type == 'send_product_images' and action.image_urls %}
                    <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                      {% for img_url in action.image_urls %}
                        <a href="{{ img_url }}" target="_blank" rel="noopener" style="display:inline-block; border:1px solid #e5e7eb; border-radius:6px; overflow:hidden;">
                          <img src="{{ img_url }}" alt="AI product" style="width:80px; height:80px; object-fit:cover;" />
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button id="sendDraft" class="action" type="button">G√∂nder</button>
              <button id="editDraft" class="action" type="button">D√ºzenle</button>
              <button id="dismissDraft" class="action" type="button" style="border-color:#ef4444;color:#ef4444">Sil</button>
            </div>
          </div>
        </div>
      {% endif %}
      {% if not messages %}
        <div class="meta">No messages cached yet.</div>
      {% endif %}
    </div>
    <div style="margin-top:16px">
      <form id="replyForm" style="display:flex;gap:8px">
        <input id="replyInput" type="text" placeholder="Type a reply..." style="flex:1;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px" />
        <button id="sendBtn" type="submit" style="background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer">Send</button>
      </form>
    </div>
    <div id="orderWizardBackdrop" class="modal-backdrop hidden">
      <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>DM ‚Üí Sipari≈ü Taslaƒüƒ±</h3>
          <button id="orderWizardClose" class="pill-button" type="button">Kapat</button>
        </div>
        <form id="orderWizardForm" style="display:flex; flex-direction:column; gap:10px;">
          <label>ƒ∞sim
            <input type="text" name="customer_name" placeholder="M√º≈üteri adƒ±" />
          </label>
          <label>Telefon
            <input type="text" name="phone" placeholder="+90..." />
          </label>
          <label>Adres
            <textarea name="address" rows="2" placeholder="Teslimat adresi"></textarea>
          </label>
          <label>Notlar
            <textarea name="notes" rows="3" placeholder="√ñrn: Beden S, renk siyah"></textarea>
          </label>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button id="orderWizardSubmit" class="action" type="submit">Taslaƒüƒ± Kaydet</button>
          </div>
        </form>
        <div id="orderWizardStatus" class="meta" style="margin-top:8px;"></div>
      </div>
    </div>
    <script>
      const conversationId = {{ conversation_id | tojson }};
      const publicConversationId = {{ (public_conversation_id or "") | tojson }};
      function fmtTs(){
        const nodes = document.querySelectorAll('.ts');
        for(const el of nodes){
          const v = el.getAttribute('data-ts');
          const ms = Number(v||0);
          if(ms>0){ const d = new Date(ms); el.textContent = d.toLocaleString(); }
          else { el.textContent = '-'; }
        }
      }
      fmtTs();

      const brandSnapshotCard = document.getElementById('brandSnapshotCard');
      async function refreshBrandProfile(force = false){
        if (!brandSnapshotCard) return;
        const btn = document.getElementById('brandRefreshBtn');
        try {
          if (btn) { btn.disabled = true; btn.textContent = 'Y√ºkleniyor...'; }
          const res = await fetch(`/ig/inbox/brand-profile${force ? '?force=1' : ''}`);
          if (!res.ok) throw new Error('fetch_failed');
          const data = await res.json();
          const updated = new Date(data.refreshed_at || Date.now()).toLocaleString();
          const statNodes = brandSnapshotCard.querySelectorAll('.brand-stat-label');
          if (statNodes.length >= 3) {
            statNodes[0].textContent = data.followers_count ?? 0;
            statNodes[1].textContent = data.follows_count ?? 0;
            statNodes[2].textContent = data.media_count ?? 0;
          }
          const updatedEl = document.getElementById('brandSnapshotUpdated');
          if (updatedEl) updatedEl.textContent = updated;
        } catch (e) {
          alert('Profil yenileme ba≈üarƒ±sƒ±z: ' + (e?.message || e));
        } finally {
          if (btn) { btn.disabled = false; btn.textContent = 'Yenile'; }
        }
      }
      document.getElementById('brandRefreshBtn')?.addEventListener('click', () => refreshBrandProfile(true));

      const assigneeSelect = document.getElementById('assigneeSelect');
      const assigneeNote = document.getElementById('assigneeNote');
      const assignmentMeta = document.getElementById('assignmentMeta');
      document.getElementById('assignmentSaveBtn')?.addEventListener('click', async () => {
        try {
          const payload = {
            user_id: assigneeSelect?.value ? Number(assigneeSelect.value) : null,
            note: assigneeNote?.value || null,
          };
          const res = await fetch(`/ig/inbox/${conversationId}/assign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json().catch(()=> ({}));
          if (!res.ok) throw new Error(data.detail || 'assign_failed');
          if (assignmentMeta) assignmentMeta.textContent = 'G√ºncellendi: ' + (data.updated_at || '');
        } catch (e) {
          alert('Atama kaydedilemedi: ' + (e?.message || e));
        }
      });

      const cannedList = document.getElementById('cannedResponseList');
      async function loadCannedResponses(){
        if (!cannedList) return;
        cannedList.innerHTML = '<div class="meta">Y√ºkleniyor...</div>';
        try {
          const res = await fetch('/ig/inbox/canned-responses');
          const data = await res.json();
          cannedList.innerHTML = '';
          (data.items || []).forEach(item => {
            const row = document.createElement('div');
            row.style.border = '1px solid #e5e7eb';
            row.style.borderRadius = '10px';
            row.style.padding = '10px';
            row.innerHTML = `<div style="font-weight:600;color:#111827;">${item.title}</div>
              <div class="meta" style="white-space:pre-wrap;margin-top:4px;">${item.body}</div>`;
            const btn = document.createElement('button');
            btn.className = 'pill-button primary';
            btn.textContent = 'Metni kullan';
            btn.style.marginTop = '8px';
            btn.addEventListener('click', () => {
              const existing = replyInput?.value || '';
              replyInput.value = existing ? `${existing}\n${item.body}` : item.body;
              replyInput.focus();
            });
            row.appendChild(btn);
            cannedList.appendChild(row);
          });
          if (!data.items || !data.items.length) {
            cannedList.innerHTML = '<div class="meta">Hen√ºz hazƒ±r yanƒ±t yok.</div>';
          }
        } catch (e) {
          cannedList.innerHTML = '<div class="meta" style="color:#b91c1c;">Y√ºklenemedi.</div>';
        }
      }
      loadCannedResponses();
      document.getElementById('cannedReloadBtn')?.addEventListener('click', () => loadCannedResponses());

      const wizardBackdrop = document.getElementById('orderWizardBackdrop');
      const wizardForm = document.getElementById('orderWizardForm');
      const wizardStatus = document.getElementById('orderWizardStatus');
      async function openWizard(){
        wizardBackdrop?.classList.remove('hidden');
        if (!wizardForm) return;
        try {
          const res = await fetch(`/ig/inbox/${conversationId}/order-prefill`);
          const data = await res.json();
          wizardForm.customer_name.value = data.contact_name || '';
          wizardForm.phone.value = data.contact_phone || '';
          wizardForm.address.value = data.contact_address || '';
          wizardForm.notes.value = data.notes || '';
        } catch {}
      }
      document.getElementById('dmOrderWizardBtn')?.addEventListener('click', openWizard);
      document.getElementById('orderWizardClose')?.addEventListener('click', () => wizardBackdrop?.classList.add('hidden'));
      wizardBackdrop?.addEventListener('click', (ev) => {
        if (ev.target === wizardBackdrop) wizardBackdrop.classList.add('hidden');
      });
      wizardForm?.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        try {
          const payload = {
            customer_name: wizardForm.customer_name.value || null,
            phone: wizardForm.phone.value || null,
            address: wizardForm.address.value || null,
            notes: wizardForm.notes.value || null,
            items: [],
          };
          const res = await fetch(`/ig/inbox/${conversationId}/order-drafts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json().catch(()=> ({}));
          if (!res.ok) throw new Error(data.detail || 'draft_failed');
          wizardStatus.textContent = `Taslak olu≈üturuldu (#${data.id})`;
        } catch (e) {
          wizardStatus.textContent = 'Hata: ' + (e?.message || e);
        }
      });

      // Toggle AI Instructions visibility
      const toggleAiInstructions = document.getElementById('toggleAiInstructions');
      const aiInstructionsContent = document.getElementById('aiInstructionsContent');
      if (toggleAiInstructions && aiInstructionsContent) {
        toggleAiInstructions.addEventListener('click', () => {
          const isHidden = aiInstructionsContent.style.display === 'none';
          aiInstructionsContent.style.display = isHidden ? 'block' : 'none';
          toggleAiInstructions.textContent = isHidden ? 'Gizle' : 'G√∂ster';
        });
      }

      const btn = document.getElementById('refresh');
      btn?.addEventListener('click', async () => {
        btn.disabled = true; btn.textContent = 'Refreshing...';
        try {
          const r = await fetch(location.pathname + '/refresh', { method: 'POST' });
          if (!r.ok) throw new Error('refresh failed');
          location.reload();
        } catch (e) { alert('Refresh error'); }
      });
      const aiRetryBtn = document.getElementById('aiRetryBtn');
      aiRetryBtn?.addEventListener('click', async () => {
        if (!confirm('Konu≈ümayƒ± tekrar AI kuyruƒüuna almak istiyor musunuz?')) return;
        aiRetryBtn.disabled = true; const prev = aiRetryBtn.textContent;
        aiRetryBtn.textContent = 'Sƒ±raya alƒ±nƒ±yor...';
        try {
          const r = await fetch(`/ig/inbox/${conversationId}/ai/retry`, { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(js.error || 'retry_failed');
          alert('AI kuyruƒüa eklendi. Birka√ß saniye i√ßinde durum g√ºncellenecek.');
          location.reload();
        } catch (e) {
          alert('AI kuyruƒüuna alma ba≈üarƒ±sƒ±z: ' + (e?.message || e));
        } finally {
          aiRetryBtn.disabled = false;
          aiRetryBtn.textContent = prev;
        }
      });
      // Manual enrich enqueue
      const enrichBtn = document.getElementById('enrichNow');
      enrichBtn?.addEventListener('click', async () => {
        enrichBtn.disabled = true; const prev = enrichBtn.textContent; enrichBtn.textContent = 'Kuyruk kontrol ediliyor...';
        try {
          // Check queue sizes first
          let before = {};
          try {
            const qs = await fetch('/ig/queue/status');
            before = await qs.json();
          } catch {}
          enrichBtn.textContent = 'Kuyruƒüa ekleniyor...';
          const r = await fetch(location.pathname + '/enrich', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          // Get queue sizes after
          let after = {};
          try {
            const qs2 = await fetch('/ig/queue/status');
            after = await qs2.json();
          } catch {}
          alert('Enrich i≈üi eklendi.\n√ñnce: ' + JSON.stringify((before.queues||{})) + '\nSonra: ' + JSON.stringify((after.queues||{})));
          location.reload();
        } catch (e) { alert('Kuyruƒüa ekleme hatasƒ±'); }
        finally { enrichBtn.disabled = false; enrichBtn.textContent = prev; }
      });
      const statusBtn = document.getElementById('statusRefresh');
      statusBtn?.addEventListener('click', () => location.reload());
      const hydrateBtn = document.getElementById('hydrateNow');
      hydrateBtn?.addEventListener('click', async () => {
        hydrateBtn.disabled = true; const prev = hydrateBtn.textContent; hydrateBtn.textContent = 'Kuyruk kontrol ediliyor...';
        try {
          // Check queue sizes first
          let before = {};
          try {
            const qs = await fetch('/ig/queue/status');
            before = await qs.json();
          } catch {}
          hydrateBtn.textContent = 'Kuyruƒüa ekleniyor...';
          const r = await fetch(location.pathname + '/hydrate', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          // Get queue sizes after
          let after = {};
          try {
            const qs2 = await fetch('/ig/queue/status');
            after = await qs2.json();
          } catch {}
          alert('Hydrate kuyruƒüa eklendi: ' + (js.key || '') + '\n√ñnce: ' + JSON.stringify((before.queues||{})) + '\nSonra: ' + JSON.stringify((after.queues||{})));
          location.reload();
        } catch (e) { alert('Hydrate kuyruƒüa ekleme hatasƒ±'); }
        finally { hydrateBtn.disabled = false; hydrateBtn.textContent = prev; }
      });
      // Admin helpers
      const btnMergeGraph = document.getElementById('btnMergeGraph');
      btnMergeGraph?.addEventListener('click', async () => {
        if (!confirm('Bu konu≈ümayƒ± Graph CID\'e ta≈üƒ±?')) return;
        btnMergeGraph.disabled = true; const prev = btnMergeGraph.textContent; btnMergeGraph.textContent = 'Birle≈ütiriliyor...';
        try {
          const r = await fetch(location.pathname + '/merge-to-graph', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Tamamlandƒ±. Graph CID: ' + (js.graph_conversation_id||'') );
          // Redirect to new Graph CID if we were on dm:<id>
          if (js.graph_conversation_id) {
            location.href = '/ig/inbox/' + js.graph_conversation_id;
            return;
          }
          location.reload();
        } catch (e) { alert('Birle≈ütirme hatasƒ±'); }
        finally { btnMergeGraph.disabled = false; btnMergeGraph.textContent = prev; }
      });
      const btnNormalizeDm = document.getElementById('btnNormalizeDm');
      btnNormalizeDm?.addEventListener('click', async () => {
        if (!confirm('Eski mesajlarda dm:<id> conversation_id normalize edilsin mi?')) return;
        btnNormalizeDm.disabled = true; const prev = btnNormalizeDm.textContent; btnNormalizeDm.textContent = 'Normalize ediliyor...';
        try {
          const r = await fetch('/ig/admin/normalize_dm_conversation_ids', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Normalize tamamlandƒ±.\nƒ∞ncelenen: ' + (js.considered||0) + '\nD√ºzeltilen: ' + (js.normalized||0));
          location.reload();
        } catch (e) { alert('Normalize hatasƒ±'); }
        finally { btnNormalizeDm.disabled = false; btnNormalizeDm.textContent = prev; }
      });
      const btnBackfillAi = document.getElementById('btnBackfillAi');
      btnBackfillAi?.addEventListener('click', async () => {
        if (!confirm('ai_conversations son mesaj alanlarƒ± geri doldurulsun mu?')) return;
        btnBackfillAi.disabled = true; const prev = btnBackfillAi.textContent; btnBackfillAi.textContent = 'Geri dolduruluyor...';
        try {
          const r = await fetch('/ig/admin/backfill/ai_latest', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Geri doldurma tamamlandƒ±.\nG√ºncellenen: ' + (js.updated||0) + '\nƒ∞≈ülenen: ' + (js.considered||0));
          location.reload();
        } catch (e) { alert('Geri doldurma hatasƒ±'); }
        finally { btnBackfillAi.disabled = false; btnBackfillAi.textContent = prev; }
      });
      // Live updates via WebSocket: reload when new message arrives for this conversation
      let wsConnected = false;
      const startWS = () => {
        try {
          const proto = location.protocol === 'https:' ? 'wss' : 'ws';
          const ws = new WebSocket(`${proto}://${location.host}/ig/ws`);
          ws.onopen = () => { wsConnected = true; };
          ws.onclose = () => { wsConnected = false; };
          ws.onerror = () => { wsConnected = false; };
          ws.onmessage = (ev) => {
            try {
              const data = JSON.parse(ev.data);
              if (data && data.type === 'ig_message') {
                const matchesPk = typeof data.conversation_pk !== 'undefined' && Number(data.conversation_pk) === Number(conversationId);
                const matchesPublic = publicConversationId && data.conversation_id === publicConversationId;
                if (matchesPk || matchesPublic) {
                  location.reload();
                }
              }
            } catch {}
          };
        } catch { wsConnected = false; }
      };
      startWS();
      // Poll fallback every 15s if sockets fail
      setInterval(async () => {
        if (wsConnected) return;
        try { await fetch(location.pathname + '/refresh', { method: 'POST' }); location.reload(); } catch {}
      }, 15000);

      // Send reply
      const replyForm = document.getElementById('replyForm');
      const replyInput = document.getElementById('replyInput');
      const useShadow = document.getElementById('useShadow');
      const dismissShadow = document.getElementById('dismissShadow');
      const sendDraft = document.getElementById('sendDraft');
      const editDraft = document.getElementById('editDraft');
      const dismissDraft = document.getElementById('dismissDraft');
      useShadow?.addEventListener('click', () => {
        try {
          const txt = {{ (shadow.text if shadow and shadow.text else "") | tojson | safe }};
          if (replyInput && txt) replyInput.value = txt;
        } catch {}
      });
      dismissShadow?.addEventListener('click', async () => {
        try {
          dismissShadow.disabled = true;
          const r = await fetch(location.pathname + '/shadow/dismiss', { method: 'POST' });
          if (!r.ok) throw new Error('dismiss failed');
          location.reload();
        } catch (e) {
          alert('Gizleme hatasƒ±');
        } finally {
          dismissShadow.disabled = false;
        }
      });
      // Inline draft controls
      sendDraft?.addEventListener('click', async () => {
        try {
          sendDraft.disabled = true;
          const text = {{ (shadow.text if shadow and shadow.text else "") | tojson | safe }};
          if (!text) return;
          const r = await fetch(location.pathname + '/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
          if (!r.ok) throw new Error(await r.text());
          await fetch(location.pathname + '/shadow/dismiss', { method: 'POST' }).catch(()=>{});
          location.reload();
        } catch (e) {
          alert('G√∂nderme hatasƒ±');
        } finally {
          sendDraft.disabled = false;
        }
      });
      editDraft?.addEventListener('click', () => {
        try {
          const txt = {{ (shadow.text if shadow and shadow.text else "") | tojson | safe }};
          if (replyInput && txt) { replyInput.value = txt; replyInput.focus(); }
        } catch {}
      });
      dismissDraft?.addEventListener('click', async () => {
        try {
          dismissDraft.disabled = true;
          const r = await fetch(location.pathname + '/shadow/dismiss', { method: 'POST' });
          if (!r.ok) throw new Error('dismiss failed');
          location.reload();
        } catch (e) {
          alert('Silme hatasƒ±');
        } finally {
          dismissDraft.disabled = false;
        }
      });
      replyForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = (replyInput?.value || '').trim();
        if (!text) return;
        try {
          const r = await fetch(location.pathname + '/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
          if (!r.ok) {
            const t = await r.text();
            alert('Send failed: ' + t);
            return;
          }
          input.value = '';
          location.reload();
        } catch (e) {
          alert('Send error');
        }
      });
    </script>
  </body>
</html>

