<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Maliyetler</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      h1 { margin-bottom: 12px; }
      .toolbar { display:flex; gap:12px; align-items:flex-end; margin:14px 0; flex-wrap:wrap; }
      .btn { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer }
      input[type=date], input[type=text], input[type=number], select { padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
      th { background: #fafafa; position: sticky; top: 0; }
      .grid { display:grid; grid-template-columns: 1fr; gap:18px; }
      @media (min-width: 1100px) { .grid { grid-template-columns: 1fr 1fr; } }
      .card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background:#fff; }
      .card h2 { margin: 0; padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
      .card .body { padding: 12px 16px; }
      .row { display:flex; gap:12px; flex-wrap:wrap; }
      .field { display:block; }
      .field label { display:block; font-size:12px; color:#374151; margin-bottom:4px; }
      .muted { color:#6b7280; font-size:12px; }
      input[type="checkbox"] { margin: 0; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <h1>Maliyetler</h1>

    <form class="toolbar" method="get" action="/costs">
      <div>
        <label style="display:block;font-size:12px;color:#374151">Başlangıç</label>
        <input type="date" name="start" value="{{ start }}" />
      </div>
      <div>
        <label style="display:block;font-size:12px;color:#374151">Bitiş</label>
        <input type="date" name="end" value="{{ end }}" />
      </div>
      <div>
        <button class="btn" type="submit">Uygula</button>
      </div>
    </form>

    <div class="grid">
      <div class="card">
        <h2>Yeni Maliyet Ekle</h2>
        <div class="body">
          <form method="post" action="/costs/add" class="row">
            <div class="field">
              <label>Tür</label>
              <select name="type_id" required>
                {% for t in types %}
                  <option value="{{ t.id }}">{{ t.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="field">
              <label>Tutar</label>
              <input type="number" step="0.01" name="amount" required />
            </div>
            <div class="field">
              <label>Tarih</label>
              <input type="date" name="date" value="{{ today }}" />
            </div>
            <div class="field">
              <label>Cari (Opsiyonel)</label>
              <select name="supplier_id" id="supplier_id">
                <option value="">Cari seçilmedi</option>
                {% if general_supplier %}
                  <option value="{{ general_supplier.id }}" selected>Genel Giderler</option>
                {% endif %}
                {% for sup in suppliers %}
                  {% if not general_supplier or sup.id != general_supplier.id %}
                    <option value="{{ sup.id }}">{{ sup.name }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="field" id="product_field" style="display:none;">
              <label>Ürün <span style="color:red;">*</span></label>
              <select name="product_id" id="product_id">
                <option value="">Ürün seçin</option>
                {% for prod in products %}
                  <option value="{{ prod.id }}">{{ prod.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="field" id="quantity_field" style="display:none;">
              <label>Adet <span style="color:red;">*</span></label>
              <input type="number" name="quantity" id="quantity" min="1" step="1" />
            </div>
            <div class="field">
              <label>Hesap (Opsiyonel)</label>
              <select name="account_id">
                <option value="">Hesap seçilmedi</option>
                {% for acc in accounts %}
                  <option value="{{ acc.id }}">{{ acc.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="field" style="min-width:280px; flex:1">
              <label>Detay</label>
              <input type="text" name="details" placeholder="örn. Kampanya X reklamları" />
            </div>
            {% if start %}<input type="hidden" name="start" value="{{ start }}"/>{% endif %}
            {% if end %}<input type="hidden" name="end" value="{{ end }}"/>{% endif %}
            <div style="align-self:flex-end">
              <button class="btn" type="submit">Kaydet</button>
            </div>
          </form>
          <div class="muted" style="margin-top:8px;">Tarih boş bırakılırsa bugün kabul edilir.</div>
        </div>
      </div>

      <div class="card">
        <h2>Maliyet Türü Ekle</h2>
        <div class="body">
          <form method="post" action="/costs/add-type" class="row">
            <div class="field">
              <label>Tür Adı</label>
              <input type="text" name="name" placeholder="örn. Reklam, Kira, Diğer" required />
            </div>
            {% if start %}<input type="hidden" name="start" value="{{ start }}"/>{% endif %}
            {% if end %}<input type="hidden" name="end" value="{{ end }}"/>{% endif %}
            <div style="align-self:flex-end">
              <button class="btn" type="submit">Ekle</button>
            </div>
          </form>
          <div class="muted" style="margin-top:8px;">Liste seçeneğine anında eklenir.</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <h2>Geçmiş Maliyetler</h2>
      <div class="body" style="padding:0">
        <div style="padding:12px 16px; border-bottom:1px solid #e5e7eb; background:#f8fafc;">
          <form method="post" action="/costs/delete" id="bulkDeleteForm" style="display:inline;">
            {% if start %}<input type="hidden" name="start" value="{{ start }}"/>{% endif %}
            {% if end %}<input type="hidden" name="end" value="{{ end }}"/>{% endif %}
            <button type="button" onclick="selectAll()" class="btn" style="background:#6b7280; margin-right:8px;">Tümünü Seç</button>
            <button type="button" onclick="deselectAll()" class="btn" style="background:#6b7280; margin-right:8px;">Seçimi Temizle</button>
            <button type="submit" class="btn" style="background:#dc2626;" onclick="return confirmDelete()">Seçilenleri Sil</button>
          </form>
          <div style="margin-top:8px; font-weight:600;">
            Toplam: {{ '%.2f'|format(total_amount) }} ₺ ({{ rows|length }} kayıt)
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:40px;"><input type="checkbox" onclick="toggleAll(this)"></th>
              <th>Tarih</th>
              <th>Tür</th>
              <th>Tutar</th>
              <th>Cari</th>
              <th>Hesap</th>
              <th>Detay</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              <td><input type="checkbox" name="cost_ids" value="{{ r.id }}" form="bulkDeleteForm"></td>
              <td>{{ r.date }}</td>
              <td>{{ type_map.get(r.type_id) or r.type_id }}</td>
              <td>{{ '%.2f'|format(r.amount or 0) }} ₺</td>
              <td>
                {% if r.supplier_id %}
                  {{ supplier_map.get(r.supplier_id, '-') }}
                  {% if r.is_payment_to_supplier %}
                    <span style="color:#10b981; font-size:11px;">(Ödeme)</span>
                  {% endif %}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ account_map.get(r.account_id, '-') if r.account_id else '-' }}</td>
              <td>
                {{ r.details or '' }}
                {% if r.type_id == 9 and r.product_id and r.quantity %}
                  <br/><span style="color:#6b7280; font-size:12px;">
                    {{ product_map.get(r.product_id, 'Ürün') }} × {{ r.quantity }} adet
                  </span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <script>
      function toggleAll(source) {
        const checkboxes = document.querySelectorAll('input[name="cost_ids"]');
        checkboxes.forEach(cb => cb.checked = source.checked);
      }

      function selectAll() {
        const checkboxes = document.querySelectorAll('input[name="cost_ids"]');
        checkboxes.forEach(cb => cb.checked = true);
        document.querySelector('thead input[type="checkbox"]').checked = true;
      }

      function deselectAll() {
        const checkboxes = document.querySelectorAll('input[name="cost_ids"]');
        checkboxes.forEach(cb => cb.checked = false);
        document.querySelector('thead input[type="checkbox"]').checked = false;
      }

      function confirmDelete() {
        const selected = document.querySelectorAll('input[name="cost_ids"]:checked');
        if (selected.length === 0) {
          alert('Lütfen en az bir maliyet seçin.');
          return false;
        }
        return confirm(selected.length + ' adet maliyeti silmek istediğinizden emin misiniz?');
      }

      // Handle MERTER MAL ALIM (type_id=9) form changes
      document.addEventListener('DOMContentLoaded', function() {
        const typeSelect = document.querySelector('select[name="type_id"]');
        const supplierSelect = document.getElementById('supplier_id');
        const productField = document.getElementById('product_field');
        const quantityField = document.getElementById('quantity_field');
        const productSelect = document.getElementById('product_id');
        const quantityInput = document.getElementById('quantity');
        const form = document.querySelector('form[action="/costs/add"]');

        function updateFormFields() {
          const selectedTypeId = parseInt(typeSelect.value);
          const isMerterMalAlim = selectedTypeId === 9;

          if (isMerterMalAlim) {
            // Show product and quantity fields
            productField.style.display = 'block';
            quantityField.style.display = 'block';
            // Make supplier required
            supplierSelect.required = true;
            productSelect.required = true;
            quantityInput.required = true;
          } else {
            // Hide product and quantity fields
            productField.style.display = 'none';
            quantityField.style.display = 'none';
            // Make supplier optional
            supplierSelect.required = false;
            productSelect.required = false;
            quantityInput.required = false;
            // Clear values
            productSelect.value = '';
            quantityInput.value = '';
          }
        }

        typeSelect.addEventListener('change', updateFormFields);
        updateFormFields(); // Initial check

        // Form validation
        form.addEventListener('submit', function(e) {
          const selectedTypeId = parseInt(typeSelect.value);
          if (selectedTypeId === 9) {
            if (!supplierSelect.value) {
              e.preventDefault();
              alert('MERTER MAL ALIM için cari seçimi zorunludur.');
              return false;
            }
            if (!productSelect.value) {
              e.preventDefault();
              alert('MERTER MAL ALIM için ürün seçimi zorunludur.');
              return false;
            }
            if (!quantityInput.value || parseInt(quantityInput.value) <= 0) {
              e.preventDefault();
              alert('MERTER MAL ALIM için adet bilgisi zorunludur ve 0\'dan büyük olmalıdır.');
              return false;
            }
          }
        });
      });
    </script>
  </body>
</html>


