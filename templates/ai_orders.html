<!doctype html>
<html lang="tr">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>{{ t(request, 'ai_orders.title') }}</title>
	<style>
		:root {
			--bg: #f5f6fb;
			--card: #ffffff;
			--border: #e5e7eb;
			--muted: #6b7280;
			--primary: #2563eb;
			--success: #15803d;
			--warn: #b45309;
			--danger: #b91c1c;
		}
		body { margin:0; font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color:#0f172a; }
		.container { max-width: 1200px; margin: 0 auto; padding: 24px 16px 40px; }
		.card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 1px 3px rgba(15,23,42,0.08); }
		h1 { font-size: 26px; margin: 18px 0 12px; }
		p.page-desc { color: var(--muted); margin: 0 0 24px; font-size: 14px; }
		.summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
		.summary-card { padding: 14px 16px; border: 1px solid var(--border); border-radius: 12px; background:#fff; }
		.summary-card h3 { margin: 0 0 6px; font-size: 13px; color:#475569; font-weight:500; }
		.summary-card strong { font-size: 24px; }
		.filter-bar { display:flex; flex-wrap:wrap; gap:12px; padding: 16px; margin-bottom: 20px; }
		.filter-bar input, .filter-bar select { border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px; }
		.filter-bar input[type="search"] { flex:1 1 220px; }
		.filter-bar button { border:none; background: var(--primary); color:#fff; padding:10px 18px; border-radius:10px; cursor:pointer; font-weight:600; }
		.filter-bar a.reset { align-self:center; color: var(--muted); font-size: 14px; text-decoration:none; }
		table { width:100%; border-collapse: collapse; }
		th { text-align:left; font-size:12px; text-transform:uppercase; letter-spacing:0.05em; color:#94a3b8; padding:10px; border-bottom:1px solid var(--border); background:#f8fafc; }
		td { padding:14px 10px; border-bottom:1px solid var(--border); vertical-align:top; font-size:14px; }
		td .meta { font-size:12px; color: var(--muted); margin-top:6px; }
		.badge { display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:4px 10px; font-size:12px; font-weight:600; text-transform: capitalize; }
		.badge.interested { background:#eef2ff; color:#4338ca; }
		.badge.very-interested { background:#dcfce7; color: var(--success); }
		.badge.not-interested { background:#fee2e2; color: var(--danger); }
		.badge.placed { background:#fef9c3; color: var(--warn); }
		.status-history { margin-top:8px; font-size:12px; color:#475569; }
		.status-history span { display:inline-block; margin-right:8px; padding:2px 6px; border-radius:6px; background:#f1f5f9; }
		.product-block strong { display:block; }
		.actions a { color: var(--primary); text-decoration:none; font-weight:600; }
		.empty { text-align:center; padding:48px 16px; color: var(--muted); font-size:15px; }
		@media (max-width: 720px){
			.filter-bar { flex-direction:column; }
			th, td { font-size:13px; }
		}
	</style>
</head>
<body>
	<div class="container">
		{% include "_nav.html" %}
		<h1>{{ t(request, 'ai_orders.heading') }}</h1>
		<p class="page-desc">{{ t(request, 'ai_orders.subtitle') }}</p>

		<div class="summary-grid">
			{% for status in available_statuses %}
				{% set count = status_counts.get(status, 0) %}
				<div class="summary-card">
					<h3>{{ status.replace('-', ' ').title() }}</h3>
					<strong>{{ count }}</strong>
				</div>
			{% endfor %}
			<div class="summary-card">
				<h3>{{ t(request, 'ai_orders.total_visible') }}</h3>
				<strong>{{ orders|length }}</strong>
			</div>
		</div>

		<form method="get" class="card filter-bar">
			<input type="search" name="q" placeholder="{{ t(request, 'ai_orders.search_placeholder') }}" value="{{ query }}" />
			<input type="date" name="start" placeholder="Başlangıç" value="{{ start_date }}" style="flex: 0 0 140px;" />
			<input type="date" name="end" placeholder="Bitiş" value="{{ end_date }}" style="flex: 0 0 140px;" />
			<select name="status">
				<option value="">{{ t(request, 'ai_orders.filter_all_statuses') }}</option>
				{% for status in available_statuses %}
					<option value="{{ status }}" {{ 'selected' if status == filter_status else '' }}>
						{{ status.replace('-', ' ').title() }}
					</option>
				{% endfor %}
			</select>
			<button type="submit">{{ t(request, 'ai_orders.apply_filters') }}</button>
			<a class="reset" href="/ai/orders">{{ t(request, 'ai_orders.reset_filters') }}</a>
		</form>

		<div class="card">
			{% if orders %}
			<table>
				<thead>
					<tr>
						<th>ID</th>
						<th>{{ t(request, 'ai_orders.th_status') }}</th>
						<th>{{ t(request, 'ai_orders.th_customer') }}</th>
						<th>{{ t(request, 'ai_orders.th_product') }}</th>
						<th>{{ t(request, 'ai_orders.th_address') }}</th>
						<th>{{ t(request, 'ai_orders.th_notes') }}</th>
						<th>{{ t(request, 'ai_orders.th_updated') }}</th>
						<th></th>
					</tr>
				</thead>
				<tbody>
					{% for order in orders %}
					{% set payload = order.order_payload or {} %}
					{% set product = payload.get('product', {}) %}
					{% set customer = payload.get('customer', {}) %}
					<tr>
						<td>
							<strong>#{{ order.id }}</strong>
							<div class="meta">DM: {{ order.conversation_id }}</div>
						</td>
						<td>
							<span class="badge {{ order.status }}">{{ order.status.replace('-', ' ') }}</span>
							{% if order.status_reason %}
								<div class="meta">{{ order.status_reason }}</div>
							{% endif %}
							{% if order.status_history %}
								<div class="status-history">
									{% for ev in order.status_history %}
										<span>{{ ev.get('status') }} · {{ ev.get('ts')[:16] if ev.get('ts') else '' }}</span>
									{% endfor %}
								</div>
							{% endif %}
						</td>
						<td>
							<div><strong>{{ customer.get('name') or order.contact_name or '-' }}</strong></div>
							<div class="meta">
								{% if order.username %}@{{ order.username }} · {% endif %}
								{{ customer.get('phone') or order.contact_phone or '-' }}
							</div>
						</td>
						<td class="product-block">
							<strong>{{ product.get('name') or '-' }}</strong>
							<div class="meta">
								{% if product.get('size') %}{{ product.get('size') }} · {% endif %}
								{% if product.get('color') %}{{ product.get('color') }} · {% endif %}
								{{ t(request, 'ai_orders.quantity_label') }} {{ product.get('quantity', 1) }}
							</div>
							{% if payload.get('measurements') %}
								<div class="meta">
									{{ t(request, 'ai_orders.measurements') }}:
									{% if payload.measurements.height_cm %}{{ payload.measurements.height_cm }}cm{% endif %}
									{% if payload.measurements.weight_kg %} / {{ payload.measurements.weight_kg }}kg{% endif %}
								</div>
							{% endif %}
						</td>
						<td>
							{% if customer.get('address') %}
								{{ customer.get('address') }}{% if customer.get('city') %}, {{ customer.get('city') }}{% endif %}
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							{% if payload.get('notes') %}
								{{ payload.get('notes') }}
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							<div>{{ order.last_status_at or '-' }}</div>
							{% if order.placed_at %}
								<div class="meta">{{ t(request, 'ai_orders.placed_at') }} {{ order.placed_at }}</div>
							{% endif %}
						</td>
						<td class="actions">
							<a href="{{ order.conversation_link }}" target="_blank">{{ t(request, 'ai_orders.view_conversation') }} →</a>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			{% else %}
				<div class="empty">{{ t(request, 'ai_orders.empty_state') }}</div>
			{% endif %}
		</div>
	</div>
</body>
</html>

