<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Conversation {{ conversation_id }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .toolbar { display:flex; gap:8px; margin-bottom:12px; }
      .msg { margin:8px 0; display:flex; }
      .bubble { max-width: 70%; padding:10px 12px; border-radius:12px; }
      .in .bubble { background:#f3f4f6; margin-right:auto; }
      .out .bubble { background:#dbeafe; margin-left:auto; }
      .meta { color:#6b7280; font-size:12px; margin-top:4px; }
      button { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
      a { color:#2563eb; text-decoration:none; }
      .toolbar .action { border:1px solid #2563eb; border-radius:6px; padding:6px 10px; font-size:13px; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <div class="toolbar">
      <a href="/ig/inbox">← Back to Inbox</a>
      <a class="action" href="/ig/inbox/{{ conversation_id }}/debug" title="AI Debug">AI Debug</a>
      <button id="refresh">Refresh</button>
    </div>
  <div style="margin-top:18px">
    <h3>AI Çıktısı</h3>
    {% if ai_status %}<div class="meta">Durum: {{ ai_status }}</div>{% endif %}
    <pre id="aiBox" style="background:#0b1021;color:#e5e7eb; padding:12px; border-radius:8px; max-height:300px; overflow:auto; white-space:pre-wrap;">{{ ai_json or 'Henüz AI verisi yok.' }}</pre>
    <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
      <h4 style="margin:0 0 8px 0; color:#111827;">Zenginleştirme Durumu</h4>
      {% if enrich %}
        <div class="meta">Kullanıcı: {{ enrich.username or '-' }} {% if enrich.name %} ({{ enrich.name }}){% endif %}</div>
        <div class="meta">Durum: {{ enrich.fetch_status or 'bilinmiyor' }} {% if enrich.fetched_at %}· fetched_at: {{ enrich.fetched_at }}{% endif %}</div>
        {% if enrich.fetch_error %}<div class="meta">Hata: {{ enrich.fetch_error }}</div>{% endif %}
        <div class="meta">Kuyruk (enrich_user) uzunluğu: {{ enrich.queue_depth if enrich.queue_depth is not none else '-' }}</div>
        {% if enrich.job and enrich.job.id %}
          <div class="meta">Bekleyen iş: #{{ enrich.job.id }} · attempts={{ enrich.job.attempts or 0 }} {% if enrich.job.run_after %}· run_after={{ enrich.job.run_after }}{% endif %}</div>
        {% else %}
          <div class="meta">Bekleyen enrich_user işi yok.</div>
        {% endif %}
      {% else %}
        <div class="meta">Zenginleştirme bilgisi mevcut değil.</div>
      {% endif %}
    </div>
    {% if contact_name or contact_phone or contact_address or linked_order_id %}
      <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
        <h4 style="margin:0 0 8px 0; color:#111827;">Çıkarılan Bilgiler</h4>
        <ul style="list-style:none; padding:0; margin:0; color:#374151; font-size:13px; display:grid; gap:6px;">
          {% if contact_name %}<li><strong>Ad:</strong> {{ contact_name }}</li>{% endif %}
          {% if contact_phone %}<li><strong>Telefon:</strong> <a href="tel:{{ contact_phone }}" style="color:#2563eb;">{{ contact_phone }}</a></li>{% endif %}
          {% if contact_address %}<li><strong>Adres:</strong> {{ contact_address }}</li>{% endif %}
          {% if linked_order_id %}<li><strong>Bağlı Sipariş:</strong> <a href="/orders/{{ linked_order_id }}/edit" style="color:#2563eb;">#{{ linked_order_id }}</a></li>{% endif %}
        </ul>
      </div>
    {% endif %}
  </div>
    <h2>
      Conversation {{ other_label or conversation_id }}
      {% if other_label %}<a class="meta" target="_blank" rel="noopener" href="https://instagram.com/{{ other_label[1:] }}">profile ↗</a>{% endif %}
      {% if contact_name or contact_phone or contact_address %}
        <div class="meta">{{ contact_name or '' }}{% if contact_name and contact_phone %} · {% endif %}{{ contact_phone or '' }}{% if (contact_name or contact_phone) and contact_address %} · {% endif %}{{ contact_address or '' }}</div>
      {% endif %}
    </h2>
    <div id="thread">
      {% for m in messages %}
        <div class="msg {{ m.direction or 'in' }}">
          <div class="bubble">
            <div>
              {% set u_map = usernames if usernames is defined else {} %}
              {% set uname = m.sender_username or (u_map.get(m.ig_sender_id or '')) %}
              {% if uname %}
                <span class="meta">@{{ uname }}</span><br/>
              {% elif m.ig_sender_id %}
                <span class="meta">id: {{ m.ig_sender_id }}</span><br/>
              {% endif %}
              {{ m.text or '' }}
            </div>
            {% set local_ids = att_ids_map.get(m.ig_message_id or '') %}
            {% if local_ids %}
              {% for aid in local_ids %}
                <div style="margin-top:8px">
                  <img src="/ig/media/local/{{ aid }}" alt="attachment" style="max-width:280px;border-radius:8px;border:1px solid #e5e7eb" />
                </div>
              {% endfor %}
            {% elif att_map.get(m.ig_message_id) %}
              {% for idx in att_map.get(m.ig_message_id) %}
                <div style="margin-top:8px">
                  <img src="/ig/media/{{ m.ig_message_id }}/{{ idx }}" alt="attachment" style="max-width:280px;border-radius:8px;border:1px solid #e5e7eb" />
                </div>
              {% endfor %}
            {% endif %}
            <div class="meta"><span class="ts" data-ts="{{ m.timestamp_ms or '' }}">{{ m.timestamp_ms }}</span>
              {% if m.ad_id or m.ad_link or m.ad_title %}
                · Replied to an ad{% if m.ad_title or m.ad_id %}: {{ m.ad_title or m.ad_id }}{% endif %}
                {% if m.ad_link %}
                  (<a target="_blank" rel="noopener" href="{{ m.ad_link }}">link</a>)
                {% else %}
                  · Ads Manager
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
      {% if not messages %}
        <div class="meta">No messages cached yet.</div>
      {% endif %}
    </div>
    <div style="margin-top:16px">
      <form id="replyForm" style="display:flex;gap:8px">
        <input id="replyInput" type="text" placeholder="Type a reply..." style="flex:1;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px" />
        <button id="sendBtn" type="submit" style="background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer">Send</button>
      </form>
    </div>
    <script>
      function fmtTs(){
        const nodes = document.querySelectorAll('.ts');
        for(const el of nodes){
          const v = el.getAttribute('data-ts');
          const ms = Number(v||0);
          if(ms>0){ const d = new Date(ms); el.textContent = d.toLocaleString(); }
          else { el.textContent = '-'; }
        }
      }
      fmtTs();

      const btn = document.getElementById('refresh');
      btn?.addEventListener('click', async () => {
        btn.disabled = true; btn.textContent = 'Refreshing...';
        try {
          const r = await fetch(location.pathname + '/refresh', { method: 'POST' });
          if (!r.ok) throw new Error('refresh failed');
          location.reload();
        } catch (e) { alert('Refresh error'); }
      });
      // Live updates via WebSocket: reload when new message arrives for this conversation
      let wsConnected = false;
      const startWS = () => {
        try {
          const proto = location.protocol === 'https:' ? 'wss' : 'ws';
          const ws = new WebSocket(`${proto}://${location.host}/ig/ws`);
          ws.onopen = () => { wsConnected = true; };
          ws.onclose = () => { wsConnected = false; };
          ws.onerror = () => { wsConnected = false; };
          ws.onmessage = (ev) => {
            try {
              const data = JSON.parse(ev.data);
              if (data && data.type === 'ig_message' && data.conversation_id === 'dm:{{ conversation_id }}') {
                location.reload();
              }
            } catch {}
          };
        } catch { wsConnected = false; }
      };
      startWS();
      // Poll fallback every 15s if sockets fail
      setInterval(async () => {
        if (wsConnected) return;
        try { await fetch(location.pathname + '/refresh', { method: 'POST' }); location.reload(); } catch {}
      }, 15000);

      // Send reply
      const form = document.getElementById('replyForm');
      const input = document.getElementById('replyInput');
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = (input?.value || '').trim();
        if (!text) return;
        try {
          const r = await fetch(location.pathname + '/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
          if (!r.ok) {
            const t = await r.text();
            alert('Send failed: ' + t);
            return;
          }
          input.value = '';
          location.reload();
        } catch (e) {
          alert('Send error');
        }
      });
    </script>
  </body>
</html>

