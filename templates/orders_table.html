<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Siparisler</title>
    <style>
        :root {
            --bg: #f7f7fb;
            --card: #ffffff;
            --border: #e5e7eb;
            --muted: #6b7280;
            --primary: #2563eb;
            --primary-100: #eef2ff;
            --success-bg: #eaffea;
            --warn-bg: #fff9db;
            --danger-bg: #ffe5e5;
            --switch-bg: #ede0d4;
        }
        html, body { background: var(--bg); }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
        .container { max-width: 100%; width: 100%; margin: 16px auto; padding: 0 16px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
        .toolbar { margin: 12px 0 16px; padding: 12px; display: flex; flex-wrap: wrap; gap: 10px 12px; align-items: center; background: var(--card); border: 1px solid var(--border); border-radius: 10px; }
        .toolbar input[type="search"] { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; min-width: 220px; flex: 1 1 280px; }
        .toolbar select, .toolbar input[type="date"] { padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; }
        .filters-form { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .pill { font-size: 12px; padding: 4px 10px; background: var(--primary-100); color: #4338ca; border-radius: 999px; }
        .link-muted { color: var(--muted); text-decoration: none; font-size: 12px; }
        a { color: var(--primary); text-decoration: none; }
        .btn { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 12px; }
        .btn:hover { background: #f8fafc; }
        .btn.primary { background: var(--primary); border-color: var(--primary); color: #fff; }
        .btn.warn { border-color:#ef4444; color:#b91c1c; }
        .btn.accent { border-color:#92400e; color:#92400e; }
        .table-wrap { }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; white-space: nowrap; }
        /* Allow wrapping only for the product (Urun) column */
        td.product { white-space: normal; word-break: break-word; overflow-wrap: anywhere; }
        /* Inline modal for editing total + IBAN */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index: 50; }
        .modal { background: var(--card); border:1px solid var(--border); border-radius: 12px; width: min(92vw, 520px); padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .modal h3 { margin: 0 0 12px; }
        .modal .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .modal label { display:block; font-size:12px; color:#6b7280; margin-bottom: 4px; }
        .modal input[type="number"], .modal input[type="text"] { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; }
        .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top: 8px; }
        .form-inline { display:flex; align-items:center; gap:8px; padding: 8px 10px; border:1px solid var(--border); border-radius:8px; }
        .err { color:#b91c1c; font-size:12px; min-height: 16px; }
        /* Slightly smaller font for client and product */
        td.client, td.product { font-size: 12px; }
        /* Constrain tracking and client columns */
        th.tracking, td.tracking { max-width: 120px; }
        th.tracking, td.tracking { font-size: 11px; }
        th.client, td.client { max-width: 220px; }
        td.tracking, td.client { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* Compact action icons */
        .icon-actions { display:flex; gap:6px; }
        .icon-btn { width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; }
        .icon-btn.warn { color:#b91c1c; border-color:#ef4444; }
        .icon-btn.accent { color:#92400e; border-color:#92400e; }
        .icon-btn:hover { background:#f8fafc; }
        .icon-btn svg { width:16px; height:16px; }
        th { background: #fafafa; position: sticky; top: 0; cursor: pointer; user-select: none; z-index: 1; }
        
        
        tr.paid { background: var(--success-bg); }
        tr.unpaid { background: var(--warn-bg); }
        tr.refunded { color: #b91c1c; background: var(--danger-bg); }
        tr.switched { color: #92400e; background: var(--switch-bg); }
        tr.cancelled { color: #6b7280; background: #f3f4f6; text-decoration: line-through; }
        tr.partial_paid { background: #fff4e6; }
        tr.merged { opacity: 0.7; }
        
        @media (max-width: 768px){
            th, td { font-size: 13px; padding: 8px 10px; }
            .toolbar { padding: 10px; }
            .toolbar input[type="search"] { flex-basis: 100%; }
        }
    </style>
    <script>
        function filterTable(table, q){
            const rows = table.tBodies[0].rows; const s = q.trim().toLowerCase();
            for (const r of rows){ const txt = r.textContent.toLowerCase(); r.style.display = s && txt.indexOf(s) === -1 ? 'none' : ''; }
        }
        function cmp(a,b,isNum){ if (isNum){ const na=parseFloat(a)||0, nb=parseFloat(b)||0; return na-nb; } return a.localeCompare(b,'tr'); }
        function sortTable(table, idx, dir){
            const rows = Array.from(table.tBodies[0].rows);
            const isNum = table.tHead.rows[0].cells[idx].dataset.type === 'num';
            rows.sort((r1,r2)=>{
                const a=r1.cells[idx].dataset.sort || r1.cells[idx].textContent.trim();
                const b=r2.cells[idx].dataset.sort || r2.cells[idx].textContent.trim();
                return dir==='asc'?cmp(a,b,isNum):cmp(b,a,isNum);
            });
            for(const r of rows) table.tBodies[0].appendChild(r);
        }
        function attach(table){ const ths=table.tHead.rows[0].cells; let active=-1, dir='asc'; for(let i=0;i<ths.length;i++){ ths[i].addEventListener('click',()=>{ dir=(active===i&&dir==='asc')?'desc':'asc'; active=i; sortTable(table,i,dir); }); } }
        function init(){ const table=document.getElementById('ordersTbl'); attach(table); const si=document.getElementById('search'); si.addEventListener('input',()=>filterTable(table, si.value)); }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</head>
<body>
    <div class="container">
    {% include "_nav.html" %}
    <div class="toolbar card">
        <input id="search" type="search" placeholder="Siparis ara (musteri, urun, takip)" />
        <form method="get" action="/orders/table" class="filters-form">
            <select name="date_field">
                <option value="shipment" {{ 'selected' if (date_field == 'shipment') else '' }}>Kargo Tarihi</option>
                <option value="data" {{ 'selected' if (date_field == 'data') else '' }}>Data Tarihi</option>
                <option value="both" {{ 'selected' if (date_field == 'both') else '' }}>Birlesik</option>
            </select>
            <input type="date" name="start" value="{{ start }}" />
            <input type="date" name="end" value="{{ end }}" />
            <select name="source">
                <option value="" {{ 'selected' if not source else '' }}>Tum Kanallar</option>
                <option value="bizim" {{ 'selected' if source == 'bizim' else '' }}>bizim</option>
                <option value="kargo" {{ 'selected' if source == 'kargo' else '' }}>kargo</option>
            </select>
            <select name="status">
                <option value="" {{ 'selected' if not status else '' }}>Tum Durumlar</option>
                <option value="paid" {{ 'selected' if status == 'paid' else '' }}>Yesil (Odendi)</option>
                <option value="unpaid" {{ 'selected' if status == 'unpaid' else '' }}>Sari (Odenmedi)</option>
                <option value="partial_paid" {{ 'selected' if status == 'partial_paid' else '' }}>Turuncu (KÄ±smi Ã–deme)</option>
                <option value="cancelled" {{ 'selected' if status == 'cancelled' else '' }}>Gri (Ä°ptal Edildi)</option>
                <option value="refunded" {{ 'selected' if status == 'refunded' else '' }}>Kirmizi (Iade)</option>
                <option value="switched" {{ 'selected' if status == 'switched' else '' }}>Kahverengi (Degisim)</option>
            </select>
            <select name="ig_linked">
                <option value="" {{ 'selected' if not ig_linked else '' }}>IG: Hepsi</option>
                <option value="linked" {{ 'selected' if ig_linked == 'linked' else '' }}>IG BaÄŸlÄ±</option>
                <option value="unlinked" {{ 'selected' if ig_linked == 'unlinked' else '' }}>IG BaÄŸsÄ±z</option>
            </select>
            <button class="btn" type="submit">Filtrele</button>
            <a class="link-muted" href="/orders/table">Temizle</a>
        </form>
        <span class="pill">{{ rows|length }} siparis</span>
        <button class="btn primary" onclick="recalc()">Tazele</button>
        <button class="btn" onclick="presetOverdue7()">7 gÃ¼n+ Ã¶deme yok</button>
        <button class="btn" onclick="presetHighCost70()">Maliyet â‰¥ %70</button>
        <button class="btn" onclick="presetAll()">TÃ¼m sipariÅŸler</button>
        <button class="btn" onclick="exportExcel()">Excel'e aktar</button>
        <a class="btn" href="/orders/duplicates">Potansiyel Ã‡iftler</a>
        <a class="btn" href="/orders/partial-payments">KÄ±smi Ã–demeler</a>
    </div>
    <h2>Siparisler</h2>
    <table id="ordersTbl">
        <thead>
            <tr><th>ID</th><th class="tracking">Takip</th><th class="client">Musteri</th><th>Urun</th><th>Adet</th><th>Toplam</th><th>Maliyet</th><th>Kargo</th><th>Kargo FirmasÄ±</th><th>Kargo Tarihi</th><th>Data Tarihi</th><th>I/D Tarihi</th><th>Kanali</th><th>IG DM</th><th>Durum</th><th></th></tr>
            <tr>
                <th colspan="4" style="text-align:right">Toplamlar:</th>
                <th data-type="num">{{ sum_qty }}</th>
                <th data-type="num">{{ '%.2f'|format(sum_total or 0) }}</th>
                <th data-type="num">{{ '%.2f'|format(sum_cost or 0) }}</th>
                <th data-type="num">{{ '%.2f'|format(sum_shipping or 0) }}</th>
                <th colspan="7"></th>
            </tr>
        </thead>
        <tbody>
            {% for o in rows %}
            {% set rowcls = status_map.get(o.id) if status_map else '' %}
            {% if o.merged_into_order_id %}
                {% set rowcls = rowcls + ' merged' if rowcls else 'merged' %}
            {% endif %}
            <tr class="{{ rowcls }}">
                <td>
                    <a href="/orders/{{ o.id }}/edit" title="DÃ¼zenle #{{ o.id }}">{{ o.id }}</a>
                    {% if o.merged_into_order_id %}
                        <span style="color: #92400e; font-size: 10px;" title="BirleÅŸtirilmiÅŸ sipariÅŸ">ðŸ”—</span>
                    {% endif %}
                    {% if o.is_partial_payment %}
                        <span style="color: #ea580c; font-size: 10px;" title="KÄ±smi Ã¶deme">ðŸ’°</span>
                    {% endif %}
                </td>
                <td class="tracking" data-sort="{{ o.tracking_no or '' }}">
                    {% if o.tracking_no %}
                        <span title="{{ o.tracking_no }}">{{ (o.tracking_no or '')[:6] }}</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="client">
                    {% set cname = client_map.get(o.client_id) if client_map else o.client_id %}
                    <a href="/clients/{{ o.client_id }}">{{ (cname or '')[:40] }}</a>
                </td>
                <td class="product">{{ o.notes or '' }}</td>
                <td>{{ o.quantity }}</td>
                <td>
                    <span id="tot-{{ o.id }}">{{ o.total_amount }}</span>
                    <button class="btn" onclick="editTotal({{ o.id }}, '{{ '%.2f'|format(o.total_amount or 0) }}', {{ 'true' if (o.paid_by_bank_transfer or False) else 'false' }}, '{{ o.shipping_company or '' }}')">DÃ¼zenle</button>
                </td>
                <td>{{ (cost_map.get(o.id) if cost_map else o.total_cost) }}</td>
                <td>{{ '%.2f'|format((shipping_map.get(o.id, 0.0) if shipping_map else 0.0)) }}</td>
                <td>
                    {% if o.shipping_company %}
                        {% if o.shipping_company == 'surat' %}SÃ¼rat
                        {% elif o.shipping_company == 'mng' %}MNG
                        {% elif o.shipping_company == 'dhl' %}DHL
                        {% elif o.shipping_company == 'ptt' %}PTT
                        {% else %}{{ o.shipping_company }}
                        {% endif %}
                    {% else %}
                        <span style="color: #9ca3af;">SÃ¼rat</span>
                    {% endif %}
                </td>
                <td>{{ o.shipment_date }}</td>
                <td>{{ o.data_date }}</td>
                <td>{{ o.return_or_switch_date }}</td>
                <td>{{ o.source }}</td>
                <td>
                    {% if o.ig_conversation_id %}
                        <a class="icon-btn" title="IG KonuÅŸma" aria-label="IG KonuÅŸma" href="/ig/inbox/{{ o.ig_conversation_id }}">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v6a5 5 0 0 1-5 5h-3l-4 4v-4H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5z"></path></svg>
                        </a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if o.merged_into_order_id %}
                        <a href="/orders/{{ o.merged_into_order_id }}/edit" style="color: #92400e; font-size: 11px;">â†’#{{ o.merged_into_order_id }}</a>
                    {% elif o.partial_payment_group_id and o.partial_payment_group_id == o.id %}
                        <span style="color: #ea580c; font-size: 11px;">KÄ±smi Ã–deme</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <div class="icon-actions">
                        <button class="icon-btn warn" title="Ä°ptal Et" aria-label="Ä°ptal Et" onclick="cancelOrder({{ o.id }})">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        </button>
                        <button class="icon-btn warn" title="Ä°ade" aria-label="Ä°ade" onclick="refund({{ o.id }})">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5l-5 5 5 5V5z"></path><path d="M9 7h5a5 5 0 1 1 0 10H9" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                        </button>
                        <button class="icon-btn accent" title="DeÄŸiÅŸim" aria-label="DeÄŸiÅŸim" onclick="switchOrder({{ o.id }})">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 7h10l-2-2 1.5-1.5L21 7l-4.5 3.5L15 9l2-2H7zM17 17H7l2 2-1.5 1.5L3 17l4.5-3.5L9 15l-2 2h10z"></path></svg>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <!-- Inline modal panel -->
    <div id="editOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="modal">
            <h3 id="editModalTitle">Toplam, Kargo FirmasÄ± & IBAN</h3>
            <div class="row">
                <div>
                    <label>Yeni Toplam</label>
                    <input id="epTotal" type="number" step="0.01" inputmode="decimal" />
                </div>
                <div>
                    <label>Kargo FirmasÄ±</label>
                    <select id="epShippingCompany" style="width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px;">
                        <option value="">SÃ¼rat Kargo (VarsayÄ±lan)</option>
                        {% for company in shipping_companies %}
                        <option value="{{ company.company_code }}">{{ company.company_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-inline">
                    <input id="epIban" type="checkbox" />
                    <label for="epIban" style="margin:0;cursor:pointer;">IBAN Ã¶demesi (banka havalesi)</label>
                </div>
                <div id="epError" class="err"></div>
            </div>
            <div class="actions">
                <button id="epCancel" class="btn">VazgeÃ§</button>
                <button id="epSave" class="btn primary">Kaydet</button>
            </div>
        </div>
    </div>
    <!-- Cancel order confirmation modal -->
    <div id="cancelOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="cancelModalTitle">
        <div class="modal">
            <h3 id="cancelModalTitle">SipariÅŸi Ä°ptal Et</h3>
            <div class="row">
                <div>
                    <p style="margin: 0 0 12px 0; color: #6b7280;">Bu sipariÅŸi iptal etmek istediÄŸinizden emin misiniz?</p>
                </div>
                <div class="form-inline">
                    <input id="cancelRestoreInventory" type="checkbox" checked />
                    <label for="cancelRestoreInventory" style="margin:0;cursor:pointer;">Stok deÄŸerlerini dÃ¼zelt (envanteri geri ekle)</label>
                </div>
                <div id="cancelError" class="err"></div>
            </div>
            <div class="actions">
                <button id="cancelCancel" class="btn">VazgeÃ§</button>
                <button id="cancelConfirm" class="btn warn">Ä°ptal Et</button>
            </div>
        </div>
    </div>
    <script>
    async function recalc(){
        try{
            const res = await fetch('/orders/recalc-financials', { method: 'POST' });
            if(!res.ok){
                const t = await res.text();
                alert('Hesaplama hatasi: ' + t);
                return;
            }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }

    async function refund(id){
        try{
            const res = await fetch(`/orders/${id}/refund`, { method: 'POST' });
            if(!res.ok){ alert('Iade hatasi'); return; }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }
    async function switchOrder(id){
        try{
            const res = await fetch(`/orders/${id}/switch`, { method: 'POST' });
            if(!res.ok){ alert('Degisim hatasi'); return; }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }
    // Cancel order modal handlers
    const cancelOverlay = document.getElementById('cancelOverlay');
    const cancelRestoreInventory = document.getElementById('cancelRestoreInventory');
    const cancelConfirm = document.getElementById('cancelConfirm');
    const cancelCancel = document.getElementById('cancelCancel');
    const cancelError = document.getElementById('cancelError');
    let cancelingOrderId = null;
    function showCancelOverlay(){ cancelOverlay.style.display = 'flex'; }
    function hideCancelOverlay(){ cancelOverlay.style.display = 'none'; cancelError.textContent=''; cancelingOrderId = null; }
    function cancelOrder(id){
        cancelingOrderId = id;
        cancelRestoreInventory.checked = true;
        cancelError.textContent = '';
        showCancelOverlay();
    }
    cancelCancel?.addEventListener('click', ()=>{ hideCancelOverlay(); });
    cancelOverlay?.addEventListener('click', (e)=>{ if(e.target === cancelOverlay){ hideCancelOverlay(); } });
    cancelConfirm?.addEventListener('click', async ()=>{
        cancelError.textContent = '';
        const id = cancelingOrderId;
        if(!id){ hideCancelOverlay(); return; }
        const restoreInv = !!cancelRestoreInventory.checked;
        try{
            const res = await fetch(`/orders/${id}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ restore_inventory: restoreInv })
            });
            if(!res.ok){
                const t = await res.text();
                cancelError.textContent = 'Ä°ptal hatasÄ±: ' + (t || res.status);
                return;
            }
            hideCancelOverlay();
            location.reload();
        }catch(e){
            cancelError.textContent = 'AÄŸ hatasÄ±: ' + e;
        }
    });
    // Inline modal state/handlers
    const overlay = document.getElementById('editOverlay');
    const epTotal = document.getElementById('epTotal');
    const epIban = document.getElementById('epIban');
    const epShippingCompany = document.getElementById('epShippingCompany');
    const epSave = document.getElementById('epSave');
    const epCancel = document.getElementById('epCancel');
    const epErr = document.getElementById('epError');
    let editingOrderId = null;
    function showOverlay(){ overlay.style.display = 'flex'; }
    function hideOverlay(){ overlay.style.display = 'none'; epErr.textContent=''; }
    function editTotal(id, cur, isIban, shippingCompany){
        editingOrderId = id;
        epTotal.value = String(cur || '0.00');
        epIban.checked = !!isIban;
        epShippingCompany.value = shippingCompany || '';
        epErr.textContent = '';
        showOverlay();
        setTimeout(()=>{ try{ epTotal.focus(); epTotal.select(); }catch(_){} }, 0);
    }
    epCancel?.addEventListener('click', ()=>{ hideOverlay(); editingOrderId = null; });
    overlay?.addEventListener('click', (e)=>{ if(e.target === overlay){ hideOverlay(); editingOrderId = null; } });
    epSave?.addEventListener('click', async ()=>{
        epErr.textContent = '';
        const id = editingOrderId;
        if(!id){ hideOverlay(); return; }
        const raw = String(epTotal.value || '').trim().replace(',', '.');
        const num = parseFloat(raw);
        if(!isFinite(num)){ epErr.textContent = 'GeÃ§ersiz tutar'; return; }
        const isIban = !!epIban.checked;
        const shippingCompany = epShippingCompany.value || null;
        try{
            const res = await fetch(`/orders/${id}/update-total`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    total: num, 
                    paid_by_bank_transfer: isIban,
                    shipping_company: shippingCompany
                })
            });
            if(!res.ok){
                const t = await res.text();
                epErr.textContent = 'GÃ¼ncelleme hatasÄ±: ' + (t || res.status);
                return;
            }
            hideOverlay();
            location.reload();
        }catch(e){
            epErr.textContent = 'AÄŸ hatasÄ±: ' + e;
        }
    });

    function presetOverdue7(){
        // Build fresh params to clear any existing filters
        const params = new URLSearchParams();
        params.set('preset','overdue_unpaid_7');
        params.set('date_field','both');
        const now = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
        const endStr = `${end.getFullYear()}-${pad(end.getMonth()+1)}-${pad(end.getDate())}`;
        const startStr = `2025-01-01`;
        params.set('start', startStr);
        params.set('end', endStr);
        window.location.href = '/orders/table?' + params.toString();
    }

    function presetAll(){
        // Clear all filters and show the full history
        const params = new URLSearchParams();
        params.set('preset','all');
        params.set('date_field','both');
        const now = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const endStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
        const startStr = `2000-01-01`;
        params.set('start', startStr);
        params.set('end', endStr);
        window.location.href = '/orders/table?' + params.toString();
    }

    function presetHighCost70(){
        const params = new URLSearchParams();
        params.set('preset','high_cost_70');
        params.set('date_field','both');
        window.location.href = '/orders/table?' + params.toString();
    }

    function exportExcel(){
        const params = new URLSearchParams(window.location.search);
        const url = '/orders/export?' + params.toString();
        window.location.href = url;
    }
    </script>
    </div>
</body>
</html>

