<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Günlük Rapor</title>
        <style>
            body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
            h1 { margin-bottom: 12px; }
            .nav { display:flex; gap:8px; flex-wrap:wrap; padding:8px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; }
            .nav a { padding:6px 10px; border-radius:6px; color:#1f2937; text-decoration:none; border:1px solid transparent; }
            .nav a:hover { background:#eef2ff; border-color:#c7d2fe; color:#1d4ed8; }
            .nav a.active { background:#e0e7ff; border-color:#c7d2fe; color:#1d4ed8; }
            .toolbar { display:flex; gap:12px; align-items:flex-end; margin:14px 0; flex-wrap:wrap; }
            .card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
            .card h2 { margin: 0; padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
            .kpis { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
            @media (min-width: 1000px) { .kpis { grid-template-columns: repeat(4, minmax(0,1fr)); } }
            .kpi { padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; }
            .kpi .label { font-size:12px; color:#6b7280; }
            .kpi .value { font-size:18px; font-weight:600; margin-top:4px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
            th { background: #fafafa; position: sticky; top: 0; }
            .grid { display:grid; grid-template-columns: 1fr; gap:18px; }
            @media (min-width: 1200px) { .grid { grid-template-columns: 1fr 1fr; } }
            .caption { color:#6b7280; font-size:12px; padding:8px 0; }
            .btn { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer }
            input[type=date], select { padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
            .radio { display:flex; gap:8px; align-items:center; }
        </style>
    </head>
    <body>
        {% include "_nav.html" %}
        <h1>Günlük Rapor</h1>
        

        <form class="toolbar" method="get" action="/reports/daily" onsubmit="/*noop*/">
            <div>
                <label style="display:block;font-size:12px;color:#374151">Başlangıç</label>
                <input type="date" name="start" value="{{ start }}" />
            </div>
            <div>
                <label style="display:block;font-size:12px;color:#374151">Bitiş</label>
                <input type="date" name="end" value="{{ end }}" />
            </div>
            <div>
                <label style="display:block;font-size:12px;color:#374151">Tarih alanı</label>
                <div class="radio">
                    <label><input type="radio" name="date_field" value="shipment" {% if date_field=='shipment' %}checked{% endif %}/> kargo_tarihi</label>
                    <label><input type="radio" name="date_field" value="data" {% if date_field=='data' %}checked{% endif %}/> data_tarihi</label>
                    <label><input type="radio" name="date_field" value="both" {% if date_field=='both' %}checked{% endif %}/> ikisinden biri</label>
                </div>
            </div>
            <div>
                <button class="btn" type="submit" onclick="this.closest('form').method='get'; this.closest('form').action='/reports/daily'">Uygula</button>
            </div>
            <div>
                <button class="btn" type="button" onclick="recalcCosts()" style="background:#0ea5e9">Maliyeti Yeniden Hesapla</button>
            </div>
            <div>
                <button class="btn" type="button" onclick="fixCancelledOrders()" style="background:#ef4444">İptal Edilen Siparişleri Düzelt</button>
            </div>
        </form>

        <div class="kpis">
            <div class="kpi"><div class="label">Toplam Satış</div><div class="value">{{ '%.2f'|format(total_sales or 0) }}</div></div>
            <div class="kpi"><div class="label">Sipariş</div><div class="value">{{ order_count or 0 }}</div></div>
            <div class="kpi"><div class="label">Toplam Adet</div><div class="value">{{ total_quantity or 0 }}</div></div>
            <div class="kpi"><div class="label">Ortalama Satış Fiyatı</div><div class="value">{{ '%.2f'|format(asp or 0) }}</div></div>
            <div class="kpi"><div class="label">Toplam Maliyet</div><div class="value">{{ '%.2f'|format(total_cost or 0) }}</div></div>
            <div class="kpi"><div class="label">Brüt Kâr</div><div class="value">{{ '%.2f'|format(gross_profit or 0) }}</div></div>
            <div class="kpi"><div class="label">Brüt Marj</div><div class="value">{{ '%.1f'|format((gross_margin or 0)*100) }}%</div></div>
            <div class="kpi"><div class="label">Tahsilat (Brüt)</div><div class="value">{{ '%.2f'|format(gross_collected or 0) }}</div></div>
            <div class="kpi"><div class="label">Tahsilat (Net)</div><div class="value">{{ '%.2f'|format(net_collected or 0) }}</div></div>
            <div class="kpi"><div class="label">Toplam Kesintiler</div><div class="value">{{ '%.2f'|format(total_fees or 0) }}</div></div>
            <div class="kpi"><div class="label">Tahsilat Oranı</div><div class="value">{{ '%.1f'|format((collection_ratio or 0)*100) }}%</div></div>
            <div class="kpi"><div class="label">Dönem Siparişlerinde Kalan</div><div class="value">{{ '%.2f'|format(outstanding or 0) }}</div></div>
            <div class="kpi"><div class="label">Net Kâr</div><div class="value">{{ '%.2f'|format(net_profit or 0) }}</div></div>
            <div class="kpi"><div class="label">Net Marj</div><div class="value">{{ '%.1f'|format((net_margin or 0)*100) }}%</div></div>
            <div class="kpi"><div class="label">Stok Değeri</div><div class="value">{{ '%.2f'|format(inventory_value or 0) }}</div></div>
            <div class="kpi"><div class="label">Stok Kalem Sayısı</div><div class="value">{{ inventory_item_count or 0 }}</div></div>
            <div class="kpi"><div class="label">İade Adedi</div><div class="value">{{ refund_count or 0 }}</div></div>
            <div class="kpi"><div class="label">İade Toplam</div><div class="value">{{ '%.2f'|format(refund_total_amount or 0) }}</div></div>
            <div class="kpi"><div class="label">İade Kargo</div><div class="value">{{ '%.2f'|format(refund_shipping_total or 0) }}</div></div>
            <div class="kpi"><div class="label">Değişim Adedi</div><div class="value">{{ switch_count or 0 }}</div></div>
            <div class="kpi"><div class="label">Değişim Toplam</div><div class="value">{{ '%.2f'|format(switch_total_amount or 0) }}</div></div>
            <div class="kpi"><div class="label">Toplam Kargo Maliyeti</div><div class="value">{{ '%.2f'|format(total_shipment_costs or 0) }}</div></div>
        </div>

        <div class="card" style="margin-top:16px;">
            <h2>Maliyet Dağılımı</h2>
            <div style="padding:16px;">
                <div style="margin-bottom:16px; padding:12px; background:#f9fafb; border-radius:6px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <span style="font-weight:600;">Sipariş Maliyetleri (Order Costs)</span>
                        <span style="font-size:18px; font-weight:600;">{{ '%.2f'|format(order_costs or 0) }} ₺</span>
                    </div>
                    <div style="font-size:12px; color:#6b7280;">Ürün maliyetleri (Order.total_cost'den)</div>
                </div>
                
                <div style="margin-bottom:16px; padding:12px; background:#f0f9ff; border-radius:6px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <span style="font-weight:600;">Operasyonel Maliyetler (Operational Costs)</span>
                        <span style="font-size:18px; font-weight:600;">{{ '%.2f'|format(operational_costs or 0) }} ₺</span>
                    </div>
                    <div style="font-size:12px; color:#6b7280;">Ödemeler ve MERTER MAL ALIM hariç</div>
                    
                    {% if operational_costs_by_type %}
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5e7eb;">
                        <div style="font-size:13px; font-weight:600; margin-bottom:8px; color:#374151;">Türe Göre Dağılım:</div>
                        <table style="width:100%; font-size:13px;">
                            <thead>
                                <tr style="border-bottom:1px solid #e5e7eb;">
                                    <th style="text-align:left; padding:6px 0; color:#6b7280; font-weight:600;">Tür</th>
                                    <th style="text-align:right; padding:6px 0; color:#6b7280; font-weight:600;">Tutar</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for type_name, amount in operational_costs_by_type.items() %}
                                <tr style="border-bottom:1px solid #f3f4f6;">
                                    <td style="padding:6px 0;">{{ type_name }}</td>
                                    <td style="text-align:right; padding:6px 0; font-weight:500;">{{ '%.2f'|format(amount) }} ₺</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                
                <div style="padding:12px; background:#fef3c7; border-radius:6px; border:2px solid #fbbf24;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:700; font-size:16px;">Toplam Maliyet</span>
                        <span style="font-size:20px; font-weight:700;">{{ '%.2f'|format(total_cost or 0) }} ₺</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top:16px;">
            <h2>Finansal Özet ve Nakit Akışı</h2>
            <div style="padding:16px;">
                <!-- Equation 1: Costs + Outstanding + Bank Balances = Total Sales -->
                <div style="margin-bottom:24px; padding:16px; background:#f0f9ff; border-radius:8px; border:2px solid #3b82f6;">
                    <h3 style="margin:0 0 16px 0; font-size:16px; color:#1e40af;">Satış Denklemi</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px; margin-bottom:16px;">
                        <!-- Sol Taraf -->
                        <div style="padding:12px; background:#fff; border-radius:6px; border:2px solid #3b82f6;">
                            <div style="font-size:13px; font-weight:600; color:#1e40af; margin-bottom:12px; text-align:center;">SOL TARAF (Harcanan + Bekleyen)</div>
                            <div style="margin-bottom:8px;">
                                <div style="color:#6b7280; font-size:12px; margin-bottom:4px;">Maliyetler</div>
                                <div style="font-weight:600; font-size:16px;">{{ '%.2f'|format(total_cost or 0) }} ₺</div>
                            </div>
                            <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5e7eb;">
                                <div style="color:#6b7280; font-size:12px; margin-bottom:4px;">+ Alacaklar</div>
                                <div style="font-weight:600; font-size:16px;">{{ '%.2f'|format(outstanding or 0) }} ₺</div>
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">Ödenmemiş siparişler</div>
                            </div>
                            <div style="margin-top:12px; padding-top:12px; border-top:2px solid #3b82f6;">
                                <div style="color:#1e40af; font-size:12px; font-weight:600; margin-bottom:4px;">TOPLAM</div>
                                <div style="font-weight:700; font-size:18px; color:#1e40af;">
                                    {% set left_total = (total_cost or 0) + (outstanding or 0) %}
                                    {{ '%.2f'|format(left_total) }} ₺
                                </div>
                            </div>
                        </div>
                        <!-- Sağ Taraf -->
                        <div style="padding:12px; background:#fff; border-radius:6px; border:2px solid #3b82f6;">
                            <div style="font-size:13px; font-weight:600; color:#1e40af; margin-bottom:12px; text-align:center;">SAĞ TARAF (Elde Edilen)</div>
                            <div style="margin-bottom:8px;">
                                <div style="color:#6b7280; font-size:12px; margin-bottom:4px;">Bankadaki Paralar</div>
                                <div style="font-weight:600; font-size:16px;">{{ '%.2f'|format(total_account_balances or 0) }} ₺</div>
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">Tahsil edilen paralar</div>
                            </div>
                            <div style="margin-top:12px; padding-top:12px; border-top:2px solid #3b82f6;">
                                <div style="color:#1e40af; font-size:12px; font-weight:600; margin-bottom:4px;">TOPLAM SATIŞ</div>
                                <div style="font-weight:700; font-size:18px; color:#1e40af;">{{ '%.2f'|format(total_sales or 0) }} ₺</div>
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">Dönem içindeki tüm siparişler</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:12px; padding:10px; background:#fff; border-radius:4px; text-align:center; font-size:12px;">
                        <div style="margin-bottom:6px; color:#374151; font-weight:600;">Denklem: Sol = Sağ</div>
                        {% set calculated_total = (total_cost or 0) + (outstanding or 0) + (total_account_balances or 0) %}
                        {% set difference = (total_sales or 0) - calculated_total %}
                        <div style="color:#059669;">
                            Sol: {{ '%.2f'|format((total_cost or 0) + (outstanding or 0)) }} ₺ + Sağ: {{ '%.2f'|format(total_account_balances or 0) }} ₺ = {{ '%.2f'|format(calculated_total) }} ₺
                        </div>
                        {% if difference|abs > 0.01 %}
                        <div style="margin-top:4px; color:#dc2626; font-weight:600;">Fark: {{ '%.2f'|format(difference) }} ₺</div>
                        {% else %}
                        <div style="margin-top:4px; color:#059669; font-weight:600;">✓ Denklem doğru</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Equation 2: Net Profit - Working Capital = Cash on Hand - Stock Value -->
                <div style="margin-bottom:24px; padding:16px; background:#fef3c7; border-radius:8px; border:2px solid #f59e0b;">
                    <h3 style="margin:0 0 16px 0; font-size:16px; color:#92400e;">Nakit Akışı Denklemi</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px; margin-bottom:16px;">
                        <!-- Sol Taraf -->
                        <div style="padding:12px; background:#fff; border-radius:6px; border:2px solid #f59e0b;">
                            <div style="font-size:13px; font-weight:600; color:#92400e; margin-bottom:12px; text-align:center;">SOL TARAF (Kâr - Bağlı Sermaye)</div>
                            <div style="margin-bottom:8px;">
                                <div style="color:#6b7280; font-size:12px; margin-bottom:4px;">Net Kâr</div>
                                <div style="font-weight:600; font-size:16px;">{{ '%.2f'|format(net_profit or 0) }} ₺</div>
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">Brüt Kâr - Kesintiler</div>
                            </div>
                            <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5e7eb;">
                                <div style="color:#6b7280; font-size:12px; margin-bottom:4px;">- Çalışma Sermayesi</div>
                                <div style="font-weight:600; font-size:16px;">{{ '%.2f'|format(working_capital or 0) }} ₺</div>
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">
                                    (Alacaklar: {{ '%.2f'|format(outstanding or 0) }} ₺ + Stok: {{ '%.2f'|format(inventory_value or 0) }} ₺)
                                </div>
                            </div>
                            <div style="margin-top:12px; padding-top:12px; border-top:2px solid #f59e0b;">
                                <div style="color:#92400e; font-size:12px; font-weight:600; margin-bottom:4px;">SONUÇ</div>
                                <div style="font-weight:700; font-size:18px; color:#92400e;">
                                    {% set left_side = (net_profit or 0) - (working_capital or 0) %}
                                    {{ '%.2f'|format(left_side) }} ₺
                                </div>
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">Serbest nakit akışı</div>
                            </div>
                        </div>
                        <!-- Sağ Taraf -->
                        <div style="padding:12px; background:#fff; border-radius:6px; border:2px solid #f59e0b;">
                            <div style="font-size:13px; font-weight:600; color:#92400e; margin-bottom:12px; text-align:center;">SAĞ TARAF (Nakit - Stok)</div>
                            <div style="margin-bottom:8px;">
                                <div style="color:#6b7280; font-size:12px; margin-bottom:4px;">Elimdeki Para</div>
                                <div style="font-weight:600; font-size:16px;">{{ '%.2f'|format(cash_on_hand or 0) }} ₺</div>
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">Banka hesaplarındaki toplam</div>
                            </div>
                            <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5e7eb;">
                                <div style="color:#6b7280; font-size:12px; margin-bottom:4px;">- Stok Değeri</div>
                                <div style="font-weight:600; font-size:16px;">{{ '%.2f'|format(inventory_value or 0) }} ₺</div>
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">Elimdeki ürünlerin maliyeti</div>
                            </div>
                            <div style="margin-top:12px; padding-top:12px; border-top:2px solid #f59e0b;">
                                <div style="color:#92400e; font-size:12px; font-weight:600; margin-bottom:4px;">SONUÇ</div>
                                <div style="font-weight:700; font-size:18px; color:#92400e;">
                                    {% set right_side = (cash_on_hand or 0) - (inventory_value or 0) %}
                                    {{ '%.2f'|format(right_side) }} ₺
                                </div>
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">Kullanılabilir nakit</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:12px; padding:10px; background:#fff; border-radius:4px; text-align:center; font-size:12px;">
                        <div style="margin-bottom:6px; color:#374151; font-weight:600;">Denklem: Sol = Sağ</div>
                        {% set left_side = (net_profit or 0) - (working_capital or 0) %}
                        {% set right_side = (cash_on_hand or 0) - (inventory_value or 0) %}
                        {% set diff = left_side - right_side %}
                        <div style="color:#059669;">
                            Sol: {{ '%.2f'|format(left_side) }} ₺ | Sağ: {{ '%.2f'|format(right_side) }} ₺
                        </div>
                        {% if diff|abs > 0.01 %}
                        <div style="margin-top:4px; color:#dc2626; font-weight:600;">Fark: {{ '%.2f'|format(diff) }} ₺</div>
                        {% else %}
                        <div style="margin-top:4px; color:#059669; font-weight:600;">✓ Denklem doğru</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Detailed Breakdown Table -->
                <div style="margin-top:24px;">
                    <h3 style="margin:0 0 12px 0; font-size:16px;">Detaylı Finansal Tablo</h3>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f9fafb; border-bottom:2px solid #e5e7eb;">
                                <th style="padding:10px; text-align:left; font-weight:600;">Kategori</th>
                                <th style="padding:10px; text-align:right; font-weight:600;">Tutar</th>
                                <th style="padding:10px; text-align:left; font-weight:600;">Açıklama</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Sales Section -->
                            <tr style="background:#f0f9ff;">
                                <td colspan="3" style="padding:8px; font-weight:600; color:#1e40af;">SATIŞLAR</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 10px;">Toplam Satış</td>
                                <td style="padding:8px 10px; text-align:right; font-weight:600;">{{ '%.2f'|format(total_sales or 0) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Dönem içindeki tüm siparişler</td>
                            </tr>
                            
                            <!-- Costs Section -->
                            <tr style="background:#fef3c7;">
                                <td colspan="3" style="padding:8px; font-weight:600; color:#92400e;">MALİYETLER</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 10px; padding-left:20px;">Sipariş Maliyetleri</td>
                                <td style="padding:8px 10px; text-align:right;">{{ '%.2f'|format(order_costs or 0) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Ürün maliyetleri</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 10px; padding-left:20px;">Operasyonel Maliyetler</td>
                                <td style="padding:8px 10px; text-align:right;">{{ '%.2f'|format(operational_costs or 0) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Genel giderler</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 10px; padding-left:20px;">Nakliye Maliyetleri</td>
                                <td style="padding:8px 10px; text-align:right;">{{ '%.2f'|format(transportation_costs or 0) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Kargo ücretleri</td>
                            </tr>
                            <tr style="border-top:2px solid #e5e7eb;">
                                <td style="padding:8px 10px; font-weight:600;">Toplam Maliyet</td>
                                <td style="padding:8px 10px; text-align:right; font-weight:700;">{{ '%.2f'|format(total_cost or 0) }} ₺</td>
                                <td style="padding:8px 10px;"></td>
                            </tr>
                            
                            <!-- Profit Section -->
                            <tr style="background:#ecfdf5;">
                                <td colspan="3" style="padding:8px; font-weight:600; color:#065f46;">KÂR/ZARAR</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 10px;">Brüt Kâr</td>
                                <td style="padding:8px 10px; text-align:right;">{{ '%.2f'|format(gross_profit or 0) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Satış - Maliyet</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 10px; padding-left:20px;">Eksi: Kesintiler</td>
                                <td style="padding:8px 10px; text-align:right; color:#dc2626;">-{{ '%.2f'|format(total_fees or 0) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Komisyon, hizmet, iade vb.</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 10px; font-weight:600;">Net Kâr</td>
                                <td style="padding:8px 10px; text-align:right; font-weight:700;">{{ '%.2f'|format(net_profit or 0) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Brüt Kâr - Kesintiler</td>
                            </tr>
                            
                            <!-- Assets Section -->
                            <tr style="background:#f5f3ff;">
                                <td colspan="3" style="padding:8px; font-weight:600; color:#5b21b6;">VARLIKLAR</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 10px;">Alacaklar</td>
                                <td style="padding:8px 10px; text-align:right;">{{ '%.2f'|format(outstanding or 0) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Ödenmemiş siparişler</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 10px;">Stok Değeri</td>
                                <td style="padding:8px 10px; text-align:right;">{{ '%.2f'|format(inventory_value or 0) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Elimdeki ürünler</td>
                            </tr>
                            {% if account_balances %}
                            <tr>
                                <td style="padding:8px 10px; font-weight:600; color:#5b21b6;">Banka ve Kasalar</td>
                                <td style="padding:8px 10px; text-align:right;"></td>
                                <td style="padding:8px 10px;"></td>
                            </tr>
                            {% for acc_id, balance in account_balances.items() %}
                            <tr>
                                <td style="padding:8px 10px; padding-left:20px;">{{ account_name_map.get(acc_id) or ('Hesap ' + acc_id|string) }}</td>
                                <td style="padding:8px 10px; text-align:right;">{{ '%.2f'|format(balance) }} ₺</td>
                                <td style="padding:8px 10px; color:#6b7280; font-size:12px;">Banka hesabı</td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                            <tr style="border-top:2px solid #e5e7eb;">
                                <td style="padding:8px 10px; font-weight:600;">Toplam Varlıklar</td>
                                <td style="padding:8px 10px; text-align:right; font-weight:700;">{{ '%.2f'|format((outstanding or 0) + (inventory_value or 0) + (total_account_balances or 0)) }} ₺</td>
                                <td style="padding:8px 10px;"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="grid" style="margin-top:16px;">
            <div class="card">
                <h2>Kanallara Göre Sipariş</h2>
                <table>
                    <thead>
                        <tr><th>Kaynak</th><th>Adet</th><th>Satış</th></tr>
                    </thead>
                    <tbody>
                        {% for src, vals in by_channel.items() %}
                        <tr>
                            <td>{{ src }}</td>
                            <td>{{ vals.count|int }}</td>
                            <td>{{ '%.2f'|format(vals.sales or 0) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>Ödemeler (dönem içinde)</h2>
                <table>
                    <thead>
                        <tr><th>Komisyon</th><th>Hizmet</th><th>Kargo</th><th>İade</th><th>Erken Ödeme</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ '%.2f'|format(fee_breakdown.komisyon or 0) }}</td>
                            <td>{{ '%.2f'|format(fee_breakdown.hizmet or 0) }}</td>
                            <td>{{ '%.2f'|format(fee_breakdown.kargo or 0) }}</td>
                            <td>{{ '%.2f'|format(fee_breakdown.iade or 0) }}</td>
                            <td>{{ '%.2f'|format(fee_breakdown.erken_odeme or 0) }}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="caption">Brüt: {{ '%.2f'|format(gross_collected or 0) }}, Net: {{ '%.2f'|format(net_collected or 0) }}, Kesintiler: {{ '%.2f'|format(total_fees or 0) }}</div>
            </div>

            <div class="card">
                <h2>Hasılata Göre Ürünler</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>SKU</th><th>Ad</th><th>Hasılat</th><th>Adet</th></tr>
                    </thead>
                    <tbody>
                        {% for it in top_items_by_revenue %}
                        <tr>
                            <td>{{ it.item_id }}</td>
                            <td>{{ it.sku }}</td>
                            <td>{{ it.name }}</td>
                            <td>{{ '%.2f'|format(it.revenue or 0) }}</td>
                            <td>{{ it.quantity|int }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>Adede Göre Ürünler</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>SKU</th><th>Ad</th><th>Adet</th><th>Hasılat</th></tr>
                    </thead>
                    <tbody>
                        {% for it in top_items_by_quantity %}
                        <tr>
                            <td>{{ it.item_id }}</td>
                            <td>{{ it.sku }}</td>
                            <td>{{ it.name }}</td>
                            <td>{{ it.quantity|int }}</td>
                            <td>{{ '%.2f'|format(it.revenue or 0) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>Hasılata Göre Müşteriler</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>Ad</th><th>Telefon</th><th>Hasılat</th></tr>
                    </thead>
                    <tbody>
                        {% for c in top_clients %}
                        <tr>
                            <td>{{ c.client_id }}</td>
                            <td>{{ c.name }}</td>
                            <td>{{ c.phone }}</td>
                            <td>{{ '%.2f'|format(c.revenue or 0) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>İçe Aktarmalar (dönem içinde)</h2>
                <table>
                    <thead>
                        <tr><th>Kaynak</th><th>Dosya</th><th>Data Tarihi</th><th>Satır</th><th>Oluşan (M/V/S/Ö)</th></tr>
                    </thead>
                    <tbody>
                        {% for r in recent_imports %}
                        <tr>
                            <td>{{ r.source }}</td>
                            <td>{{ r.filename }}</td>
                            <td>{{ r.data_date }}</td>
                            <td>{{ r.row_count }}</td>
                            <td>{{ r.created_clients }}/{{ r.created_items }}/{{ r.created_orders }}/{{ r.created_payments }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="caption">Toplam çalıştırma: {{ imports_total }}, Satır: {{ imports_row_count }}, Oluşan M/V/S/Ö: {{ imports_created.clients }}/{{ imports_created.items }}/{{ imports_created.orders }}/{{ imports_created.payments }}</div>
            </div>

            <div class="card">
                <h2>Stok Hareketleri (dönem içinde)</h2>
                <table>
                    <thead>
                        <tr><th>Giriş</th><th>Çıkış</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>{{ qty_in|int }}</td><td>{{ qty_out|int }}</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>Siparişler (filtreli)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Takip</th>
                            <th>Müşteri</th>
                            <th>Ürün</th>
                            <th>Adet</th>
                            <th>Toplam</th>
                            <th>Kargo Tarihi</th>
                            <th>Data Tarihi</th>
                            <th>Kanal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for o in orders %}
                        <tr>
                            <td>{{ o.id }}</td>
                            <td>{{ o.tracking_no }}</td>
                            <td>{{ client_map.get(o.client_id).name if o.client_id in client_map else o.client_id }}</td>
                            <td>
                                {% if o.item_id and o.item_id in item_map %}
                                    {{ item_map.get(o.item_id).sku }} - {{ item_map.get(o.item_id).name }}
                                {% else %}
                                    {{ o.item_id }}
                                {% endif %}
                            </td>
                            <td>{{ o.quantity or 0 }}</td>
                            <td>{{ '%.2f'|format(o.total_amount or 0) }}</td>
                            <td>{{ o.shipment_date }}</td>
                            <td>{{ o.data_date }}</td>
                            <td>{{ o.source }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <script>
        async function recalcCosts(){
            try{
                const params = new URLSearchParams(new FormData(document.querySelector('form.toolbar')));
                const res = await fetch(`/reports/recalculate-costs?${params.toString()}`, { method: 'POST' });
                if(!res.ok){
                    const t = await res.text();
                    alert('Hesaplama başarısız: ' + t);
                    return;
                }
                const j = await res.json();
                alert(`Güncellendi: ${j.updated_orders} sipariş`);
                // Refresh the page to reflect recalculated totals
                location.href = `/reports/daily?${params.toString()}`;
            }catch(e){
                alert('Ağ hatası: ' + e);
            }
        }
        async function fixCancelledOrders(){
            if(!confirm('İptal edilen tüm siparişlerin finansal değerlerini (toplam, maliyet, kargo) sıfırlamak istediğinizden emin misiniz? Bu işlem geri alınamaz.')){
                return;
            }
            try{
                const res = await fetch('/admin/orders/fix-cancelled', { method: 'POST' });
                if(!res.ok){
                    const t = await res.text();
                    alert('Düzeltme başarısız: ' + t);
                    return;
                }
                const j = await res.json();
                if(j.status === 'ok'){
                    alert(`Başarılı! ${j.fixed_count} sipariş düzeltildi. Sayfa yenileniyor...`);
                    location.reload();
                } else {
                    alert('Beklenmeyen yanıt: ' + JSON.stringify(j));
                }
            }catch(e){
                alert('Ağ hatası: ' + e);
            }
        }
        </script>
    </body>
    </html>


