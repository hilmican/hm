<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Shadow Draft #{{ draft.id }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      h1, h2, h3 { margin: 0 0 8px 0; }
      .meta { color:#6b7280; font-size:13px; margin:4px 0; }
      pre { background:#0b1021; color:#e5e7eb; padding:12px; border-radius:8px; white-space:pre-wrap; max-height:320px; overflow:auto; }
      a { color:#2563eb; text-decoration:none; }
      .section { margin-top:16px; padding:12px; border-radius:10px; border:1px solid #e5e7eb; background:#f9fafb; }
      .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #d1d5db; font-size:12px; margin-left:4px; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <a href="/ig/inbox/{{ conversation_id }}">← Konuşmaya geri dön</a>
    <h1>Shadow Draft #{{ draft.id }}</h1>
    <div class="meta">
      Konuşma: <a href="/ig/inbox/{{ conversation_id }}">{{ conversation_id }}</a>
      {% if draft.status %}<span class="pill">{{ draft.status }}</span>{% endif %}
    </div>
    <div class="meta">
      Model: {{ draft.model or '-' }}
      {% if draft.confidence is not none %} · Güven: {{ '%.2f' % draft.confidence }}{% endif %}
      {% if draft.reason %} · Sebep: {{ draft.reason }}{% endif %}
      {% if draft.created_at %} · Oluşturulma: {{ draft.created_at }}{% endif %}
    </div>

    {% if conversation_info %}
    <div class="section">
      <h3>Konuşma Bilgisi</h3>
      <div class="meta">
        Kullanıcı: {% if conversation_info.username %}@{{ conversation_info.username }}{% else %}(username yok){% endif %}
        {% if conversation_info.name %} · {{ conversation_info.name }}{% endif %}
      </div>
      <div class="meta">
        IG User ID: {{ conversation_info.ig_user_id or '-' }}
        {% if conversation_info.is_mock %}
          <span class="pill">Mock</span>
        {% endif %}
      </div>
      {% if conversation_info.last_message_at %}
      <div class="meta">Son mesaj: {{ conversation_info.last_message_at }}</div>
      {% endif %}
    </div>
    {% endif %}

    {% if history_preview %}
    <div class="section">
      <h3>AI'ya Aktarılan Geçmiş (Özet)</h3>
      <ul style="padding-left:16px; margin:0;">
        {% for msg in history_preview %}
          <li style="margin-bottom:6px;">
            <strong>{{ (msg.dir or msg.direction or 'in')|upper }}</strong>
            {% if msg.timestamp_ms %} · {{ msg.timestamp_ms }}{% endif %}
            · {{ msg.text or '(boş)' }}
          </li>
        {% endfor %}
      </ul>
      <div class="meta">Not: Bu liste mevcut kurallara göre yeniden oluşturulmuştur.</div>
    </div>
    {% endif %}

    {% if actions %}
    <div class="section">
      <h3>Planlanan Aksiyonlar</h3>
      <ul>
        {% for action in actions %}
          <li style="margin-bottom:8px;">
            <strong>{{ action.type }}</strong>
            {% if action.trigger %} · tetikleyici: {{ action.trigger }}{% endif %}
            {% if action.image_count %} · {{ action.image_count }} görsel{% endif %}
            {% if action.product_name %} · ürün: {{ action.product_name }}{% elif action.product_slug %} · ürün: {{ action.product_slug }}{% endif %}
            {% if action.type == 'send_product_images' and action.image_urls %}
              <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
                {% for img_url in action.image_urls %}
                  <a href="{{ img_url }}" target="_blank" rel="noopener" style="display:inline-block; border:1px solid #e5e7eb; border-radius:6px; overflow:hidden;">
                    <img src="{{ img_url }}" alt="product" style="width:90px; height:90px; object-fit:cover;" />
                  </a>
                {% endfor %}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="section">
      <h3>AI Cevabı (reply_text)</h3>
      <pre>{{ (draft.reply_text or '') }}</pre>
    </div>

    <div class="section">
      <h3>System Prompt</h3>
      {% if debug_meta and debug_meta.system_prompt %}
        <pre>{{ debug_meta.system_prompt }}</pre>
      {% else %}
        <div class="meta">System prompt kaydı yok.</div>
      {% endif %}
    </div>

    <div class="section">
      <h3>User Payload (Prompt JSON)</h3>
      {% if debug_meta and debug_meta.user_payload %}
        <pre>{{ debug_meta.user_payload_pretty }}</pre>
      {% else %}
        <div class="meta">user_payload kaydı yok.</div>
      {% endif %}
    </div>

    <div class="section">
      <h3>Ham Model Cevabı (raw_response)</h3>
      {% if debug_meta and debug_meta.raw_response %}
        <pre>{{ debug_meta.raw_response_pretty }}</pre>
      {% else %}
        <div class="meta">raw_response kaydı yok.</div>
      {% endif %}
    </div>
  </body>
</html>


