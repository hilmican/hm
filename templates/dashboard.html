<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Yönetim Paneli</title>
		<style>
			body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
			h1 { margin-bottom: 12px; }
			.grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
			@media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
			.card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
			.card h2 { margin: 0; padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
            table { width: 100%; border-collapse: collapse; }
			th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
			th { background: #fafafa; position: sticky; top: 0; }
			.caption { color: #6b7280; font-size: 12px; padding: 8px 16px; }
			.toolbar { margin-bottom: 12px; }
			.toolbar .nav { display:flex; gap:8px; flex-wrap:wrap; padding:8px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; }
			.toolbar .nav a { padding:6px 10px; border-radius:6px; color:#1f2937; text-decoration:none; border:1px solid transparent; }
			.toolbar .nav a:hover { background:#eef2ff; border-color:#c7d2fe; color:#1d4ed8; }
            tr.paid { background: #eaffea; }
            tr.unpaid { background: #fff9db; }
		</style>
	</head>
	<body>
		{% include "_nav.html" %}
		<h1>Kargo Yönetim Paneli</h1>
		<div style="display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 18px 0;">
			<div class="card" style="padding:8px 12px;">
				<strong>Toplam Satış:</strong> {{ '%.2f'|format(total_sales or 0) }}
			</div>
			<div class="card" style="padding:8px 12px;">
				<strong>Toplanan (Net):</strong> {{ '%.2f'|format(total_collected or 0) }}
			</div>
			<div class="card" style="padding:8px 12px;">
				<strong>Alınacak:</strong> {{ '%.2f'|format(total_to_collect or 0) }}
			</div>
			<div class="card" style="padding:8px 12px;">
				<strong>Toplam Kesintiler:</strong> {{ '%.2f'|format(total_fees or 0) }}
			</div>
		</div>
		<div class="toolbar">
			<form id="uploadForm" method="post" action="/import/upload" enctype="multipart/form-data" style="display:inline-block;margin-left:12px;">
				<select name="source" style="padding:6px 8px;border:1px solid #ddd;border-radius:6px;">
					<option value="bizim">bizim</option>
					<option value="kargo">kargo</option>
					<option value="returns">returns</option>
				</select>
				<input type="file" name="files" multiple accept=".xlsx" required style="margin-left:6px" />
				<button type="submit" style="margin-left:6px;background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">Yükle</button>
			</form>
		</div>

		<div id="uploadResult" class="caption"></div>
		<div class="grid">
			<div class="card">
				<h2>Sipariş Durum Dağılımı</h2>
				<canvas id="statusPie" width="400" height="260" style="display:block;margin:8px auto;"></canvas>
				<div id="statusLegend" class="caption" style="padding:8px 16px;"></div>
			</div>

			<div class="card">
				<h2>En Çok Satan - Düşük Stok (<=5)</h2>
				<table>
					<thead>
						<tr><th>ID</th><th>SKU</th><th>Ürün Adı</th><th>Mevcut Stok</th><th>Satış (Toplam)</th></tr>
					</thead>
					<tbody>
					{% for it, onhand, sold in low_stock_best %}
						<tr>
							<td>{{ it.id }}</td>
							<td>{{ it.sku }}</td>
							<td>{{ it.name }}</td>
							<td>{{ onhand }}</td>
							<td>{{ sold }}</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
		</div>

		<script>
		const form = document.getElementById('uploadForm');
		const result = document.getElementById('uploadResult');
		const logoutBtn = document.getElementById('logoutBtn');
		if (logoutBtn) {
			logoutBtn.addEventListener('click', async () => {
				try {
					await fetch('/auth/logout', { method: 'POST' });
					location.href = '/auth/login';
				} catch (e) { alert('Çıkış hatası'); }
			});
		}
		if (form) {
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				const data = new FormData(form);
				result.textContent = 'Yükleniyor...';
				try {
					const res = await fetch('/import/upload', { method: 'POST', body: data });
					if (!res.ok) throw new Error('Yükleme başarısız');
					const json = await res.json();
					console.log('Yüklenen dosyalar (önizleme)', json.files);
					result.textContent = `Yüklenen dosya sayısı: ${json.files.length}`;
					// For 'returns', redirect to interactive review for the first file
					if (json.source === 'returns' && json.files && json.files.length){
						const fn = encodeURIComponent(json.files[0].filename);
						location.href = `/import/returns/review?filename=${fn}`;
						return;
					}
					// For 'bizim', check unmatched patterns across all uploaded files and redirect to mapping wizard if needed
					if (json.source === 'bizim' && json.files && json.files.length) {
                        const fnames = json.files.map(f=>f.filename);
                        try {
                            const pm = await fetch('/import/preview-map', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ source: 'bizim', filenames: fnames, exclude_generic: false }) });
                            if (pm.ok) {
                                const j = await pm.json();
								if ((j.total_unmatched||0) > 0) {
									if (confirm(`${j.total_unmatched} eşleşmeyen ürün bulundu. Haritalandırma ekranına gitmek ister misiniz?`)) {
                                        const joined = fnames.map(encodeURIComponent).join(',');
                                        location.href = `/import/map?source=bizim&filename=${joined}`;
                                        return;
                                    }
                                }
                            }
                        } catch (e) { /* ignore preview errors and continue to commit flow */ }
                    }

					// Offer to commit each file sequentially (date prompt only for bizim)
					if (confirm('Dosyalar yüklendi. Hepsini içe aktarmak ister misiniz?')) {
						const totals = { created_orders:0, created_clients:0, created_items:0, created_payments:0, unmatched:0, enriched_orders:0, payments_existing:0, payments_skipped_zero:0 };
						const runIds = [];
						for (const f of json.files) {
							let body = { source: json.source, filename: f.filename };
							// returns are handled via interactive review; skip commit here
							if (json.source === 'returns') { continue; }
							if (json.source === 'bizim') {
								let today = new Date();
								const pad = (n)=> String(n).padStart(2,'0');
								const defaultDate = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
								const input = prompt(`${f.filename} için veri tarihi (YYYY-MM-DD)`, defaultDate);
								if (!input) { console.log('Skipped commit for', f.filename); continue; }
								body.data_date = input;
							}
							const res2 = await fetch('/import/commit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)});
							if (!res2.ok) { const t = await res2.text(); throw new Error(`${f.filename} için içe aktarım başarısız: ${t}`); }
							const j2 = await res2.json();
							console.group('İçe aktarma sonucu', f.filename);
							console.log('Özet:', j2);
							console.groupEnd();
							for (const k of Object.keys(totals)) { totals[k] += (j2[k] || 0); }
							if (j2.run_id) { runIds.push(j2.run_id); }
						}
						if (runIds.length) {
							const q = encodeURIComponent(runIds.join(','));
							location.href = `/import/result?run_ids=${q}`;
						} else {
							location.reload();
						}
					}
				} catch (err) {
					console.error(err);
					result.textContent = 'Yükleme hatası';
				}
			});
		}

		// Simple pie chart without external deps
		(function(){
			const data = {{ (order_status_counts or []) | tojson }};
			if (!data || !data.length) return;
			const canvas = document.getElementById('statusPie');
			if (!canvas) return;
			const ctx = canvas.getContext('2d');
			const total = data.reduce((s, r) => s + (r.count || 0), 0) || 1;
			// Palette order matches: tamamlandi, dagitimda, gecikmede, sorunlu, refunded, switched, stitched
			const colors = ['#10b981','#60a5fa','#f59e0b','#ef4444','#a78bfa','#fbbf24','#34d399'];
			let start = -Math.PI/2;
			data.forEach((r, i) => {
				const frac = (r.count || 0) / total;
				const end = start + frac * Math.PI * 2;
				ctx.beginPath();
				ctx.moveTo(canvas.width/2, canvas.height/2);
				ctx.arc(canvas.width/2, canvas.height/2, Math.min(canvas.width, canvas.height)/2 - 8, start, end);
				ctx.closePath();
				ctx.fillStyle = colors[i % colors.length];
				ctx.fill();
				start = end;
			});
			const legend = document.getElementById('statusLegend');
			if (legend) {
				const trMap = {
					'tamamlandi': 'Tamamlandı',
					'dagitimda': 'Dağıtımda (≤7g)',
					'gecikmede': 'Gecikmede (8‑17g)',
					'sorunlu': 'Sorunlu (>17g)',
					'refunded': 'İade',
					'switched': 'Değişim',
					'stitched': 'Birleştirilmiş',
					'unknown': 'Bilinmiyor'
				};
				const label = (s)=> trMap[String(s||'').toLowerCase()] || (String(s||'').charAt(0).toUpperCase() + String(s||'').slice(1));
				legend.innerHTML = data.map((r,i)=>`<span style="display:inline-flex;align-items:center;margin-right:12px;">
					<span style="display:inline-block;width:10px;height:10px;background:${colors[i%colors.length]};border-radius:2px;margin-right:6px;"></span>
					${label(r.status)}: <strong style="margin-left:4px;">${r.count}</strong>
				</span>`).join('');

				// Tooltip on hover
				const tip = document.createElement('div');
				tip.style.position = 'absolute';
				tip.style.background = 'rgba(17,24,39,0.9)';
				tip.style.color = '#fff';
				tip.style.fontSize = '12px';
				tip.style.padding = '6px 8px';
				tip.style.borderRadius = '6px';
				tip.style.pointerEvents = 'none';
				tip.style.display = 'none';
				canvas.parentElement.style.position = 'relative';
				canvas.parentElement.appendChild(tip);
				const totals = data.map(r=>r.count||0);
				const sum = totals.reduce((a,b)=>a+b,0)||1;
				const cum = []; let acc = 0; for(const r of totals){ acc += r/sum; cum.push(acc); }
				function sliceAt(theta){
					let t = theta; while (t < -Math.PI/2) t += Math.PI*2; while (t > Math.PI*3/2) t -= Math.PI*2;
					let frac = (t + Math.PI/2) / (Math.PI*2);
					for (let i=0;i<cum.length;i++){ if (frac <= cum[i]) return i; }
					return cum.length-1;
				}
				canvas.addEventListener('mousemove', (e)=>{
					const rect = canvas.getBoundingClientRect();
					const x = e.clientX - rect.left - canvas.width/2;
					const y = e.clientY - rect.top - canvas.height/2;
					const r = Math.min(canvas.width, canvas.height)/2 - 8;
					if (Math.sqrt(x*x + y*y) > r){ tip.style.display='none'; return; }
					const theta = Math.atan2(y, x);
					const idx = sliceAt(theta);
					const d = data[idx]; const cnt = totals[idx]; const pct = Math.round((cnt/sum)*1000)/10;
					tip.textContent = `${label(d.status)}: ${cnt} (${pct}%)`;
					tip.style.left = (e.clientX - rect.left + 10) + 'px';
					tip.style.top = (e.clientY - rect.top + 10) + 'px';
					tip.style.display = 'block';
				});
				canvas.addEventListener('mouseleave', ()=>{ tip.style.display='none'; });
			}
		})();
		</script>
	</body>
</html>
