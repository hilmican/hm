<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Haritalandirma Sihirbazi</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
        .layout { display: grid; grid-template-columns: 340px 1fr; gap: 16px; }
        .card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
        .card h2 { margin: 0; padding: 10px 12px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; position: sticky; top: 0; z-index: 1; }
        .card .inner { padding: 12px; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        li:hover { background: #fafafa; }
        label { font-size: 12px; color: #6b7280; display:block; margin-top: 8px; }
        input, select { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
        th { background: #fafafa; }
        .toolbar { display:flex; gap:8px; align-items:center; margin-bottom: 10px; }
        .pill { font-size: 12px; padding: 2px 8px; background: #eef2ff; color: #4338ca; border-radius: 999px; }
        button { background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer }
        /* AI-injected rows highlight */
        .ai-suggested { border: 2px solid #10b981; }
        /* Modal basic styles */
        #aiProductModal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 50; }
        #aiProductModal .modal-card { width: min(960px, 96vw); max-height: 84vh; overflow: auto; background: #fff; border-radius: 10px; border: 1px solid #e5e7eb; }
        #aiProductModal .modal-card h3 { margin: 0; padding: 12px 14px; background:#f9fafb; border-bottom:1px solid #e5e7eb; font-size: 15px; }
        #aiProductModal .modal-card .body { padding: 12px; }
        #aiProductModal table { width: 100%; border-collapse: collapse; }
        #aiProductModal th, #aiProductModal td { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
        #aiProductModal .actions { display:flex; gap:8px; justify-content: flex-end; padding: 12px; border-top:1px solid #e5e7eb; }
        .muted { color: #6b7280; font-size: 12px; }
        /* Button spinner */
        .btn-loading { opacity: 0.8; cursor: default; }
        .spinner { display:inline-block; width:14px; height:14px; border:2px solid rgba(255,255,255,0.9); border-top-color: transparent; border-radius:50%; vertical-align:middle; margin-right:6px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="toolbar">
        <a href="/dashboard" style="color:#2563eb;text-decoration:none">← Dashboard</a>
        <span class="pill"><span id="unmatchedCount">{{ total_unmatched or 0 }}</span> row(s) unmatched</span>
        <span class="muted">Source: {{ source }}{% if filenames %}, Files: {{ ", ".join(filenames) }}{% else %}, File: {{ filename }}{% endif %}</span>
        <button id="rescanBtn" type="button">Re-scan</button>
        <button id="aiSuggestBtn" type="button" style="background:#7c3aed">AI ile Öneri Al</button>
        <button id="commitBtn" style="margin-left:auto" disabled>Commit Import</button>
    </div>

    <div class="layout">
        <div class="card" style="grid-column: 1">
            <h2>Eslesmeyen Patternler</h2>
            <div class="inner">
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                    <input id="investigatePat" type="text" placeholder="Arastirilacak pattern (opsiyonel)" style="padding:6px 8px;border:1px solid #ddd;border-radius:6px;flex:1" />
                    <button id="investigateBtn" type="button">Arastir</button>
                </div>
                <ul id="patList">
                    {% for p in unmatched_patterns %}
                    <li data-pattern="{{ p.pattern }}" data-suggested-price="{{ p.suggested_price or '' }}">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <span>{{ p.pattern }}</span>
                            <span class="pill" title="Occurrence count in uploaded file">{{ p.count }}</span>
                        </div>
                        {% if p.samples %}<div class="muted">Samples: {{ ", ".join(p.samples) }}</div>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="card" style="grid-column: 2">
            <h2>Editor</h2>
            <div class="inner">
                <div id="editorEmpty" class="muted">Mapping icin bir pattern secin.</div>
                <div id="editor" style="display:none">
                    <label>Pattern</label>
                    <input id="pat" type="text" readonly />

                    <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end;margin-top:8px;">
                        <div>
                            <label>Urun</label>
                            <select id="product"></select>
                        </div>
                        <div>
                            <button id="newProdBtn" type="button">Yeni Urun</button>
                        </div>
                    </div>

                    <div style="margin-top:10px;">
                        <label>Ciktilar (urun, beden, renk, adet, fiyat)</label>
                        <table>
                            <thead><tr><th>Product</th><th>Size</th><th>Color</th><th>Qty</th><th>Price</th><th></th></tr></thead>
                            <tbody id="outs"></tbody>
                        </table>
                        <button id="addOut" type="button" style="margin-top:6px">Cikti Ekle</button>
                        <div id="priceHint" class="muted" style="margin-top:6px"></div>
                    </div>

                    <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
                        <button id="saveRule" type="button" title="Saves a mapping rule for this pattern with the outputs listed below.">Save Rule</button>
                        <button id="saveNext" type="button" style="background:#10b981" title="Saves the rule and jumps to the next unmatched pattern.">Save & Next</button>
                        <span id="saveMsg" class="muted"></span>
                    </div>

                    <div style="margin-top:14px;">
                        <label>Stok (secili urun)</label>
                        <table>
                            <thead><tr><th>Variant</th><th>On-hand</th></tr></thead>
                            <tbody id="inv"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- AI panel removed in favor of product-first modal -->
        {% if filenames and filenames|length > 1 %}
        <div class="card" style="grid-column: 1">
            <h2>Dosya Bazli Tarihler</h2>
            <div class="inner">
                <table>
                    <thead><tr><th>Dosya</th><th>Data tarihi (YYYY-MM-DD)</th></tr></thead>
                    <tbody id="datesTbody">
                        {% for fn in filenames %}
                        <tr>
                            <td>{{ fn }}</td>
                            <td><input type="date" data-filename="{{ fn }}" /></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="muted">Each file will use its specific date during commit.</div>
            </div>
        </div>
        {% endif %}
        
    </div>

    <script>
    const products = {{ products | tojson if products else '[]' }};
    const source = {{ source | tojson }};
    const filename = {{ filename | tojson }};
    const filenames = {{ filenames | tojson if filenames else 'null' }};
    const unmatchedCountEl = document.getElementById('unmatchedCount');
    const commitBtn = document.getElementById('commitBtn');
    const rescanBtn = document.getElementById('rescanBtn');
    const datesTbody = document.getElementById('datesTbody');

    function setCommitEnabled(enabled){
        if (enabled) { commitBtn.removeAttribute('disabled'); }
        else { commitBtn.setAttribute('disabled','disabled'); }
    }
    async function refreshPreviewCount(){
        try {
            const body = filenames && Array.isArray(filenames) ? { source, filenames, exclude_generic: false } : { source, filename, exclude_generic: false };
            const r = await fetch('/import/preview-map', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            if (r.ok) {
                const j = await r.json();
                if (unmatchedCountEl) unmatchedCountEl.textContent = String(j.total_unmatched||0);
                setCommitEnabled((j.total_unmatched||0) === 0);
                return j;
            }
        } catch (e) {}
        return null;
    }
    setCommitEnabled((Number(unmatchedCountEl?.textContent||'0')||0) === 0);
    rescanBtn.addEventListener('click', refreshPreviewCount);

    const patList = document.getElementById('patList');
    const editor = document.getElementById('editor');
    const editorEmpty = document.getElementById('editorEmpty');
    const patInp = document.getElementById('pat');
    const productSel = document.getElementById('product');
    const outsTbody = document.getElementById('outs');
    const invTbody = document.getElementById('inv');
    const saveMsg = document.getElementById('saveMsg');
    const investigateBtn = document.getElementById('investigateBtn');
    const investigatePat = document.getElementById('investigatePat');
    const aiBtn = document.getElementById('aiSuggestBtn');
    // Modal state
    let aiSuggestions = null;
    let aiRuleMap = {};

    function refillProducts(selectedId){
        productSel.innerHTML = '';
        for (const p of products){
            const opt = document.createElement('option');
            opt.value = p.id; opt.textContent = p.name;
            if (selectedId && Number(selectedId) === Number(p.id)) opt.selected = true;
            productSel.appendChild(opt);
        }
    }

    function addOutputRow(pref, opts){
        const tr = document.createElement('tr');
        // determine default product for the row: use provided, else current selector, else first product
        const defPid = (pref && pref.product_id) ? Number(pref.product_id) : (Number(productSel?.value||0)|| (products[0]?.id||''));
        let prodOpts = '<option value=""></option>';
        for (const p of products){
            const sel = Number(p.id) === Number(defPid) ? 'selected' : '';
            prodOpts += `<option value="${p.id}" ${sel}>${p.name}</option>`;
        }
        tr.innerHTML = `
            <td><select class="prodSel">${prodOpts}</select></td>
            <td><input type="text" placeholder="Size" value="${pref?.size||''}"/></td>
            <td><input type="text" placeholder="Color" value="${pref?.color||''}"/></td>
            <td><input type="number" min="1" value="${pref?.quantity||1}"/></td>
            <td><input type="number" step="0.01" value="${pref?.unit_price||''}"/></td>
            <td><button type="button" class="rm">X</button></td>
        `;
        tr.querySelector('.rm').addEventListener('click', ()=> tr.remove());
        if (opts && opts.isAI) tr.classList.add('ai-suggested');
        outsTbody.appendChild(tr);

        // Default color fallback on render and on product change (only if empty)
        try {
            const prodSelEl = tr.querySelector('.prodSel');
            const colorInp = tr.querySelector('td:nth-child(3) input');
            function applyDefaultColorIfEmpty(){
                if (!colorInp.value){
                    const pidNow = Number(prodSelEl.value||0);
                    const prod = (products||[]).find(p=>Number(p.id)===pidNow);
                    if (prod && prod.default_color) colorInp.value = prod.default_color;
                }
            }
            applyDefaultColorIfEmpty();
            prodSelEl.addEventListener('change', applyDefaultColorIfEmpty);
        } catch(_) {}
    }

    function guessFromPattern(txt){
        txt = txt || '';
        const up = txt.toUpperCase();
        const sizeTokens = ['XS','S','M','L','XL','XXL','30','31','32','33','34','35','36','38','40','42'];
        const colorTokens = ['SİYAH','SIYAH','LACİVERT','LACIVERT','KREM','AÇIK GRİ','ACIK GRI','GRİ','GRI','BEYAZ'];
        let size = ''; for (const t of sizeTokens){ if (up.includes(t)) { size = t; break; } }
        let color = ''; for (const t of colorTokens){ if (up.includes(t)) { color = t; break; } }
        const isCift = up.includes('ÇİFT')||up.includes('CIFT');
        const isTek = up.includes('TEK');
        let quantity = isCift ? 2 : 1;
        if (isTek) quantity = 1;
        // detect numeric pack patterns like "3LÜ", "2LI", "x2", "2 ADET"
        try {
            const m1 = up.match(/(\d+)\s*(L[IUÜİ]|ADET)\b/);
            const m2 = up.match(/X\s*(\d+)/);
            const n = m1 ? Number(m1[1]) : (m2 ? Number(m2[1]) : NaN);
            if (!isNaN(n) && n > 0) quantity = n;
        } catch (_) {}
        return { size, color, quantity };
    }

    function loadInventory(productId){
        invTbody.innerHTML = '';
        if (!productId) return;
        fetch(`/inventory/stock?product_id=${productId}`)
          .then(r=>r.json()).then(j=>{
            for (const it of (j.items||[])){
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${it.name}</td><td>${it.on_hand}</td>`;
                invTbody.appendChild(tr);
            }
          }).catch(()=>{});
    }

    function openPattern(pat){
        editorEmpty.style.display = 'none';
        editor.style.display = '';
        patInp.value = pat;
        refillProducts();
        outsTbody.innerHTML = '';
        // Prefer AI outputs if available
        if (aiRuleMap && aiRuleMap[pat] && aiRuleMap[pat].length){
            for (const o of aiRuleMap[pat]){
                addOutputRow({ product_id:o.product_id, size:o.size, color:o.color, quantity:o.quantity, unit_price:o.unit_price }, { isAI: true });
            }
        } else {
            addOutputRow(guessFromPattern(pat));
        }
        if (productSel.value) loadInventory(productSel.value);
        // price hint and prefill from suggested price
        try {
            const li = [...patList.querySelectorAll('li[data-pattern]')].find(x=>x.getAttribute('data-pattern')===pat);
            const hintEl = document.getElementById('priceHint');
            const valStr = li ? li.getAttribute('data-suggested-price') : null;
            const val = valStr ? Number(valStr) : NaN;
            if (!isNaN(val) && val > 0) {
                hintEl.textContent = `Suggested price: ${val}`;
                const priceInput = outsTbody.querySelector('tr td:nth-child(5) input');
                if (priceInput && !priceInput.value) priceInput.value = String(val);
            } else {
                hintEl.textContent = '';
            }
        } catch (e) {}
    }

    patList.addEventListener('click', (e)=>{
        const li = e.target.closest('li[data-pattern]');
        if (!li) return;
        openPattern(li.getAttribute('data-pattern'));
    });

    document.getElementById('addOut').addEventListener('click', ()=> addOutputRow({quantity:1}));
    productSel.addEventListener('change', ()=> loadInventory(productSel.value));

    document.getElementById('newProdBtn').addEventListener('click', async ()=>{
        const name = prompt('Yeni urun adi?');
        if (!name) return;
        const fd = new FormData();
        fd.append('name', name);
        fd.append('default_unit', 'adet');
        try {
            const r = await fetch('/products', { method:'POST', body: fd });
            if (!r.ok) throw new Error(await r.text());
            const j = await r.json();
            products.unshift({ id: j.id, name: j.name });
            refillProducts(j.id);
        } catch (e) { alert('Ürün oluşturma hatası'); }
    });

    async function saveRuleCore(){
        const pattern = patInp.value;
        const outputs = [];
        for (const tr of outsTbody.querySelectorAll('tr')){
            const tds = tr.querySelectorAll('td');
            const productId = Number(tds[0].querySelector('select').value || 0) || null;
            const size = tds[1].querySelector('input').value || null;
            const color = tds[2].querySelector('input').value || null;
            const qty = Number(tds[3].querySelector('input').value || 1);
            const priceVal = tds[4].querySelector('input').value;
            const unit_price = priceVal ? Number(priceVal) : null;
            outputs.push({ product_id: productId, size, color, quantity: qty, unit_price });
        }
        const body = { source_pattern: pattern, match_mode: 'exact', priority: 100, outputs };
        const r = await fetch('/mappings/rules', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (!r.ok) throw new Error(await r.text());
        // reload saved outputs into editor so navigating back preserves them
        try {
            const rs = await fetch(`/mappings/rules?pattern=${encodeURIComponent(pattern)}`);
            if (rs.ok) {
                const jr = await rs.json();
                const rules = jr.rules||[];
                if (rules.length) {
                    const outs = rules[0].outputs||[];
                    outsTbody.innerHTML = '';
                    for (const o of outs) addOutputRow({ product_id:o.product_id, size:o.size, color:o.color, quantity:o.quantity, unit_price:o.unit_price });
                }
            }
        } catch (e) {}
    }

    document.getElementById('saveRule').addEventListener('click', async ()=>{
        saveMsg.textContent = 'Saving...';
        try { await saveRuleCore(); saveMsg.textContent = 'Saved.'; await refreshPreviewCount(); }
        catch (e) { saveMsg.textContent = 'Save error'; }
    });
    document.getElementById('saveNext').addEventListener('click', async ()=>{
        saveMsg.textContent = 'Saving...';
        try { await saveRuleCore(); saveMsg.textContent = 'Saved.'; await refreshPreviewCount(); }
        catch (e) { saveMsg.textContent = 'Save error'; return; }
        // move to next pattern
        const cur = patInp.value;
        const lis = [...patList.querySelectorAll('li[data-pattern]')];
        const idx = lis.findIndex(li=>li.getAttribute('data-pattern')===cur);
        if (idx>=0 && idx+1<lis.length){ openPattern(lis[idx+1].getAttribute('data-pattern')); }
    });

    investigateBtn?.addEventListener('click', async ()=>{
        try {
            const pat = (investigatePat && investigatePat.value) || (document.querySelector('#patList li[data-pattern]')?.getAttribute('data-pattern')) || '';
            const body = filenames && Array.isArray(filenames) ? { source, filenames, exclude_generic: false, return_rows: true, rows_limit: 200, pattern: pat } : { source, filename, exclude_generic: false, return_rows: true, rows_limit: 200, pattern: pat };
            const r = await fetch('/import/preview-map', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            if (!r.ok) { alert('Investigate error'); return; }
            const j = await r.json();
            const list = (j.unmatched_rows||[]).map(row=>`• ${row.base} | ${row.item_name||''} | ${row.name||''} | ${row.phone||''} | qty:${row.quantity||''} | total:${row.total_amount||''} | file:${row.filename} #${row.row_index}`).join('\n');
            alert(list || 'No rows found for this pattern.');
        } catch (e) { alert('Investigate error'); }
    });

    document.getElementById('commitBtn').addEventListener('click', async ()=>{
        let body;
        // If multiple files, require per-file dates; if single file, prompt for one date
        if (filenames && Array.isArray(filenames) && filenames.length > 1) {
            const map = {};
            let missing = false;
            if (datesTbody) {
                for (const inp of datesTbody.querySelectorAll('input[type="date"][data-filename]')){
                    const fn = inp.getAttribute('data-filename');
                    const v = inp.value;
                    if (!v) { missing = true; break; }
                    map[fn] = v;
                }
            }
            if (missing) { alert('Please fill all dates.'); return; }
            body = { source, filenames, data_dates: map };
        } else {
            const data_date = prompt('Data date (YYYY-MM-DD)?');
            if (!data_date) return;
            // Prefer explicit single filename if available, otherwise fall back to list[0]
            const single = (typeof filename === 'string' && filename) ? filename : (Array.isArray(filenames) && filenames.length ? filenames[0] : null);
            body = single ? { source, filename: single, data_date } : { source, filename, data_date };
        }
        try {
            const r = await fetch('/import/commit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            if (!r.ok) {
                let txt = await r.text();
                try {
                    const j = JSON.parse(txt);
                    if (j && j.detail && j.detail.error === 'unmatched_mappings' && j.detail.next) {
                        if (confirm(`${j.detail.total_unmatched} eşleşmeyen ürün var. Haritalandırma sayfasına dönmek ister misiniz?`)) {
                            location.href = j.detail.next;
                            return;
                        }
                    }
                } catch (_) { /* not json */ }
                alert(`Commit error: ${txt}`);
                return;
            }
            alert('Import committed.');
            location.href = '/dashboard';
        } catch (e) { alert('Commit error'); }
    });

    // --- AI suggestions (product-first modal) ---
    function slugifyClient(s){
        return String(s||'')
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
          .replace(/[^a-z0-9]+/g,'-')
          .replace(/(^-|-$)/g,'');
    }
    function buildSlugIndex(){
        const m = {};
        for (const p of (products||[])) if (p.slug) m[p.slug] = p.id;
        return m;
    }
    let slugIndex = buildSlugIndex();
    function updateProducts(newProd){
        if (!newProd) return;
        products.unshift({ id:newProd.id, name:newProd.name, slug:newProd.slug, default_color: newProd.default_color||'' });
        slugIndex = buildSlugIndex();
    }
    function collectUnmatched(){
        const list = [];
        for (const li of patList.querySelectorAll('li[data-pattern]')){
            const pattern = li.getAttribute('data-pattern');
            const count = Number(li.querySelector('.pill')?.textContent||'0')||0;
            const suggested_price = Number(li.getAttribute('data-suggested-price')||'')||null;
            // samples are not in DOM; omitted here (server investigates if needed)
            list.push({ pattern, count, samples: [], suggested_price });
        }
        return list;
    }
    // Build product-first modal markup once and reuse
    (function ensureModal(){
        if (document.getElementById('aiProductModal')) return;
        const wrap = document.createElement('div');
        wrap.id = 'aiProductModal';
        wrap.innerHTML = `
            <div class="modal-card">
              <h3>AI Ürün Önerileri</h3>
              <div class="body">
                <div id="aiModalMsg" class="muted" style="margin-bottom:8px"></div>
                <table id="aiModalTbl">
                  <thead><tr><th>Ad</th><th>Slug</th><th>Birim</th><th>Varsayılan Renk</th><th>Fiyat</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="actions">
                <button type="button" id="aiModalClose" style="background:#6b7280">Kapat</button>
                <button type="button" id="aiModalNext" style="background:#10b981">Next</button>
              </div>
            </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#aiModalClose').addEventListener('click', ()=>{ wrap.style.display='none'; });
        wrap.addEventListener('click', (e)=>{ if (e.target===wrap) wrap.style.display='none'; });
    })();

    function renderAiProductRows(rows){
        const tb = document.querySelector('#aiModalTbl tbody');
        const msg = document.getElementById('aiModalMsg');
        if (!tb) return;
        tb.innerHTML = '';
        for (const r of (rows||[])){
            const tr = document.createElement('tr');
            const defaultName = r.name||'';
            const defaultUnit = r.default_unit||'adet';
            const defaultPrice = (r.default_price==null||r.default_price===undefined)?'':String(r.default_price);
            const initialSlug = slugifyClient(defaultName);
            const exists = !!slugIndex[initialSlug];
            tr.innerHTML = `
              <td><input class="pname" value="${defaultName}"/></td>
              <td class="pslug">${initialSlug}</td>
              <td><input class="punit" value="${defaultUnit}"/></td>
              <td><input class="pcolor" placeholder="Varsayılan renk" value="${r.default_color||''}"/></td>
              <td><input class="pprice" type="number" step="0.01" value="${defaultPrice}"/></td>
              <td><button type="button" class="pcreate" ${exists? 'disabled title="Already exists"':''}>Create</button></td>
            `;
            const inpName = tr.querySelector('.pname');
            inpName.addEventListener('input', ()=>{
                const s = slugifyClient(inpName.value||'');
                tr.querySelector('.pslug').textContent = s;
                const ex = !!slugIndex[s];
                const btn = tr.querySelector('.pcreate');
                if (ex) { btn.setAttribute('disabled','disabled'); btn.title = 'Already exists'; }
                else { btn.removeAttribute('disabled'); btn.title=''; }
            });
            tr.querySelector('.pcreate').addEventListener('click', async ()=>{
                const fd = new FormData();
                const n = tr.querySelector('.pname').value;
                const u = tr.querySelector('.punit').value || 'adet';
                const pv = tr.querySelector('.pprice').value;
                const dc = tr.querySelector('.pcolor').value || '';
                fd.append('name', n);
                fd.append('default_unit', u);
                if (pv !== '') fd.append('default_price', pv);
                if (dc) fd.append('default_color', dc);
                try {
                    const r = await fetch('/products', { method:'POST', body: fd });
                    if (!r.ok) throw new Error(await r.text());
                    const j = await r.json();
                    updateProducts(j);
                    const btn = tr.querySelector('.pcreate');
                    btn.setAttribute('disabled','disabled');
                    btn.textContent = 'Created';
                } catch (e) { alert('Ürün oluşturma hatası'); }
            });
            tb.appendChild(tr);
        }
        msg.textContent = rows && rows.length ? '' : 'AI herhangi bir ürün önermedi.';
    }

    function inferQuantityFromPattern(txt){
        txt = txt || '';
        const up = txt.toUpperCase();
        if (up.includes('TEK')) return 1;
        if (up.includes('ÇİFT') || up.includes('CIFT')) return 2;
        try {
            const m1 = up.match(/(\d+)\s*(L[IUÜİ]|ADET)\b/);
            if (m1) return Math.max(1, Number(m1[1]));
            const m2 = up.match(/X\s*(\d+)/);
            if (m2) return Math.max(1, Number(m2[1]));
        } catch (_) {}
        return null;
    }

    async function applyAiToRuleMap(){
        aiRuleMap = {};
        const rules = (aiSuggestions && aiSuggestions.mappings_to_create) || [];
        for (const r of rules){
            const outs = [];
            for (const o of (r.outputs||[])){
                let pid = null;
                if (o.product_name){
                    const s = slugifyClient(o.product_name);
                    if (slugIndex[s]) pid = slugIndex[s];
                }
                // Quantity correction from pattern tokens (TEK/ÇİFT/x2/3LÜ/..)
                // If no explicit quantity indicator exists in the pattern, FORCE 1 (ignore AI quantity)
                const inferred = inferQuantityFromPattern(r.source_pattern||'');
                let q = (inferred !== null) ? inferred : 1;
                // Default color fallback from product when AI did not set a color
                let colorVal = (o.color||'').trim() || null;
                if (!colorVal && pid){
                    try {
                        const prod = (products||[]).find(pp=>Number(pp.id)===Number(pid));
                        if (prod && prod.default_color) colorVal = prod.default_color;
                    } catch(_) {}
                }
                outs.push({ product_id: pid, size: o.size||null, color: colorVal, quantity: q, unit_price: (o.unit_price===''?null:o.unit_price) });
            }
            aiRuleMap[r.source_pattern] = outs;
        }
    }
    aiBtn?.addEventListener('click', async ()=>{
        if (!aiBtn) return;
        const originalText = aiBtn.textContent;
        aiBtn.classList.add('btn-loading');
        aiBtn.disabled = true;
        aiBtn.innerHTML = '<span class="spinner"></span>Öneriler alınıyor...';
        try {
            const unmatched = collectUnmatched();
            const r = await fetch('/mappings/ai/suggest', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ unmatched_patterns: unmatched, context: { products } })});
            if (!r.ok) throw new Error(await r.text());
            aiSuggestions = await r.json();
            renderAiProductRows(aiSuggestions.products_to_create||[]);
            document.getElementById('aiModalMsg').textContent = (aiSuggestions.warnings&&aiSuggestions.warnings.length) ? aiSuggestions.warnings.join(' • ') : '';
            document.getElementById('aiProductModal').style.display = 'flex';
        } catch (e) { alert('Öneri hatası'); }
        finally {
            aiBtn.classList.remove('btn-loading');
            aiBtn.disabled = false;
            aiBtn.textContent = originalText;
        }
    });
    document.addEventListener('click', async (e)=>{
        if (e.target && e.target.id === 'aiModalNext'){
            await applyAiToRuleMap();
            document.getElementById('aiProductModal').style.display = 'none';
        }
    });
    </script>
</body>
</html>


