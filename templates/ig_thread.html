<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Conversation {{ conversation_id }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .toolbar { display:flex; gap:8px; margin-bottom:12px; }
      .msg { margin:8px 0; display:flex; }
      .bubble { max-width: 70%; padding:10px 12px; border-radius:12px; }
      .in .bubble { background:#f3f4f6; margin-right:auto; }
      .out .bubble { background:#dbeafe; margin-left:auto; }
      .meta { color:#6b7280; font-size:12px; margin-top:4px; }
      button { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
      a { color:#2563eb; text-decoration:none; }
      .toolbar .action { border:1px solid #2563eb; border-radius:6px; padding:6px 10px; font-size:13px; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <div class="toolbar">
      <a href="/ig/inbox">← Back to Inbox</a>
      <a class="action" href="/ig/inbox/{{ conversation_id }}/debug" title="AI Debug">AI Debug</a>
      <button id="refresh">Refresh</button>
    </div>
    {% if shadow and shadow.text and not inline_drafts %}
      <div style="margin:12px 0; padding:12px; border:1px dashed #93c5fd; background:#eff6ff; border-radius:10px;">
        <div style="font-weight:600; color:#1e40af; margin-bottom:6px;">AI Öneri (gönderilmedi)</div>
        <div style="white-space:pre-wrap; color:#111827;">{{ shadow.text }}</div>
        {% if shadow.timestamp_ms %}
          <div class="meta"><span class="ts" data-ts="{{ shadow.timestamp_ms }}">{{ shadow.timestamp_ms }}</span></div>
        {% endif %}
        <div class="meta" style="margin-top:6px;">
          model={{ shadow.model or '-' }} · güven={{ ('%.2f' % shadow.confidence) if shadow.confidence is not none else '-' }} · sebep={{ shadow.reason or '-' }}
        </div>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="useShadow" class="action" type="button">Metni kutuya al</button>
          <button id="dismissShadow" class="action" type="button" style="border-color:#ef4444;color:#ef4444">Gizle</button>
        </div>
      </div>
    {% endif %}
  <div style="margin-top:18px">
    <h3>AI Çıktısı</h3>
    {% if ai_status %}<div class="meta">Durum: {{ ai_status }}</div>{% endif %}
    <pre id="aiBox" style="background:#0b1021;color:#e5e7eb; padding:12px; border-radius:8px; max-height:300px; overflow:auto; white-space:pre-wrap;">{{ ai_json or 'Henüz AI verisi yok.' }}</pre>
    {% if focus_product %}
      <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
        <h4 style="margin:0 0 8px 0; color:#111827;">Ürün AI Talimatları
          {% if focus_product.id %}
            <a href="/ig/ai/products?focus={{ focus_product.slug or focus_product.name or 'default' }}" target="_blank" rel="noopener" class="meta" style="margin-left:6px;">(düzenle)</a>
          {% endif %}
        </h4>
        <div class="meta">
          Ürün: {{ focus_product.name or '-' }}
          {% if focus_product.confidence is not none %} · güven: {{ '%.2f' % focus_product.confidence }}{% endif %}
        </div>
        {% if focus_product.system %}
          <div style="margin-top:8px; white-space:pre-wrap; font-size:13px;"><strong>System:</strong> {{ focus_product.system }}</div>
        {% endif %}
        {% if focus_product.prompt %}
          <div style="margin-top:8px; white-space:pre-wrap; font-size:13px;"><strong>Prompt:</strong> {{ focus_product.prompt }}</div>
        {% endif %}
      </div>
    {% endif %}
    <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
      <h4 style="margin:0 0 8px 0; color:#111827;">Zenginleştirme Durumu</h4>
      {% if enrich %}
        <div class="meta">Kullanıcı: {{ enrich.username or '-' }} {% if enrich.name %} ({{ enrich.name }}){% endif %}</div>
        <div class="meta">Durum: {{ enrich.fetch_status or 'bilinmiyor' }} {% if enrich.fetched_at %}· fetched_at: {{ enrich.fetched_at }}{% endif %}</div>
        {% if enrich.fetch_error %}<div class="meta">Hata: {{ enrich.fetch_error }}</div>{% endif %}
        <div class="meta">Kuyruk (enrich_user) uzunluğu: {{ enrich.queue_depth if enrich.queue_depth is not none else '-' }}</div>
        {% if enrich.job and enrich.job.id %}
          <div class="meta">Bekleyen iş: #{{ enrich.job.id }} · attempts={{ enrich.job.attempts or 0 }} {% if enrich.job.run_after %}· run_after={{ enrich.job.run_after }}{% endif %}</div>
        {% else %}
          <div class="meta">Bekleyen enrich_user işi yok.</div>
        {% endif %}
      {% else %}
        <div class="meta">Zenginleştirme bilgisi mevcut değil.</div>
      {% endif %}
      <div style="margin-top:8px;">
        <button id="enrichNow" class="action" style="margin-right:6px">Şimdi Zenginleştir</button>
        <button id="hydrateNow" class="action" style="margin-right:6px">Hydrate Now</button>
        <button id="statusRefresh" class="action">Durumu Yenile</button>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnMergeGraph" class="action" title="dm:<id> → Graph CID'e taşı" style="background:#0ea5e9">Graph CID'e Birleştir</button>
        <button id="btnNormalizeDm" class="action" title="Eski mesajlarda dm:&lt;id&gt; conversation_id düzelt" style="background:#10b981">dm:&lt;id&gt; Normalize</button>
        <button id="btnBackfillAi" class="action" title="ai_conversations son mesaj alanlarını geri doldur" style="background:#6366f1">AI Özetlerini Geri Doldur</button>
      </div>
    </div>
    {% if contact_name or contact_phone or contact_address or linked_order_id %}
      <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
        <h4 style="margin:0 0 8px 0; color:#111827;">Çıkarılan Bilgiler</h4>
        <ul style="list-style:none; padding:0; margin:0; color:#374151; font-size:13px; display:grid; gap:6px;">
          {% if contact_name %}<li><strong>Ad:</strong> {{ contact_name }}</li>{% endif %}
          {% if contact_phone %}<li><strong>Telefon:</strong> <a href="tel:{{ contact_phone }}" style="color:#2563eb;">{{ contact_phone }}</a></li>{% endif %}
          {% if contact_address %}<li><strong>Adres:</strong> {{ contact_address }}</li>{% endif %}
          {% if linked_order_id %}<li><strong>Bağlı Sipariş:</strong> <a href="/orders/{{ linked_order_id }}/edit" style="color:#2563eb;">#{{ linked_order_id }}</a></li>{% endif %}
        </ul>
      </div>
    {% endif %}
  </div>
    <h2>
      Conversation {{ other_label or conversation_id }}
      {% if other_label %}<a class="meta" target="_blank" rel="noopener" href="https://instagram.com/{{ other_label[1:] }}">profile ↗</a>{% endif %}
      {% if contact_name or contact_phone or contact_address %}
        <div class="meta">{{ contact_name or '' }}{% if contact_name and contact_phone %} · {% endif %}{{ contact_phone or '' }}{% if (contact_name or contact_phone) and contact_address %} · {% endif %}{{ contact_address or '' }}</div>
      {% endif %}
    </h2>
    <div id="thread">
      {% for m in messages %}
        <div class="msg {{ m.direction or 'in' }}">
          <div class="bubble" {% if m.is_ai_draft %}style="border:1px dashed #93c5fd; background:#eff6ff;"{% endif %}>
            <div>
              {% set u_map = usernames if usernames is defined else {} %}
              {% set uname = m.sender_username or (u_map.get(m.ig_sender_id or '')) %}
              {% if uname %}
                <span class="meta">@{{ uname }}</span><br/>
              {% elif m.ig_sender_id %}
                <span class="meta">id: {{ m.ig_sender_id }}</span><br/>
              {% endif %}
              {{ m.text or '' }}
              {% if m.is_ai_draft %}
                <div class="meta" style="margin-top:4px">
                  AI Öneri · model: {{ m.ai_model or '-' }}{% if m.ai_reason %} · {{ m.ai_reason }}{% endif %}
                  {% if m.draft_id %}
                    · <a href="/ig/inbox/shadow/{{ m.draft_id }}" target="_blank" rel="noopener">Detayları gör</a>
                  {% endif %}
                </div>
                <div style="margin-top:6px">
                  <a class="action" href="/ig/ai/products?focus={{ m.product_slug or 'default' }}" target="_blank" rel="noopener">Ürün AI mesajlarını düzenle ↗</a>
                </div>
              {% endif %}
            </div>
            {% set local_ids = att_ids_map.get(m.ig_message_id or '') %}
            {% if local_ids %}
              {% for aid in local_ids %}
                <div style="margin-top:8px">
                  <img src="/ig/media/local/{{ aid }}" alt="attachment" style="max-width:280px;border-radius:8px;border:1px solid #e5e7eb" />
                </div>
              {% endfor %}
            {% elif att_map.get(m.ig_message_id) %}
              {% for idx in att_map.get(m.ig_message_id) %}
                <div style="margin-top:8px">
                  <img src="/ig/media/{{ m.ig_message_id }}/{{ idx }}" alt="attachment" style="max-width:280px;border-radius:8px;border:1px solid #e5e7eb" />
                </div>
              {% endfor %}
            {% endif %}
            <div class="meta"><span class="ts" data-ts="{{ m.timestamp_ms or '' }}">{{ m.timestamp_ms }}</span>
              {% if m.ad_id or m.ad_link or m.ad_title %}
                · Replied to an ad{% if m.ad_title or m.ad_id %}: {{ m.ad_title or m.ad_id }}{% endif %}
                {% set ad_url = m.ad_link or (('https://www.facebook.com/ads/library/?id=' ~ m.ad_id) if m.ad_id else None) %}
                {% if ad_url %} (<a target="_blank" rel="noopener" href="{{ ad_url }}">link</a>){% endif %}
                {% set ad = (ads_cache.get(m.ad_id|string) if (ads_cache is defined and m.ad_id) else None) %}
                {% set ap = (ad_products.get(m.ad_id|string) if (ad_products is defined and m.ad_id) else None) %}
                {% if ap and ap.product_name %}
                  · Ürün: {{ ap.product_name }}
                  {% if m.ad_id %}
                    <a class="meta" href="/ads/{{ m.ad_id }}/edit" title="Ürün bağlantısını düzenle">(düzenle)</a>
                  {% endif %}
                {% elif m.ad_id %}
                  · <a class="meta" href="/ads/{{ m.ad_id }}/edit" title="Reklamı ürüne bağla">Reklamı Bağla</a>
                {% endif %}
                {% if ad and ad.image_url %}
                  <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
                    <img src="{{ ad.image_url }}" alt="ad" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb" />
                    <div class="meta">{{ ad.name or '' }}</div>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
      {% if inline_drafts and shadow and shadow.text %}
        <div class="msg out">
          <div class="bubble" style="border:1px dashed #93c5fd; background:#eff6ff;">
            <div style="font-weight:600; color:#1e40af; margin-bottom:6px;">AI Öneri (gönderilmedi)</div>
            <div style="white-space:pre-wrap; color:#111827;">{{ shadow.text }}</div>
            <div class="meta" style="margin-top:6px;">
              model={{ shadow.model or '-' }} · güven={{ ('%.2f' % shadow.confidence) if shadow.confidence is not none else '-' }} · sebep={{ shadow.reason or '-' }}
            </div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button id="sendDraft" class="action" type="button">Gönder</button>
              <button id="editDraft" class="action" type="button">Düzenle</button>
              <button id="dismissDraft" class="action" type="button" style="border-color:#ef4444;color:#ef4444">Sil</button>
            </div>
          </div>
        </div>
      {% endif %}
      {% if not messages %}
        <div class="meta">No messages cached yet.</div>
      {% endif %}
    </div>
    <div style="margin-top:16px">
      <form id="replyForm" style="display:flex;gap:8px">
        <input id="replyInput" type="text" placeholder="Type a reply..." style="flex:1;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px" />
        <button id="sendBtn" type="submit" style="background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer">Send</button>
      </form>
    </div>
    <script>
      function fmtTs(){
        const nodes = document.querySelectorAll('.ts');
        for(const el of nodes){
          const v = el.getAttribute('data-ts');
          const ms = Number(v||0);
          if(ms>0){ const d = new Date(ms); el.textContent = d.toLocaleString(); }
          else { el.textContent = '-'; }
        }
      }
      fmtTs();

      const btn = document.getElementById('refresh');
      btn?.addEventListener('click', async () => {
        btn.disabled = true; btn.textContent = 'Refreshing...';
        try {
          const r = await fetch(location.pathname + '/refresh', { method: 'POST' });
          if (!r.ok) throw new Error('refresh failed');
          location.reload();
        } catch (e) { alert('Refresh error'); }
      });
      // Manual enrich enqueue
      const enrichBtn = document.getElementById('enrichNow');
      enrichBtn?.addEventListener('click', async () => {
        enrichBtn.disabled = true; const prev = enrichBtn.textContent; enrichBtn.textContent = 'Kuyruk kontrol ediliyor...';
        try {
          // Check queue sizes first
          let before = {};
          try {
            const qs = await fetch('/ig/queue/status');
            before = await qs.json();
          } catch {}
          enrichBtn.textContent = 'Kuyruğa ekleniyor...';
          const r = await fetch(location.pathname + '/enrich', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          // Get queue sizes after
          let after = {};
          try {
            const qs2 = await fetch('/ig/queue/status');
            after = await qs2.json();
          } catch {}
          alert('Enrich işi eklendi.\nÖnce: ' + JSON.stringify((before.queues||{})) + '\nSonra: ' + JSON.stringify((after.queues||{})));
          location.reload();
        } catch (e) { alert('Kuyruğa ekleme hatası'); }
        finally { enrichBtn.disabled = false; enrichBtn.textContent = prev; }
      });
      const statusBtn = document.getElementById('statusRefresh');
      statusBtn?.addEventListener('click', () => location.reload());
      const hydrateBtn = document.getElementById('hydrateNow');
      hydrateBtn?.addEventListener('click', async () => {
        hydrateBtn.disabled = true; const prev = hydrateBtn.textContent; hydrateBtn.textContent = 'Kuyruk kontrol ediliyor...';
        try {
          // Check queue sizes first
          let before = {};
          try {
            const qs = await fetch('/ig/queue/status');
            before = await qs.json();
          } catch {}
          hydrateBtn.textContent = 'Kuyruğa ekleniyor...';
          const r = await fetch(location.pathname + '/hydrate', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          // Get queue sizes after
          let after = {};
          try {
            const qs2 = await fetch('/ig/queue/status');
            after = await qs2.json();
          } catch {}
          alert('Hydrate kuyruğa eklendi: ' + (js.key || '') + '\nÖnce: ' + JSON.stringify((before.queues||{})) + '\nSonra: ' + JSON.stringify((after.queues||{})));
          location.reload();
        } catch (e) { alert('Hydrate kuyruğa ekleme hatası'); }
        finally { hydrateBtn.disabled = false; hydrateBtn.textContent = prev; }
      });
      // Admin helpers
      const btnMergeGraph = document.getElementById('btnMergeGraph');
      btnMergeGraph?.addEventListener('click', async () => {
        if (!confirm('Bu konuşmayı Graph CID\'e taşı?')) return;
        btnMergeGraph.disabled = true; const prev = btnMergeGraph.textContent; btnMergeGraph.textContent = 'Birleştiriliyor...';
        try {
          const r = await fetch(location.pathname + '/merge-to-graph', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Tamamlandı. Graph CID: ' + (js.graph_conversation_id||'') );
          // Redirect to new Graph CID if we were on dm:<id>
          if (js.graph_conversation_id) {
            location.href = '/ig/inbox/' + js.graph_conversation_id;
            return;
          }
          location.reload();
        } catch (e) { alert('Birleştirme hatası'); }
        finally { btnMergeGraph.disabled = false; btnMergeGraph.textContent = prev; }
      });
      const btnNormalizeDm = document.getElementById('btnNormalizeDm');
      btnNormalizeDm?.addEventListener('click', async () => {
        if (!confirm('Eski mesajlarda dm:<id> conversation_id normalize edilsin mi?')) return;
        btnNormalizeDm.disabled = true; const prev = btnNormalizeDm.textContent; btnNormalizeDm.textContent = 'Normalize ediliyor...';
        try {
          const r = await fetch('/ig/admin/normalize_dm_conversation_ids', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Normalize tamamlandı.\nİncelenen: ' + (js.considered||0) + '\nDüzeltilen: ' + (js.normalized||0));
          location.reload();
        } catch (e) { alert('Normalize hatası'); }
        finally { btnNormalizeDm.disabled = false; btnNormalizeDm.textContent = prev; }
      });
      const btnBackfillAi = document.getElementById('btnBackfillAi');
      btnBackfillAi?.addEventListener('click', async () => {
        if (!confirm('ai_conversations son mesaj alanları geri doldurulsun mu?')) return;
        btnBackfillAi.disabled = true; const prev = btnBackfillAi.textContent; btnBackfillAi.textContent = 'Geri dolduruluyor...';
        try {
          const r = await fetch('/ig/admin/backfill/ai_latest', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Geri doldurma tamamlandı.\nGüncellenen: ' + (js.updated||0) + '\nİşlenen: ' + (js.considered||0));
          location.reload();
        } catch (e) { alert('Geri doldurma hatası'); }
        finally { btnBackfillAi.disabled = false; btnBackfillAi.textContent = prev; }
      });
      // Live updates via WebSocket: reload when new message arrives for this conversation
      let wsConnected = false;
      const startWS = () => {
        try {
          const proto = location.protocol === 'https:' ? 'wss' : 'ws';
          const ws = new WebSocket(`${proto}://${location.host}/ig/ws`);
          ws.onopen = () => { wsConnected = true; };
          ws.onclose = () => { wsConnected = false; };
          ws.onerror = () => { wsConnected = false; };
          ws.onmessage = (ev) => {
            try {
              const data = JSON.parse(ev.data);
              if (data && data.type === 'ig_message' && data.conversation_id === 'dm:{{ conversation_id }}') {
                location.reload();
              }
            } catch {}
          };
        } catch { wsConnected = false; }
      };
      startWS();
      // Poll fallback every 15s if sockets fail
      setInterval(async () => {
        if (wsConnected) return;
        try { await fetch(location.pathname + '/refresh', { method: 'POST' }); location.reload(); } catch {}
      }, 15000);

      // Send reply
      const form = document.getElementById('replyForm');
      const input = document.getElementById('replyInput');
      const useShadow = document.getElementById('useShadow');
      const dismissShadow = document.getElementById('dismissShadow');
      const sendDraft = document.getElementById('sendDraft');
      const editDraft = document.getElementById('editDraft');
      const dismissDraft = document.getElementById('dismissDraft');
      useShadow?.addEventListener('click', () => {
        try {
          const txt = {{ (shadow.text if shadow and shadow.text else "") | tojson | safe }};
          if (input && txt) input.value = txt;
        } catch {}
      });
      dismissShadow?.addEventListener('click', async () => {
        try {
          dismissShadow.disabled = true;
          const r = await fetch(location.pathname + '/shadow/dismiss', { method: 'POST' });
          if (!r.ok) throw new Error('dismiss failed');
          location.reload();
        } catch (e) {
          alert('Gizleme hatası');
        } finally {
          dismissShadow.disabled = false;
        }
      });
      // Inline draft controls
      sendDraft?.addEventListener('click', async () => {
        try {
          sendDraft.disabled = true;
          const text = {{ (shadow.text if shadow and shadow.text else "") | tojson | safe }};
          if (!text) return;
          const r = await fetch(location.pathname + '/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
          if (!r.ok) throw new Error(await r.text());
          await fetch(location.pathname + '/shadow/dismiss', { method: 'POST' }).catch(()=>{});
          location.reload();
        } catch (e) {
          alert('Gönderme hatası');
        } finally {
          sendDraft.disabled = false;
        }
      });
      editDraft?.addEventListener('click', () => {
        try {
          const txt = {{ (shadow.text if shadow and shadow.text else "") | tojson | safe }};
          if (input && txt) { input.value = txt; input.focus(); }
        } catch {}
      });
      dismissDraft?.addEventListener('click', async () => {
        try {
          dismissDraft.disabled = true;
          const r = await fetch(location.pathname + '/shadow/dismiss', { method: 'POST' });
          if (!r.ok) throw new Error('dismiss failed');
          location.reload();
        } catch (e) {
          alert('Silme hatası');
        } finally {
          dismissDraft.disabled = false;
        }
      });
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = (input?.value || '').trim();
        if (!text) return;
        try {
          const r = await fetch(location.pathname + '/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
          if (!r.ok) {
            const t = await r.text();
            alert('Send failed: ' + t);
            return;
          }
          input.value = '';
          location.reload();
        } catch (e) {
          alert('Send error');
        }
      });
    </script>
  </body>
</html>

