<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
        th { background: #fafafa; position: sticky; top: 0; cursor: pointer; user-select: none; }
        tr:nth-child(even) { background: #fcfcfd; }
        .toolbar { margin: 12px 0; display: flex; gap: 8px; align-items: center; }
        .toolbar input { padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; width: 280px; }
        .pill { font-size: 12px; padding: 2px 8px; background: #eef2ff; color: #4338ca; border-radius: 999px; }
        a { color: #2563eb; text-decoration: none; }
    </style>
    <script>
        function filterTable(table, q){
            const rows = table.tBodies[0].rows; const s = q.trim().toLowerCase();
            for (const r of rows){ const txt = r.textContent.toLowerCase(); r.style.display = s && txt.indexOf(s) === -1 ? 'none' : ''; }
        }
        function cmp(a,b,isNum){ if(isNum){ const na=parseFloat(a.replace(',','.'))||0, nb=parseFloat(b.replace(',','.'))||0; return na-nb; } return a.localeCompare(b,'tr'); }
        function sortTable(table, idx, dir){
            const rows = Array.from(table.tBodies[0].rows);
            const isNum = table.tHead.rows[0].cells[idx].dataset.type === 'num';
            rows.sort((r1,r2)=>{ const a=r1.cells[idx].textContent.trim(); const b=r2.cells[idx].textContent.trim(); return dir==='asc'?cmp(a,b,isNum):cmp(b,a,isNum); });
            for(const r of rows) table.tBodies[0].appendChild(r);
        }
        function attach(table){ const ths=table.tHead.rows[0].cells; let active=-1, dir='asc'; for(let i=0;i<ths.length;i++){ ths[i].addEventListener('click',()=>{ dir=(active===i&&dir==='asc')?'desc':'asc'; active=i; sortTable(table,i,dir); }); } }
        function init(){ const table=document.getElementById('invTbl'); attach(table); const si=document.getElementById('search'); si.addEventListener('input',()=>filterTable(table, si.value)); }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</head>
<body>
    {% include "_nav.html" %}
    <div class="toolbar">
        <input id="search" type="search" placeholder="Stokta ara (ad, sku, beden, renk)" />
        <span class="pill">{{ rows|length }} varyant</span>
        <input id="sinceDate" type="date" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px;" />
        <button id="recalcBtn" type="button" style="background:#334155;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">Stokları yeniden hesapla</button>
        <span id="recalcMsg" class="pill" style="display:none"></span>
    </div>
    <div class="card" style="padding:12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:14px;">
        <h3 style="margin:0 0 8px 0; font-size:15px;">Seri Stok Ekle</h3>
        <form id="seriesForm" onsubmit="return false;" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <select id="productId" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:220px;">
                <option value="">Urun</option>
            </select>
            <select id="supplierId" required style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:200px;">
                <option value="">Cari seçin</option>
            </select>
            <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="display:flex; gap:6px; align-items:center;">
                    <select id="sizes" multiple size="4" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:200px;"></select>
                    <button id="selectAllSizes" type="button" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; background:#f9fafb; cursor:pointer;">Tumu</button>
                </div>
                <div style="display:flex; gap:6px; align-items:center;">
                    <input id="customSize" type="text" placeholder="Yeni beden ekle (orn. S)" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:160px;" />
                    <button id="addSize" type="button" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; background:#f9fafb; cursor:pointer;">Ekle</button>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="display:flex; gap:6px; align-items:center;">
                    <select id="colors" multiple size="4" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:200px;"></select>
                    <button id="selectAllColors" type="button" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; background:#f9fafb; cursor:pointer;">Tumu</button>
                </div>
                <div style="display:flex; gap:6px; align-items:center;">
                    <input id="customColor" type="text" placeholder="Yeni renk ekle (orn. Siyah)" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:160px;" />
                    <button id="addColor" type="button" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; background:#f9fafb; cursor:pointer;">Ekle</button>
                </div>
            </div>
            <input id="qty" type="number" min="1" value="1" placeholder="Qty/variant" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; width:120px;" />
            <input id="price" type="number" step="0.01" placeholder="Price (optional)" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; width:140px;" />
            <input id="cost" type="number" step="0.01" placeholder="Cost (optional)" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; width:140px;" />
            <button id="seriesBtn" type="button" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">Ekle</button>
            <span id="seriesMsg" class="pill" style="display:none"></span>
        </form>
    </div>
    <div class="card" style="padding:12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:14px;">
        <h3 style="margin:0 0 8px 0; font-size:15px;">Manuel Stok Düzeltme</h3>
        <form id="adjustForm" onsubmit="return false;" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <input id="adjustItemId" type="number" min="1" placeholder="Item ID" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; width:120px;" />
            <input id="adjustDelta" type="number" step="1" placeholder="Delta (örn. -2 veya 5)" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; width:180px;" />
            <button id="adjustBtn" type="button" style="background:#059669;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">Uygula</button>
            <span id="adjustMsg" class="pill" style="display:none"></span>
        </form>
    </div>
    <h2>Stok</h2>
    <div id="filterSummary" class="pill" style="display:none; margin: 6px 0; width: fit-content;">Filtrelenen: 0 · Toplam stok: 0</div>
    <table id="invTbl">
        <thead>
            <tr><th>ID</th><th>SKU</th><th>Ad</th><th>Urun</th><th>Beden</th><th>Renk</th><th data-type="num">Fiyat</th><th data-type="num">Stok</th></tr>
        </thead>
        <tbody>
            {% for it in rows %}
            <tr data-product-id="{{ it.product_id or '' }}" data-size="{{ it.size or '' }}" data-color="{{ it.color or '' }}" data-on-hand="{{ stock_map.get(it.id, 0) }}">
                <td>{{ it.id }}</td>
                <td>{{ it.sku }}</td>
                <td>{{ it.name }}</td>
                <td>{% if it.product_id %}{{ product_map.get(it.product_id, it.product_id) }}{% else %}-{% endif %}</td>
                <td>{{ it.size }}</td>
                <td>{{ it.color }}</td>
                
                <td>{{ it.price }}</td>
                <td>{{ stock_map.get(it.id, 0) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
<script>
const btn = document.getElementById('seriesBtn');
const msg = document.getElementById('seriesMsg');
const productSuppliers = {{ product_suppliers|tojson }};
const supplierMap = {{ supplier_map|tojson }};

function populateSuppliers(pid){
    const sel = document.getElementById('supplierId');
    if (!sel) return;
    const key = pid ? String(pid) : '';
    const list = key ? (productSuppliers[key] || []) : [];
    sel.innerHTML = '';
    if (!list.length){
        sel.innerHTML = '<option value="">Bu ürün için cari maliyeti yok</option>';
        return;
    }
    sel.innerHTML = '<option value="">Cari seçin</option>' + list.map(id => `<option value="${id}">${supplierMap[id]?.name || id}</option>`).join('');
    if (list.length === 1) sel.value = String(list[0]);
}

async function loadProducts(){
    try {
        const r = await fetch('/products?limit=500');
        if (!r.ok) return;
        const j = await r.json();
        const sel = document.getElementById('productId');
        sel.innerHTML = '<option value="">Product</option>' + (j.products||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    } catch {}
}
async function loadAttributes(pid){
    try {
        const r = await fetch(`/inventory/attributes?product_id=${pid}`);
        if (!r.ok) return;
        const j = await r.json();
        const fill = (elId, arr)=>{ const el=document.getElementById(elId); el.innerHTML = (arr||[]).map(v=>`<option value="${v}">${v}</option>`).join(''); };
        fill('sizes', j.sizes || []);
        fill('colors', j.colors || []);
        populateSuppliers(pid);
    } catch {}
}
    function selectAll(elId){ const el=document.getElementById(elId); for(const o of el.options) o.selected = true; }
    function addCustom(elId, inputId){ const el=document.getElementById(elId); const v=(document.getElementById(inputId).value||'').trim(); if(!v) return; if(![...el.options].some(o=>o.value===v)){ const opt = new Option(v, v, true, true); el.add(opt); } document.getElementById(inputId).value=''; }
const getSelected = id => Array.from(document.getElementById(id).selectedOptions || []).map(o=>o.value);

// --- Persist and restore filters across reloads ---
const LS_KEY = 'invFilterState';
function saveFilterState(){
    const pid = document.getElementById('productId')?.value || '';
    const sizes = getSelected('sizes');
    const colors = getSelected('colors');
    const q = document.getElementById('search')?.value || '';
    try { localStorage.setItem(LS_KEY, JSON.stringify({ pid, sizes, colors, q })); } catch {}
}
async function restoreFilterState(){
    let st = null;
    try { st = JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch {}
    if (!st) return;
    try {
        if (st.pid){
            const prodSel = document.getElementById('productId');
            if (prodSel) prodSel.value = String(st.pid);
            await loadAttributes(st.pid);
            populateSuppliers(st.pid);
        }
        const sizesEl = document.getElementById('sizes');
        const colorsEl = document.getElementById('colors');
        if (sizesEl && Array.isArray(st.sizes)){
            for (const opt of sizesEl.options) opt.selected = st.sizes.includes(opt.value);
        }
        if (colorsEl && Array.isArray(st.colors)){
            for (const opt of colorsEl.options) opt.selected = st.colors.includes(opt.value);
        }
        const si = document.getElementById('search'); if (si) si.value = st.q || '';
    } finally {
        try { localStorage.removeItem(LS_KEY); } catch {}
    }
}

    function applyInventoryFilter(){
        const pid = Number(document.getElementById('productId')?.value || 0);
        const sizes = getSelected('sizes');
        const colors = getSelected('colors');
        const q = (document.getElementById('search')?.value || '').trim().toLowerCase();
        const tbody = document.querySelector('#invTbl tbody');
        let visibleCount = 0;
        let totalOnHand = 0;
        if (!tbody) return;
        for (const tr of tbody.rows){
            const rowPid = Number(tr.getAttribute('data-product-id') || 0);
            const rowSize = (tr.getAttribute('data-size') || '').toString();
            const rowColor = (tr.getAttribute('data-color') || '').toString();
            const rowText = tr.textContent.toLowerCase();
            const matchesPid = !pid || rowPid === pid;
            const matchesSize = !sizes.length || sizes.includes(rowSize);
            const matchesColor = !colors.length || colors.includes(rowColor);
            const matchesSearch = !q || rowText.indexOf(q) !== -1;
            const show = matchesPid && matchesSize && matchesColor && matchesSearch;
            tr.style.display = show ? '' : 'none';
            if (show){
                visibleCount++;
                const oh = Number(tr.getAttribute('data-on-hand') || 0);
                if (!Number.isNaN(oh)) totalOnHand += oh;
            }
        }
        const sumEl = document.getElementById('filterSummary');
        const anyFilter = pid || sizes.length || colors.length || q;
        if (sumEl){
            if (anyFilter){
                sumEl.style.display = 'inline-block';
                sumEl.textContent = `Filtrelenen: ${visibleCount} · Toplam stok: ${totalOnHand}`;
            } else {
                sumEl.style.display = 'none';
            }
        }
    }

document.addEventListener('DOMContentLoaded', async ()=>{
    await loadProducts();
    await restoreFilterState();
    const supplierSel = document.getElementById('supplierId');
    const prodSel = document.getElementById('productId');
    if (prodSel) prodSel.addEventListener('change', async e=>{
        const pid=e.target.value;
        if(pid){
            await loadAttributes(pid);
            populateSuppliers(pid);
        } else {
            populateSuppliers(null);
        }
        applyInventoryFilter();
        suggestCostFromSupplier();
    });
    if (supplierSel) supplierSel.addEventListener('change', suggestCostFromSupplier);
        const sas = document.getElementById('selectAllSizes'); if (sas) sas.addEventListener('click', ()=>{ selectAll('sizes'); applyInventoryFilter(); });
        const sac = document.getElementById('selectAllColors'); if (sac) sac.addEventListener('click', ()=>{ selectAll('colors'); applyInventoryFilter(); });
        const asz = document.getElementById('addSize'); if (asz) asz.addEventListener('click', ()=>{ addCustom('sizes','customSize'); applyInventoryFilter(); });
        const acl = document.getElementById('addColor'); if (acl) acl.addEventListener('click', ()=>{ addCustom('colors','customColor'); applyInventoryFilter(); });
        const sizesEl = document.getElementById('sizes'); if (sizesEl) sizesEl.addEventListener('change', applyInventoryFilter);
        const colorsEl = document.getElementById('colors'); if (colorsEl) colorsEl.addEventListener('change', applyInventoryFilter);
        const si = document.getElementById('search'); if (si) si.addEventListener('input', applyInventoryFilter);
        applyInventoryFilter();
});

async function suggestCostFromSupplier(){
    const pid = Number(document.getElementById('productId')?.value || 0);
    const supplierId = Number(document.getElementById('supplierId')?.value || 0);
    if (!pid || !supplierId) return;
    try{
        const r = await fetch(`/products/${pid}/supplier-prices`);
        if(!r.ok) return;
        const j = await r.json();
        const entry = (j.supplier_prices||[]).find(sp=>Number(sp.supplier_id)===supplierId && (sp.item_id===null || sp.item_id===undefined));
        if (entry){
            const costEl = document.getElementById('cost');
            const priceEl = document.getElementById('price');
            if (costEl && entry.cost != null) costEl.value = entry.cost;
            if (priceEl && entry.price != null) priceEl.value = entry.price;
        }
    } catch(e){}
}

if (btn) {
    btn.addEventListener('click', async () => {
        const pid = Number(document.getElementById('productId').value || 0);
        const supplierId = Number(document.getElementById('supplierId').value || 0) || null;
        const sizes = getSelected('sizes');
        const colors = getSelected('colors'); // empty means default no-color will be used server-side
        const qty = Number(document.getElementById('qty').value || 0);
        
        const priceVal = document.getElementById('price').value;
        const price = priceVal ? Number(priceVal) : null;
        const costVal = document.getElementById('cost').value;
        const cost = costVal ? Number(costVal) : null;
        if (!pid || !sizes.length || qty <= 0) { alert('product_id, sizes ve qty gereklidir'); return; }
        if (!supplierId) { alert('Cari seçimi zorunlu'); return; }
        const body = { product_id: pid, sizes, colors, quantity_per_variant: qty, price, cost, supplier_id: supplierId };
        try {
            const r = await fetch('/inventory/series', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            if (!r.ok) throw new Error(await r.text());
            const j = await r.json();
            msg.style.display = 'inline-block';
            msg.textContent = `Eklendi: ${j.created_item_ids.length} variant`;
            // preserve filters and refresh view
            saveFilterState();
            setTimeout(()=> location.reload(), 400);
        } catch (e) {
            alert('Seri ekle hatası');
        }
    });
}

// Manual adjustment actions
const adjustBtn = document.getElementById('adjustBtn');
const adjustMsg = document.getElementById('adjustMsg');
if (adjustBtn){
    adjustBtn.addEventListener('click', async ()=>{
        const itemId = Number(document.getElementById('adjustItemId')?.value || 0);
        const delta = Number(document.getElementById('adjustDelta')?.value || 0);
        if (!itemId || !Number.isInteger(delta) || delta === 0){
            alert('Geçerli Item ID ve sıfır olmayan tam sayı delta giriniz');
            return;
        }
        try {
            adjustBtn.disabled = true;
            const r = await fetch('/inventory/movements', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ item_id: itemId, delta })
            });
            if (!r.ok){
                throw new Error(await r.text());
            }
            adjustMsg.style.display = 'inline-block';
            adjustMsg.textContent = 'Kaydedildi';
            saveFilterState();
            setTimeout(()=> location.reload(), 400);
        } catch(e){
            alert('Düzeltme hatası');
        } finally {
            adjustBtn.disabled = false;
        }
    });
}

// Recalculate inventory button
const recalcBtn = document.getElementById('recalcBtn');
const recalcMsg = document.getElementById('recalcMsg');
if (recalcBtn){
    recalcBtn.addEventListener('click', async ()=>{
        const pidVal = document.getElementById('productId')?.value || '';
        const pid = pidVal ? Number(pidVal) : null;
        const since = document.getElementById('sinceDate')?.value || null;
        const dryRun = false; // set true if you want to preview only
        const body = { product_id: pid || undefined, since: since || undefined, dry_run: dryRun };
        try {
            recalcBtn.disabled = true;
            const r = await fetch('/inventory/recalc', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            if (!r.ok){
                const t = await r.text();
                throw new Error(t);
            }
            const j = await r.json();
            recalcMsg.style.display = 'inline-block';
            recalcMsg.textContent = `OK · İşlenen: ${j.orders_processed}, Güncellenen: ${j.orders_updated}`;
            // preserve filters and refresh
            saveFilterState();
            setTimeout(()=> location.reload(), 600);
        } catch(e){
            alert('Yeniden hesaplama hatası');
        } finally {
            recalcBtn.disabled = false;
        }
    });
}
</script>
</html>
