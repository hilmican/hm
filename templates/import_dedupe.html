<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Kargo Çift Satır Düzeltme</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:24px; }
		h1 { margin-bottom: 12px; }
		table { width: 100%; border-collapse: collapse; }
		th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; text-align: left; font-size: 14px; }
		th { background: #f9fafb; }
		.card { border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-top:12px; background:#fff; }
		.btn { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-size:13px; }
		.btn.outline { background:#fff; color:#2563eb; border:1px solid #2563eb; }
		.badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:12px; background:#e0f2fe; color:#0ea5e9; }
		.rows { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
		.meta { color:#6b7280; font-size:12px; }
	</style>
</head>
<body>
	{% include "_nav.html" %}
	<h1>Kargo Çift Satır Düzeltme</h1>
	<form style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin:10px 0;" method="get" action="/import/dedupe/kargo">
		<div>
			<label style="font-size:12px;color:#475569;">Başlangıç</label><br/>
			<input type="date" name="start" value="{{ start }}" />
		</div>
		<div>
			<label style="font-size:12px;color:#475569;">Bitiş</label><br/>
			<input type="date" name="end" value="{{ end }}" />
		</div>
		<div>
			<label style="font-size:12px;color:#475569;">Limit</label><br/>
			<input type="number" name="limit" min="10" max="500" value="{{ limit }}" />
		</div>
		<div>
			<button class="btn" type="submit">Filtrele</button>
		</div>
	</form>
	<p class="meta">{{ start }} - {{ end }} aralığında, kargo import satırlarında hem ödeme=0 hem ödeme&gt;0 içeren ve duplicate nedeniyle atlananlar.</p>
	<p class="meta">Bulunan aday: {{ found }} (limit {{ limit }}). Düzelt: Ödemeleri rollback placeholderlardan gerçek siparişe taşır, siparişi paid yapar, toplam yoksa set eder.</p>

	{% if not candidates %}
		<div class="card">Kriterlere uyan kayıt bulunamadı.</div>
	{% endif %}

	{% for c in candidates %}
	<div class="card">
		<div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
			<div>
				<div><strong>Order #{{ c.order.id if c.order else c.order_id }}</strong> · {{ c.client.name if c.client else 'Müşteri yok' }}</div>
				<div class="meta">
					Run #{{ c.run.id }} · {{ c.run.filename }} · {{ c.run.started_at }} · Tracking: {{ c.tracking_no or '—' }}
				</div>
				<div class="meta">
					Order status: {{ c.order.status if c.order else '—' }} · total: {{ '%.2f'|format(c.order.total_amount or 0) if c.order else '0.00' }}
				</div>
			</div>
			<div>
				<button class="btn" onclick="fix({{ c.run.id }}, {{ c.order.id if c.order else c.order_id }}, this)">Düzelt</button>
			</div>
		</div>
		<div class="rows" style="margin-top:8px;">
			{% for r in c.rows %}
				<div>row {{ r.row_index }} · pay={{ r.payment_amount }} · fee_kargo={{ r.fee_kargo }} · msg={{ r.message }}</div>
			{% endfor %}
		</div>
		{% if c.placeholder_payments %}
			<div class="meta" style="margin-top:6px;">Placeholder ödemeleri: {{ c.placeholder_payments|length }} adet</div>
		{% endif %}
	</div>
	{% endfor %}

	<script>
	async function fix(runId, orderId, btn){
		if (!confirm(`#${orderId} için ödemeleri taşı ve paid yap?`)) return;
		const prev = btn.textContent;
		btn.disabled = true; btn.textContent = 'Çalışıyor...';
		try{
			const res = await fetch('/import/dedupe/kargo/fix', {
				method:'POST',
				headers:{'Content-Type':'application/x-www-form-urlencoded'},
				body: new URLSearchParams({ run_id: runId, order_id: orderId })
			});
			if(!res.ok){ const t = await res.text(); alert('Hata: '+t); return; }
			const j = await res.json();
			alert(`Taşındı: ${j.payments_moved} ödeme, toplam ${j.amount_moved}. Order #${orderId} paid.`);
			location.reload();
		}catch(err){
			console.error(err); alert('Hata: '+err);
		}finally{
			btn.disabled = false; btn.textContent = prev;
		}
	}
	</script>
</body>
</html>
