<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Instagram Gelen Kutusu</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .toolbar { display:flex; gap:8px; margin-bottom:12px; }
      .conv { border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-bottom:8px; }
      .meta { color:#6b7280; font-size:12px; }
      a { color:#2563eb; text-decoration:none; }
      button { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
      .meta-link { font-size:12px; border:1px solid #2563eb; border-radius:6px; padding:2px 6px; margin-left:6px; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <h1>Instagram Gelen Kutusu</h1>
    <div class="toolbar">
      <form method="get" action="/ig/inbox" style="display:flex;gap:8px;align-items:center;">
        <input type="text" name="q" placeholder="Mesajlarda ara..." value="{{ q or '' }}" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;min-width:280px" />
        <button type="submit">Ara</button>
        <a href="/ig/inbox" class="meta" style="margin-left:6px">Temizle</a>
      </form>
      <button id="refresh">Yenile</button>
      <button id="clearEnrich" style="background:#ef4444">Enrich Kuyruğunu Temizle</button>
      <button id="backfillAds" style="background:#10b981">Reklamları Geri Doldur</button>
      <button id="backfillAiLatest" style="background:#0ea5e9">Son Mesajları Geri Doldur</button>
      <form method="post" action="/ig/admin/backfill/ai_latest" style="display:inline;">
        <button type="submit" class="meta" style="background:#fff;color:#2563eb;border:1px solid #2563eb;">(Form ile gönder)</button>
      </form>
      <button id="enrichUsersErrors" style="background:#f59e0b">Hatalı Kullanıcıları Enrich Et</button>
      <form method="post" action="/ig/admin/enrich/users-errors" style="display:inline;">
        <button type="submit" class="meta" style="background:#fff;color:#2563eb;border:1px solid #2563eb;">(Form ile gönder)</button>
      </form>
    </div>
    <div id="list">
      {% for m in conversations %}
        <div class="conv">
          <div>
            <a href="/ig/inbox/{{ m.conversation_id }}">
              {% if names and names.get(m.conversation_id) %}
                {{ names.get(m.conversation_id) }} {% if labels and labels.get(m.conversation_id) %}· {{ labels.get(m.conversation_id) }}{% endif %}
              {% else %}
                {{ labels.get(m.conversation_id) or m.conversation_id }}
              {% endif %}
            </a>
            {% if labels and labels.get(m.conversation_id) %}
              <a class="meta" target="_blank" rel="noopener" href="https://instagram.com/{{ labels.get(m.conversation_id)[1:] }}">profil ↗</a>
            {% endif %}
            <a class="meta-link" href="/ig/inbox/{{ m.conversation_id }}/debug" title="AI Hata Ayıklama">AI Hata Ayıklama</a>
            {% if ad_map.get(m.conversation_id) %}
              {% set ad = ad_map.get(m.conversation_id) %}
              {% if ad.link %}
                <a class="meta" target="_blank" rel="noopener" href="{{ ad.link }}">· Ad</a>
              {% else %}
                <span class="meta">· Ad</span>
              {% endif %}
              {% if ad.title %}
                <span class="meta"> — {{ (ad.title or '')[:60] }}</span>
              {% endif %}
              {% if ad.id %}
                <a class="meta-link" href="/ads/{{ ad.id }}/edit" title="Reklamı ürüne bağla">Reklamı Bağla</a>
              {% endif %}
            {% endif %}
          </div>
          <div class="meta"><span class="ts" data-ts="{{ m.timestamp_ms or '' }}">{{ m.timestamp_ms }}</span> · {{ (m.text or '')[:120] }}</div>
        </div>
      {% endfor %}
      {% if not conversations %}
        <div class="meta">Henüz önbelleğe alınmış konuşma yok. Senkron için Yenile’ye tıklayın.</div>
      {% endif %}
    </div>
    <script>
      const btn = document.getElementById('refresh');
      btn?.addEventListener('click', async () => {
        btn.disabled = true; btn.textContent = 'Yenileniyor...';
        try {
          const r = await fetch('/ig/inbox/refresh', { method: 'POST' });
          if (!r.ok) throw new Error('yenileme başarısız');
          const js = await r.json();
          if (js.status !== 'ok') console.warn('Yenileme hatası', js);
          location.reload();
        } catch (e) { alert('Yenileme hatası'); }
      });
      const clearBtn = document.getElementById('clearEnrich');
      clearBtn?.addEventListener('click', async () => {
        if (!confirm('Enrich kuyruklarını temizlemek istediğinize emin misiniz?')) return;
        clearBtn.disabled = true; const prev = clearBtn.textContent; clearBtn.textContent = 'Temizleniyor...';
        try {
          const r = await fetch('/ig/inbox/clear-enrich', { method: 'POST' });
          if (!r.ok) throw new Error('temizleme başarısız');
          const js = await r.json();
          alert('Temizlendi: ' + JSON.stringify(js.cleared || {}));
        } catch (e) { alert('Temizleme hatası'); }
        finally { clearBtn.disabled = false; clearBtn.textContent = prev; }
      });
      const backfillBtn = document.getElementById('backfillAds');
      backfillBtn?.addEventListener('click', async () => {
        if (!confirm('Mesajlardan reklamları geri doldurmak ister misiniz?')) return;
        backfillBtn.disabled = true; const prev = backfillBtn.textContent; backfillBtn.textContent = 'Geri dolduruluyor...';
        try {
          const r = await fetch('/ig/admin/backfill/ads', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Reklam geri doldurma tamamlandı.\nOluşturulan: ' + (js.created||0) + '\nGüncellenen: ' + (js.updated||0));
          location.reload();
        } catch (e) { alert('Geri doldurma hatası'); }
        finally { backfillBtn.disabled = false; backfillBtn.textContent = prev; }
      });
      const backfillLatestBtn = document.getElementById('backfillAiLatest');
      backfillLatestBtn?.addEventListener('click', async () => {
        if (!confirm('Son mesaj özetlerini (ai_conversations) geri doldurmak ister misiniz?')) return;
        backfillLatestBtn.disabled = true; const prev = backfillLatestBtn.textContent; backfillLatestBtn.textContent = 'Geri dolduruluyor...';
        try {
          const r = await fetch('/ig/admin/backfill/ai_latest', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Geri doldurma tamamlandı.\nGüncellenen: ' + (js.updated||0) + '\nİşlenen: ' + (js.considered||0));
          location.reload();
        } catch (e) { alert('Geri doldurma hatası'); }
        finally { backfillLatestBtn.disabled = false; backfillLatestBtn.textContent = prev; }
      });
      const enrichUsersBtn = document.getElementById('enrichUsersErrors');
      enrichUsersBtn?.addEventListener('click', async () => {
        if (!confirm('fetch_status=error olan tüm kullanıcıları enrich kuyruğuna eklemek ister misiniz?')) return;
        enrichUsersBtn.disabled = true; const prev = enrichUsersBtn.textContent; enrichUsersBtn.textContent = 'Kuyruğa ekleniyor...';
        try {
          const r = await fetch('/ig/admin/enrich/users-errors', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Kuyruğa eklendi: ' + (js.enqueued||0));
        } catch (e) { alert('Enrich hatası'); }
        finally { enrichUsersBtn.disabled = false; enrichUsersBtn.textContent = prev; }
      });

      function fmtTs(){
        const nodes = document.querySelectorAll('.ts');
        for(const el of nodes){
          const v = el.getAttribute('data-ts');
          const ms = Number(v||0);
          if(ms>0){ const d = new Date(ms); el.textContent = d.toLocaleString(); }
          else { el.textContent = '-'; }
        }
      }
      fmtTs();

      // Live updates via WebSocket
      let wsConnected = false;
      const startWS = () => {
        try {
          const proto = location.protocol === 'https:' ? 'wss' : 'ws';
          const ws = new WebSocket(`${proto}://${location.host}/ig/ws`);
          ws.onopen = () => { wsConnected = true; };
          ws.onclose = () => { wsConnected = false; };
          ws.onerror = () => { wsConnected = false; };
          ws.onmessage = (ev) => {
            try {
              const data = JSON.parse(ev.data);
              if (data && data.type === 'ig_message') {
                location.reload();
              }
            } catch {}
          };
        } catch { wsConnected = false; }
      };
      startWS();
      // Poll fallback every 15s if sockets fail
      setInterval(async () => {
        if (wsConnected) return;
        try { await fetch('/ig/inbox/refresh', { method: 'POST' }); location.reload(); } catch {}
      }, 15000);
    </script>
  </body>
</html>

