<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>İade/Değişim İçeri Aktarma - Eşleştirme</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
    th { background: #fafafa; position: sticky; top: 0; }
    .toolbar { margin: 12px 0; display: flex; gap: 8px; align-items: center; }
    .btn { padding:4px 8px; border-radius:6px; border:1px solid #d1d5db; background:#fff; cursor:pointer; font-size:12px; }
  </style>
</head>
<body>
  {% include "_nav.html" %}
  <h2>İade/Değişim Eşleştirme ({{ filename }})</h2>
  <div class="toolbar">
    <label>Data Tarihi: <input id="dataDate" type="date" /></label>
    <label><input id="skipStock" type="checkbox" /> stok hareketi yapma</label>
    <button class="btn" onclick="applySelections()">Uygula ve Kaydet</button>
  </div>
  <table>
    <thead>
      <tr><th>#</th><th>Ad Soyad</th><th>Ürün</th><th>İşlem</th><th>Tarih</th><th>Tutar</th><th>Aday Sipariş</th><th>Ad/Soyad veya Telefon ile Ara</th></tr>
    </thead>
    <tbody>
    {% for r in rows %}
      <tr>
        <td>{{ r.row_index }}</td>
        <td>{{ r.record.name }}</td>
        <td>{{ r.record.item_name }}</td>
        <td>{{ r.record.action }}</td>
        <td>{{ r.record.date }}</td>
        <td>{{ r.record.amount }}</td>
        <td>
          <select data-row="{{ r.row_index }}">
            <option value="">Seçiniz</option>
            {% for c in r.candidates %}
              <option value="{{ c.id }}" {{ 'selected' if c.selected else '' }}>
                #{{ c.id }} · {{ c.date }} · {{ c.status }} · {{ c.item_name or '' }} · {{ c.total }} · {{ c.client_name or '' }} {{ c.client_phone or '' }}
              </option>
            {% endfor %}
          </select>
        </td>
        <td>
          <div style="display:flex; gap:6px; align-items:center;">
            <input type="text" placeholder="Ad Soyad veya Telefon" data-search="{{ r.row_index }}" />
            <button class="btn" type="button" onclick="searchOrders({{ r.row_index }})">Ara</button>
          </div>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <script>
    async function applySelections(){
      const sels = [];
      document.querySelectorAll('select[data-row]').forEach(sel => {
        const idx = Number(sel.getAttribute('data-row'));
        const oid = Number(sel.value || 0);
        if (idx >= 0 && oid) sels.push({ row_index: idx, order_id: oid });
      });
      const dataDate = document.getElementById('dataDate').value || '';
      const skipStock = !!document.getElementById('skipStock').checked;
      if (!sels.length){ if(!confirm('Seçim yapılmadı. Devam edilsin mi?')) return; }
      try{
        const r = await fetch('/import/returns/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: '{{ filename }}', data_date: dataDate, skip_stock: skipStock, selections: sels }) });
        if (!r.ok){ const t = await r.text(); alert('Hata: ' + t); return; }
        const data = await r.json().catch(() => ({}));
        const msg = `Uygulama tamamlandı. Güncellenen: ${data.updated ?? 0}, Eşleşmeyen: ${data.unmatched ?? 0}` + ((data.errors && data.errors.length) ? `, Hatalı: ${data.errors.length}` : '');
        alert(msg);
        location.href = '/orders/table';
      }catch(e){ alert('Ağ hatası'); }
    }

    async function searchOrders(rowIdx){
      const inp = document.querySelector(`input[data-search="${rowIdx}"]`);
      const sel = document.querySelector(`select[data-row="${rowIdx}"]`);
      if (!inp || !sel) return;
      const q = (inp.value || '').trim();
      if (q.length < 2){ alert('En az 2 karakter giriniz'); return; }
      try{
        const r = await fetch(`/reconcile/returns/search-orders?q=${encodeURIComponent(q)}`);
        if (!r.ok){ const t = await r.text(); alert('Arama hatası: ' + t); return; }
        const data = await r.json();
        Array.from(sel.querySelectorAll('option[data-src="search"]')).forEach(o => o.remove());
        (data.orders || []).forEach(o => {
          const opt = document.createElement('option');
          opt.value = String(o.id);
          opt.textContent = `#${o.id} · ${o.date || ''} · ${o.status || ''} · ${o.item_name || ''} · ${o.total || ''} · ${o.client_name || ''} ${o.client_phone || ''}`;
          opt.setAttribute('data-src', 'search');
          sel.appendChild(opt);
        });
        if ((data.orders || []).length === 0){ alert('Sonuç bulunamadı'); }
      }catch(e){ alert('Ağ hatası'); }
    }
  </script>
</body>
</html>

