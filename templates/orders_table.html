<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Siparisler</title>
    <style>
        :root {
            --bg: #f7f7fb;
            --card: #ffffff;
            --border: #e5e7eb;
            --muted: #6b7280;
            --primary: #2563eb;
            --primary-100: #eef2ff;
            --success-bg: #eaffea;
            --warn-bg: #fff9db;
            --danger-bg: #ffe5e5;
            --switch-bg: #ede0d4;
        }
        html, body { background: var(--bg); }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
        .container { max-width: 100%; width: 100%; margin: 16px auto; padding: 0 16px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
        .toolbar { margin: 12px 0 16px; padding: 12px; display: flex; flex-wrap: wrap; gap: 10px 12px; align-items: flex-start; background: var(--card); border: 1px solid var(--border); border-radius: 10px; }
        .toolbar input[type="search"] { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; min-width: 220px; flex: 1 1 240px; }
        .toolbar select, .toolbar input[type="date"] { padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; }
        .filters-form { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; flex: 1 1 auto; }
        .toolbar .metrics { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .toolbar-actions { display: flex; flex-wrap: wrap; gap: 8px; }
        .pill { font-size: 12px; padding: 4px 10px; background: var(--primary-100); color: #4338ca; border-radius: 999px; }
        .link-muted { color: var(--muted); text-decoration: none; font-size: 12px; }
        a { color: var(--primary); text-decoration: none; }
        .btn { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 12px; }
        .btn:hover { background: #f8fafc; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.primary { background: var(--primary); border-color: var(--primary); color: #fff; }
        .btn.warn { border-color:#ef4444; color:#b91c1c; }
        .btn.accent { border-color:#92400e; color:#92400e; }
        .table-wrap { }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; white-space: nowrap; }
        /* Allow wrapping only for the product (Urun) column */
        th.product, td.product { white-space: normal; word-break: break-word; overflow-wrap: anywhere; max-width: 260px; line-height: 1.3; }
        td.product { font-size: 12px; white-space: pre-line; }
        td.client .phone { display: block; color: var(--muted); font-size: 11px; margin-top: 2px; }
        /* Inline modal for editing total + IBAN */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index: 50; }
        .modal { background: var(--card); border:1px solid var(--border); border-radius: 12px; width: min(92vw, 520px); padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .modal h3 { margin: 0 0 12px; }
        .modal .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .modal label { display:block; font-size:12px; color:#6b7280; margin-bottom: 4px; }
        .modal input[type="number"], .modal input[type="text"] { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; }
        .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top: 8px; }
        .form-inline { display:flex; align-items:center; gap:8px; padding: 8px 10px; border:1px solid var(--border); border-radius:8px; }
        .err { color:#b91c1c; font-size:12px; min-height: 16px; }
        /* Slightly smaller font for client and product */
        td.client, td.product { font-size: 12px; }
        /* Constrain tracking and client columns */
        th.tracking, td.tracking { max-width: 120px; }
        th.tracking, td.tracking { font-size: 11px; }
        th.client, td.client { max-width: 220px; }
        td.tracking, td.client { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* Compact action icons */
        .icon-actions { display:flex; gap:6px; }
        .icon-btn { width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; }
        .icon-btn.warn { color:#b91c1c; border-color:#ef4444; }
        .icon-btn.accent { color:#92400e; border-color:#92400e; }
        .icon-btn:hover { background:#f8fafc; }
        .icon-btn svg { width:16px; height:16px; }
        th { background: #fafafa; position: sticky; top: 0; cursor: pointer; user-select: none; z-index: 1; }
        
        
        tr.paid { background: var(--success-bg); }
        tr.unpaid { background: var(--warn-bg); }
        tr.refunded { color: #b91c1c; background: var(--danger-bg); }
        tr.switched { color: #92400e; background: var(--switch-bg); }
        tr.stitched { color: #92400e; background: var(--switch-bg); }
        tr.cancelled { color: #6b7280; background: #f3f4f6; text-decoration: line-through; }
        tr.partial_paid { background: #fff4e6; }
        tr.tanzim_bekliyor { background: #e0f2fe; }
        tr.tanzim_basari { background: #dcfce7; }
        tr.tanzim_basarisiz { background: #fee2e2; }
        tr.iade_bekliyor { background: #fef3c7; }
        tr.merged { opacity: 0.7; }
        .pagination { margin: 10px 0 14px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .status-stack { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .status-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 9px; border-radius: 999px; font-size: 12px; font-weight: 600; border: 1px solid transparent; }
        .status-chip.status-paid { background: var(--success-bg); color: #166534; border-color: #86efac; }
        .status-chip.status-unpaid { background: var(--warn-bg); color: #92400e; border-color: #fbbf24; }
        .status-chip.status-partial_paid { background: #fff4e6; color: #b45309; border-color: #fb923c; }
        .status-chip.status-refunded { background: var(--danger-bg); color: #b91c1c; border-color: #fca5a5; }
        .status-chip.status-switched { background: var(--switch-bg); color: #92400e; border-color: #d6bfa5; }
        .status-chip.status-stitched { background: var(--switch-bg); color: #92400e; border-color: #d6bfa5; }
        .status-chip.status-cancelled { background: #f3f4f6; color: #4b5563; border-color: #e5e7eb; text-decoration: line-through; }
        .status-chip.status-iade_bekliyor { background: #fef3c7; color: #b45309; border-color: #fcd34d; }
        .status-chip.status-tanzim_bekliyor { background: #e0f2fe; color: #0369a1; border-color: #7dd3fc; }
        .status-chip.status-tanzim_basari { background: #dcfce7; color: #166534; border-color: #86efac; }
        .status-chip.status-tanzim_basarisiz { background: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .status-chip.status-unknown { background: #e5e7eb; color: #374151; border-color: #cbd5e1; }
        .status-note { font-size: 11px; color: #6b7280; margin-top: 4px; }
        .status-legend { display: flex; flex-wrap: wrap; gap: 8px; margin: 6px 0 12px; align-items: center; }
        @media (max-width: 900px){
            .toolbar { align-items: stretch; gap: 10px; }
            .toolbar input[type="search"] { flex: 1 1 100%; }
            .toolbar select, .toolbar input[type="date"] { flex: 1 1 48%; min-width: 140px; }
            table { border: 0; }
            thead { display: none; }
            #ordersTbl tbody { display: block; }
            #ordersTbl tbody tr { display: block; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); overflow: hidden; }
            #ordersTbl tbody tr td { display: block; border-bottom: 1px solid var(--border); padding: 10px 12px; white-space: normal; text-overflow: unset; overflow: visible; }
            #ordersTbl tbody tr td:last-child { border-bottom: 0; }
            #ordersTbl tbody tr td::before { content: attr(data-label); display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; font-weight: 600; letter-spacing: 0.01em; }
            .mobile-inline { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
            .mobile-actions { display: flex; gap: 6px; justify-content: flex-end; }
            .mobile-hide { display: none !important; }
            .pagination { justify-content: center; }
        }
        
        @media (max-width: 768px){
            th, td { font-size: 13px; padding: 8px 10px; }
            .toolbar { padding: 10px; }
            .toolbar input[type="search"] { flex-basis: 100%; }
        }
    </style>
    <script>
        function cmp(a,b,isNum){ if (isNum){ const na=parseFloat(a)||0, nb=parseFloat(b)||0; return na-nb; } return a.localeCompare(b,'tr'); }
        function sortTable(table, idx, dir){
            const rows = Array.from(table.tBodies[0].rows);
            const isNum = table.tHead.rows[0].cells[idx].dataset.type === 'num';
            rows.sort((r1,r2)=>{
                const a=r1.cells[idx].dataset.sort || r1.cells[idx].textContent.trim();
                const b=r2.cells[idx].dataset.sort || r2.cells[idx].textContent.trim();
                return dir==='asc'?cmp(a,b,isNum):cmp(b,a,isNum);
            });
            for(const r of rows) table.tBodies[0].appendChild(r);
        }
        function attach(table){ const ths=table.tHead.rows[0].cells; let active=-1, dir='asc'; for(let i=0;i<ths.length;i++){ ths[i].addEventListener('click',()=>{ dir=(active===i&&dir==='asc')?'desc':'asc'; active=i; sortTable(table,i,dir); }); } }
        function init(){ const table=document.getElementById('ordersTbl'); if(table){ attach(table); } }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</head>
<body>
    <div class="container">
    {% include "_nav.html" %}
    <div class="toolbar card">
        <form method="get" action="/orders/table" class="filters-form" id="filtersForm">
            <input id="search" name="search" type="search" value="{{ search or '' }}" placeholder="Ä°sim, telefon, takip, ID (virgÃ¼l ile Ã§oklu)" />
            <select name="date_field">
                <option value="shipment" {{ 'selected' if (date_field == 'shipment') else '' }}>Kargo Tarihi</option>
                <option value="data" {{ 'selected' if (date_field == 'data') else '' }}>Data Tarihi</option>
                <option value="both" {{ 'selected' if (date_field == 'both') else '' }}>Birlesik</option>
            </select>
            <input type="date" name="start" value="{{ start }}" />
            <input type="date" name="end" value="{{ end }}" />
            <select name="source">
                <option value="" {{ 'selected' if not source else '' }}>Tum Kanallar</option>
                <option value="bizim" {{ 'selected' if source == 'bizim' else '' }}>bizim</option>
                <option value="kargo" {{ 'selected' if source == 'kargo' else '' }}>kargo</option>
            </select>
            <select name="status">
                <option value="" {{ 'selected' if not status else '' }}>Tum Durumlar</option>
                <option value="paid" {{ 'selected' if status == 'paid' else '' }}>Yesil (Odendi)</option>
                <option value="unpaid" {{ 'selected' if status == 'unpaid' else '' }}>Sari (Odenmedi)</option>
                <option value="partial_paid" {{ 'selected' if status == 'partial_paid' else '' }}>Turuncu (KÄ±smi Ã–deme)</option>
                <option value="cancelled" {{ 'selected' if status == 'cancelled' else '' }}>Gri (Ä°ptal Edildi)</option>
                <option value="refunded" {{ 'selected' if status == 'refunded' else '' }}>Kirmizi (Iade)</option>
                <option value="switched" {{ 'selected' if status == 'switched' else '' }}>Kahverengi (Degisim)</option>
                <option value="iade_bekliyor" {{ 'selected' if status == 'iade_bekliyor' else '' }}>iade_bekliyor</option>
                <option value="tanzim_bekliyor" {{ 'selected' if status == 'tanzim_bekliyor' else '' }}>tanzim_bekliyor</option>
                <option value="tanzim_basari" {{ 'selected' if status == 'tanzim_basari' else '' }}>tanzim_basari</option>
                <option value="tanzim_basarisiz" {{ 'selected' if status == 'tanzim_basarisiz' else '' }}>tanzim_basarisiz</option>
            </select>
            <select name="ig_linked">
                <option value="" {{ 'selected' if not ig_linked else '' }}>IG: Hepsi</option>
                <option value="linked" {{ 'selected' if ig_linked == 'linked' else '' }}>IG BaÄŸlÄ±</option>
                <option value="unlinked" {{ 'selected' if ig_linked == 'unlinked' else '' }}>IG BaÄŸsÄ±z</option>
            </select>
            <select name="repeat_customer">
                <option value="" {{ 'selected' if not repeat_customer else '' }}>TÃ¼m MÃ¼ÅŸteriler</option>
                <option value="multi" {{ 'selected' if repeat_customer == 'multi' else '' }}>1'den fazla sipariÅŸ</option>
            </select>
            <select name="page_size" id="pageSize">
                <option value="25" {{ 'selected' if page_size == 25 else '' }}>25 / sayfa</option>
                <option value="50" {{ 'selected' if page_size == 50 else '' }}>50 / sayfa</option>
                <option value="100" {{ 'selected' if page_size == 100 else '' }}>100 / sayfa</option>
                <option value="200" {{ 'selected' if page_size == 200 else '' }}>200 / sayfa</option>
                <option value="500" {{ 'selected' if page_size == 500 else '' }}>500 / sayfa</option>
            </select>
            <input type="hidden" name="page" id="pageInput" value="{{ page }}">
            <input type="hidden" name="preset" value="{{ preset or '' }}">
            <button class="btn" type="button" onclick="submitWithPage(1)">Filtrele</button>
            <a class="link-muted" href="/orders/table">Temizle</a>
        </form>
        <div class="metrics">
            <span class="pill">GÃ¶sterilen {{ rows|length }} / {{ total_count }}</span>
            <span class="pill">Sayfa {{ page }} / {{ total_pages }}</span>
        </div>
        <div class="toolbar-actions">
            <button class="btn primary" onclick="recalc()">Tazele</button>
            <button class="btn" onclick="presetOverdue7()">7 gÃ¼n+ Ã¶deme yok</button>
            <button class="btn" onclick="presetHighCost70()">Maliyet â‰¥ %70</button>
            <button class="btn" onclick="presetAll()">TÃ¼m sipariÅŸler</button>
            <button class="btn" onclick="exportExcel()">Excel'e aktar</button>
            <a class="btn" href="/orders/duplicates">Potansiyel Ã‡iftler</a>
            <a class="btn" href="/orders/partial-payments">KÄ±smi Ã–demeler</a>
            <a class="btn" href="/orders/problem">Sorunlu SipariÅŸler</a>
        </div>
    </div>
    <h2>Siparisler</h2>
    {% set status_labels = {
        'paid': 'Ã–dendi',
        'unpaid': 'Ã–denmedi',
        'partial_paid': 'KÄ±smi Ã–deme',
        'refunded': 'Ä°ade',
        'switched': 'DeÄŸiÅŸim',
        'stitched': 'DeÄŸiÅŸim',
        'cancelled': 'Ä°ptal',
        'iade_bekliyor': 'Ä°ade Bekliyor',
        'tanzim_bekliyor': 'Tanzim Bekliyor',
        'tanzim_basari': 'Tanzim BaÅŸarÄ±lÄ±',
        'tanzim_basarisiz': 'Tanzim BaÅŸarÄ±sÄ±z'
    } %}
    <div class="status-legend" aria-label="Durum renkleri">
        {% for key in ['paid','unpaid','partial_paid','refunded','switched','cancelled','iade_bekliyor','tanzim_bekliyor','tanzim_basari','tanzim_basarisiz'] %}
            <span class="status-chip status-{{ key }}">{{ status_labels.get(key, key) }}</span>
        {% endfor %}
    </div>
    <table id="ordersTbl">
        <thead>
            <tr><th>ID</th><th class="tracking">Takip</th><th class="client">Musteri</th><th class="product">Urun</th><th>Adet</th><th>Toplam (etkin)</th><th class="mobile-hide">Maliyet</th><th class="mobile-hide">Kargo</th><th class="mobile-hide">Kargo FirmasÄ±</th><th class="mobile-hide">Kargo Tarihi</th><th class="mobile-hide">Data Tarihi</th><th class="mobile-hide">I/D Tarihi</th><th class="mobile-hide">Kanali</th><th class="mobile-hide">IG DM</th><th>Durum</th><th></th></tr>
            <tr>
                <th colspan="4" style="text-align:right">Toplamlar:</th>
                <th data-type="num">{{ sum_qty }}</th>
                <th data-type="num">{{ '%.2f'|format(sum_total or 0) }}</th>
                <th data-type="num">{{ '%.2f'|format(sum_cost or 0) }}</th>
                <th data-type="num">{{ '%.2f'|format(sum_shipping or 0) }}</th>
                <th colspan="7"></th>
            </tr>
        </thead>
        <tbody>
            {% for o in rows %}
            {% set rowcls = status_map.get(o.id) if status_map else '' %}
            {% if o.tanzim_status %}
                {% set rowcls = (rowcls + ' ' + o.tanzim_status) if rowcls else o.tanzim_status %}
            {% endif %}
            {% if o.merged_into_order_id %}
                {% set rowcls = rowcls + ' merged' if rowcls else 'merged' %}
            {% endif %}
            <tr class="{{ rowcls }}">
                <td data-label="ID">
                    <a href="/orders/{{ o.id }}/edit" title="DÃ¼zenle #{{ o.id }}">{{ o.id }}</a>
                    {% if o.merged_into_order_id %}
                        <span style="color: #92400e; font-size: 10px;" title="BirleÅŸtirilmiÅŸ sipariÅŸ">ðŸ”—</span>
                    {% endif %}
                    {% if o.is_partial_payment %}
                        <span style="color: #ea580c; font-size: 10px;" title="KÄ±smi Ã¶deme">ðŸ’°</span>
                    {% endif %}
                </td>
                <td class="tracking" data-label="Takip" data-sort="{{ o.tracking_no or '' }}">
                    {% if o.tracking_no %}
                        <span title="{{ o.tracking_no }}">{{ (o.tracking_no or '')[:6] }}</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="client" data-label="Musteri">
                    {% set cname = client_map.get(o.client_id) if client_map else o.client_id %}
                    {% set cphone = client_phone_map.get(o.client_id) if client_phone_map else None %}
                    <a href="/clients/{{ o.client_id }}">{{ (cname or '')[:40] }}</a>
                    {% if cphone %}
                        <span class="phone">{{ cphone }}</span>
                    {% endif %}
                </td>
                <td class="product" data-label="Urun">{{ o.notes or '' }}</td>
                <td data-label="Adet">{{ o.quantity }}</td>
                {% set eff = (effective_map.get(o.id) if effective_map else o.total_amount) %}
                {% set orig = o.total_amount %}
                <td data-label="Toplam (etkin)" data-sort="{{ eff }}">
                    <span id="tot-{{ o.id }}">{{ '%.2f'|format(eff or 0) }}</span>
                    {% if (orig is not none) and (eff != orig) %}
                        <div style="font-size:11px; color:#6b7280;">Orj: {{ '%.2f'|format(orig or 0) }}</div>
                    {% endif %}
                    <button class="btn" onclick="editTotal({{ o.id }}, '{{ '%.2f'|format(orig or 0) }}', {{ 'true' if (o.paid_by_bank_transfer or False) else 'false' }}, '{{ o.shipping_company or '' }}', '{{ o.status or '' }}', '{{ o.payment_date.isoformat() if o.payment_date else '' }}', '{{ '%.2f'|format(o.tanzim_amount_manual or 0) if o.tanzim_amount_manual is not none else '' }}')">DÃ¼zenle</button>
                </td>
                <td class="mobile-hide" data-label="Maliyet">{{ (cost_map.get(o.id) if cost_map else o.total_cost) }}</td>
                <td class="mobile-hide" data-label="Kargo">{{ '%.2f'|format((shipping_map.get(o.id, 0.0) if shipping_map else 0.0)) }}</td>
                <td class="mobile-hide" data-label="Kargo FirmasÄ±">
                    {% if o.shipping_company %}
                        {% if o.shipping_company == 'surat' %}SÃ¼rat
                        {% elif o.shipping_company == 'mng' %}MNG
                        {% elif o.shipping_company == 'dhl' %}DHL
                        {% elif o.shipping_company == 'ptt' %}PTT
                        {% else %}{{ o.shipping_company }}
                        {% endif %}
                    {% else %}
                        <span style="color: #9ca3af;">SÃ¼rat</span>
                    {% endif %}
                </td>
                <td class="mobile-hide" data-label="Kargo Tarihi">{{ o.shipment_date }}</td>
                <td class="mobile-hide" data-label="Data Tarihi">{{ o.data_date }}</td>
                <td class="mobile-hide" data-label="I/D Tarihi">{{ o.return_or_switch_date }}</td>
                <td class="mobile-hide" data-label="Kanali">{{ o.source }}</td>
                <td class="mobile-hide" data-label="IG DM">
                    {% if o.ig_conversation_id %}
                        <a class="icon-btn" title="IG KonuÅŸma" aria-label="IG KonuÅŸma" href="/ig/inbox/{{ o.ig_conversation_id }}">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v6a5 5 0 0 1-5 5h-3l-4 4v-4H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5z"></path></svg>
                        </a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td data-label="Durum">
                    {% set primary_status = status_map.get(o.id) if status_map else '' %}
                    <div class="status-stack">
                        {% if primary_status %}
                            <span class="status-chip status-{{ primary_status }}">{{ status_labels.get(primary_status, primary_status) }}</span>
                        {% else %}
                            <span class="status-chip status-unknown">Durum yok</span>
                        {% endif %}
                        {% if o.tanzim_status %}
                            <span class="status-chip status-{{ o.tanzim_status }}">{{ status_labels.get(o.tanzim_status, o.tanzim_status) }}</span>
                        {% endif %}
                    </div>
                    {% if o.tanzim_amount_manual %}
                        <div class="status-note">Tanzim manuel: {{ '%.2f'|format(o.tanzim_amount_manual) }}</div>
                    {% endif %}
                    {% if o.merged_into_order_id %}
                        <div class="status-note"><a href="/orders/{{ o.merged_into_order_id }}/edit" style="color: #92400e;">BirleÅŸtirildi: #{{ o.merged_into_order_id }}</a></div>
                    {% elif o.partial_payment_group_id and o.partial_payment_group_id == o.id %}
                        <div class="status-note" style="color: #ea580c;">KÄ±smi Ã¶deme grubu</div>
                    {% elif not primary_status and not o.tanzim_status %}
                        <div class="status-note">-</div>
                    {% endif %}
                </td>
                <td class="actions" data-label="Ä°ÅŸlemler">
                    <div class="icon-actions mobile-actions">
                        <button class="icon-btn warn" title="Ä°ptal Et" aria-label="Ä°ptal Et" onclick="cancelOrder({{ o.id }})">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        </button>
                        <button class="icon-btn warn" title="Ä°ade" aria-label="Ä°ade" onclick="refund({{ o.id }})">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5l-5 5 5 5V5z"></path><path d="M9 7h5a5 5 0 1 1 0 10H9" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                        </button>
                        <button class="icon-btn accent" title="DeÄŸiÅŸim" aria-label="DeÄŸiÅŸim" onclick="switchOrder({{ o.id }})">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 7h10l-2-2 1.5-1.5L21 7l-4.5 3.5L15 9l2-2H7zM17 17H7l2 2-1.5 1.5L3 17l4.5-3.5L9 15l-2 2h10z"></path></svg>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="pagination">
        <button class="btn" onclick="goPage({{ page - 1 }})" {% if page <= 1 %}disabled{% endif %}>Ã–nceki</button>
        <span>Sayfa {{ page }} / {{ total_pages }}</span>
        <button class="btn" onclick="goPage({{ page + 1 }})" {% if page >= total_pages %}disabled{% endif %}>Sonraki</button>
    </div>
    <!-- Inline modal panel -->
    <div id="editOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="modal">
            <h3 id="editModalTitle">Toplam, Kargo FirmasÄ±, IBAN & Ã–deme Durumu</h3>
            <div class="row">
                <div>
                    <label>Yeni Toplam</label>
                    <input id="epTotal" type="number" step="0.01" inputmode="decimal" />
                </div>
            <div>
                <label>Tanzim Manuel Tutar</label>
                <input id="epTanzimAmount" type="number" step="0.01" inputmode="decimal" />
            </div>
                <div>
                    <label>Kargo FirmasÄ±</label>
                    <select id="epShippingCompany" style="width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px;">
                        <option value="">SÃ¼rat Kargo (VarsayÄ±lan)</option>
                        {% for company in shipping_companies %}
                        <option value="{{ company.company_code }}">{{ company.company_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-inline">
                    <input id="epIban" type="checkbox" />
                    <label for="epIban" style="margin:0;cursor:pointer;">IBAN Ã¶demesi (banka havalesi)</label>
                </div>
                <div>
                    <label>Ã–deme Durumu</label>
                    <select id="epPaymentStatus" style="width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px;">
                        <option value="">-- SeÃ§iniz --</option>
                        <option value="paid">Ã–dendi</option>
                        <option value="unpaid">Ã–denmedi</option>
                        <option value="partial_paid">KÄ±smi Ã–deme</option>
                        <option value="cancelled">Ä°ptal</option>
                        <option value="refunded">Ä°ade</option>
                        <option value="switched">DeÄŸiÅŸim</option>
                <option value="iade_bekliyor">iade_bekliyor</option>
                <option value="tanzim_bekliyor">tanzim_bekliyor</option>
                <option value="tanzim_basari">tanzim_basari</option>
                <option value="tanzim_basarisiz">tanzim_basarisiz</option>
                    </select>
                </div>
                <div>
                    <label>Ã–deme Tarihi</label>
                    <input id="epPaymentDate" type="date" style="width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px;" />
                </div>
                <div id="epError" class="err"></div>
            </div>
            <div class="actions">
                <button id="epCancel" class="btn">VazgeÃ§</button>
                <button id="epSave" class="btn primary">Kaydet</button>
            </div>
        </div>
    </div>
    <!-- Cancel order confirmation modal -->
    <div id="cancelOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="cancelModalTitle">
        <div class="modal">
            <h3 id="cancelModalTitle">SipariÅŸi Ä°ptal Et</h3>
            <div class="row">
                <div>
                    <p style="margin: 0 0 12px 0; color: #6b7280;">Bu sipariÅŸi iptal etmek istediÄŸinizden emin misiniz?</p>
                </div>
                <div class="form-inline">
                    <input id="cancelRestoreInventory" type="checkbox" checked />
                    <label for="cancelRestoreInventory" style="margin:0;cursor:pointer;">Stok deÄŸerlerini dÃ¼zelt (envanteri geri ekle)</label>
                </div>
                <div id="cancelError" class="err"></div>
            </div>
            <div class="actions">
                <button id="cancelCancel" class="btn">VazgeÃ§</button>
                <button id="cancelConfirm" class="btn warn">Ä°ptal Et</button>
            </div>
        </div>
    </div>
    <script>
    const filtersForm = document.getElementById('filtersForm');
    const searchInput = document.getElementById('search');
    const pageInput = document.getElementById('pageInput');
    const pageSizeSelect = document.getElementById('pageSize');
    let searchTimer = null;
    function submitWithPage(targetPage){
        if(pageInput){ pageInput.value = String(targetPage); }
        filtersForm?.submit();
    }
    searchInput?.addEventListener('input', ()=>{
        clearTimeout(searchTimer);
        searchTimer = setTimeout(()=>submitWithPage(1), 450);
    });
    pageSizeSelect?.addEventListener('change', ()=>submitWithPage(1));
    function goPage(p){
        const maxPage = {{ total_pages }};
        if(!filtersForm || p < 1 || p > maxPage){ return; }
        submitWithPage(p);
    }

    async function recalc(){
        try{
            const res = await fetch('/orders/recalc-financials', { method: 'POST' });
            if(!res.ok){
                const t = await res.text();
                alert('Hesaplama hatasi: ' + t);
                return;
            }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }

    async function refund(id){
        try{
            const res = await fetch(`/orders/${id}/refund`, { method: 'POST' });
            if(!res.ok){ alert('Iade hatasi'); return; }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }
    async function switchOrder(id){
        try{
            const res = await fetch(`/orders/${id}/switch`, { method: 'POST' });
            if(!res.ok){ alert('Degisim hatasi'); return; }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }
    // Cancel order modal handlers
    const cancelOverlay = document.getElementById('cancelOverlay');
    const cancelRestoreInventory = document.getElementById('cancelRestoreInventory');
    const cancelConfirm = document.getElementById('cancelConfirm');
    const cancelCancel = document.getElementById('cancelCancel');
    const cancelError = document.getElementById('cancelError');
    let cancelingOrderId = null;
    function showCancelOverlay(){ cancelOverlay.style.display = 'flex'; }
    function hideCancelOverlay(){ cancelOverlay.style.display = 'none'; cancelError.textContent=''; cancelingOrderId = null; }
    function cancelOrder(id){
        cancelingOrderId = id;
        cancelRestoreInventory.checked = true;
        cancelError.textContent = '';
        showCancelOverlay();
    }
    cancelCancel?.addEventListener('click', ()=>{ hideCancelOverlay(); });
    cancelOverlay?.addEventListener('click', (e)=>{ if(e.target === cancelOverlay){ hideCancelOverlay(); } });
    cancelConfirm?.addEventListener('click', async ()=>{
        cancelError.textContent = '';
        const id = cancelingOrderId;
        if(!id){ hideCancelOverlay(); return; }
        const restoreInv = !!cancelRestoreInventory.checked;
        try{
            const res = await fetch(`/orders/${id}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ restore_inventory: restoreInv })
            });
            if(!res.ok){
                const t = await res.text();
                cancelError.textContent = 'Ä°ptal hatasÄ±: ' + (t || res.status);
                return;
            }
            hideCancelOverlay();
            location.reload();
        }catch(e){
            cancelError.textContent = 'AÄŸ hatasÄ±: ' + e;
        }
    });
    // Inline modal state/handlers
    const overlay = document.getElementById('editOverlay');
    const epTotal = document.getElementById('epTotal');
    const epIban = document.getElementById('epIban');
    const epShippingCompany = document.getElementById('epShippingCompany');
    const epPaymentStatus = document.getElementById('epPaymentStatus');
    const epPaymentDate = document.getElementById('epPaymentDate');
    const epTanzimAmount = document.getElementById('epTanzimAmount');
    const epSave = document.getElementById('epSave');
    const epCancel = document.getElementById('epCancel');
    const epErr = document.getElementById('epError');
    let editingOrderId = null;
    function showOverlay(){ overlay.style.display = 'flex'; }
    function hideOverlay(){ overlay.style.display = 'none'; epErr.textContent=''; }
    function editTotal(id, cur, isIban, shippingCompany, paymentStatus, paymentDate, tanzimAmount=''){
        editingOrderId = id;
        epTotal.value = String(cur || '0.00');
        epIban.checked = !!isIban;
        epShippingCompany.value = shippingCompany || '';
        epPaymentStatus.value = paymentStatus || '';
        epTanzimAmount.value = tanzimAmount || '';
        // Set payment date: if exists use it, otherwise default to today
        if(paymentDate && paymentDate.trim() !== ''){
            epPaymentDate.value = paymentDate;
        } else {
            // Default to today
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            epPaymentDate.value = `${year}-${month}-${day}`;
        }
        epErr.textContent = '';
        showOverlay();
        setTimeout(()=>{ try{ epTotal.focus(); epTotal.select(); }catch(_){} }, 0);
    }
    epCancel?.addEventListener('click', ()=>{ hideOverlay(); editingOrderId = null; });
    overlay?.addEventListener('click', (e)=>{ if(e.target === overlay){ hideOverlay(); editingOrderId = null; } });
    epSave?.addEventListener('click', async ()=>{
        epErr.textContent = '';
        const id = editingOrderId;
        if(!id){ hideOverlay(); return; }
        const raw = String(epTotal.value || '').trim().replace(',', '.');
        const num = parseFloat(raw);
        if(!isFinite(num)){ epErr.textContent = 'GeÃ§ersiz tutar'; return; }
        const isIban = !!epIban.checked;
        const shippingCompany = epShippingCompany.value || null;
        const paymentStatus = epPaymentStatus.value || null;
        const paymentDate = epPaymentDate.value || null;
        const tanzimAmountRaw = String(epTanzimAmount.value || '').trim();
        const tanzimAmount = tanzimAmountRaw ? parseFloat(tanzimAmountRaw.replace(',', '.')) : null;
        try{
            const res = await fetch(`/orders/${id}/update-total`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    total: num, 
                    paid_by_bank_transfer: isIban,
                    shipping_company: shippingCompany,
                    payment_status: paymentStatus,
                    payment_date: paymentDate,
                    tanzim_amount_manual: tanzimAmount
                })
            });
            if(!res.ok){
                const t = await res.text();
                epErr.textContent = 'GÃ¼ncelleme hatasÄ±: ' + (t || res.status);
                return;
            }
            hideOverlay();
            location.reload();
        }catch(e){
            epErr.textContent = 'AÄŸ hatasÄ±: ' + e;
        }
    });

    function presetOverdue7(){
        // Build fresh params to clear any existing filters
        const params = new URLSearchParams();
        params.set('preset','overdue_unpaid_7');
        params.set('date_field','both');
        const now = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
        const endStr = `${end.getFullYear()}-${pad(end.getMonth()+1)}-${pad(end.getDate())}`;
        const startStr = `2025-01-01`;
        params.set('start', startStr);
        params.set('end', endStr);
        window.location.href = '/orders/table?' + params.toString();
    }

    function presetAll(){
        // Clear all filters and show the full history
        const params = new URLSearchParams();
        params.set('preset','all');
        params.set('date_field','both');
        const now = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const endStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
        const startStr = `2000-01-01`;
        params.set('start', startStr);
        params.set('end', endStr);
        window.location.href = '/orders/table?' + params.toString();
    }

    function presetHighCost70(){
        const params = new URLSearchParams();
        params.set('preset','high_cost_70');
        params.set('date_field','both');
        window.location.href = '/orders/table?' + params.toString();
    }

    function exportExcel(){
        const params = new URLSearchParams(window.location.search);
        const url = '/orders/export?' + params.toString();
        window.location.href = url;
    }
    </script>
    </div>
</body>
</html>

