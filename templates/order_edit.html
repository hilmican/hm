<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Edit</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f5f6fa; color:#111827; }
        .page { max-width: 1080px; margin: 16px auto 32px; padding: 0 16px; }
        h2, h3 { margin: 12px 0; }
        .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
        .card + .card { margin-top: 12px; }
        .row { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; }
        label { display:block; font-size:12px; color:#6b7280; margin-bottom:4px; }
        input, select, textarea { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; font-size:14px; }
        textarea { min-height: 80px; }
        .toolbar { display:flex; flex-wrap:wrap; gap:8px; margin:12px 0; align-items:center; }
        .btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; background:#fff; cursor:pointer; font-size:13px; }
        .btn.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
        .pill-muted { color:#6b7280; font-size:12px; }
        .table-wrap { width:100%; overflow-x:auto; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
        table { width:100%; border-collapse: collapse; min-width: 640px; }
        th, td { padding:10px 12px; border-bottom:1px solid #f0f0f0; text-align:left; font-size: 13px; white-space: nowrap; }
        th { background:#f9fafb; position: sticky; top: 0; z-index:1; }
        pre { font-size:12px; white-space: pre-wrap; }
        @media (max-width: 900px){
            .row { grid-template-columns: 1fr; }
            table { min-width: 520px; }
            body { background:#f7f7fb; }
        }
        @media (max-width: 640px){
            .page { padding: 0 12px; }
            .toolbar { flex-direction: column; align-items: flex-start; }
            table { min-width: 480px; }
        }
    </style>
</head>
<body>
    {% include "_nav.html" %}
    <div class="page">
    <h2>Order #{{ order.id }} D√ºzenle</h2>
    {% if status_param %}
    <div style="margin:10px 0; padding:10px 12px; border-radius:10px; border:1px solid {{ 'transparent' if status_param=='ok' else '#fecdd3' }}; background: {{ '#ecfdf3' if status_param=='ok' else '#fef2f2' }}; color: {{ '#166534' if status_param=='ok' else '#b91c1c' }};">
        {{ status_msg or ('Kaydedildi' if status_param=='ok' else 'Kaydedilemedi') }}
    </div>
    {% endif %}
    {% if order.ig_conversation_id %}
    <div class="card" style="margin-bottom:12px; padding:12px;">
        <div style="font-size:13px; color:#374151;">
            <strong>Instagram Konu≈ümasƒ±:</strong>
            <a href="/ig/inbox/{{ order.ig_conversation_id }}" target="_blank" rel="noopener" style="color:#2563eb;">{{ order.ig_conversation_id }}</a>
        </div>
    </div>
    {% endif %}
    {% if order.merged_into_order_id %}
    <div class="card" style="margin-bottom:12px; padding:12px; background:#fff4e6; border-color:#ea580c;">
        <div style="font-size:13px; color:#92400e;">
            <strong>‚ö†Ô∏è Bu sipari≈ü birle≈ütirilmi≈ü:</strong>
            <a href="/orders/{{ order.merged_into_order_id }}/edit" style="color:#ea580c; font-weight:600;">Sipari≈ü #{{ order.merged_into_order_id }}</a> sipari≈üine birle≈ütirilmi≈ü.
        </div>
    </div>
    {% endif %}
    {% if order.is_partial_payment and order.partial_payment_group_id == order.id %}
    <div class="card" style="margin-bottom:12px; padding:12px; background:#fff4e6; border-color:#ea580c;">
        <div style="font-size:13px; color:#92400e;">
            <strong>üí∞ Kƒ±smi √ñdeme Grubu:</strong> Bu sipari≈ü kƒ±smi √∂deme grubunun birincil sipari≈üidir.
            {% if merged_orders %}
            <div style="margin-top:8px;">
                <strong>Birle≈ütirilmi≈ü sipari≈üler:</strong>
                {% for merged in merged_orders %}
                    <a href="/orders/{{ merged.id }}/edit" style="color:#ea580c;">#{{ merged.id }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    <div class="card">
        <form method="post" action="/orders/{{ order.id }}/edit">
            <div class="row">
                <div>
                    <label>M√º≈üteri</label>
                    <input name="client" list="clients" value="{{ client_disp or order.client_id }}" />
                    <datalist id="clients">
                        {% for c in clients %}
                        <option value="{{ c.id }} | {{ c.name }} | {{ c.phone }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div>
                    <label>Takip No</label>
                    <input name="tracking_no" value="{{ order.tracking_no or '' }}" />
                </div>
                <div>
                    <label>√úr√ºn (Item)</label>
                    <input name="item" list="items" value="{{ item_disp or (order.item_id or '') }}" />
                    <datalist id="items">
                        {% for it in items %}
                        <option value="{{ it.id }} | {{ it.sku }} | {{ it.name }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div>
                    <label>Adet</label>
                    <input name="quantity" type="number" step="1" value="{{ order.quantity or 1 }}" />
                </div>
                <div>
                    <label>Toplam</label>
                    <input name="total_amount" type="number" step="0.01" value="{{ order.total_amount or 0 }}" />
                </div>
                <div>
                    <label>√ñdeme ≈ûekli</label>
                    <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;">
                        <input id="ibanPaid" name="paid_by_bank_transfer" type="checkbox" {{ 'checked' if (order.paid_by_bank_transfer or False) else '' }} />
                        <label for="ibanPaid" style="margin:0;cursor:pointer;">IBAN √∂demesi (banka havalesi)</label>
                    </div>
                </div>
                <div>
                    <label>Durum</label>
                    <select name="status">
                        {% set st = order.status or '' %}
                        <option value="" {{ 'selected' if st=='' else '' }}>(bo≈ü)</option>
                        <option value="paid" {{ 'selected' if st=='paid' else '' }}>paid</option>
                        <option value="unpaid" {{ 'selected' if st=='unpaid' else '' }}>unpaid</option>
                        <option value="partial_paid" {{ 'selected' if st=='partial_paid' else '' }}>partial_paid (Kƒ±smi √ñdeme)</option>
                        <option value="refunded" {{ 'selected' if st=='refunded' else '' }}>refunded</option>
                        <option value="switched" {{ 'selected' if st=='switched' else '' }}>switched</option>
                        <option value="cancelled" {{ 'selected' if st=='cancelled' else '' }}>cancelled</option>
                        <option value="iade_bekliyor" {{ 'selected' if st=='iade_bekliyor' else '' }}>iade_bekliyor</option>
                        <option value="tanzim_bekliyor" {{ 'selected' if st=='tanzim_bekliyor' else '' }}>tanzim_bekliyor</option>
                        <option value="tanzim_basari" {{ 'selected' if st=='tanzim_basari' else '' }}>tanzim_basari</option>
                        <option value="tanzim_basarisiz" {{ 'selected' if st=='tanzim_basarisiz' else '' }}>tanzim_basarisiz</option>
                    </select>
                </div>
                <div>
                    <label>Tanzim Durumu</label>
                    {% set tz = order.tanzim_status or '' %}
                    <select name="tanzim_status">
                        <option value="" {{ 'selected' if tz=='' else '' }}>(bo≈ü)</option>
                        <option value="tanzim_bekliyor" {{ 'selected' if tz=='tanzim_bekliyor' else '' }}>tanzim_bekliyor</option>
                        <option value="tanzim_basari" {{ 'selected' if tz=='tanzim_basari' else '' }}>tanzim_basari</option>
                        <option value="tanzim_basarisiz" {{ 'selected' if tz=='tanzim_basarisiz' else '' }}>tanzim_basarisiz</option>
                    </select>
                </div>
                <div>
                    <label>Tanzim Manuel Tutar</label>
                    <input name="tanzim_amount_manual" type="number" step="0.01" value="{{ order.tanzim_amount_manual or '' }}" />
                </div>
                <div>
                    <label>Kaynak</label>
                    <select name="source">
                        {% set src = order.source or '' %}
                        <option value="bizim" {{ 'selected' if src=='bizim' else '' }}>bizim</option>
                        <option value="kargo" {{ 'selected' if src=='kargo' else '' }}>kargo</option>
                    </select>
                </div>
                <div>
                    <label>Satƒ±≈ü Kanalƒ±</label>
                    {% set ch = order.channel or 'instagram' %}
                    <select name="channel">
                        <option value="instagram" {{ 'selected' if ch=='instagram' else '' }}>instagram</option>
                        <option value="magaza" {{ 'selected' if ch=='magaza' else '' }}>magaza</option>
                        <option value="tiktok" {{ 'selected' if ch=='tiktok' else '' }}>tiktok</option>
                        <option value="whatsapp" {{ 'selected' if ch=='whatsapp' else '' }}>whatsapp</option>
                        <option value="other" {{ 'selected' if ch=='other' else '' }}>other</option>
                    </select>
                </div>
                <div>
                    <label>POS Gelir Hesabƒ± (opsiyonel)</label>
                    <select name="pos_income_account_id">
                        <option value="">{{ '(bo≈ü bƒ±rak)' }}</option>
                        {% for acc in accounts %}
                        <option value="{{ acc.id }}" {% if pos_income_account_id and acc.id == pos_income_account_id %}selected{% endif %}>
                            {{ acc.name }} ({{ acc.type }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label>Kargo Tarihi</label>
                    <input name="shipment_date" type="date" value="{{ order.shipment_date }}" />
                </div>
                <div>
                    <label>Data Tarihi</label>
                    <input name="data_date" type="date" value="{{ order.data_date }}" />
                </div>
                <div style="grid-column:1/-1;">
                    <label>Notlar</label>
                    <textarea name="notes">{{ order.notes or '' }}</textarea>
                </div>
            </div>

            <h3 style="margin-top:16px;">Sipari≈ü Kalemleri</h3>
            <div>
                <div class="table-wrap">
                    <table id="orderItemsTbl">
                        <thead>
                            <tr><th>Item</th><th>Adet</th><th></th></tr>
                        </thead>
                        <tbody>
                            {% for row in (order_items or []) %}
                            <tr>
                                <td><input name="item_display" list="items_all" value="{{ (row.item.id ~ ' | ' ~ row.item.sku ~ ' | ' ~ row.item.name) if row.item else '' }}" /></td>
                                <td><input name="item_qty" type="number" step="1" min="1" value="{{ row.quantity }}" /></td>
                                <td><button class="btn" type="button" onclick="removeRow(this)">Sil</button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="toolbar">
                    <button class="btn primary" type="button" onclick="addRow()">Satƒ±r Ekle</button>
                    <span class="pill-muted">Toplam tutar elle girilir, otomatik hesaplanmaz.</span>
                </div>
                <datalist id="items_all">
                    {% for it in (items_all or []) %}
                    <option value="{{ it.id }} | {{ it.sku }} | {{ it.name }}"></option>
                    {% endfor %}
                </datalist>
            </div>
            <div class="toolbar">
                <button class="btn primary" type="submit">Kaydet</button>
                <a href="/orders/table" class="btn">Geri</a>
            </div>
        </form>
    </div>

    <h3>Kaynak & √ñdeme ƒ∞zleme</h3>
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap;">
            <div style="font-size:13px;color:#374151;">Bu sipari≈üe ait excel ve √∂deme hareketleri</div>
            <a href="/excel-tracker?order_id={{ order.id }}" target="_blank" rel="noopener" style="color:#2563eb;">Excel Tracker'da a√ß</a>
        </div>
        <div style="margin-bottom:6px;font-weight:600;">Excel Kayƒ±tlarƒ± (Bizim/Kargo)</div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr><th>Kaynak</th><th>Dosya</th><th>Run</th><th>Satƒ±r</th><th>Durum</th><th>Data Tarihi</th><th>Ba≈ülangƒ±√ß</th><th>Mesaj</th></tr>
                </thead>
                <tbody>
                {% if import_rows %}
                    {% for row in import_rows %}
                    <tr>
                        <td>{{ row.source }}</td>
                        <td>
                            {{ row.filename }}
                            {% if row.import_run_id %}
                                <a href="/excel-tracker/download/{{ row.import_run_id }}" target="_blank" rel="noopener" style="color:#2563eb;">indir</a>
                            {% endif %}
                        </td>
                        <td>#{{ row.import_run_id }}</td>
                        <td>{{ row.row_index }}</td>
                        <td>{{ row.status }}</td>
                        <td>{{ row.data_date or '-' }}</td>
                        <td>{{ row.started_at or '-' }}</td>
                        <td style="max-width:240px; white-space:pre-wrap;">{{ row.message or '-' }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="8" style="color:#6b7280;">Bu sipari≈üle e≈üle≈üen excel kaydƒ± bulunamadƒ±.</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
        <div style="margin:12px 0 6px;font-weight:600;">√ñdeme Detaylarƒ±</div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr><th>Tutar</th><th>Tarih</th><th>Y√∂ntem</th><th>Referans</th><th>Net</th></tr>
                </thead>
                <tbody>
                {% for p in payments %}
                    <tr>
                        <td>{{ p.amount }}</td>
                        <td>{{ p.payment_date or p.date or '-' }}</td>
                        <td>{{ p.method or '-' }}</td>
                        <td>{{ p.reference or '-' }}</td>
                        <td>{{ p.net_amount or '-' }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="5" style="color:#6b7280;">√ñdeme kaydƒ± yok.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="margin-top:6px;font-size:12px;color:#6b7280;">√ñdeme satƒ±rlarƒ± kargo excelinden geldiyse yukarƒ±daki kargo kayƒ±tlarƒ±nda ilgili dosyayƒ± g√∂rebilirsiniz.</div>
    </div>

    <h3>Deƒüi≈üiklik G√ºnl√ºƒü√º</h3>
    <div class="card">
        <div class="table-wrap">
            <table>
                <thead>
                    <tr><th>Zaman</th><th>Kullanƒ±cƒ±</th><th>Aksiyon</th><th>Deƒüi≈üiklikler</th></tr>
                </thead>
                <tbody>
                {% for lg in logs %}
                    <tr>
                        <td>{{ lg.created_at }}</td>
                        <td>
                            {% if lg.editor_user_id %}
                                {{ users_by_id.get(lg.editor_user_id) or ('#' ~ lg.editor_user_id) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ lg.action }}</td>
                        <td><pre style="margin:0;">{{ lg.changes_json }}</pre></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <script>
    const form = document.querySelector('form[action="/orders/{{ order.id }}/edit"]');
    function addRow(itemDisplay='', qty=1){
        const tb = document.querySelector('#orderItemsTbl tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input name="item_display" list="items_all" value="${itemDisplay}" /></td>
            <td><input name="item_qty" type="number" step="1" min="1" value="${qty}" /></td>
            <td><button type="button" onclick="removeRow(this)">Sil</button></td>
        `;
        tb.appendChild(tr);
    }
    function removeRow(btn){
        const tr = btn.closest('tr');
        tr && tr.remove();
    }
    function clearHidden(form){
        for (const el of Array.from(form.querySelectorAll('input[name="item_ids[]"], input[name="qtys[]"]'))){ el.remove(); }
    }
    function serializeOrderItems(form){
        clearHidden(form);
        const rows = document.querySelectorAll('#orderItemsTbl tbody tr');
        for (const r of rows){
            const disp = r.querySelector('input[name="item_display"]').value.trim();
            const qty = parseInt(r.querySelector('input[name="item_qty"]').value || '0', 10);
            if (!disp || !isFinite(qty) || qty <= 0) continue;
            const hid1 = document.createElement('input');
            hid1.type = 'hidden'; hid1.name = 'item_ids[]'; hid1.value = disp;
            const hid2 = document.createElement('input');
            hid2.type = 'hidden'; hid2.name = 'qtys[]'; hid2.value = String(qty);
            form.appendChild(hid1); form.appendChild(hid2);
        }
    }
    if (form){
        form.addEventListener('submit', (e)=>{ serializeOrderItems(form); });
    }
    
    </script>
    </div>
</body>
</html>


