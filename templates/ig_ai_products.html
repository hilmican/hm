<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Ürün AI Mesajları — {{ focus }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .field { margin-bottom: 12px; }
      label { display:block; font-weight:600; margin-bottom:6px; color:#111827; }
      textarea { width:100%; min-height:160px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      input[type="text"] { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; }
      button { background:#2563eb; color:#fff; border:none; border-radius:8px; padding:10px 14px; cursor:pointer }
      .meta { color:#6b7280; font-size:12px; }
      .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
      .box { border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <h1>Ürün AI Mesajları</h1>
    <div class="meta">Odak: {{ name }} (slug: {{ focus }})</div>
    <form method="post" action="/ig/ai/products/save" style="margin-top:16px">
      <input type="hidden" name="focus" value="{{ focus }}" />
      <div class="field">
        <label>Sistem Mesajı (ai_system_msg)</label>
        <textarea name="ai_system_msg" placeholder="Sistem talimatları">{{ ai_system_msg }}</textarea>
      </div>
      <div class="field">
        <label>Prompt Mesajı (ai_prompt_msg)</label>
        <textarea name="ai_prompt_msg" placeholder="Ürün/paket/ifadeler...">{{ ai_prompt_msg }}</textarea>
      </div>
      <div class="field">
        <label>Pretext Seçimi</label>
        <select name="pretext_id" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px;">
          <option value="">Varsayılan pretext kullan</option>
          {% for p in pretexts %}
          <option value="{{ p.id }}" {% if pretext_id == p.id %}selected{% endif %}>
            {{ p.name }}{% if p.is_default %} (Varsayılan){% endif %}
          </option>
          {% endfor %}
        </select>
        <div class="meta" style="margin-top:6px;">
          Pretext, sistem mesajının başına eklenen özel metindir. 
          <a href="/ig/ai/pretexts" target="_blank">Pretext'leri yönet</a>
        </div>
      </div>
      <div class="field">
        <label>
          <input type="checkbox" 
                 name="ai_reply_sending_enabled" 
                 value="1" 
                 {% if ai_reply_sending_enabled %}checked{% endif %} 
                 style="width:20px; height:20px; margin-right:8px;" />
          AI Cevap Gönderme Aktif
        </label>
        <div class="meta" style="margin-top:6px;">
          Bu ürün için AI'ın gerçekten cevap göndermesine izin ver. 
          Gölge cevaplar (shadow replies) her zaman çalışır, bu ayar sadece gerçek gönderimi kontrol eder.
        </div>
      </div>
      <button type="submit">Kaydet</button>
    </form>

    <hr style="margin:24px 0;" />

    <h2>Ürün Fotoğrafları</h2>
    <div class="meta">
      Dosya yapısı örneği:
      <code>products/{{ (skus[0] if skus else focus) }}/image-x.jpg</code>.<br />
      Burada yüklediğiniz fotoğraflardan hangilerini AI'ın müşteriye gönderebileceğini
      seçebilir ve gönderim sırasını belirleyebilirsiniz.
    </div>

    <!-- Upload form -->
    <form method="post"
          action="/ig/ai/products/images/upload"
          enctype="multipart/form-data"
          style="margin-top:12px; margin-bottom:16px;">
      <input type="hidden" name="focus" value="{{ focus }}" />
      <div class="field">
        <label>Yeni Fotoğraflar Yükle (birden fazla seçebilirsiniz)</label>
        <input type="file" name="files" multiple />
      </div>
      <button type="submit">Fotoğrafları Yükle</button>
    </form>

    <!-- Existing images / AI configuration -->
    {% if images %}
    <form method="post" action="/ig/ai/products/images/save" style="margin-top:8px;">
      <input type="hidden" name="focus" value="{{ focus }}" />
      <table style="width:100%; border-collapse:collapse; margin-top:8px;">
        <thead>
          <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
            <th style="padding:6px;">Önizleme</th>
            <th style="padding:6px;">URL</th>
            <th style="padding:6px;">AI Göndersin mi?</th>
            <th style="padding:6px;">AI Sırası</th>
            <th style="padding:6px;">Varyant Anahtarı</th>
            <th style="padding:6px;">Sil</th>
          </tr>
        </thead>
        <tbody>
          {% for img in images %}
          <tr style="border-bottom:1px solid #f3f4f6;">
            <td style="padding:6px; width:120px;">
              <input type="hidden" name="image_ids[]" value="{{ img.id }}" />
              <img src="{{ img.url }}" alt="" style="max-width:110px; max-height:110px; border-radius:8px; border:1px solid #e5e7eb;" />
            </td>
            <td style="padding:6px; font-size:12px; color:#4b5563; word-break:break-all;">
              {{ img.url }}
            </td>
            <td style="padding:6px; text-align:center;">
              <input type="checkbox"
                     name="ai_send_{{ img.id }}"
                     value="1"
                     {% if img.ai_send %}checked{% endif %} />
            </td>
            <td style="padding:6px; width:80px;">
              <input type="number"
                     name="ai_send_order_{{ img.id }}"
                     min="1"
                     style="width:70px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:6px;"
                     value="{{ img.ai_send_order or '' }}" />
            </td>
            <td style="padding:6px; width:140px;">
              <input type="text"
                     name="variant_key_{{ img.id }}"
                     placeholder="örn. krem, acik-gri"
                     style="width:130px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:6px;"
                     value="{{ img.variant_key or '' }}" />
            </td>
            <td style="padding:6px; text-align:center;">
              <input type="checkbox" name="delete_{{ img.id }}" value="1" />
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="margin-top:10px;">
        <button type="submit">Fotoğraf Ayarlarını Kaydet</button>
      </div>
    </form>
    {% else %}
      <div class="meta" style="margin-top:8px;">
        Bu ürün için henüz fotoğraf eklenmemiş.
      </div>
    {% endif %}

    <div class="row" style="margin-top:18px">
      <div class="box">
        <h3 style="margin:0 0 8px 0">Reklam Eşlemesi</h3>
        <div class="meta" style="margin-bottom:6px">Bu ürüne ait Facebook Ads Library ID’lerini ekleyin.</div>
        <form method="post" action="/ig/ads/map">
          <div class="field">
            <label>Ad ID (Ads Library id=...)</label>
            <input type="text" name="ad_id" placeholder="120235971585560789" />
          </div>
          <div class="field">
            <label>Product ID (opsiyonel)</label>
            <input type="text" name="product_id" placeholder="örn. 42" />
          </div>
          <div class="field">
            <label>SKU (opsiyonel)</label>
            <input type="text" name="sku" placeholder="örn. PANT-SLIM-ANTR" />
          </div>
          <button type="submit">Eşle</button>
        </form>
      </div>
      <div class="box">
        <h3 style="margin:0 0 8px 0">İpucu</h3>
        <div class="meta">
          Bu düzenlemeler AI cevaplarında kullanılacak. Ads Library ID eşlemesi, bu reklama cevap veren konuşmalar için ürün odağını otomatik belirler.
        </div>
      </div>
    </div>
  </body>
</html>



