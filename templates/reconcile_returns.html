<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>İade/Değişim Eşleştirme</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
    th { background: #fafafa; position: sticky; top: 0; }
    .btn { padding:4px 8px; border-radius:6px; border:1px solid #d1d5db; background:#fff; cursor:pointer; font-size:12px; }
  </style>
</head>
<body>
  {% include "_nav.html" %}
  <h2>İade/Değişim Eşleştirme</h2>
  <form id="applyForm" onsubmit="return false;">
    <table>
      <thead>
        <tr><th>Import Row</th><th>İşlem</th><th>Tarih</th><th>Tutar</th><th>Aday Sipariş</th><th>Ad/Soyad veya Telefon ile Ara</th></tr>
      </thead>
      <tbody>
      {% for r in rows %}
        <tr>
          <td>#{{ r.import_row_id }}</td>
          <td>{{ r.record.action }}</td>
          <td>{{ r.record.date }}</td>
          <td>{{ r.record.amount }}</td>
          <td>
            <select data-row="{{ r.import_row_id }}">
              <option value="">Seçiniz</option>
              {% for c in r.candidates %}
                <option value="{{ c.id }}">#{{ c.id }} · {{ c.date }} · {{ c.status }} · {{ c.item_name or '' }} · {{ c.total }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <div style="display:flex; gap:6px; align-items:center;">
              <input type="text" placeholder="Ad Soyad veya Telefon" data-search="{{ r.import_row_id }}" />
              <button class="btn" type="button" onclick="searchOrders({{ r.import_row_id }})">Ara</button>
            </div>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    <div style="margin-top:10px;">
      <button class="btn" onclick="applySelections()">Uygula</button>
    </div>
  </form>
  <script>
  async function applySelections(){
    const sels = [];
    document.querySelectorAll('select[data-row]').forEach(sel => {
      const ir = Number(sel.getAttribute('data-row'));
      const oid = Number(sel.value || 0);
      if (ir && oid) sels.push({ import_row_id: ir, order_id: oid });
    });
    if (!sels.length){ alert('Seçim yapınız'); return; }
    try{
      const r = await fetch('/reconcile/returns/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ selections: sels }) });
      if (!r.ok){ const t = await r.text(); alert('Hata: ' + t); return; }
      location.reload();
    }catch(e){ alert('Ağ hatası'); }
  }

  async function searchOrders(rowId){
    const inp = document.querySelector(`input[data-search="${rowId}"]`);
    const sel = document.querySelector(`select[data-row="${rowId}"]`);
    if (!inp || !sel) return;
    const q = (inp.value || "").trim();
    if (q.length < 2){ alert('En az 2 karakter giriniz'); return; }
    try{
      const r = await fetch(`/reconcile/returns/search-orders?q=${encodeURIComponent(q)}`);
      if (!r.ok){ const t = await r.text(); alert('Arama hatası: ' + t); return; }
      const data = await r.json();
      // Remove previous search results
      Array.from(sel.querySelectorAll('option[data-src="search"]')).forEach(o => o.remove());
      // Append new options
      (data.orders || []).forEach(o => {
        const opt = document.createElement('option');
        opt.value = String(o.id);
        opt.textContent = `#${o.id} · ${o.date || ''} · ${o.status || ''} · ${o.item_name || ''} · ${o.total || ''} · ${o.client_name || ''} ${o.client_phone || ''}`;
        opt.setAttribute('data-src', 'search');
        sel.appendChild(opt);
      });
      if ((data.orders || []).length === 0){ alert('Sonuç bulunamadı'); }
    }catch(e){ alert('Ağ hatası'); }
  }
  </script>
</body>
</html>

