<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Kısmi Ödeme Siparişleri</title>
    <style>
        :root {
            --bg: #f7f7fb;
            --card: #ffffff;
            --border: #e5e7eb;
            --muted: #6b7280;
            --primary: #2563eb;
            --orange-bg: #fff4e6;
        }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: var(--bg); }
        .container { max-width: 100%; width: 100%; margin: 16px auto; padding: 0 16px; }
        .card { border:1px solid var(--border); border-radius:10px; padding:16px; background:var(--card); margin-bottom: 16px; }
        .toolbar { margin-bottom: 12px; padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; }
        table { width:100%; border-collapse: collapse; }
        th, td { padding:8px 10px; border-bottom:1px solid #f0f0f0; text-align:left; font-size: 13px; }
        th { background: #fafafa; font-weight: 600; }
        .group-header { background: var(--orange-bg); font-weight: 600; }
        .bizim { color: #059669; font-weight: 600; }
        .kargo { color: #dc2626; font-weight: 600; }
        .btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #f8fafc; }
        .btn.primary { background: var(--primary); border-color: var(--primary); color: #fff; }
        .btn.primary:hover { background: #1d4ed8; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .summary { font-size: 12px; color: var(--muted); margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
    {% include "_nav.html" %}
    <h2>Kısmi Ödeme Siparişleri</h2>
    <div class="toolbar">
        <form method="get" action="/orders/partial-payments">
            <label>Başlangıç: <input type="date" name="start" value="{{ start }}" /></label>
            <label>Bitiş: <input type="date" name="end" value="{{ end }}" /></label>
            <button type="submit" class="btn">Ara</button>
            <a href="/orders/table" class="btn">Geri</a>
        </form>
    </div>
    
    <form id="mergeForm" method="post" action="/orders/merge-partial-payments">
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;">Seç</th>
                        <th>Müşteri</th>
                        <th>Telefon</th>
                        <th>Ürün</th>
                        <th>Sipariş ID</th>
                        <th>Kanal</th>
                        <th>Tutar</th>
                        <th>Ödenen</th>
                        <th>Kalan</th>
                        <th>Data Tarihi</th>
                        <th>Kargo Tarihi</th>
                        <th>Durum</th>
                    </tr>
                </thead>
                <tbody>
                    {% for g in groups %}
                    {% set group_index = loop.index0 %}
                    <tr class="group-header">
                        <td colspan="12" style="padding: 12px;">
                            <strong>Grup:</strong> {{ g.client.name if g.client else 'Bilinmeyen' }} 
                            ({{ g.phone }}) | 
                            <strong>Ürün:</strong> {{ g.item.name if g.item else 'ID: ' + g.item_id|string if g.item_id else 'Yok' }} |
                            <strong>Toplam Ödeme:</strong> {{ '%.2f'|format(g.total_payments or 0) }} |
                            <strong>Max Sipariş Tutarı:</strong> {{ '%.2f'|format(g.max_order_total or 0) }}
                        </td>
                    </tr>
                    {% for o_data in g.orders %}
                    <tr>
                        <td>
                            <input type="checkbox" 
                                   name="order_ids" 
                                   value="{{ o_data.order.id }}" 
                                   data-group="{{ group_index }}"
                                   class="order-checkbox" />
                        </td>
                        <td>
                            <a href="/clients/{{ o_data.order.client_id }}">{{ o_data.client.name if o_data.client else o_data.order.client_id }}</a>
                        </td>
                        <td>{{ o_data.client.phone if o_data.client and o_data.client.phone else '-' }}</td>
                        <td>{{ o_data.item.name if o_data.item else 'ID: ' + o_data.order.item_id|string if o_data.order.item_id else '-' }}</td>
                        <td>
                            <a href="/orders/{{ o_data.order.id }}/edit">#{{ o_data.order.id }}</a>
                            {% if o_data.order.id == g.primary_order_id %}
                                <span style="color: #059669; font-weight: 600;">(Birincil)</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if (o_data.order.source or '') == 'bizim' %}
                                <span class="bizim">bizim</span>
                            {% else %}
                                <span class="kargo">kargo</span>
                            {% endif %}
                        </td>
                        <td>{{ '%.2f'|format(o_data.order_total or 0) }}</td>
                        <td>{{ '%.2f'|format(o_data.paid_amount or 0) }}</td>
                        <td>{{ '%.2f'|format((o_data.order_total or 0) - (o_data.paid_amount or 0)) }}</td>
                        <td>{{ o_data.order.data_date or '-' }}</td>
                        <td>{{ o_data.order.shipment_date or '-' }}</td>
                        <td>{{ o_data.order.status or '-' }}</td>
                    </tr>
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="card">
            <button type="submit" class="btn primary" id="mergeBtn" disabled>Seçilenleri Birleştir</button>
            <span class="summary" id="selectedCount">0 sipariş seçildi</span>
        </div>
    </form>
    
    <script>
        const checkboxes = document.querySelectorAll('.order-checkbox');
        const mergeBtn = document.getElementById('mergeBtn');
        const selectedCount = document.getElementById('selectedCount');
        
        function updateSelection() {
            const selected = Array.from(checkboxes).filter(cb => cb.checked);
            const count = selected.length;
            mergeBtn.disabled = count < 2;
            selectedCount.textContent = count + ' sipariş seçildi';
        }
        
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateSelection);
        });
        
        document.getElementById('mergeForm').addEventListener('submit', function(e) {
            const selected = Array.from(checkboxes).filter(cb => cb.checked);
            if (selected.length < 2) {
                e.preventDefault();
                alert('En az 2 sipariş seçmelisiniz');
                return false;
            }
            if (!confirm('Seçilen siparişleri birleştirmek istediğinizden emin misiniz?')) {
                e.preventDefault();
                return false;
            }
        });
    </script>
    </div>
</body>
</html>

