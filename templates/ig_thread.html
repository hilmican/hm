<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Conversation {{ conversation_id }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .toolbar { display:flex; gap:8px; margin-bottom:12px; }
      .msg { margin:8px 0; display:flex; }
      .bubble { max-width: 70%; padding:10px 12px; border-radius:12px; }
      .in .bubble { background:#f3f4f6; margin-right:auto; }
      .out .bubble { background:#dbeafe; margin-left:auto; }
      .meta { color:#6b7280; font-size:12px; margin-top:4px; }
      button { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
      a { color:#2563eb; text-decoration:none; }
      .toolbar .action { border:1px solid #2563eb; border-radius:6px; padding:6px 10px; font-size:13px; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    {% set lc = link_context or {} %}
    {% set uc = user_context or {} %}
    {% set ai_state = ai_state or {} %}
    <div class="toolbar">
      <a href="/ig/inbox">â† Back to Inbox</a>
      <a class="action" href="/ig/inbox/{{ conversation_id }}/debug" title="AI Debug">AI Debug</a>
      <button id="refresh">Refresh</button>
    </div>
    <div style="display:grid; gap:12px; margin-bottom:16px;">
      <div style="border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
        <h3 style="margin:0 0 8px 0; color:#111827;">KonuÅŸma Ã–zeti</h3>
        <div class="meta">IG KullanÄ±cÄ±sÄ±:
          {% if uc.username %}@{{ uc.username }}
          {% elif other_label %}{{ other_label }}
          {% else %}-{% endif %}
          {% if uc.ig_user_id %} Â· id: {{ uc.ig_user_id }}{% endif %}
        </div>
        {% if uc.contact_name or uc.contact_phone or uc.contact_address %}
          <div class="meta">
            {% if uc.contact_name %}Ad: {{ uc.contact_name }}{% endif %}
            {% if uc.contact_name and uc.contact_phone %} Â· {% endif %}
            {% if uc.contact_phone %}Tel: {{ uc.contact_phone }}{% endif %}
            {% if (uc.contact_name or uc.contact_phone) and uc.contact_address %} Â· {% endif %}
            {% if uc.contact_address %}Adres: {{ uc.contact_address }}{% endif %}
          </div>
        {% endif %}
        {% if uc.linked_order_id %}
          <div class="meta">BaÄŸlÄ± SipariÅŸ: <a href="/orders/{{ uc.linked_order_id }}/edit" style="color:#2563eb;">#{{ uc.linked_order_id }}</a></div>
        {% endif %}
        {% if lc.product_name %}
          <div class="meta">BaÄŸlÄ± ÃœrÃ¼n: {{ lc.product_name }}
            {% if lc.product_slug %}
              <a class="meta" href="/ig/ai/products?focus={{ lc.product_slug }}" target="_blank" rel="noopener">(AI talimatlarÄ±nÄ± dÃ¼zenle)</a>
            {% endif %}
          </div>
        {% elif lc.has_link %}
          <div class="meta">
            BaÄŸlÄ± {{ lc.link_type or 'ad' }}: {{ lc.link_id or lc.ad_id }}
            {% if lc.ad_edit_url %}
              <a class="meta" href="{{ lc.ad_edit_url }}" target="_blank" rel="noopener">dÃ¼zenle â†—</a>
            {% endif %}
          </div>
        {% else %}
          <div class="meta" style="color:#b91c1c;">HenÃ¼z reklama/Ã¼rÃ¼ne baÄŸlanmadÄ±.</div>
        {% endif %}
        {% if ai_state.label %}
          <div class="meta">AI Durumu: {{ ai_state.label }}{% if ai_state.description %} â€” {{ ai_state.description }}{% endif %}</div>
        {% endif %}
        {% if ai_state.needs_link %}
          {% if lc.product_slug %}
            <button id="aiRetryBtn" class="action" style="margin-top:8px; font-size:13px;">ÃœrÃ¼n baÄŸlandÄ±, AI'yi sÄ±raya al</button>
          {% else %}
            <div class="meta" style="color:#b91c1c;">Ã–nce ilgili reklamÄ±/postu Ã¼rÃ¼ne baÄŸlayÄ±n.</div>
          {% endif %}
        {% endif %}
      </div>
    </div>
    {% if shadow and shadow.text and not inline_drafts %}
      <div style="margin:12px 0; padding:12px; border:1px dashed #93c5fd; background:#eff6ff; border-radius:10px;">
        <div style="font-weight:600; color:#1e40af; margin-bottom:6px;">AI Ã–neri (gÃ¶nderilmedi)</div>
        <div style="white-space:pre-wrap; color:#111827;">{{ shadow.text }}</div>
        {% if shadow.timestamp_ms %}
          <div class="meta"><span class="ts" data-ts="{{ shadow.timestamp_ms }}">{{ shadow.timestamp_ms }}</span></div>
        {% endif %}
        <div class="meta" style="margin-top:6px;">
          model={{ shadow.model or '-' }} Â· gÃ¼ven={{ ('%.2f' % shadow.confidence) if shadow.confidence is not none else '-' }} Â· sebep={{ shadow.reason or '-' }}
        </div>
        {% if shadow.actions %}
          <div style="margin-top:8px;">
            <div class="meta" style="font-weight:600; color:#1f2937;">ğŸ¤– Planlanan Aksiyonlar</div>
            {% for action in shadow.actions %}
              <div class="meta" style="margin-top:4px;">
                â€¢ {{ action.type }}
                {% if action.trigger %} Â· tetikleyici: {{ action.trigger }}{% endif %}
                {% if action.image_count %} Â· {{ action.image_count }} gÃ¶rsel{% endif %}
                {% if action.product_name %} Â· Ã¼rÃ¼n: {{ action.product_name }}{% elif action.product_slug %} Â· Ã¼rÃ¼n: {{ action.product_slug }}{% endif %}
              </div>
              {% if action.type == 'send_product_images' and action.image_urls %}
                <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                  {% for img_url in action.image_urls %}
                    <a href="{{ img_url }}" target="_blank" rel="noopener" style="display:inline-block; border:1px solid #e5e7eb; border-radius:6px; overflow:hidden;">
                      <img src="{{ img_url }}" alt="AI product" style="width:80px; height:80px; object-fit:cover;" />
                    </a>
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="useShadow" class="action" type="button">Metni kutuya al</button>
          <button id="dismissShadow" class="action" type="button" style="border-color:#ef4444;color:#ef4444">Gizle</button>
        </div>
      </div>
    {% endif %}
  <div style="margin-top:18px">
    <h3>AI Ã‡Ä±ktÄ±sÄ±</h3>
    {% if ai_status %}<div class="meta">Durum: {{ ai_status }}</div>{% endif %}
    <pre id="aiBox" style="background:#0b1021;color:#e5e7eb; padding:12px; border-radius:8px; max-height:300px; overflow:auto; white-space:pre-wrap;">{{ ai_json or 'HenÃ¼z AI verisi yok.' }}</pre>
    <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h4 style="margin:0; color:#111827;">ÃœrÃ¼n AI TalimatlarÄ±
          {% if focus_product and focus_product.id %}
            <a href="/ig/ai/products?focus={{ focus_product.slug or focus_product.name }}" target="_blank" rel="noopener" class="meta" style="margin-left:6px;">(dÃ¼zenle)</a>
          {% endif %}
        </h4>
        {% if focus_product %}
          <button id="toggleAiInstructions" type="button" class="action" style="font-size:12px; padding:4px 8px;">GÃ¶ster</button>
        {% endif %}
      </div>
      {% if focus_product %}
        <div id="aiInstructionsContent" style="display:none;">
          <div class="meta">
            ÃœrÃ¼n: {{ focus_product.name or '-' }}
            {% if focus_product.price %} Â· fiyat: {{ '%.0f' % focus_product.price }}â‚º{% endif %}
            {% if focus_product.confidence is not none %} Â· gÃ¼ven: {{ '%.2f' % focus_product.confidence }}{% endif %}
          </div>
          {% if focus_product.system %}
            <div style="margin-top:8px; white-space:pre-wrap; font-size:13px;"><strong>System:</strong> {{ focus_product.system }}</div>
          {% endif %}
          {% if focus_product.prompt %}
            <div style="margin-top:8px; white-space:pre-wrap; font-size:13px;"><strong>Prompt:</strong> {{ focus_product.prompt }}</div>
          {% endif %}
        </div>
      {% else %}
        <div class="meta" style="color:#b91c1c;">
          Bu konuÅŸma henÃ¼z Ã¼rÃ¼ne baÄŸlanmadÄ±. Ä°lgili reklamÄ± Ã¼rÃ¼ne eÅŸledikten sonra AI talimatlarÄ±nÄ± dÃ¼zenleyebilirsiniz.
        </div>
      {% endif %}
    </div>
    <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
      <h4 style="margin:0 0 8px 0; color:#111827;">ZenginleÅŸtirme Durumu</h4>
      {% if enrich %}
        <div class="meta">KullanÄ±cÄ±: {{ enrich.username or '-' }} {% if enrich.name %} ({{ enrich.name }}){% endif %}</div>
        <div class="meta">Durum: {{ enrich.fetch_status or 'bilinmiyor' }} {% if enrich.fetched_at %}Â· fetched_at: {{ enrich.fetched_at }}{% endif %}</div>
        {% if enrich.fetch_error %}<div class="meta">Hata: {{ enrich.fetch_error }}</div>{% endif %}
        <div class="meta">Kuyruk (enrich_user) uzunluÄŸu: {{ enrich.queue_depth if enrich.queue_depth is not none else '-' }}</div>
        {% if enrich.job and enrich.job.id %}
          <div class="meta">Bekleyen iÅŸ: #{{ enrich.job.id }} Â· attempts={{ enrich.job.attempts or 0 }} {% if enrich.job.run_after %}Â· run_after={{ enrich.job.run_after }}{% endif %}</div>
        {% else %}
          <div class="meta">Bekleyen enrich_user iÅŸi yok.</div>
        {% endif %}
      {% else %}
        <div class="meta">ZenginleÅŸtirme bilgisi mevcut deÄŸil.</div>
      {% endif %}
      <div style="margin-top:8px;">
        <button id="enrichNow" class="action" style="margin-right:6px">Åimdi ZenginleÅŸtir</button>
        <button id="hydrateNow" class="action" style="margin-right:6px">Hydrate Now</button>
        <button id="statusRefresh" class="action">Durumu Yenile</button>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btnMergeGraph" class="action" title="dm:<id> â†’ Graph CID'e taÅŸÄ±" style="background:#0ea5e9">Graph CID'e BirleÅŸtir</button>
        <button id="btnNormalizeDm" class="action" title="Eski mesajlarda dm:&lt;id&gt; conversation_id dÃ¼zelt" style="background:#10b981">dm:&lt;id&gt; Normalize</button>
        <button id="btnBackfillAi" class="action" title="ai_conversations son mesaj alanlarÄ±nÄ± geri doldur" style="background:#6366f1">AI Ã–zetlerini Geri Doldur</button>
      </div>
    </div>
    {% if contact_name or contact_phone or contact_address or linked_order_id %}
      <div style="margin-top:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px;">
        <h4 style="margin:0 0 8px 0; color:#111827;">Ã‡Ä±karÄ±lan Bilgiler</h4>
        <ul style="list-style:none; padding:0; margin:0; color:#374151; font-size:13px; display:grid; gap:6px;">
          {% if contact_name %}<li><strong>Ad:</strong> {{ contact_name }}</li>{% endif %}
          {% if contact_phone %}<li><strong>Telefon:</strong> <a href="tel:{{ contact_phone }}" style="color:#2563eb;">{{ contact_phone }}</a></li>{% endif %}
          {% if contact_address %}<li><strong>Adres:</strong> {{ contact_address }}</li>{% endif %}
          {% if linked_order_id %}<li><strong>BaÄŸlÄ± SipariÅŸ:</strong> <a href="/orders/{{ linked_order_id }}/edit" style="color:#2563eb;">#{{ linked_order_id }}</a></li>{% endif %}
        </ul>
      </div>
    {% endif %}
  </div>
    <h2>
      Conversation {{ other_label or conversation_id }}
      {% if other_label %}<a class="meta" target="_blank" rel="noopener" href="https://instagram.com/{{ other_label[1:] }}">profile â†—</a>{% endif %}
      {% if contact_name or contact_phone or contact_address %}
        <div class="meta">{{ contact_name or '' }}{% if contact_name and contact_phone %} Â· {% endif %}{{ contact_phone or '' }}{% if (contact_name or contact_phone) and contact_address %} Â· {% endif %}{{ contact_address or '' }}</div>
      {% endif %}
    </h2>
    <div id="thread">
      {% for m in messages %}
        <div class="msg {{ m.direction or 'in' }}">
          <div class="bubble" {% if m.is_ai_draft %}{% if m.ai_decision_status == 'no_reply' %}style="border:1px dashed #f59e0b; background:#fef3c7;"{% else %}style="border:1px dashed #93c5fd; background:#eff6ff;"{% endif %}{% endif %}>
            <div>
              {% set u_map = usernames if usernames is defined else {} %}
              {% set uname = m.sender_username or (u_map.get(m.ig_sender_id or '')) %}
              {% if uname %}
                <span class="meta">@{{ uname }}</span><br/>
              {% elif m.ig_sender_id %}
                <span class="meta">id: {{ m.ig_sender_id }}</span><br/>
              {% endif %}
              {{ m.text or '' }}
              {% if m.is_ai_draft %}
                <div class="meta" style="margin-top:4px">
                  {% if m.ai_decision_status == 'no_reply' %}
                    <span style="color:#f59e0b; font-weight:600;">âš ï¸ AI KararÄ±: Cevap verilmeyecek</span>
                  {% elif m.ai_decision_status == 'suggested' %}
                    <span style="color:#3b82f6; font-weight:600;">ğŸ’¬ AI Ã–nerisi</span>
                  {% elif m.ai_decision_status == 'dismissed' %}
                    <span style="color:#6b7280; font-weight:600;">âŒ AI Ã–nerisi (Reddedildi)</span>
                  {% else %}
                    <span style="color:#6366f1; font-weight:600;">ğŸ¤– AI Aksiyonu</span>
                  {% endif %}
                  {% if m.ai_model %} Â· model: {{ m.ai_model }}{% endif %}
                  {% if m.ai_reason %} Â· {{ m.ai_reason }}{% endif %}
                  {% if m.draft_id %}
                    Â· <a href="/ig/inbox/shadow/{{ m.draft_id }}" target="_blank" rel="noopener">DetaylarÄ± gÃ¶r</a>
                  {% endif %}
                </div>
                {% if m.ai_decision_status != 'no_reply' %}
                <div style="margin-top:6px">
                  {% set draft_slug = m.product_slug or (focus_product.slug if focus_product else None) %}
                  {% if draft_slug %}
                    <a class="action" href="/ig/ai/products?focus={{ draft_slug }}" target="_blank" rel="noopener">ÃœrÃ¼n AI mesajlarÄ±nÄ± dÃ¼zenle â†—</a>
                  {% else %}
                    <span class="meta" style="color:#b91c1c;">ÃœrÃ¼n baÄŸlantÄ±sÄ± yok (AI talimatÄ± dÃ¼zenlenemez)</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if m.ai_actions %}
                  <div style="margin-top:8px;">
                    <div class="meta" style="font-weight:600; color:#1f2937;">ğŸ¤– Planlanan Aksiyonlar</div>
                    {% for action in m.ai_actions %}
                      <div class="meta" style="margin-top:4px;">
                        â€¢ {{ action.type }}
                        {% if action.trigger %} Â· tetikleyici: {{ action.trigger }}{% endif %}
                        {% if action.image_count %} Â· {{ action.image_count }} gÃ¶rsel{% endif %}
                        {% if action.product_name %} Â· Ã¼rÃ¼n: {{ action.product_name }}{% elif action.product_slug %} Â· Ã¼rÃ¼n: {{ action.product_slug }}{% endif %}
                      </div>
                      {% if action.type == 'send_product_images' and action.image_urls %}
                        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                          {% for img_url in action.image_urls %}
                            <a href="{{ img_url }}" target="_blank" rel="noopener" style="display:inline-block; border:1px solid #e5e7eb; border-radius:6px; overflow:hidden;">
                              <img src="{{ img_url }}" alt="AI product" style="width:80px; height:80px; object-fit:cover;" />
                            </a>
                          {% endfor %}
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              {% endif %}
            </div>
            {% set local_ids = att_ids_map.get(m.ig_message_id or '') %}
            {% if local_ids %}
              {% for aid in local_ids %}
                <div style="margin-top:8px">
                  <img src="/ig/media/local/{{ aid }}" alt="attachment" style="max-width:280px;border-radius:8px;border:1px solid #e5e7eb" />
                </div>
              {% endfor %}
            {% elif att_map.get(m.ig_message_id) %}
              {% for idx in att_map.get(m.ig_message_id) %}
                <div style="margin-top:8px">
                  <img src="/ig/media/{{ m.ig_message_id }}/{{ idx }}" alt="attachment" style="max-width:280px;border-radius:8px;border:1px solid #e5e7eb" />
                </div>
              {% endfor %}
            {% endif %}
            <div class="meta"><span class="ts" data-ts="{{ m.timestamp_ms or '' }}">{{ m.timestamp_ms }}</span>
              {% if m.ad_id or m.ad_link or m.ad_title %}
                Â· Replied to an ad{% if m.ad_title or m.ad_id %}: {{ m.ad_title or m.ad_id }}{% endif %}
                {% set ad_url = m.ad_link or (('https://www.facebook.com/ads/library/?id=' ~ m.ad_id) if m.ad_id else None) %}
                {% if ad_url %} (<a target="_blank" rel="noopener" href="{{ ad_url }}">link</a>){% endif %}
                {% set ad = (ads_cache.get(m.ad_id|string) if (ads_cache is defined and m.ad_id) else None) %}
                {% set ap = (ad_products.get(m.ad_id|string) if (ad_products is defined and m.ad_id) else None) %}
                {% if ap and ap.product_name %}
                  Â· ÃœrÃ¼n: {{ ap.product_name }}
                  {% if m.ad_id %}
                    <a class="meta" href="/ads/{{ m.ad_id }}/edit" title="ÃœrÃ¼n baÄŸlantÄ±sÄ±nÄ± dÃ¼zenle">(dÃ¼zenle)</a>
                  {% endif %}
                {% elif m.ad_id %}
                  Â· <a class="meta" href="/ads/{{ m.ad_id }}/edit" title="ReklamÄ± Ã¼rÃ¼ne baÄŸla">ReklamÄ± BaÄŸla</a>
                {% endif %}
                {% if ad and ad.image_url %}
                  <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
                    <img src="{{ ad.image_url }}" alt="ad" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb" />
                    <div class="meta">{{ ad.name or '' }}</div>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
      {% if inline_drafts and shadow and shadow.text %}
        <div class="msg out">
          <div class="bubble" style="border:1px dashed #93c5fd; background:#eff6ff;">
            <div style="font-weight:600; color:#1e40af; margin-bottom:6px;">AI Ã–neri (gÃ¶nderilmedi)</div>
            <div style="white-space:pre-wrap; color:#111827;">{{ shadow.text }}</div>
            <div class="meta" style="margin-top:6px;">
              model={{ shadow.model or '-' }} Â· gÃ¼ven={{ ('%.2f' % shadow.confidence) if shadow.confidence is not none else '-' }} Â· sebep={{ shadow.reason or '-' }}
            </div>
            {% if shadow.actions %}
              <div style="margin-top:8px;">
                <div class="meta" style="font-weight:600; color:#1f2937;">ğŸ¤– Planlanan Aksiyonlar</div>
                {% for action in shadow.actions %}
                  <div class="meta" style="margin-top:4px;">
                    â€¢ {{ action.type }}
                    {% if action.trigger %} Â· tetikleyici: {{ action.trigger }}{% endif %}
                    {% if action.image_count %} Â· {{ action.image_count }} gÃ¶rsel{% endif %}
                    {% if action.product_name %} Â· Ã¼rÃ¼n: {{ action.product_name }}{% elif action.product_slug %} Â· Ã¼rÃ¼n: {{ action.product_slug }}{% endif %}
                  </div>
                  {% if action.type == 'send_product_images' and action.image_urls %}
                    <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                      {% for img_url in action.image_urls %}
                        <a href="{{ img_url }}" target="_blank" rel="noopener" style="display:inline-block; border:1px solid #e5e7eb; border-radius:6px; overflow:hidden;">
                          <img src="{{ img_url }}" alt="AI product" style="width:80px; height:80px; object-fit:cover;" />
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button id="sendDraft" class="action" type="button">GÃ¶nder</button>
              <button id="editDraft" class="action" type="button">DÃ¼zenle</button>
              <button id="dismissDraft" class="action" type="button" style="border-color:#ef4444;color:#ef4444">Sil</button>
            </div>
          </div>
        </div>
      {% endif %}
      {% if not messages %}
        <div class="meta">No messages cached yet.</div>
      {% endif %}
    </div>
    <div style="margin-top:16px">
      <form id="replyForm" style="display:flex;gap:8px">
        <input id="replyInput" type="text" placeholder="Type a reply..." style="flex:1;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px" />
        <button id="sendBtn" type="submit" style="background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer">Send</button>
      </form>
    </div>
    <script>
      const conversationId = {{ conversation_id | tojson }};
      function fmtTs(){
        const nodes = document.querySelectorAll('.ts');
        for(const el of nodes){
          const v = el.getAttribute('data-ts');
          const ms = Number(v||0);
          if(ms>0){ const d = new Date(ms); el.textContent = d.toLocaleString(); }
          else { el.textContent = '-'; }
        }
      }
      fmtTs();

      // Toggle AI Instructions visibility
      const toggleAiInstructions = document.getElementById('toggleAiInstructions');
      const aiInstructionsContent = document.getElementById('aiInstructionsContent');
      if (toggleAiInstructions && aiInstructionsContent) {
        toggleAiInstructions.addEventListener('click', () => {
          const isHidden = aiInstructionsContent.style.display === 'none';
          aiInstructionsContent.style.display = isHidden ? 'block' : 'none';
          toggleAiInstructions.textContent = isHidden ? 'Gizle' : 'GÃ¶ster';
        });
      }

      const btn = document.getElementById('refresh');
      btn?.addEventListener('click', async () => {
        btn.disabled = true; btn.textContent = 'Refreshing...';
        try {
          const r = await fetch(location.pathname + '/refresh', { method: 'POST' });
          if (!r.ok) throw new Error('refresh failed');
          location.reload();
        } catch (e) { alert('Refresh error'); }
      });
      const aiRetryBtn = document.getElementById('aiRetryBtn');
      aiRetryBtn?.addEventListener('click', async () => {
        if (!confirm('KonuÅŸmayÄ± tekrar AI kuyruÄŸuna almak istiyor musunuz?')) return;
        aiRetryBtn.disabled = true; const prev = aiRetryBtn.textContent;
        aiRetryBtn.textContent = 'SÄ±raya alÄ±nÄ±yor...';
        try {
          const r = await fetch(`/ig/inbox/${conversationId}/ai/retry`, { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(js.error || 'retry_failed');
          alert('AI kuyruÄŸa eklendi. BirkaÃ§ saniye iÃ§inde durum gÃ¼ncellenecek.');
          location.reload();
        } catch (e) {
          alert('AI kuyruÄŸuna alma baÅŸarÄ±sÄ±z: ' + (e?.message || e));
        } finally {
          aiRetryBtn.disabled = false;
          aiRetryBtn.textContent = prev;
        }
      });
      // Manual enrich enqueue
      const enrichBtn = document.getElementById('enrichNow');
      enrichBtn?.addEventListener('click', async () => {
        enrichBtn.disabled = true; const prev = enrichBtn.textContent; enrichBtn.textContent = 'Kuyruk kontrol ediliyor...';
        try {
          // Check queue sizes first
          let before = {};
          try {
            const qs = await fetch('/ig/queue/status');
            before = await qs.json();
          } catch {}
          enrichBtn.textContent = 'KuyruÄŸa ekleniyor...';
          const r = await fetch(location.pathname + '/enrich', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          // Get queue sizes after
          let after = {};
          try {
            const qs2 = await fetch('/ig/queue/status');
            after = await qs2.json();
          } catch {}
          alert('Enrich iÅŸi eklendi.\nÃ–nce: ' + JSON.stringify((before.queues||{})) + '\nSonra: ' + JSON.stringify((after.queues||{})));
          location.reload();
        } catch (e) { alert('KuyruÄŸa ekleme hatasÄ±'); }
        finally { enrichBtn.disabled = false; enrichBtn.textContent = prev; }
      });
      const statusBtn = document.getElementById('statusRefresh');
      statusBtn?.addEventListener('click', () => location.reload());
      const hydrateBtn = document.getElementById('hydrateNow');
      hydrateBtn?.addEventListener('click', async () => {
        hydrateBtn.disabled = true; const prev = hydrateBtn.textContent; hydrateBtn.textContent = 'Kuyruk kontrol ediliyor...';
        try {
          // Check queue sizes first
          let before = {};
          try {
            const qs = await fetch('/ig/queue/status');
            before = await qs.json();
          } catch {}
          hydrateBtn.textContent = 'KuyruÄŸa ekleniyor...';
          const r = await fetch(location.pathname + '/hydrate', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          // Get queue sizes after
          let after = {};
          try {
            const qs2 = await fetch('/ig/queue/status');
            after = await qs2.json();
          } catch {}
          alert('Hydrate kuyruÄŸa eklendi: ' + (js.key || '') + '\nÃ–nce: ' + JSON.stringify((before.queues||{})) + '\nSonra: ' + JSON.stringify((after.queues||{})));
          location.reload();
        } catch (e) { alert('Hydrate kuyruÄŸa ekleme hatasÄ±'); }
        finally { hydrateBtn.disabled = false; hydrateBtn.textContent = prev; }
      });
      // Admin helpers
      const btnMergeGraph = document.getElementById('btnMergeGraph');
      btnMergeGraph?.addEventListener('click', async () => {
        if (!confirm('Bu konuÅŸmayÄ± Graph CID\'e taÅŸÄ±?')) return;
        btnMergeGraph.disabled = true; const prev = btnMergeGraph.textContent; btnMergeGraph.textContent = 'BirleÅŸtiriliyor...';
        try {
          const r = await fetch(location.pathname + '/merge-to-graph', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('TamamlandÄ±. Graph CID: ' + (js.graph_conversation_id||'') );
          // Redirect to new Graph CID if we were on dm:<id>
          if (js.graph_conversation_id) {
            location.href = '/ig/inbox/' + js.graph_conversation_id;
            return;
          }
          location.reload();
        } catch (e) { alert('BirleÅŸtirme hatasÄ±'); }
        finally { btnMergeGraph.disabled = false; btnMergeGraph.textContent = prev; }
      });
      const btnNormalizeDm = document.getElementById('btnNormalizeDm');
      btnNormalizeDm?.addEventListener('click', async () => {
        if (!confirm('Eski mesajlarda dm:<id> conversation_id normalize edilsin mi?')) return;
        btnNormalizeDm.disabled = true; const prev = btnNormalizeDm.textContent; btnNormalizeDm.textContent = 'Normalize ediliyor...';
        try {
          const r = await fetch('/ig/admin/normalize_dm_conversation_ids', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Normalize tamamlandÄ±.\nÄ°ncelenen: ' + (js.considered||0) + '\nDÃ¼zeltilen: ' + (js.normalized||0));
          location.reload();
        } catch (e) { alert('Normalize hatasÄ±'); }
        finally { btnNormalizeDm.disabled = false; btnNormalizeDm.textContent = prev; }
      });
      const btnBackfillAi = document.getElementById('btnBackfillAi');
      btnBackfillAi?.addEventListener('click', async () => {
        if (!confirm('ai_conversations son mesaj alanlarÄ± geri doldurulsun mu?')) return;
        btnBackfillAi.disabled = true; const prev = btnBackfillAi.textContent; btnBackfillAi.textContent = 'Geri dolduruluyor...';
        try {
          const r = await fetch('/ig/admin/backfill/ai_latest', { method: 'POST' });
          const js = await r.json().catch(()=>({}));
          if (!r.ok || js.status !== 'ok') throw new Error(JSON.stringify(js||{}));
          alert('Geri doldurma tamamlandÄ±.\nGÃ¼ncellenen: ' + (js.updated||0) + '\nÄ°ÅŸlenen: ' + (js.considered||0));
          location.reload();
        } catch (e) { alert('Geri doldurma hatasÄ±'); }
        finally { btnBackfillAi.disabled = false; btnBackfillAi.textContent = prev; }
      });
      // Live updates via WebSocket: reload when new message arrives for this conversation
      let wsConnected = false;
      const startWS = () => {
        try {
          const proto = location.protocol === 'https:' ? 'wss' : 'ws';
          const ws = new WebSocket(`${proto}://${location.host}/ig/ws`);
          ws.onopen = () => { wsConnected = true; };
          ws.onclose = () => { wsConnected = false; };
          ws.onerror = () => { wsConnected = false; };
          ws.onmessage = (ev) => {
            try {
              const data = JSON.parse(ev.data);
              if (data && data.type === 'ig_message' && data.conversation_id === 'dm:{{ conversation_id }}') {
                location.reload();
              }
            } catch {}
          };
        } catch { wsConnected = false; }
      };
      startWS();
      // Poll fallback every 15s if sockets fail
      setInterval(async () => {
        if (wsConnected) return;
        try { await fetch(location.pathname + '/refresh', { method: 'POST' }); location.reload(); } catch {}
      }, 15000);

      // Send reply
      const form = document.getElementById('replyForm');
      const input = document.getElementById('replyInput');
      const useShadow = document.getElementById('useShadow');
      const dismissShadow = document.getElementById('dismissShadow');
      const sendDraft = document.getElementById('sendDraft');
      const editDraft = document.getElementById('editDraft');
      const dismissDraft = document.getElementById('dismissDraft');
      useShadow?.addEventListener('click', () => {
        try {
          const txt = {{ (shadow.text if shadow and shadow.text else "") | tojson | safe }};
          if (input && txt) input.value = txt;
        } catch {}
      });
      dismissShadow?.addEventListener('click', async () => {
        try {
          dismissShadow.disabled = true;
          const r = await fetch(location.pathname + '/shadow/dismiss', { method: 'POST' });
          if (!r.ok) throw new Error('dismiss failed');
          location.reload();
        } catch (e) {
          alert('Gizleme hatasÄ±');
        } finally {
          dismissShadow.disabled = false;
        }
      });
      // Inline draft controls
      sendDraft?.addEventListener('click', async () => {
        try {
          sendDraft.disabled = true;
          const text = {{ (shadow.text if shadow and shadow.text else "") | tojson | safe }};
          if (!text) return;
          const r = await fetch(location.pathname + '/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
          if (!r.ok) throw new Error(await r.text());
          await fetch(location.pathname + '/shadow/dismiss', { method: 'POST' }).catch(()=>{});
          location.reload();
        } catch (e) {
          alert('GÃ¶nderme hatasÄ±');
        } finally {
          sendDraft.disabled = false;
        }
      });
      editDraft?.addEventListener('click', () => {
        try {
          const txt = {{ (shadow.text if shadow and shadow.text else "") | tojson | safe }};
          if (input && txt) { input.value = txt; input.focus(); }
        } catch {}
      });
      dismissDraft?.addEventListener('click', async () => {
        try {
          dismissDraft.disabled = true;
          const r = await fetch(location.pathname + '/shadow/dismiss', { method: 'POST' });
          if (!r.ok) throw new Error('dismiss failed');
          location.reload();
        } catch (e) {
          alert('Silme hatasÄ±');
        } finally {
          dismissDraft.disabled = false;
        }
      });
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = (input?.value || '').trim();
        if (!text) return;
        try {
          const r = await fetch(location.pathname + '/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
          if (!r.ok) {
            const t = await r.text();
            alert('Send failed: ' + t);
            return;
          }
          input.value = '';
          location.reload();
        } catch (e) {
          alert('Send error');
        }
      });
    </script>
  </body>
</html>

