<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ReklamÄ± ÃœrÃ¼ne BaÄŸla</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .meta { color:#6b7280; font-size:12px; }
      .card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin:12px 0; background:#f9fafb; }
      input { padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; }
      label { display:block; font-size:13px; color:#111827; margin-bottom:6px; }
      .row { display:flex; gap:8px; align-items:center; }
      button { background:#2563eb; color:#fff; border:none; border-radius:8px; padding:10px 12px; cursor:pointer; }
      a { color:#2563eb; text-decoration:none; }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <h1>ReklamÄ± ÃœrÃ¼ne BaÄŸla</h1>
    <div class="card">
      <div class="row">
        {% if ad and ad.image_url %}
          <img src="{{ ad.image_url }}" alt="ad" style="width:96px;height:96px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb" />
        {% endif %}
        <div>
          <div><strong>Ad ID:</strong> {{ ad.ad_id or '-' }}</div>
          <div><strong>BaÅŸlÄ±k:</strong> {{ ad.name or ad.title or '-' }}</div>
          {% if ad.link %}<div><a href="{{ ad.link }}" target="_blank" rel="noopener">Ads link â†—</a></div>{% endif %}
          {% if ad.fetch_status %}<div class="meta">Durum: {{ ad.fetch_status }} {% if ad.updated_at %}Â· {{ ad.updated_at }}{% endif %}</div>{% endif %}
          {% if ad.fetch_error %}<div class="meta">Hata: {{ ad.fetch_error }}</div>{% endif %}
        </div>
      </div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px 0;">Mevcut BaÄŸlantÄ±</h3>
      <div class="meta">
        Product ID: {{ mapping.product_id or '-' }}
        {% if mapping.sku %} Â· SKU (eski): {{ mapping.sku }}{% endif %}
        {% if not mapping.product_id %}
          Â· <span style="color:#b91c1c;">Bu reklam henÃ¼z bir Ã¼rÃ¼ne baÄŸlÄ± deÄŸil.</span>
        {% else %}
          Â· <span style="color:#16a34a;">Bu reklam bir Ã¼rÃ¼ne baÄŸlÄ±.</span>
        {% endif %}
      </div>
    </div>
    <form method="post" action="/ads/{{ ad_id }}/save" style="margin-top:12px;" id="adForm">
      <div style="display:grid; gap:12px; max-width:420px;">
        <div>
          <label>ÃœrÃ¼n SeÃ§imi</label>
          <select name="product_id" id="productSelect" style="width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px;">
            <option value="">ÃœrÃ¼n seÃ§iniz</option>
            {% for p in products or [] %}
              <option value="{{ p.id }}" {% if mapping.product_id and p.id == mapping.product_id %}selected{% endif %}>
                {{ p.name }}
              </option>
            {% endfor %}
          </select>
          <div class="meta" style="margin-top:4px;">Bu reklamÄ± baÄŸlamak istediÄŸiniz Ã¼rÃ¼nÃ¼ seÃ§in. Beden / renk gibi varyantlar bu sayfada ayrÄ±ÅŸtÄ±rÄ±lmaz.</div>
        </div>
        <div>
          <button type="button" id="aiSuggestBtn" style="background:#10b981; margin-right:8px;">ğŸ¤– AI ile Ã–ner</button>
          <button type="submit">Kaydet</button>
          {% if ad and ad.ad_id %}<a style="margin-left:8px" href="/ig/inbox?q={{ ad.ad_id }}">Ä°nboxta ara</a>{% endif %}
        </div>
        <div id="aiResult" style="display:none; padding:8px; border-radius:8px; margin-top:8px; font-size:13px;"></div>
      </div>
    </form>
    <script>
      const aiBtn = document.getElementById('aiSuggestBtn');
      const productSelect = document.getElementById('productSelect');
      const aiResult = document.getElementById('aiResult');
      
      if (aiBtn) {
        aiBtn.addEventListener('click', async () => {
          if (!aiBtn) return;
          const adId = '{{ ad_id }}';
          aiBtn.disabled = true;
          aiBtn.textContent = 'â³ Ä°ÅŸleniyor...';
          aiResult.style.display = 'none';
          
          try {
            const response = await fetch(`/ads/${adId}/ai/suggest`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(errorText || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.product_id) {
              // Set the product in the select
              productSelect.value = data.product_id;
              aiResult.style.display = 'block';
              aiResult.style.background = '#d1fae5';
              aiResult.style.color = '#065f46';
              aiResult.innerHTML = `âœ… Ã–nerilen Ã¼rÃ¼n: <strong>${data.product_name || 'ID: ' + data.product_id}</strong> (GÃ¼ven: ${(data.confidence * 100).toFixed(0)}%)${data.notes ? '<br><small>' + data.notes + '</small>' : ''}`;
            } else {
              aiResult.style.display = 'block';
              aiResult.style.background = '#fef3c7';
              aiResult.style.color = '#92400e';
              aiResult.innerHTML = `âš ï¸ Uygun Ã¼rÃ¼n bulunamadÄ±.${data.notes ? '<br><small>' + data.notes + '</small>' : ''}`;
            }
          } catch (error) {
            aiResult.style.display = 'block';
            aiResult.style.background = '#fee2e2';
            aiResult.style.color = '#991b1b';
            aiResult.innerHTML = `âŒ Hata: ${error.message}`;
          } finally {
            aiBtn.disabled = false;
            aiBtn.textContent = 'ğŸ¤– AI ile Ã–ner';
          }
        });
      }
    </script>
  </body>
  </html>


