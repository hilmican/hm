<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Günlük Rapor</title>
        <style>
            body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
            h1 { margin-bottom: 12px; }
            .nav { display:flex; gap:8px; flex-wrap:wrap; padding:8px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; }
            .nav a { padding:6px 10px; border-radius:6px; color:#1f2937; text-decoration:none; border:1px solid transparent; }
            .nav a:hover { background:#eef2ff; border-color:#c7d2fe; color:#1d4ed8; }
            .nav a.active { background:#e0e7ff; border-color:#c7d2fe; color:#1d4ed8; }
            .toolbar { display:flex; gap:12px; align-items:flex-end; margin:14px 0; flex-wrap:wrap; }
            .card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
            .card h2 { margin: 0; padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
            .kpis { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
            @media (min-width: 1000px) { .kpis { grid-template-columns: repeat(4, minmax(0,1fr)); } }
            .kpi { padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; }
            .kpi .label { font-size:12px; color:#6b7280; }
            .kpi .value { font-size:18px; font-weight:600; margin-top:4px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
            th { background: #fafafa; position: sticky; top: 0; }
            .grid { display:grid; grid-template-columns: 1fr; gap:18px; }
            @media (min-width: 1200px) { .grid { grid-template-columns: 1fr 1fr; } }
            .caption { color:#6b7280; font-size:12px; padding:8px 0; }
            .btn { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer }
            input[type=date], select { padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
            .radio { display:flex; gap:8px; align-items:center; }
        </style>
    </head>
    <body>
        {% include "_nav.html" %}
        <h1>Günlük Rapor</h1>
        <div class="nav">
            <a href="/dashboard">Panel</a>
            <a href="/clients/table">Müşteriler</a>
            <a href="/items/table">Varyantlar</a>
            <a href="/products/table">Ürünler</a>
            <a href="/orders/table">Siparişler</a>
            <a href="/inventory/table">Stok</a>
            <a class="active" href="/reports/daily">Günlük Rapor</a>
        </div>

        <form class="toolbar" method="get" action="/reports/daily" onsubmit="/*noop*/">
            <div>
                <label style="display:block;font-size:12px;color:#374151">Başlangıç</label>
                <input type="date" name="start" value="{{ start }}" />
            </div>
            <div>
                <label style="display:block;font-size:12px;color:#374151">Bitiş</label>
                <input type="date" name="end" value="{{ end }}" />
            </div>
            <div>
                <label style="display:block;font-size:12px;color:#374151">Tarih alanı</label>
                <div class="radio">
                    <label><input type="radio" name="date_field" value="shipment" {% if date_field=='shipment' %}checked{% endif %}/> kargo_tarihi</label>
                    <label><input type="radio" name="date_field" value="data" {% if date_field=='data' %}checked{% endif %}/> data_tarihi</label>
                    <label><input type="radio" name="date_field" value="both" {% if date_field=='both' %}checked{% endif %}/> ikisinden biri</label>
                </div>
            </div>
            <div>
                <button class="btn" type="submit" onclick="this.closest('form').method='get'; this.closest('form').action='/reports/daily'">Uygula</button>
            </div>
            <div>
                <button class="btn" type="button" onclick="recalcCosts()" style="background:#0ea5e9">Maliyeti Yeniden Hesapla</button>
            </div>
        </form>

        <div class="kpis">
            <div class="kpi"><div class="label">Toplam Satış</div><div class="value">{{ '%.2f'|format(total_sales or 0) }}</div></div>
            <div class="kpi"><div class="label">Sipariş</div><div class="value">{{ order_count or 0 }}</div></div>
            <div class="kpi"><div class="label">Toplam Adet</div><div class="value">{{ total_quantity or 0 }}</div></div>
            <div class="kpi"><div class="label">Sipariş Başına Ortalama</div><div class="value">{{ '%.2f'|format(aov or 0) }}</div></div>
            <div class="kpi"><div class="label">Ortalama Satış Fiyatı</div><div class="value">{{ '%.2f'|format(asp or 0) }}</div></div>
            <div class="kpi"><div class="label">Toplam Maliyet</div><div class="value">{{ '%.2f'|format(total_cost or 0) }}</div></div>
            <div class="kpi"><div class="label">Brüt Kâr</div><div class="value">{{ '%.2f'|format(gross_profit or 0) }}</div></div>
            <div class="kpi"><div class="label">Brüt Marj</div><div class="value">{{ '%.1f'|format((gross_margin or 0)*100) }}%</div></div>
            <div class="kpi"><div class="label">Tahsilat (Brüt)</div><div class="value">{{ '%.2f'|format(gross_collected or 0) }}</div></div>
            <div class="kpi"><div class="label">Tahsilat (Net)</div><div class="value">{{ '%.2f'|format(net_collected or 0) }}</div></div>
            <div class="kpi"><div class="label">Toplam Kesintiler</div><div class="value">{{ '%.2f'|format(total_fees or 0) }}</div></div>
            <div class="kpi"><div class="label">Tahsilat Oranı</div><div class="value">{{ '%.1f'|format((collection_ratio or 0)*100) }}%</div></div>
            <div class="kpi"><div class="label">Dönem Siparişlerinde Kalan</div><div class="value">{{ '%.2f'|format(outstanding or 0) }}</div></div>
            <div class="kpi"><div class="label">Net Kâr</div><div class="value">{{ '%.2f'|format(net_profit or 0) }}</div></div>
        </div>

        <div class="grid" style="margin-top:16px;">
            <div class="card">
                <h2>Kanallara Göre Sipariş</h2>
                <table>
                    <thead>
                        <tr><th>Kaynak</th><th>Adet</th><th>Satış</th></tr>
                    </thead>
                    <tbody>
                        {% for src, vals in by_channel.items() %}
                        <tr>
                            <td>{{ src }}</td>
                            <td>{{ vals.count|int }}</td>
                            <td>{{ '%.2f'|format(vals.sales or 0) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>Ödemeler (dönem içinde)</h2>
                <table>
                    <thead>
                        <tr><th>Komisyon</th><th>Hizmet</th><th>Kargo</th><th>İade</th><th>Erken Ödeme</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ '%.2f'|format(fee_breakdown.komisyon or 0) }}</td>
                            <td>{{ '%.2f'|format(fee_breakdown.hizmet or 0) }}</td>
                            <td>{{ '%.2f'|format(fee_breakdown.kargo or 0) }}</td>
                            <td>{{ '%.2f'|format(fee_breakdown.iade or 0) }}</td>
                            <td>{{ '%.2f'|format(fee_breakdown.erken_odeme or 0) }}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="caption">Brüt: {{ '%.2f'|format(gross_collected or 0) }}, Net: {{ '%.2f'|format(net_collected or 0) }}, Kesintiler: {{ '%.2f'|format(total_fees or 0) }}</div>
            </div>

            <div class="card">
                <h2>Hasılata Göre Ürünler</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>SKU</th><th>Ad</th><th>Hasılat</th><th>Adet</th></tr>
                    </thead>
                    <tbody>
                        {% for it in top_items_by_revenue %}
                        <tr>
                            <td>{{ it.item_id }}</td>
                            <td>{{ it.sku }}</td>
                            <td>{{ it.name }}</td>
                            <td>{{ '%.2f'|format(it.revenue or 0) }}</td>
                            <td>{{ it.quantity|int }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>Adede Göre Ürünler</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>SKU</th><th>Ad</th><th>Adet</th><th>Hasılat</th></tr>
                    </thead>
                    <tbody>
                        {% for it in top_items_by_quantity %}
                        <tr>
                            <td>{{ it.item_id }}</td>
                            <td>{{ it.sku }}</td>
                            <td>{{ it.name }}</td>
                            <td>{{ it.quantity|int }}</td>
                            <td>{{ '%.2f'|format(it.revenue or 0) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>Hasılata Göre Müşteriler</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>Ad</th><th>Telefon</th><th>Hasılat</th></tr>
                    </thead>
                    <tbody>
                        {% for c in top_clients %}
                        <tr>
                            <td>{{ c.client_id }}</td>
                            <td>{{ c.name }}</td>
                            <td>{{ c.phone }}</td>
                            <td>{{ '%.2f'|format(c.revenue or 0) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>İçe Aktarmalar (dönem içinde)</h2>
                <table>
                    <thead>
                        <tr><th>Kaynak</th><th>Dosya</th><th>Data Tarihi</th><th>Satır</th><th>Oluşan (M/V/S/Ö)</th></tr>
                    </thead>
                    <tbody>
                        {% for r in recent_imports %}
                        <tr>
                            <td>{{ r.source }}</td>
                            <td>{{ r.filename }}</td>
                            <td>{{ r.data_date }}</td>
                            <td>{{ r.row_count }}</td>
                            <td>{{ r.created_clients }}/{{ r.created_items }}/{{ r.created_orders }}/{{ r.created_payments }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="caption">Toplam çalıştırma: {{ imports_total }}, Satır: {{ imports_row_count }}, Oluşan M/V/S/Ö: {{ imports_created.clients }}/{{ imports_created.items }}/{{ imports_created.orders }}/{{ imports_created.payments }}</div>
            </div>

            <div class="card">
                <h2>Stok Hareketleri (dönem içinde)</h2>
                <table>
                    <thead>
                        <tr><th>Giriş</th><th>Çıkış</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>{{ qty_in|int }}</td><td>{{ qty_out|int }}</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="card">
                <h2>Siparişler (filtreli)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Takip</th>
                            <th>Müşteri</th>
                            <th>Ürün</th>
                            <th>Adet</th>
                            <th>Toplam</th>
                            <th>Kargo Tarihi</th>
                            <th>Data Tarihi</th>
                            <th>Kanal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for o in orders %}
                        <tr>
                            <td>{{ o.id }}</td>
                            <td>{{ o.tracking_no }}</td>
                            <td>{{ client_map.get(o.client_id).name if o.client_id in client_map else o.client_id }}</td>
                            <td>
                                {% if o.item_id and o.item_id in item_map %}
                                    {{ item_map.get(o.item_id).sku }} - {{ item_map.get(o.item_id).name }}
                                {% else %}
                                    {{ o.item_id }}
                                {% endif %}
                            </td>
                            <td>{{ o.quantity or 0 }}</td>
                            <td>{{ '%.2f'|format(o.total_amount or 0) }}</td>
                            <td>{{ o.shipment_date }}</td>
                            <td>{{ o.data_date }}</td>
                            <td>{{ o.source }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <script>
        async function recalcCosts(){
            try{
                const params = new URLSearchParams(new FormData(document.querySelector('form.toolbar')));
                const res = await fetch(`/reports/recalculate-costs?${params.toString()}`, { method: 'POST' });
                if(!res.ok){
                    const t = await res.text();
                    alert('Hesaplama başarısız: ' + t);
                    return;
                }
                const j = await res.json();
                alert(`Güncellendi: ${j.updated_orders} sipariş`);
                // Refresh the page to reflect recalculated totals
                location.href = `/reports/daily?${params.toString()}`;
            }catch(e){
                alert('Ağ hatası: ' + e);
            }
        }
        </script>
    </body>
    </html>


