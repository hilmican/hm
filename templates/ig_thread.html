<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Conversation {{ conversation_id }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .toolbar { display:flex; gap:8px; margin-bottom:12px; }
      .msg { margin:8px 0; display:flex; }
      .bubble { max-width: 70%; padding:10px 12px; border-radius:12px; }
      .in .bubble { background:#f3f4f6; margin-right:auto; }
      .out .bubble { background:#dbeafe; margin-left:auto; }
      .meta { color:#6b7280; font-size:12px; margin-top:4px; }
      button { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
      a { color:#2563eb; text-decoration:none; }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <a href="/ig/inbox">‚Üê Back to Inbox</a>
      <button id="refresh">Refresh</button>
    </div>
    <h2>Conversation {{ conversation_id }}</h2>
    <div id="thread">
      {% for m in messages %}
        <div class="msg {{ m.direction or 'in' }}">
          <div class="bubble">
            <div>
              {% if m.sender_username %}<span class="meta">@{{ m.sender_username }}</span><br/>{% endif %}
              {{ m.text or '' }}
            </div>
            <div class="meta">{{ m.timestamp_ms }}</div>
          </div>
        </div>
      {% endfor %}
      {% if not messages %}
        <div class="meta">No messages cached yet.</div>
      {% endif %}
    </div>
    <script>
      const btn = document.getElementById('refresh');
      btn?.addEventListener('click', async () => {
        btn.disabled = true; btn.textContent = 'Refreshing...';
        try {
          const r = await fetch(location.pathname + '/refresh', { method: 'POST' });
          if (!r.ok) throw new Error('refresh failed');
          location.reload();
        } catch (e) { alert('Refresh error'); }
      });
      // Live updates via WebSocket: reload when new message arrives for this conversation
      let wsConnected = false;
      const startWS = () => {
        try {
          const proto = location.protocol === 'https:' ? 'wss' : 'ws';
          const ws = new WebSocket(`${proto}://${location.host}/ig/ws`);
          ws.onopen = () => { wsConnected = true; };
          ws.onclose = () => { wsConnected = false; };
          ws.onerror = () => { wsConnected = false; };
          ws.onmessage = (ev) => {
            try {
              const data = JSON.parse(ev.data);
              if (data && data.type === 'ig_message' && data.conversation_id === 'dm:{{ conversation_id }}') {
                location.reload();
              }
            } catch {}
          };
        } catch { wsConnected = false; }
      };
      startWS();
      // Poll fallback every 15s if sockets fail
      setInterval(async () => {
        if (wsConnected) return;
        try { await fetch(location.pathname + '/refresh', { method: 'POST' }); location.reload(); } catch {}
      }, 15000);
    </script>
  </body>
</html>

