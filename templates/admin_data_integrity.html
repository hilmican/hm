<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Veri Butunlugu Kontrolu</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px 0; }
    .muted { color: #6b7280; font-size: 13px; }
    .toolbar { margin: 12px 0 18px 0; display:flex; gap:8px; align-items:center; }
    .toolbar input { padding: 6px 8px; border:1px solid #d1d5db; border-radius: 6px; width: 120px; }
    .btn { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; text-decoration:none; display:inline-block; }
    .btn:hover { background:#1d4ed8; }
    .btn-danger { background:#b91c1c; }
    .btn-danger:hover { background:#991b1b; }
    .btn-secondary { background:#374151; }
    .btn-secondary:hover { background:#1f2937; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    .card { border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; background:#fff; }
    .card h2 { margin:0; padding:10px 14px; background:#f9fafb; border-bottom:1px solid #e5e7eb; font-size:16px; }
    .body { padding: 10px 14px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #f3f4f6; padding:6px 8px; text-align:left; font-size:13px; vertical-align: top; }
    th { background:#fafafa; }
    .ok { color:#059669; }
    .warn { color:#b45309; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .actions { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
    .small { font-size:12px; }
    .meta { margin-top:4px; color:#4b5563; }
    .link { color:#2563eb; text-decoration:none; }
    .link:hover { text-decoration:underline; }
  </style>
</head>
<body>
  {% include "_nav.html" %}
  <h1>Veri Butunlugu Kontrolu</h1>
  <div class="muted">Satis ve odeme kayitlarinda potansiyel ciftleri/tutarsizliklari listeler. Her satirda detay linkleri ve hizli aksiyonlar vardir.</div>

  <form class="toolbar" method="get" action="/admin/data-integrity">
    <label>Limit</label>
    <input type="number" name="limit" value="{{ limit }}" min="10" max="500" />
    <label style="display:flex; gap:6px; align-items:center;">
      <input type="checkbox" name="include_cancelled" value="1" {% if include_cancelled %}checked{% endif %} />
      cancelled dahil et
    </label>
    <label style="display:flex; gap:6px; align-items:center;">
      <input type="checkbox" name="include_returned" value="1" {% if include_returned %}checked{% endif %} />
      iade/refunded dahil et
    </label>
    <button class="btn" type="submit">Yenile</button>
  </form>

  <div class="grid">
    <div class="card">
      <h2>Cift Siparis Adaylari (tracking_no bazli) - {{ dup_tracking|length }}</h2>
      <div class="body">
        {% if dup_tracking %}
        <table>
          <thead>
            <tr><th>Tracking</th><th>Adet</th><th>Siparisler ve Karar</th></tr>
          </thead>
          <tbody>
            {% for g in dup_tracking %}
            <tr>
              <td class="mono">
                {{ g.tracking_no }}
                <div class="meta"><a class="link" href="/excel-tracker?order_id={{ g.canonical_order_id or '' }}" target="_blank">Excel Tracker</a></div>
              </td>
              <td>{{ g.count }}</td>
              <td>
                {% for o in g.orders %}
                  <div class="mono">
                    <a class="link" href="/orders/{{ o.id }}/edit" target="_blank">#{{ o.id }}</a>
                    | client=<a class="link" href="/clients/{{ o.client_id }}" target="_blank">{{ o.client_id }}</a>
                    | src={{ o.source }}
                    | st={{ o.status or '-' }}
                    | total={{ o.total_amount or 0 }}
                    {% if g.canonical_order_id == o.id %}<strong> | KANONIK</strong>{% endif %}
                  </div>
                {% endfor %}
                <div class="actions">
                  {% if g.canonical_order_id %}
                  <button class="btn btn-secondary small" onclick="mergeTrackingOrders('{{ g.tracking_no }}', {{ g.canonical_order_id }})">
                    Bu tracking'i #{{ g.canonical_order_id }} altinda birlestir
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="ok">Kayit bulunmadi.</div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <h2>Cift Odeme Adaylari (reference + amount) - {{ dup_payments|length }}</h2>
      <div class="body">
        {% if dup_payments %}
        <table>
          <thead>
            <tr><th>Reference</th><th>Tutar</th><th>Adet</th><th>Odeme Kayitlari ve Karar</th></tr>
          </thead>
          <tbody>
            {% for g in dup_payments %}
            <tr>
              <td class="mono">{{ g.reference }}</td>
              <td>{{ '%.2f'|format(g.amount or 0) }}</td>
              <td>{{ g.count }}</td>
              <td>
                {% for p in g.payments %}
                  <div class="mono">
                    pay#{{ p.id }}
                    {% if p.order_id %}| order=<a class="link" href="/orders/{{ p.order_id }}/edit" target="_blank">#{{ p.order_id }}</a>{% endif %}
                    | client=<a class="link" href="/clients/{{ p.client_id }}" target="_blank">{{ p.client_id }}</a>
                    | src={{ p.order_source or '-' }}
                    | st={{ p.order_status or '-' }}
                    | date={{ p.date }}
                    | pdate={{ p.payment_date or '-' }}
                    {% if g.canonical_payment_id == p.id %}<strong> | KANONIK</strong>{% endif %}
                  </div>
                {% endfor %}
                <div class="actions">
                  {% if g.canonical_payment_id %}
                  <button class="btn btn-secondary small" onclick="dedupePaymentGroup('{{ g.reference }}', {{ g.amount or 0 }}, {{ g.canonical_payment_id }})">
                    Cift odemeleri temizle (keep pay#{{ g.canonical_payment_id }})
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="ok">Kayit bulunmadi.</div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <h2>Payment Client Uyumsuzlugu (payment.client_id != order.client_id) - {{ client_mismatches|length }}</h2>
      <div class="body">
        {% if client_mismatches %}
        <table>
          <thead>
            <tr><th>Payment</th><th>Order</th><th>Payment Client</th><th>Order Client</th><th>Tutar</th><th>Reference</th><th>Aksiyon</th></tr>
          </thead>
          <tbody>
            {% for r in client_mismatches %}
            <tr>
              <td>pay#{{ r.id }}</td>
              <td><a class="link" href="/orders/{{ r.order_id }}/edit" target="_blank">#{{ r.order_id }}</a></td>
              <td class="warn"><a class="link" href="/clients/{{ r.payment_client_id }}" target="_blank">{{ r.payment_client_id }}</a></td>
              <td><a class="link" href="/clients/{{ r.order_client_id }}" target="_blank">{{ r.order_client_id }}</a></td>
              <td>{{ '%.2f'|format(r.amount or 0) }}</td>
              <td class="mono">{{ r.reference or '-' }}</td>
              <td>
                <button class="btn btn-secondary small" onclick="syncPaymentClient({{ r.id }})">payment.client'i order.client ile senkronla</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="ok">Kayit bulunmadi.</div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <h2>Kargo Placeholder + Bizim Siparis Cakisimi - {{ placeholder_overlaps|length }}</h2>
      <div class="body">
        {% if placeholder_overlaps %}
        <table>
          <thead>
            <tr><th>Tracking</th><th>Kargo Siparis</th><th>Bizim Siparis</th><th>Aksiyon</th></tr>
          </thead>
          <tbody>
            {% for r in placeholder_overlaps %}
            <tr>
              <td class="mono">{{ r.tracking_no }}</td>
              <td class="mono">
                <a class="link" href="/orders/{{ r.kargo_order_id }}/edit" target="_blank">#{{ r.kargo_order_id }}</a>
                | client=<a class="link" href="/clients/{{ r.kargo_client_id }}" target="_blank">{{ r.kargo_client_id }}</a>
                | st={{ r.kargo_status or '-' }} | total={{ r.kargo_total or 0 }}
              </td>
              <td class="mono">
                <a class="link" href="/orders/{{ r.bizim_order_id }}/edit" target="_blank">#{{ r.bizim_order_id }}</a>
                | client=<a class="link" href="/clients/{{ r.bizim_client_id }}" target="_blank">{{ r.bizim_client_id }}</a>
                | st={{ r.bizim_status or '-' }} | total={{ r.bizim_total or 0 }}
              </td>
              <td>
                <button class="btn btn-secondary small" onclick="mergeTrackingOrders('{{ r.tracking_no }}', {{ r.bizim_order_id }})">
                  Kargo'yu Bizim'e birlestir
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="ok">Kayit bulunmadi.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <script>
    async function postJson(url, payload) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload || {})
      });
      const data = await res.json();
      return { ok: res.ok, data: data, status: res.status };
    }

    async function runActionWithPreview(url, payload, previewFormatter, successMsg) {
      try {
        const preview = await postJson(url, { ...(payload || {}), preview: true });
        if (!preview.ok) {
          alert('Onizleme hatasi: ' + (preview.data.detail || preview.data.error || preview.status));
          return;
        }
        const summary = previewFormatter(preview.data || {});
        const msg = `Onizleme:\\n${summary}\\n\\nUygulansin mi?`;
        if (!confirm(msg)) return;

        const apply = await postJson(url, { ...(payload || {}), preview: false });
        if (!apply.ok) {
          alert('Uygulama hatasi: ' + (apply.data.detail || apply.data.error || apply.status));
          return;
        }
        alert(successMsg || 'Tamamlandi');
        location.reload();
      } catch (e) {
        alert('Istek hatasi: ' + (e && e.message ? e.message : e));
      }
    }

    function syncPaymentClient(paymentId) {
      runActionWithPreview(
        '/admin/data-integrity/actions/sync-payment-client',
        { payment_id: paymentId },
        (p) => {
          if (!p.will_change) {
            return `Payment #${p.payment_id}: degisiklik yok (client zaten ${p.current_client_id})`;
          }
          return `Payment #${p.payment_id}: client ${p.current_client_id} -> ${p.new_client_id}`;
        },
        'Payment client senkronlandi'
      );
    }

    function dedupePaymentGroup(reference, amount, keepPaymentId) {
      runActionWithPreview(
        '/admin/data-integrity/actions/dedupe-payment-group',
        {
          reference: reference,
          amount: amount,
          keep_payment_id: keepPaymentId
        },
        (p) => {
          const drop = (p.drop_payment_ids || []).join(', ') || '-';
          return [
            `Reference: ${p.reference}`,
            `Amount: ${p.amount}`,
            `Keep payment: #${p.keep_payment_id}`,
            `Silinecek payment id'ler: ${drop}`,
            `Toplam silinecek: ${p.will_delete || 0}`
          ].join('\\n');
        },
        'Cift odeme kayitlari temizlendi'
      );
    }

    function mergeTrackingOrders(trackingNo, keepOrderId) {
      runActionWithPreview(
        '/admin/data-integrity/actions/merge-tracking-orders',
        {
          tracking_no: trackingNo,
          keep_order_id: keepOrderId,
          delete_merged: true
        },
        (p) => {
          const lines = [
            `Tracking: ${p.tracking_no}`,
            `Kanonik siparis: #${p.keep_order_id}`,
            `Birlesecek siparis adedi: ${p.merge_count || 0}`,
          ];
          (p.merge_plan || []).forEach((m) => {
            const c = m.reference_counts || {};
            lines.push(
              `- #${m.from_order_id} -> #${m.to_order_id} (payment:${c.payment||0}, importrow:${c.importrow||0}, orderitem:${c.orderitem||0}, stock:${c.stockmovement||0})`
            );
          });
          return lines.join('\\n');
        },
        'Siparisler birlestirildi'
      );
    }
  </script>
</body>
</html>
