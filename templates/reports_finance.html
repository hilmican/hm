<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Finans Raporu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      h1 { margin-bottom: 12px; }
      .toolbar { display:flex; gap:12px; align-items:flex-end; margin:14px 0; flex-wrap:wrap; }
      .btn { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer }
      table { width: 100%; border-collapse: collapse; margin-top: 18px; }
      th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
      th { background: #fafafa; position: sticky; top: 0; }
      .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:18px; }
      .card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background:#fff; }
      .card h2 { margin: 0; padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
      .card .body { padding: 12px 16px; }
      .stat-card { text-align: center; }
      .stat-value { font-size: 32px; font-weight: 600; margin: 8px 0; }
      .stat-label { color: #6b7280; font-size: 14px; }
      .balance-positive { color: #059669; }
      .balance-negative { color: #dc2626; }
      .balance-zero { color: #6b7280; }
      .leak-warning { background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px; margin: 8px 0; }
      .leak-warning strong { color: #dc2626; }
      .pagination { display: flex; gap: 8px; align-items: center; margin-top: 12px; flex-wrap: wrap; }
      .pagination a, .pagination span { padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 4px; text-decoration: none; color: #374151; }
      .pagination a:hover { background: #f3f4f6; }
      .pagination .current { background: #2563eb; color: #fff; border-color: #2563eb; }
      .pagination .disabled { color: #9ca3af; cursor: not-allowed; }
      a { color: #2563eb; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .muted { color: #6b7280; font-size: 13px; margin-bottom: 8px; }
      
      /* Mobile responsive styles */
      @media (max-width: 768px) {
        body { margin: 12px; }
        h1 { font-size: 20px; }
        .toolbar { flex-direction: column; align-items: stretch; }
        .toolbar > div { width: 100%; }
        .toolbar input[type="date"] { width: 100%; }
        .grid { grid-template-columns: 1fr; gap: 12px; }
        .stat-value { font-size: 24px; }
        table { font-size: 12px; }
        th, td { padding: 6px 8px; }
        .card .body { padding: 8px 12px; }
        .pagination { justify-content: center; }
        .pagination a, .pagination span { padding: 4px 8px; font-size: 12px; }
        .card { margin-top: 12px; }
      }
      
      @media (max-width: 480px) {
        body { margin: 8px; }
        h1 { font-size: 18px; margin-bottom: 8px; }
        table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        th, td { font-size: 11px; padding: 4px 6px; white-space: nowrap; }
        .stat-value { font-size: 20px; }
        .stat-label { font-size: 12px; }
      }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <h1>Finans Raporu</h1>

    <form class="toolbar" method="get" action="/reports/finance">
      <div>
        <label style="display:block;font-size:12px;color:#374151">Başlangıç</label>
        <input type="date" name="start" value="{{ start }}" />
      </div>
      <div>
        <label style="display:block;font-size:12px;color:#374151">Bitiş</label>
        <input type="date" name="end" value="{{ end }}" />
      </div>
      <div>
        <button class="btn" type="submit">Uygula</button>
      </div>
      <!-- Preserve pagination when changing dates (will reset to page 1) -->
      <input type="hidden" name="leaks_page" value="1" />
      <input type="hidden" name="leaks_per_page" value="{{ leaks_per_page }}" />
    </form>

    <div class="grid" style="margin-top: 18px;">
      <div class="card stat-card">
        <div class="body">
          <div class="stat-label">Toplam Gelir</div>
          <div class="stat-value balance-positive">{{ '%.2f'|format(total_income) }} ₺</div>
        </div>
      </div>
      <div class="card stat-card">
        <div class="body">
          <div class="stat-label">Toplam Gider</div>
          <div class="stat-value balance-negative">{{ '%.2f'|format(total_expenses) }} ₺</div>
        </div>
      </div>
      <div class="card stat-card">
        <div class="body">
          <div class="stat-label">Net</div>
          <div class="stat-value {% if (total_income - total_expenses) > 0 %}balance-positive{% elif (total_income - total_expenses) < 0 %}balance-negative{% else %}balance-zero{% endif %}">
            {{ '%.2f'|format(total_income - total_expenses) }} ₺
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 18px;">
      <h2>Hesap Bakiyeleri</h2>
      <div class="body" style="padding:0">
        <table>
          <thead>
            <tr>
              <th>Hesap</th>
              <th>Tür</th>
              <th>Güncel Bakiye</th>
              <th>Gelir (Dönem)</th>
              <th>Gider (Dönem)</th>
            </tr>
          </thead>
          <tbody>
            {% for acc in accounts %}
            {% if acc.id %}
            <tr>
              <td><a href="/accounts/{{ acc.id }}/transactions">{{ acc.name }}</a></td>
              <td>{{ acc.type }}</td>
              <td>
                {% set balance = balances.get(acc.id, 0.0) %}
                <span class="{% if balance > 0 %}balance-positive{% elif balance < 0 %}balance-negative{% else %}balance-zero{% endif %}">
                  {{ '%.2f'|format(balance) }} ₺
                </span>
              </td>
              <td>{{ '%.2f'|format(income_by_account.get(acc.id, 0.0)) }} ₺</td>
              <td>{{ '%.2f'|format(expense_by_account.get(acc.id, 0.0)) }} ₺</td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% if leaks or total_leaks > 0 %}
    <div class="card" style="margin-top: 18px;">
      <h2>⚠️ Ödenmemiş Siparişler (Nakit Sızıntısı)</h2>
      <div class="body" style="padding:0">
        <div style="padding: 12px 16px;">
          <p class="muted">7 günden eski ve henüz tahsil edilmemiş siparişler: <strong>{{ total_leaks }}</strong> adet</p>
        </div>
        {% if leaks %}
        <table>
          <thead>
            <tr>
              <th>Sipariş #</th>
              <th>Takip No</th>
              <th>Tarih</th>
              <th>Toplam</th>
              <th>Beklenen Ödeme</th>
            </tr>
          </thead>
          <tbody>
            {% for leak in leaks %}
            <tr>
              <td><a href="/orders/{{ leak.order_id }}">#{{ leak.order_id }}</a></td>
              <td>{{ leak.tracking_no or '-' }}</td>
              <td>{{ leak.shipment_date or leak.data_date or '-' }}</td>
              <td>{{ '%.2f'|format(leak.total_amount or 0) }} ₺</td>
              <td class="balance-negative"><strong>{{ '%.2f'|format(leak.expected_payment) }} ₺</strong></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        
        {% if total_pages > 1 or leaks_per_page != 50 %}
        <div style="padding: 12px 16px; border-top: 1px solid #e5e7eb;">
          <div class="pagination">
            {% if leaks_page > 1 %}
            <a href="?start={{ start }}&end={{ end }}&leaks_page={{ leaks_page - 1 }}&leaks_per_page={{ leaks_per_page }}">« Önceki</a>
            {% else %}
            <span class="disabled">« Önceki</span>
            {% endif %}
            
            {% if total_pages > 1 %}
              {% for page in range(1, total_pages + 1) %}
                {% if page == leaks_page %}
                <span class="current">{{ page }}</span>
                {% elif page == 1 or page == total_pages or (page >= leaks_page - 2 and page <= leaks_page + 2) %}
                <a href="?start={{ start }}&end={{ end }}&leaks_page={{ page }}&leaks_per_page={{ leaks_per_page }}">{{ page }}</a>
                {% elif page == leaks_page - 3 or page == leaks_page + 3 %}
                <span>...</span>
                {% endif %}
              {% endfor %}
            {% endif %}
            
            {% if leaks_page < total_pages %}
            <a href="?start={{ start }}&end={{ end }}&leaks_page={{ leaks_page + 1 }}&leaks_per_page={{ leaks_per_page }}">Sonraki »</a>
            {% else %}
            <span class="disabled">Sonraki »</span>
            {% endif %}
            
            <span style="margin-left: auto; color: #6b7280; font-size: 13px; margin-right: 12px;">
              Sayfa {{ leaks_page }} / {{ total_pages }} ({{ total_leaks }} toplam)
            </span>
            
            <form method="get" action="/reports/finance" style="display: inline-flex; gap: 4px; align-items: center;">
              <input type="hidden" name="start" value="{{ start }}" />
              <input type="hidden" name="end" value="{{ end }}" />
              <input type="hidden" name="leaks_page" value="1" />
              <label style="font-size: 13px; color: #6b7280;">Sayfa başına:</label>
              <select name="leaks_per_page" onchange="this.form.submit()" style="padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px;">
                <option value="25" {% if leaks_per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if leaks_per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if leaks_per_page == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if leaks_per_page == 200 %}selected{% endif %}>200</option>
              </select>
            </form>
          </div>
        </div>
        {% endif %}
        {% else %}
        <div style="padding: 12px 16px; color: #6b7280;">
          Bu sayfada gösterilecek ödenmemiş sipariş bulunmuyor.
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <div class="card" style="margin-top: 18px;">
      <h2>Son İşlemler</h2>
      <div class="body" style="padding:0">
        <table>
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Tür</th>
              <th>Hesap</th>
              <th>Açıklama</th>
              <th>Tutar</th>
            </tr>
          </thead>
          <tbody>
            {% for txn in recent_transactions %}
            <tr>
              <td>{{ txn.date }}</td>
              <td>{{ 'Gelir' if txn.type == 'income' else 'Gider' }}</td>
              <td>{{ txn.account }}</td>
              <td>{{ txn.description }}</td>
              <td class="{% if txn.amount > 0 %}balance-positive{% else %}balance-negative{% endif %}">
                {{ '%.2f'|format(txn.amount) }} ₺
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </body>
</html>

