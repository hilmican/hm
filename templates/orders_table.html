<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Siparisler</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
        th { background: #fafafa; position: sticky; top: 0; cursor: pointer; user-select: none; }
        tr:nth-child(even) { background: #fcfcfd; }
        .toolbar { margin: 12px 0; display: flex; gap: 8px; align-items: center; }
        .toolbar input { padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; width: 320px; }
        .pill { font-size: 12px; padding: 2px 8px; background: #eef2ff; color: #4338ca; border-radius: 999px; }
        a { color: #2563eb; text-decoration: none; }
        tr.paid { background: #eaffea; }
        tr.unpaid { background: #fff9db; }
        tr.refunded { color: #b91c1c; background: #ffe5e5; }
        tr.stitched { color: #92400e; background: #ede0d4; }
        .btn { padding:4px 8px; border-radius:6px; border:1px solid #d1d5db; background:#fff; cursor:pointer; font-size:12px; }
        .btn:hover { background:#f8fafc; }
        .btn.warn { border-color:#ef4444; color:#b91c1c; }
        .btn.accent { border-color:#92400e; color:#92400e; }
    </style>
    <script>
        function filterTable(table, q){
            const rows = table.tBodies[0].rows; const s = q.trim().toLowerCase();
            for (const r of rows){ const txt = r.textContent.toLowerCase(); r.style.display = s && txt.indexOf(s) === -1 ? 'none' : ''; }
        }
        function cmp(a,b,isNum){ if (isNum){ const na=parseFloat(a)||0, nb=parseFloat(b)||0; return na-nb; } return a.localeCompare(b,'tr'); }
        function sortTable(table, idx, dir){
            const rows = Array.from(table.tBodies[0].rows);
            const isNum = table.tHead.rows[0].cells[idx].dataset.type === 'num';
            rows.sort((r1,r2)=>{
                const a=r1.cells[idx].dataset.sort || r1.cells[idx].textContent.trim();
                const b=r2.cells[idx].dataset.sort || r2.cells[idx].textContent.trim();
                return dir==='asc'?cmp(a,b,isNum):cmp(b,a,isNum);
            });
            for(const r of rows) table.tBodies[0].appendChild(r);
        }
        function attach(table){ const ths=table.tHead.rows[0].cells; let active=-1, dir='asc'; for(let i=0;i<ths.length;i++){ ths[i].addEventListener('click',()=>{ dir=(active===i&&dir==='asc')?'desc':'asc'; active=i; sortTable(table,i,dir); }); } }
        function init(){ const table=document.getElementById('ordersTbl'); attach(table); const si=document.getElementById('search'); si.addEventListener('input',()=>filterTable(table, si.value)); }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</head>
<body>
    {% include "_nav.html" %}
    <div class="toolbar">
        <input id="search" type="search" placeholder="Siparis ara (musteri, urun, takip)" />
        <form method="get" action="/orders/table" style="display:flex; gap:8px; align-items:center;">
            <select name="date_field">
                <option value="shipment" {{ 'selected' if (date_field == 'shipment') else '' }}>Kargo Tarihi</option>
                <option value="data" {{ 'selected' if (date_field == 'data') else '' }}>Data Tarihi</option>
                <option value="both" {{ 'selected' if (date_field == 'both') else '' }}>Birlesik</option>
            </select>
            <input type="date" name="start" value="{{ start }}" />
            <input type="date" name="end" value="{{ end }}" />
            <select name="source">
                <option value="" {{ 'selected' if not source else '' }}>Tum Kanallar</option>
                <option value="bizim" {{ 'selected' if source == 'bizim' else '' }}>bizim</option>
                <option value="kargo" {{ 'selected' if source == 'kargo' else '' }}>kargo</option>
            </select>
            <select name="status">
                <option value="" {{ 'selected' if not status else '' }}>Tum Durumlar</option>
                <option value="paid" {{ 'selected' if status == 'paid' else '' }}>Yesil (Odendi)</option>
                <option value="unpaid" {{ 'selected' if status == 'unpaid' else '' }}>Sari (Odenmedi)</option>
                <option value="refunded" {{ 'selected' if status == 'refunded' else '' }}>Kirmizi (Iade)</option>
                <option value="stitched" {{ 'selected' if status == 'stitched' else '' }}>Kahverengi (Dikis)</option>
            </select>
            <button type="submit">Filtrele</button>
            <a href="/orders/table" style="font-size:12px; color:#6b7280;">Temizle</a>
        </form>
        <span class="pill">{{ rows|length }} siparis</span>
        <button onclick="recalc()">Tazele</button>
    </div>
    <h2>Siparisler</h2>
    <table id="ordersTbl">
        <thead>
            <tr><th>ID</th><th>Takip</th><th>Musteri</th><th>Urun</th><th>Adet</th><th>Toplam</th><th>Maliyet</th><th>Kargo</th><th>Kargo Tarihi</th><th>Data Tarihi</th><th>Kanali</th><th></th></tr>
            <tr>
                <th colspan="4" style="text-align:right">Toplamlar:</th>
                <th data-type="num">{{ sum_qty }}</th>
                <th data-type="num">{{ '%.2f'|format(sum_total or 0) }}</th>
                <th data-type="num">{{ '%.2f'|format(sum_cost or 0) }}</th>
                <th data-type="num">{{ '%.2f'|format(sum_shipping or 0) }}</th>
                <th colspan="3"></th>
            </tr>
        </thead>
        <tbody>
            {% for o in rows %}
            {% set rowcls = status_map.get(o.id) if status_map else '' %}
            <tr class="{{ rowcls }}">
                <td>{{ o.id }}</td>
                <td>{{ o.tracking_no }}</td>
                <td>
                    {% set cname = client_map.get(o.client_id) if client_map else o.client_id %}
                    <a href="/clients/{{ o.client_id }}">{{ cname }}</a>
                </td>
                <td>{{ o.notes or '' }}</td>
                <td>{{ o.quantity }}</td>
                <td>
                    <span id="tot-{{ o.id }}">{{ o.total_amount }}</span>
                    <button class="btn" onclick="editTotal({{ o.id }}, '{{ '%.2f'|format(o.total_amount or 0) }}')">DÃ¼zenle</button>
                </td>
                <td>{{ (cost_map.get(o.id) if cost_map else o.total_cost) }}</td>
                <td>{{ '%.2f'|format((shipping_map.get(o.id, 0.0) if shipping_map else 0.0)) }}</td>
                <td>{{ o.shipment_date }}</td>
                <td>{{ o.data_date }}</td>
                <td>{{ o.source }}</td>
                <td>
                    <div style="display:flex; gap:6px;">
                        <button class="btn warn" onclick="refund({{ o.id }})">Iade</button>
                        <button class="btn accent" onclick="stitch({{ o.id }})">Dikis</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <script>
    async function recalc(){
        try{
            const res = await fetch('/orders/recalc-financials', { method: 'POST' });
            if(!res.ok){
                const t = await res.text();
                alert('Hesaplama hatasi: ' + t);
                return;
            }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }

    async function refund(id){
        try{
            const res = await fetch(`/orders/${id}/refund`, { method: 'POST' });
            if(!res.ok){ alert('Iade hatasi'); return; }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }
    async function stitch(id){
        try{
            const res = await fetch(`/orders/${id}/stitch`, { method: 'POST' });
            if(!res.ok){ alert('Dikis hatasi'); return; }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }
    async function editTotal(id, cur){
        const s = prompt('Yeni Toplam:', cur);
        if(s === null) return;
        const val = s.replace(',', '.');
        const num = parseFloat(val);
        if(!isFinite(num)){ alert('Gecersiz tutar'); return; }
        try{
            const res = await fetch(`/orders/${id}/update-total`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ total: num }) });
            if(!res.ok){ const t = await res.text(); alert('Guncelleme hatasi: ' + t); return; }
            location.reload();
        }catch(e){ alert('Ag hatasi: ' + e); }
    }
    </script>
</body>
</html>

