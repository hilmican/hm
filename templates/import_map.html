<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Haritalandirma Sihirbazi</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
        .layout { display: grid; grid-template-columns: 340px 1fr; gap: 16px; }
        .card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
        .card h2 { margin: 0; padding: 10px 12px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; position: sticky; top: 0; z-index: 1; }
        .card .inner { padding: 12px; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        li:hover { background: #fafafa; }
        label { font-size: 12px; color: #6b7280; display:block; margin-top: 8px; }
        input, select { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 6px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
        th { background: #fafafa; }
        .toolbar { display:flex; gap:8px; align-items:center; margin-bottom: 10px; }
        .pill { font-size: 12px; padding: 2px 8px; background: #eef2ff; color: #4338ca; border-radius: 999px; }
        button { background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer }
        .muted { color: #6b7280; font-size: 12px; }
    </style>
</head>
<body>
    <div class="toolbar">
        <a href="/dashboard" style="color:#2563eb;text-decoration:none">← Dashboard</a>
        <span class="pill"><span id="unmatchedCount">{{ total_unmatched or 0 }}</span> row(s) unmatched</span>
        <span class="muted">Source: {{ source }}{% if filenames %}, Files: {{ ", ".join(filenames) }}{% else %}, File: {{ filename }}{% endif %}</span>
        <button id="rescanBtn" type="button">Re-scan</button>
        <button id="aiSuggestBtn" type="button" style="background:#7c3aed">AI ile Öneri Al</button>
        <button id="commitBtn" style="margin-left:auto" disabled>Commit Import</button>
    </div>

    <div class="layout">
        <div class="card" style="grid-column: 1">
            <h2>Eslesmeyen Patternler</h2>
            <div class="inner">
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                    <input id="investigatePat" type="text" placeholder="Arastirilacak pattern (opsiyonel)" style="padding:6px 8px;border:1px solid #ddd;border-radius:6px;flex:1" />
                    <button id="investigateBtn" type="button">Arastir</button>
                </div>
                <ul id="patList">
                    {% for p in unmatched_patterns %}
                    <li data-pattern="{{ p.pattern }}" data-suggested-price="{{ p.suggested_price or '' }}">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <span>{{ p.pattern }}</span>
                            <span class="pill" title="Occurrence count in uploaded file">{{ p.count }}</span>
                        </div>
                        {% if p.samples %}<div class="muted">Samples: {{ ", ".join(p.samples) }}</div>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% if filenames and filenames|length > 1 %}
        <div class="card" style="grid-column: 1">
            <h2>Dosya Bazli Tarihler</h2>
            <div class="inner">
                <table>
                    <thead><tr><th>Dosya</th><th>Data tarihi (YYYY-MM-DD)</th></tr></thead>
                    <tbody id="datesTbody">
                        {% for fn in filenames %}
                        <tr>
                            <td>{{ fn }}</td>
                            <td><input type="date" data-filename="{{ fn }}" /></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="muted">Each file will use its specific date during commit.</div>
            </div>
        </div>
        {% endif %}
        <div class="card" style="grid-column: 2">
            <h2>Editor</h2>
            <div class="inner">
                <div id="editorEmpty" class="muted">Mapping icin bir pattern secin.</div>
                <div id="editor" style="display:none">
                    <label>Pattern</label>
                    <input id="pat" type="text" readonly />

                    <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end;margin-top:8px;">
                        <div>
                            <label>Urun</label>
                            <select id="product"></select>
                        </div>
                        <div>
                            <button id="newProdBtn" type="button">Yeni Urun</button>
                        </div>
                    </div>

                    <div style="margin-top:10px;">
                        <label>Ciktilar (urun, beden, renk, adet, fiyat)</label>
                        <table>
                            <thead><tr><th>Product</th><th>Size</th><th>Color</th><th>Qty</th><th>Price</th><th></th></tr></thead>
                            <tbody id="outs"></tbody>
                        </table>
                        <button id="addOut" type="button" style="margin-top:6px">Cikti Ekle</button>
                        <div id="priceHint" class="muted" style="margin-top:6px"></div>
                    </div>

                    <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
                        <button id="saveRule" type="button" title="Saves a mapping rule for this pattern with the outputs listed below.">Save Rule</button>
                        <button id="saveNext" type="button" style="background:#10b981" title="Saves the rule and jumps to the next unmatched pattern.">Save & Next</button>
                        <span id="saveMsg" class="muted"></span>
                    </div>

                    <div style="margin-top:14px;">
                        <label>Stok (secili urun)</label>
                        <table>
                            <thead><tr><th>Variant</th><th>On-hand</th></tr></thead>
                            <tbody id="inv"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="card" id="aiPanel" style="display:none; grid-column: 2;">
            <h2>AI Önerileri</h2>
            <div class="inner">
                <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                    <button id="applySelected" type="button" style="background:#10b981">Seçileni Uygula</button>
                    <button id="applyAll" type="button" style="background:#059669">Tümünü Uygula</button>
                    <span id="aiMsg" class="muted"></span>
                </div>
                <div>
                    <h3 style="margin:6px 0">Ürün Önerileri</h3>
                    <table id="aiProdTbl">
                        <thead><tr><th><input type="checkbox" id="chkAllProd"/></th><th>Ad</th><th>Slug</th><th>Birim</th><th>Fiyat</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="margin-top:10px">
                    <h3 style="margin:6px 0">Eşleme Kuralları</h3>
                    <table id="aiRuleTbl">
                        <thead><tr><th><input type="checkbox" id="chkAllRule"/></th><th>Pattern</th><th>Mode</th><th>Priority</th><th>Outputs</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>

    <script>
    const products = {{ products | tojson if products else '[]' }};
    const source = {{ source | tojson }};
    const filename = {{ filename | tojson }};
    const filenames = {{ filenames | tojson if filenames else 'null' }};
    const unmatchedCountEl = document.getElementById('unmatchedCount');
    const commitBtn = document.getElementById('commitBtn');
    const rescanBtn = document.getElementById('rescanBtn');
    const datesTbody = document.getElementById('datesTbody');

    function setCommitEnabled(enabled){
        if (enabled) { commitBtn.removeAttribute('disabled'); }
        else { commitBtn.setAttribute('disabled','disabled'); }
    }
    async function refreshPreviewCount(){
        try {
            const body = filenames && Array.isArray(filenames) ? { source, filenames, exclude_generic: false } : { source, filename, exclude_generic: false };
            const r = await fetch('/import/preview-map', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            if (r.ok) {
                const j = await r.json();
                if (unmatchedCountEl) unmatchedCountEl.textContent = String(j.total_unmatched||0);
                setCommitEnabled((j.total_unmatched||0) === 0);
                return j;
            }
        } catch (e) {}
        return null;
    }
    setCommitEnabled((Number(unmatchedCountEl?.textContent||'0')||0) === 0);
    rescanBtn.addEventListener('click', refreshPreviewCount);

    const patList = document.getElementById('patList');
    const editor = document.getElementById('editor');
    const editorEmpty = document.getElementById('editorEmpty');
    const patInp = document.getElementById('pat');
    const productSel = document.getElementById('product');
    const outsTbody = document.getElementById('outs');
    const invTbody = document.getElementById('inv');
    const saveMsg = document.getElementById('saveMsg');
    const investigateBtn = document.getElementById('investigateBtn');
    const investigatePat = document.getElementById('investigatePat');
    const aiBtn = document.getElementById('aiSuggestBtn');
    const aiPanel = document.getElementById('aiPanel');
    const aiMsg = document.getElementById('aiMsg');
    const aiProdTbl = document.getElementById('aiProdTbl');
    const aiRuleTbl = document.getElementById('aiRuleTbl');

    function refillProducts(selectedId){
        productSel.innerHTML = '';
        for (const p of products){
            const opt = document.createElement('option');
            opt.value = p.id; opt.textContent = p.name;
            if (selectedId && Number(selectedId) === Number(p.id)) opt.selected = true;
            productSel.appendChild(opt);
        }
    }

    function addOutputRow(pref){
        const tr = document.createElement('tr');
        // determine default product for the row: use provided, else current selector, else first product
        const defPid = (pref && pref.product_id) ? Number(pref.product_id) : (Number(productSel?.value||0)|| (products[0]?.id||''));
        let prodOpts = '<option value=""></option>';
        for (const p of products){
            const sel = Number(p.id) === Number(defPid) ? 'selected' : '';
            prodOpts += `<option value="${p.id}" ${sel}>${p.name}</option>`;
        }
        tr.innerHTML = `
            <td><select class="prodSel">${prodOpts}</select></td>
            <td><input type="text" placeholder="Size" value="${pref?.size||''}"/></td>
            <td><input type="text" placeholder="Color" value="${pref?.color||''}"/></td>
            <td><input type="number" min="1" value="${pref?.quantity||1}"/></td>
            <td><input type="number" step="0.01" value="${pref?.unit_price||''}"/></td>
            <td><button type="button" class="rm">X</button></td>
        `;
        tr.querySelector('.rm').addEventListener('click', ()=> tr.remove());
        outsTbody.appendChild(tr);
    }

    function guessFromPattern(txt){
        txt = txt || '';
        const up = txt.toUpperCase();
        const sizeTokens = ['XS','S','M','L','XL','XXL','30','31','32','33','34','35','36','38','40','42'];
        const colorTokens = ['SİYAH','SIYAH','LACİVERT','LACIVERT','KREM','AÇIK GRİ','ACIK GRI','GRİ','GRI','BEYAZ'];
        let size = ''; for (const t of sizeTokens){ if (up.includes(t)) { size = t; break; } }
        let color = ''; for (const t of colorTokens){ if (up.includes(t)) { color = t; break; } }
        const isCift = up.includes('ÇİFT')||up.includes('CIFT');
        return { size, color, quantity: isCift ? 2 : 1 };
    }

    function loadInventory(productId){
        invTbody.innerHTML = '';
        if (!productId) return;
        fetch(`/inventory/stock?product_id=${productId}`)
          .then(r=>r.json()).then(j=>{
            for (const it of (j.items||[])){
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${it.name}</td><td>${it.on_hand}</td>`;
                invTbody.appendChild(tr);
            }
          }).catch(()=>{});
    }

    function openPattern(pat){
        editorEmpty.style.display = 'none';
        editor.style.display = '';
        patInp.value = pat;
        refillProducts();
        outsTbody.innerHTML = '';
        addOutputRow(guessFromPattern(pat));
        if (productSel.value) loadInventory(productSel.value);
        // price hint and prefill from suggested price
        try {
            const li = [...patList.querySelectorAll('li[data-pattern]')].find(x=>x.getAttribute('data-pattern')===pat);
            const hintEl = document.getElementById('priceHint');
            const valStr = li ? li.getAttribute('data-suggested-price') : null;
            const val = valStr ? Number(valStr) : NaN;
            if (!isNaN(val) && val > 0) {
                hintEl.textContent = `Suggested price: ${val}`;
                const priceInput = outsTbody.querySelector('tr td:nth-child(5) input');
                if (priceInput && !priceInput.value) priceInput.value = String(val);
            } else {
                hintEl.textContent = '';
            }
        } catch (e) {}
    }

    patList.addEventListener('click', (e)=>{
        const li = e.target.closest('li[data-pattern]');
        if (!li) return;
        openPattern(li.getAttribute('data-pattern'));
    });

    document.getElementById('addOut').addEventListener('click', ()=> addOutputRow({quantity:1}));
    productSel.addEventListener('change', ()=> loadInventory(productSel.value));

    document.getElementById('newProdBtn').addEventListener('click', async ()=>{
        const name = prompt('Yeni urun adi?');
        if (!name) return;
        const fd = new FormData();
        fd.append('name', name);
        fd.append('default_unit', 'adet');
        try {
            const r = await fetch('/products', { method:'POST', body: fd });
            if (!r.ok) throw new Error(await r.text());
            const j = await r.json();
            products.unshift({ id: j.id, name: j.name });
            refillProducts(j.id);
        } catch (e) { alert('Ürün oluşturma hatası'); }
    });

    async function saveRuleCore(){
        const pattern = patInp.value;
        const outputs = [];
        for (const tr of outsTbody.querySelectorAll('tr')){
            const tds = tr.querySelectorAll('td');
            const productId = Number(tds[0].querySelector('select').value || 0) || null;
            const size = tds[1].querySelector('input').value || null;
            const color = tds[2].querySelector('input').value || null;
            const qty = Number(tds[3].querySelector('input').value || 1);
            const priceVal = tds[4].querySelector('input').value;
            const unit_price = priceVal ? Number(priceVal) : null;
            outputs.push({ product_id: productId, size, color, quantity: qty, unit_price });
        }
        const body = { source_pattern: pattern, match_mode: 'exact', priority: 100, outputs };
        const r = await fetch('/mappings/rules', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (!r.ok) throw new Error(await r.text());
        // reload saved outputs into editor so navigating back preserves them
        try {
            const rs = await fetch(`/mappings/rules?pattern=${encodeURIComponent(pattern)}`);
            if (rs.ok) {
                const jr = await rs.json();
                const rules = jr.rules||[];
                if (rules.length) {
                    const outs = rules[0].outputs||[];
                    outsTbody.innerHTML = '';
                    for (const o of outs) addOutputRow({ product_id:o.product_id, size:o.size, color:o.color, quantity:o.quantity, unit_price:o.unit_price });
                }
            }
        } catch (e) {}
    }

    document.getElementById('saveRule').addEventListener('click', async ()=>{
        saveMsg.textContent = 'Saving...';
        try { await saveRuleCore(); saveMsg.textContent = 'Saved.'; await refreshPreviewCount(); }
        catch (e) { saveMsg.textContent = 'Save error'; }
    });
    document.getElementById('saveNext').addEventListener('click', async ()=>{
        saveMsg.textContent = 'Saving...';
        try { await saveRuleCore(); saveMsg.textContent = 'Saved.'; await refreshPreviewCount(); }
        catch (e) { saveMsg.textContent = 'Save error'; return; }
        // move to next pattern
        const cur = patInp.value;
        const lis = [...patList.querySelectorAll('li[data-pattern]')];
        const idx = lis.findIndex(li=>li.getAttribute('data-pattern')===cur);
        if (idx>=0 && idx+1<lis.length){ openPattern(lis[idx+1].getAttribute('data-pattern')); }
    });

    investigateBtn?.addEventListener('click', async ()=>{
        try {
            const pat = (investigatePat && investigatePat.value) || (document.querySelector('#patList li[data-pattern]')?.getAttribute('data-pattern')) || '';
            const body = filenames && Array.isArray(filenames) ? { source, filenames, exclude_generic: false, return_rows: true, rows_limit: 200, pattern: pat } : { source, filename, exclude_generic: false, return_rows: true, rows_limit: 200, pattern: pat };
            const r = await fetch('/import/preview-map', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            if (!r.ok) { alert('Investigate error'); return; }
            const j = await r.json();
            const list = (j.unmatched_rows||[]).map(row=>`• ${row.base} | ${row.item_name||''} | ${row.name||''} | ${row.phone||''} | qty:${row.quantity||''} | total:${row.total_amount||''} | file:${row.filename} #${row.row_index}`).join('\n');
            alert(list || 'No rows found for this pattern.');
        } catch (e) { alert('Investigate error'); }
    });

    document.getElementById('commitBtn').addEventListener('click', async ()=>{
        let body;
        // If multiple files, require per-file dates; if single file, prompt for one date
        if (filenames && Array.isArray(filenames) && filenames.length > 1) {
            const map = {};
            let missing = false;
            if (datesTbody) {
                for (const inp of datesTbody.querySelectorAll('input[type="date"][data-filename]')){
                    const fn = inp.getAttribute('data-filename');
                    const v = inp.value;
                    if (!v) { missing = true; break; }
                    map[fn] = v;
                }
            }
            if (missing) { alert('Please fill all dates.'); return; }
            body = { source, filenames, data_dates: map };
        } else {
            const data_date = prompt('Data date (YYYY-MM-DD)?');
            if (!data_date) return;
            // Prefer explicit single filename if available, otherwise fall back to list[0]
            const single = (typeof filename === 'string' && filename) ? filename : (Array.isArray(filenames) && filenames.length ? filenames[0] : null);
            body = single ? { source, filename: single, data_date } : { source, filename, data_date };
        }
        try {
            const r = await fetch('/import/commit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
            if (!r.ok) {
                let txt = await r.text();
                try {
                    const j = JSON.parse(txt);
                    if (j && j.detail && j.detail.error === 'unmatched_mappings' && j.detail.next) {
                        if (confirm(`${j.detail.total_unmatched} eşleşmeyen ürün var. Haritalandırma sayfasına dönmek ister misiniz?`)) {
                            location.href = j.detail.next;
                            return;
                        }
                    }
                } catch (_) { /* not json */ }
                alert(`Commit error: ${txt}`);
                return;
            }
            alert('Import committed.');
            location.href = '/dashboard';
        } catch (e) { alert('Commit error'); }
    });

    // --- AI suggestions ---
    function slugifyClient(s){
        return String(s||'')
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
          .replace(/[^a-z0-9]+/g,'-')
          .replace(/(^-|-$)/g,'');
    }
    function collectUnmatched(){
        const list = [];
        for (const li of patList.querySelectorAll('li[data-pattern]')){
            const pattern = li.getAttribute('data-pattern');
            const count = Number(li.querySelector('.pill')?.textContent||'0')||0;
            const suggested_price = Number(li.getAttribute('data-suggested-price')||'')||null;
            // samples are not in DOM; omitted here (server investigates if needed)
            list.push({ pattern, count, samples: [], suggested_price });
        }
        return list;
    }
    function renderAiProducts(rows){
        const tb = aiProdTbl.querySelector('tbody');
        tb.innerHTML = '';
        for (const r of (rows||[])){
            const slug = slugifyClient(r.name);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="chkProd" checked></td>
                <td><input class="pname" value="${r.name||''}"/></td>
                <td>${slug}</td>
                <td><input class="punit" value="${r.default_unit||'adet'}"/></td>
                <td><input class="pprice" type="number" step="0.01" value="${r.default_price??''}"/></td>
            `;
            tb.appendChild(tr);
        }
    }
    function renderAiRules(rows){
        const tb = aiRuleTbl.querySelector('tbody');
        tb.innerHTML = '';
        for (const r of (rows||[])){
            const outs = (r.outputs||[]).map(o=>{
                const pn = o.product_name ? `product:${o.product_name}` : (o.item_sku ? `sku:${o.item_sku}` : '');
                return `${pn} ${o.size||''} ${o.color||''} x${o.quantity||1} ${o.unit_price??''}`.trim();
            }).join('<br/>');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="chkRule" checked></td>
                <td>${r.source_pattern}</td>
                <td>
                    <select class="rmode">
                        <option value="exact" ${r.match_mode==='exact'?'selected':''}>exact</option>
                        <option value="icontains" ${r.match_mode==='icontains'?'selected':''}>icontains</option>
                        <option value="regex" ${r.match_mode==='regex'?'selected':''}>regex</option>
                    </select>
                </td>
                <td><input class="rpri" type="number" value="${r.priority||100}" style="width:80px"/></td>
                <td class="outs" data-outs='${JSON.stringify(r.outputs||[]).replace(/'/g,"&#39;")}' style="font-size:12px">${outs}</td>
            `;
            tb.appendChild(tr);
        }
    }
    aiBtn?.addEventListener('click', async ()=>{
        aiPanel.style.display = '';
        aiMsg.textContent = 'Öneriler alınıyor...';
        try {
            const unmatched = collectUnmatched();
            const r = await fetch('/mappings/ai/suggest', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ unmatched_patterns: unmatched, context: { products } })});
            if (!r.ok) throw new Error(await r.text());
            const j = await r.json();
            renderAiProducts(j.products_to_create||[]);
            renderAiRules(j.mappings_to_create||[]);
            aiMsg.textContent = (j.warnings&&j.warnings.length) ? j.warnings.join(' • ') : '';
        } catch (e) {
            aiMsg.textContent = 'Öneri hatası';
        }
    });
    document.getElementById('chkAllProd')?.addEventListener('change', (e)=>{
        const v = e.target.checked; for (const c of aiProdTbl.querySelectorAll('.chkProd')) c.checked = v;
    });
    document.getElementById('chkAllRule')?.addEventListener('change', (e)=>{
        const v = e.target.checked; for (const c of aiRuleTbl.querySelectorAll('.chkRule')) c.checked = v;
    });
    function collectApplyPayload(){
        const products_to_create = [];
        for (const tr of aiProdTbl.querySelectorAll('tbody tr')){
            const chk = tr.querySelector('.chkProd');
            if (!chk.checked) continue;
            products_to_create.push({
                name: tr.querySelector('.pname').value,
                default_unit: tr.querySelector('.punit').value || 'adet',
                default_price: (function(v){ return v===''?null:Number(v) })(tr.querySelector('.pprice').value)
            });
        }
        const mappings_to_create = [];
        for (const tr of aiRuleTbl.querySelectorAll('tbody tr')){
            if (!tr.querySelector('.chkRule').checked) continue;
            const outs = JSON.parse(tr.querySelector('.outs').getAttribute('data-outs')||'[]');
            mappings_to_create.push({
                source_pattern: tr.children[1].textContent,
                match_mode: tr.querySelector('.rmode').value,
                priority: Number(tr.querySelector('.rpri').value||100),
                outputs: outs,
            });
        }
        return { suggestions: { products_to_create, mappings_to_create, notes: null, warnings: [] }, create_products: true, create_rules: true };
    }
    document.getElementById('applySelected')?.addEventListener('click', async ()=>{
        aiMsg.textContent = 'Uygulanıyor...';
        try {
            const payload = collectApplyPayload();
            const r = await fetch('/mappings/ai/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            if (!r.ok) throw new Error(await r.text());
            aiMsg.textContent = 'Uygulandı';
            await refreshPreviewCount();
        } catch (e) { aiMsg.textContent = 'Uygulama hatası'; }
    });
    document.getElementById('applyAll')?.addEventListener('click', async ()=>{
        for (const c of aiProdTbl.querySelectorAll('.chkProd')) c.checked = true;
        for (const c of aiRuleTbl.querySelectorAll('.chkRule')) c.checked = true;
        document.getElementById('applySelected').click();
    });
    </script>
</body>
</html>


