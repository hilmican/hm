<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Excel DosyasÄ± Takibi</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
		.card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; margin-bottom: 16px; }
		.card h2 { margin: 0; padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
		.search-section { padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
		.search-form { display: flex; gap: 8px; align-items: center; }
		.search-form input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
		.search-form button { padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
		.search-form button:hover { background: #2563eb; }
		table { width: 100%; border-collapse: collapse; }
		th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
		th { background: #fafafa; position: sticky; top: 0; font-weight: 600; }
		.badge { display: inline-block; padding: 3px 6px; border-radius: 6px; font-size: 12px; background: #eef2ff; color: #1d4ed8; }
		.badge.created { background: #d1fae5; color: #065f46; }
		.badge.skipped { background: #fef3c7; color: #92400e; }
		.badge.unmatched { background: #fee2e2; color: #991b1b; }
		.badge.error { background: #fee2e2; color: #991b1b; }
		.order-header { padding: 16px; background: #f0f9ff; border-bottom: 1px solid #e5e7eb; }
		.order-header h3 { margin: 0 0 8px 0; font-size: 18px; }
		.order-header p { margin: 4px 0; color: #6b7280; font-size: 14px; }
		.download-link { color: #3b82f6; text-decoration: none; padding: 4px 8px; border-radius: 4px; }
		.download-link:hover { background: #eff6ff; }
		.btn { padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; font-size: 12px; }
		.btn:hover { background: #f8fafc; }
		.btn.primary { background: #2563eb; color: #fff; border-color: #2563eb; }
		.btn.danger { border-color: #b91c1c; color: #b91c1c; }
		.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.3); display: none; align-items: center; justify-content: center; z-index: 200; }
		.modal { background: #fff; border-radius: 10px; padding: 16px; width: min(640px, 90vw); max-height: 80vh; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
		.modal h4 { margin: 0 0 10px 0; }
		.modal-body { flex: 1; overflow: auto; padding-right: 4px; }
		.flex-end { display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; }
		.small { font-size: 12px; color: #6b7280; }
		.mapped-data { font-family: monospace; font-size: 12px; background: #f9fafb; padding: 8px; border-radius: 4px; white-space: pre-wrap; word-break: break-all; max-width: 600px; }
		.file-missing { color: #ef4444; font-style: italic; }
	</style>
</head>
<body>
	{% include "_nav.html" %}
	<h1>Excel DosyasÄ± Takibi</h1>
	
	<div class="card">
		<div class="search-section">
			<form class="search-form" method="get" action="/excel-tracker">
				<input type="number" name="order_id" placeholder="SipariÅŸ ID" value="{{ order_id or '' }}" />
				<span>veya</span>
				<input type="text" name="q" placeholder="MÃ¼ÅŸteri adÄ± veya telefon" value="{{ q }}" style="flex: 1; min-width: 200px;" />
				<button type="submit">Ara</button>
			</form>
		</div>
	</div>
	
	{% if orders_data %}
		{% for item in orders_data %}
		<div class="card">
			<div class="order-header">
				<h3>SipariÅŸ #{{ item.order.id }}</h3>
				<p>
					<strong>MÃ¼ÅŸteri:</strong> {{ item.client.name if item.client else 'Bilinmiyor' }}
					{% if item.client and item.client.phone %} Â· {{ item.client.phone }}{% endif %}
				</p>
				<p>
					<strong>Toplam:</strong> {{ item.order.total_amount }} TL
					{% if item.order.shipment_date %} Â· <strong>Kargo Tarihi:</strong> {{ item.order.shipment_date }}{% endif %}
					{% if item.order.data_date %} Â· <strong>Data Tarihi:</strong> {{ item.order.data_date }}{% endif %}
					Â· <strong>Kaynak:</strong> {{ item.order.source }}
				</p>
			</div>
			
			<table>
				<thead>
					<tr>
						<th>Import Run</th>
						<th>Kaynak</th>
						<th>Dosya AdÄ±</th>
						<th>SatÄ±r #</th>
						<th>Durum</th>
						<th>Mesaj</th>
						<th>Tarih</th>
						<th>Dosya</th>
						<th>EÅŸleÅŸen Veri</th>
						<th>Ä°ÅŸlem</th>
					</tr>
				</thead>
				<tbody>
					{% for row in item.import_rows %}
					<tr>
						<td>#{{ row.import_run_id }}</td>
						<td>{{ row.source }}</td>
						<td><strong>{{ row.filename }}</strong></td>
						<td>{{ row.row_index }}</td>
						<td><span class="badge {{ row.status }}">{{ row.status }}</span></td>
						<td>{{ row.message or '' }}</td>
						<td>
							{% if row.data_date %}{{ row.data_date }}{% endif %}
							{% if row.started_at %}<br><small>{{ row.started_at.strftime('%Y-%m-%d %H:%M') if row.started_at else '' }}</small>{% endif %}
						</td>
						<td>
							{% if row.file_exists %}
								<a href="/excel-tracker/download/{{ row.import_run_id }}" class="download-link" target="_blank">ðŸ“¥ Ä°ndir</a>
							{% else %}
								<span class="file-missing">Dosya bulunamadÄ±</span>
							{% endif %}
						</td>
						<td>
							<div class="mapped-data">
								{% if row.mapped_data %}
									{% for key, value in row.mapped_data.items() %}
										<strong>{{ key }}:</strong> {{ value }}<br>
									{% endfor %}
								{% else %}
									(veri yok)
								{% endif %}
							</div>
						</td>
						<td>
							{% if row.source == 'bizim' %}
								<button class="btn" onclick="showRollbackPreview({{ row.import_run_id }})">Rollback (Ã¶nizleme)</button>
							{% else %}
								<span class="small" style="color:#6b7280;">-</span>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% endfor %}
	{% elif order_id or q %}
		<div class="card">
			<div style="padding: 16px; text-align: center; color: #6b7280;">
				SonuÃ§ bulunamadÄ±. FarklÄ± bir arama terimi deneyin.
			</div>
		</div>
	{% else %}
		<div class="card">
			<div style="padding: 16px; text-align: center; color: #6b7280;">
				Bir sipariÅŸ ID veya mÃ¼ÅŸteri adÄ±/telefonu ile arama yapÄ±n.
			</div>
		</div>
	{% endif %}

	<div id="rbModal" class="modal-backdrop" role="dialog" aria-modal="true">
		<div class="modal">
			<h4>Rollback Ã–nizleme</h4>
			<div id="rbContent" class="modal-body small">YÃ¼kleniyor...</div>
			<div class="flex-end">
				<button class="btn" onclick="hideRollback()">Kapat</button>
				<button id="rbApplyBtn" class="btn danger" onclick="applyRollback()" disabled>Rollback Uygula</button>
			</div>
		</div>
	</div>

	<script>
		let rollbackRunId = null;
		let rollbackCandidates = [];
		function showRollbackPreview(runId){
			rollbackRunId = runId;
			rollbackCandidates = [];
			const modal = document.getElementById('rbModal');
			const content = document.getElementById('rbContent');
			const applyBtn = document.getElementById('rbApplyBtn');
			if(!modal || !content || !applyBtn) return;
			modal.style.display = 'flex';
			content.textContent = 'YÃ¼kleniyor...';
			applyBtn.disabled = true;
			fetch(`/import/imports/runs/${runId}/rollback?preview=1`, { method: 'POST' })
			.then(async res => {
				if(!res.ok){ throw new Error(await res.text() || res.status); }
				return res.json();
			})
			.then(data=>{
				rollbackCandidates = data?.candidates || [];
				const kept = data?.kept || [];
				const candCount = rollbackCandidates.length;
				const keptCount = kept.length;
				let html = `<div><strong>Run #${runId}</strong></div>`;
				html += `<div>Ä°ptal edilecek aday: <strong>${candCount}</strong></div>`;
				if(keptCount>0){
					html += `<div>Dokunulmayacak (daha eski runlarda da var): <strong>${keptCount}</strong></div>`;
				}
				if(candCount){
					const limit = 100;
					html += '<ul style="margin:8px 0 0 16px; padding:0;">';
					rollbackCandidates.slice(0, limit).forEach(c=>{
						html += `<li style="margin-bottom:4px;">SipariÅŸ #${c.order_id} Â· Toplam ${c.total_amount} Â· Status ${c.status || '-'} Â· Payments ${c.payments?.length||0}</li>`;
					});
					if(candCount > limit){
						html += `<li style="margin-top:4px;">... ${candCount - limit} adet daha</li>`;
					}
					html += '</ul>';
					applyBtn.disabled = false;
				} else {
					html += '<div>Rollback adayÄ± yok.</div>';
				}
				content.innerHTML = html;
			})
			.catch(err=>{
				content.textContent = `Hata: ${err.message || err}`;
			});
		}
		function hideRollback(){
			const modal = document.getElementById('rbModal');
			if(modal) modal.style.display = 'none';
		}
		function applyRollback(){
			if(!rollbackRunId) return;
			const content = document.getElementById('rbContent');
			const applyBtn = document.getElementById('rbApplyBtn');
			if(content) content.textContent = 'Rollback uygulanÄ±yor...';
			if(applyBtn) applyBtn.disabled = true;
			fetch(`/import/imports/runs/${rollbackRunId}/rollback?preview=0`, { method: 'POST' })
			.then(async res => {
				if(!res.ok){ throw new Error(await res.text() || res.status); }
				return res.json();
			})
			.then(data=>{
				if(content){
					content.innerHTML = `TamamlandÄ±. Rolled back: ${data?.rolled_back_orders?.length || 0}. Kept: ${data?.kept_orders?.length || 0}. SayfayÄ± yenileyin.`;
				}
			})
			.catch(err=>{
				if(content) content.textContent = `Hata: ${err.message || err}`;
				if(applyBtn) applyBtn.disabled = false;
			});
		}
	</script>
</body>
</html>

