<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Dashboard</title>
		<style>
			body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
			h1 { margin-bottom: 12px; }
			.grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
			@media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
			.card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
			.card h2 { margin: 0; padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
            table { width: 100%; border-collapse: collapse; }
			th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
			th { background: #fafafa; position: sticky; top: 0; }
			.caption { color: #6b7280; font-size: 12px; padding: 8px 16px; }
			.toolbar { margin-bottom: 12px; }
			.toolbar a { margin-right: 8px; color: #2563eb; text-decoration: none; }
            tr.paid { background: #eaffea; }
            tr.unpaid { background: #fff9db; }
		</style>
	</head>
	<body>
		<h1>Kargo Management Dashboard</h1>
		<div style="display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 18px 0;">
			<div class="card" style="padding:8px 12px;">
				<strong>Toplam Satış:</strong> {{ '%.2f'|format(total_sales or 0) }}
			</div>
			<div class="card" style="padding:8px 12px;">
				<strong>Toplanan:</strong> {{ '%.2f'|format(total_collected or 0) }}
			</div>
			<div class="card" style="padding:8px 12px;">
				<strong>Alınacak:</strong> {{ '%.2f'|format(total_to_collect or 0) }}
			</div>
			<div class="card" style="padding:8px 12px;">
				<strong>Toplam Kesintiler:</strong> {{ '%.2f'|format(total_fees or 0) }}
			</div>
		</div>
		<div class="toolbar">
			<a href="/clients" target="_blank">Clients API</a>
			<a href="/clients/table" target="_blank">Clients Table</a>
			<a href="/items" target="_blank">Items API</a>
			<a href="/items/table" target="_blank">Items Table</a>
			<a href="/orders/table" target="_blank">Orders Table</a>
			<a href="/payments" target="_blank">Payments API</a>
			<button id="logoutBtn" type="button" style="margin-left:12px;background:#6b7280;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">Logout</button>
			<button id="resetBtn" type="button" style="margin-left:12px;background:#b91c1c;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">Reset DB</button>
			<form id="uploadForm" method="post" action="/import/upload" enctype="multipart/form-data" style="display:inline-block;margin-left:12px;">
				<select name="source" style="padding:6px 8px;border:1px solid #ddd;border-radius:6px;">
					<option value="bizim">bizim</option>
					<option value="kargo">kargo</option>
				</select>
				<input type="file" name="files" multiple accept=".xlsx" required style="margin-left:6px" />
				<button type="submit" style="margin-left:6px;background:#2563eb;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">Upload</button>
			</form>
		</div>

		<div id="uploadResult" class="caption"></div>
		<div class="grid">
			<div class="card">
				<h2>Orders (latest 20)</h2>
				<table>
					<thead>
						<tr><th>ID</th><th>Tracking</th><th>Client</th><th>Item</th><th>Qty</th><th>Total</th><th>Ship Date</th><th>Data Date</th><th>Channel</th></tr>
					</thead>
					<tbody>
					{% for o in orders %}
						{% set rowcls = status_map.get(o.id) if status_map else '' %}
						<tr class="{{ rowcls }}">
							<td>{{ o.id }}</td>
							<td>{{ o.tracking_no }}</td>
							<td>
								{% set cname = client_map.get(o.client_id) if client_map else None %}
								{% if not cname %}
									{% set ns = namespace(name='') %}
									{% for c in clients %}{% if c.id == o.client_id %}{% set ns.name = c.name %}{% endif %}{% endfor %}
									{% set cname = ns.name %}
								{% endif %}
								<a href="/clients/{{ o.client_id }}">{{ (cname or '')[:40] }}</a>
							</td>
							<td>
								{% if o.item_id %}
									{% set iname = item_map.get(o.item_id) if item_map else None %}
									{% if not iname %}
										{% set ns2 = namespace(name='') %}
										{% for it in items %}{% if it.id == o.item_id %}{% set ns2.name = it.name %}{% endif %}{% endfor %}
										{% set iname = ns2.name %}
									{% endif %}
									<a href="/items/table#{{ o.item_id }}">{{ (iname or '')[:40] }}</a>
								{% endif %}
							</td>
							<td>{{ o.quantity }}</td>
							<td>{{ o.total_amount }}</td>
							<td>{{ o.shipment_date }}</td>
							<td>{{ o.data_date }}</td>
							<td>{{ o.source }}</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
				<div class="caption">Open <a href="/orders/table">/orders/table</a> for full list.</div>
			</div>

			<div class="card">
				<h2>Clients (latest 20)</h2>
				<table>
					<thead>
						<tr><th>ID</th><th>Name</th><th>Phone</th><th>City</th><th>Height</th><th>Weight</th><th>Source</th><th>Created</th></tr>
					</thead>
					<tbody>
					{% for c in clients %}
						<tr>
							<td>{{ c.id }}</td>
							<td>{{ c.name }}</td>
							<td>{{ c.phone }}</td>
							<td>{{ c.city }}</td>
							<td>{{ c.height_cm }}</td>
							<td>{{ c.weight_kg }}</td>
							<td>{% if c.id in client_sources %}{{ client_sources[c.id] }}{% endif %}</td>
							<td>{{ c.created_at }}</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
				<div class="caption">Open <a href="/clients/table">/clients/table</a> for full list.</div>
			</div>

			<div class="card">
				<h2>Payments (latest 20)</h2>
				<table>
					<thead>
						<tr>
							<th>ID</th>
							<th>Client</th>
							<th>Order</th>
							<th>Order Total</th>
							<th>Paid Amount</th>
							<th>Fees</th>
							<th>Net</th>
							<th>Date</th>
							<th>Method</th>
						</tr>
					</thead>
					<tbody>
					{% for p in payments %}
						<tr>
							<td>{{ p.id }}</td>
							<td>
								{% set cname = client_map.get(p.client_id) if client_map else p.client_id %}
								<a href="/clients/{{ p.client_id }}">{{ cname }}</a>
							</td>
							<td>
								{% if p.order_id %}
									{% set onum = order_map.get(p.order_id) if order_map else p.order_id %}
									<a href="/orders/table#{{ p.order_id }}">{{ onum }}</a>
								{% endif %}
							</td>
							<td>{% if p.order_id %}{{ order_total_map.get(p.order_id, 0) }}{% else %}-{% endif %}</td>
							<td>{{ p.amount }}</td>
							<td>
								{# show itemized fees #}
								{% set fkom = p.fee_komisyon or 0 %}
								{% set fhiz = p.fee_hizmet or 0 %}
								{% set fkar = p.fee_kargo or 0 %}
								{% set fiad = p.fee_iade or 0 %}
								{% set feok = p.fee_erken_odeme or 0 %}
								{% set fsum = (fkom + fhiz + fkar + fiad + feok) %}
								{{ '%.2f'|format(fsum) }}
								<span class="caption">(K:{{ '%.2f'|format(fkom) }}, H:{{ '%.2f'|format(fhiz) }}, KG:{{ '%.2f'|format(fkar) }}, I:{{ '%.2f'|format(fiad) }}, E:{{ '%.2f'|format(feok) }})</span>
							</td>
							<td>{{ p.net_amount }}</td>
							<td>{{ p.date }}</td>
							<td>{{ p.method }}</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
				<div class="caption">Open <a href="/payments/table">/payments/table</a> for full list.</div>
			</div>

			<div class="card">
				<h2>Items (latest 20)</h2>
				<table>
					<thead>
						<tr><th>ID</th><th>SKU</th><th>Name</th><th>Unit</th></tr>
					</thead>
					<tbody>
					{% for it in items %}
						<tr>
							<td>{{ it.id }}</td>
							<td>{{ it.sku }}</td>
							<td>{{ it.name }}</td>
							<td>{{ it.unit }}</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
				<div class="caption">Open <a href="/items/table">/items/table</a> for full list.</div>
			</div>
		</div>

		<script>
		const form = document.getElementById('uploadForm');
		const result = document.getElementById('uploadResult');
		const resetBtn = document.getElementById('resetBtn');
		if (resetBtn) {
			resetBtn.addEventListener('click', async () => {
				if (!confirm('Tüm veritabanı silinecek ve sıfırlanacak. Emin misiniz?')) return;
				try {
					const r = await fetch('/import/reset', { method: 'POST' });
					if (!r.ok) throw new Error('Reset failed');
					alert('Veritabanı sıfırlandı.');
					location.reload();
				} catch (e) {
					alert('Reset error');
				}
			});
		}
		const logoutBtn = document.getElementById('logoutBtn');
		if (logoutBtn) {
			logoutBtn.addEventListener('click', async () => {
				try {
					await fetch('/auth/logout', { method: 'POST' });
					location.href = '/auth/login';
				} catch (e) { alert('Logout error'); }
			});
		}
		if (form) {
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				const data = new FormData(form);
				result.textContent = 'Uploading...';
				try {
					const res = await fetch('/import/upload', { method: 'POST', body: data });
					if (!res.ok) throw new Error('Upload failed');
					const json = await res.json();
					console.log('Uploaded files preview', json.files);
					result.textContent = `Uploaded ${json.files.length} file(s).`;
					// Offer to commit each file sequentially (date prompt only for bizim)
					if (confirm('Dosyalar yüklendi. Hepsini içe aktarmak ister misiniz?')) {
						const totals = { created_orders:0, created_clients:0, created_items:0, created_payments:0, unmatched:0, enriched_orders:0, payments_existing:0, payments_skipped_zero:0 };
						for (const f of json.files) {
							let body = { source: json.source, filename: f.filename };
							if (json.source === 'bizim') {
								let today = new Date();
								const pad = (n)=> String(n).padStart(2,'0');
								const defaultDate = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
								const input = prompt(`Data date for ${f.filename} (YYYY-MM-DD)`, defaultDate);
								if (!input) { console.log('Skipped commit for', f.filename); continue; }
								body.data_date = input;
							}
							const res2 = await fetch('/import/commit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)});
							if (!res2.ok) { const t = await res2.text(); throw new Error(`Commit failed for ${f.filename}: ${t}`); }
							const j2 = await res2.json();
							console.group('Commit result for', f.filename);
							console.log('Summary:', j2);
							console.groupEnd();
							for (const k of Object.keys(totals)) { totals[k] += (j2[k] || 0); }
						}
						console.group('Aggregate totals');
						console.log('Siparişler (created/enriched):', totals.created_orders, totals.enriched_orders);
						console.log('Müşteriler created:', totals.created_clients);
						console.log('Ürünler created:', totals.created_items);
						console.log('Ödemeler (created/existing/skipped0):', totals.created_payments, totals.payments_existing, totals.payments_skipped_zero);
						console.log('Eşleşmeyen satırlar:', totals.unmatched);
						console.groupEnd();
						location.reload();
					}
				} catch (err) {
					console.error(err);
					result.textContent = 'Upload error';
				}
			});
		}
		</script>
	</body>
</html>
