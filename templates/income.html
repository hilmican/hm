<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelir Girişi</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      h1 { margin-bottom: 12px; }
      .toolbar { display:flex; gap:12px; align-items:flex-end; margin:14px 0; flex-wrap:wrap; }
      .btn { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer }
      .btn-success { background:#059669; }
      .btn-danger { background:#ef4444; }
      input[type=date], input[type=text], input[type=number], select { padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
      table { width: 100%; border-collapse: collapse; margin-top: 18px; }
      th, td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; text-align: left; font-size: 14px; }
      th { background: #fafafa; position: sticky; top: 0; }
      .grid { display:grid; grid-template-columns: 1fr; gap:18px; }
      @media (min-width: 1100px) { .grid { grid-template-columns: 1fr 1fr; } }
      .card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background:#fff; }
      .card h2 { margin: 0; padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 16px; }
      .card .body { padding: 12px 16px; }
      .row { display:flex; gap:12px; flex-wrap:wrap; }
      .field { display:block; }
      .field label { display:block; font-size:12px; color:#374151; margin-bottom:4px; }
      .muted { color:#6b7280; font-size:12px; }
      .order-row { cursor: pointer; }
      .order-row:hover { background: #f9fafb; }
      .order-row.selected { background: #dbeafe; }
      .order-row input[type=checkbox] { margin-right: 8px; }
      .summary { background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 12px; }
      .summary strong { color: #1e40af; }
      #searchBox { width: 100%; max-width: 400px; }
      .btn-sm { font-size: 12px; padding: 4px 8px; }
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
      .modal-content { background: #fff; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
      .modal-header h3 { margin: 0; }
      .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
      .close:hover { color: #000; }
      
      /* Mobile responsive styles */
      @media (max-width: 768px) {
        body { margin: 12px; }
        h1 { font-size: 20px; }
        .toolbar { flex-direction: column; align-items: stretch; }
        .toolbar > div { width: 100%; }
        .toolbar input[type="date"] { width: 100%; }
        .row { flex-direction: column; align-items: stretch; }
        .field { width: 100%; }
        input[type=date], input[type=text], input[type=number], select { width: 100%; box-sizing: border-box; }
        #searchBox { max-width: 100%; }
        table { font-size: 12px; }
        th, td { padding: 8px 6px; }
        .card .body { padding: 8px 12px; }
        .card h2 { font-size: 14px; padding: 10px 12px; }
        .modal-content { width: 95%; margin: 10% auto; padding: 16px; }
      }
      
      @media (max-width: 480px) {
        body { margin: 8px; }
        h1 { font-size: 18px; margin-bottom: 8px; }
        table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        th, td { font-size: 11px; padding: 6px 4px; white-space: nowrap; }
        .card { margin-bottom: 12px; }
        .btn { padding: 8px 12px; font-size: 14px; width: 100%; text-align: center; margin-bottom: 8px; }
        .modal-content { width: 98%; margin: 5% auto; padding: 12px; }
      }
    </style>
  </head>
  <body>
    {% include "_nav.html" %}
    <h1>Gelir Girişi</h1>

    <form class="toolbar" method="get" action="/income/table">
      <div>
        <label style="display:block;font-size:12px;color:#374151">Başlangıç</label>
        <input type="date" name="start" value="{{ start }}" />
      </div>
      <div>
        <label style="display:block;font-size:12px;color:#374151">Bitiş</label>
        <input type="date" name="end" value="{{ end }}" />
      </div>
      <div>
        <button class="btn" type="submit">Uygula</button>
      </div>
    </form>

    <div class="grid">
      <div class="card">
        <h2>Yeni Gelir Ekle</h2>
        <div class="body">
          <form id="incomeForm" method="post" action="/income/add" class="row">
            <div class="field">
              <label>Hesap</label>
              <select name="account_id" id="accountSelect" required>
                <option value="">Seçiniz...</option>
                {% for acc in accounts %}
                {% if acc.id %}
                <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.type }})</option>
                {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="field">
              <label>Tutar</label>
              <input type="number" step="0.01" name="amount" id="amountInput" required />
            </div>
            <div class="field">
              <label>Tarih</label>
              <input type="date" name="date" value="{{ today }}" />
            </div>
            <div class="field">
              <label>Kaynak</label>
              <select name="source" required>
                <option value="shipment_firm">Kargo Firması</option>
                <option value="iban_customer">Müşteri IBAN</option>
                <option value="other">Diğer</option>
              </select>
            </div>
            <div class="field" style="min-width:280px; flex:1">
              <label>Referans / Açıklama</label>
              <input type="text" name="reference" placeholder="Opsiyonel" />
            </div>
            <div class="field" style="min-width:280px; flex:1">
              <label>Notlar</label>
              <input type="text" name="notes" placeholder="Opsiyonel" />
            </div>
            {% if start %}<input type="hidden" name="start" value="{{ start }}"/>{% endif %}
            {% if end %}<input type="hidden" name="end" value="{{ end }}"/>{% endif %}
            <div style="align-self:flex-end">
              <button class="btn" type="submit">Kaydet</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <h2>Sipariş Tahsilatı</h2>
        <div class="body">
          <div class="field">
            <label>Sipariş Ara</label>
            <input type="text" id="searchBox" placeholder="Takip no, müşteri adı..." />
          </div>
          <button class="btn" type="button" onclick="loadUnpaidOrders()">Ödenmemiş Siparişleri Yükle</button>
          
          <div id="ordersContainer" style="margin-top: 12px; max-height: 400px; overflow-y: auto;">
            <p class="muted">Ödenmemiş siparişleri yüklemek için yukarıdaki butona tıklayın.</p>
          </div>
          
          <div id="summary" class="summary" style="display: none;">
            <strong>Seçilen Siparişler:</strong> <span id="selectedCount">0</span> adet<br>
            <strong>Toplam Beklenen:</strong> <span id="totalExpected">0.00</span> ₺
          </div>
          
          <button class="btn btn-success" type="button" id="collectBtn" onclick="collectSelectedOrders()" style="margin-top: 12px; display: none;">
            Seçili Siparişleri Tahsil Et ve Gelir Oluştur
          </button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <h2>Gelir Geçmişi</h2>
      <div class="body" style="padding:0">
        <div style="padding:12px 16px; border-bottom:1px solid #e5e7eb; background:#f8fafc; font-weight:600;">
          Toplam: {{ '%.2f'|format(total_amount or 0) }} ₺ ({{ income_entries|length }} kayıt)
        </div>
        <table>
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Hesap</th>
              <th>Kaynak</th>
              <th>Tutar</th>
              <th>Referans</th>
              <th>Notlar</th>
              <th>İşlemler</th>
            </tr>
          </thead>
          <tbody>
            {% for inc in income_entries %}
            <tr id="income-row-{{ inc.id }}">
              <td>{{ inc.date }}</td>
              <td>{{ account_map.get(inc.account_id, inc.account_id) }}</td>
              <td>{{ inc.source }}</td>
              <td>{{ '%.2f'|format(inc.amount) }} ₺</td>
              <td>{{ inc.reference or '-' }}</td>
              <td>{{ inc.notes or '-' }}</td>
              <td>
                <button class="btn btn-sm" onclick="editIncome({{ inc.id }})" style="padding:4px 8px; font-size:12px; margin-right:4px;">Düzenle</button>
                <button class="btn btn-danger btn-sm" onclick="deleteIncome({{ inc.id }})" style="padding:4px 8px; font-size:12px;">Sil</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <script>
      let selectedOrders = new Set();
      let ordersData = [];

      // Load unpaid orders
      async function loadUnpaidOrders() {
        const search = document.getElementById('searchBox').value;
        const params = new URLSearchParams();
        if (search) params.append('q', search);
        params.append('limit', '500');

        try {
          const res = await fetch(`/income/orders-to-collect?${params}`);
          const data = await res.json();
          ordersData = data.orders || [];
          renderOrders();
        } catch (e) {
          console.error('Failed to load orders:', e);
          alert('Siparişler yüklenemedi');
        }
      }

      function renderOrders() {
        const container = document.getElementById('ordersContainer');
        if (ordersData.length === 0) {
          container.innerHTML = '<p class="muted">Ödenmemiş sipariş bulunamadı.</p>';
          return;
        }

        let html = '<table><thead><tr><th></th><th>ID</th><th>Takip</th><th>Müşteri</th><th>Toplam</th><th>Beklenen</th><th>Tarih</th></tr></thead><tbody>';
        ordersData.forEach(order => {
          const checked = selectedOrders.has(order.id) ? 'checked' : '';
          html += `<tr class="order-row ${checked ? 'selected' : ''}" onclick="toggleOrder(${order.id})">
            <td><input type="checkbox" ${checked} onchange="toggleOrder(${order.id})" /></td>
            <td>${order.id}</td>
            <td>${order.tracking_no || '-'}</td>
            <td>${order.client_name}</td>
            <td>${order.total_amount ? order.total_amount.toFixed(2) : '0.00'} ₺</td>
            <td>${order.expected_payment.toFixed(2)} ₺</td>
            <td>${order.shipment_date || order.data_date || '-'}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        updateSummary();
      }

      function toggleOrder(orderId) {
        if (selectedOrders.has(orderId)) {
          selectedOrders.delete(orderId);
        } else {
          selectedOrders.add(orderId);
        }
        renderOrders();
      }

      function updateSummary() {
        const selected = Array.from(selectedOrders);
        let total = 0;
        selected.forEach(id => {
          const order = ordersData.find(o => o.id === id);
          if (order) total += order.expected_payment;
        });

        document.getElementById('selectedCount').textContent = selected.length;
        document.getElementById('totalExpected').textContent = total.toFixed(2);
        document.getElementById('summary').style.display = selected.length > 0 ? 'block' : 'none';
        document.getElementById('collectBtn').style.display = selected.length > 0 ? 'block' : 'none';
      }

      async function collectSelectedOrders() {
        const selected = Array.from(selectedOrders);
        if (selected.length === 0) {
          alert('Lütfen en az bir sipariş seçin');
          return;
        }

        const accountId = document.getElementById('accountSelect').value;
        const amount = parseFloat(document.getElementById('amountInput').value);
        const date = document.querySelector('input[name="date"]').value;
        const source = document.querySelector('select[name="source"]').value;
        const reference = document.querySelector('input[name="reference"]').value;
        const notes = document.querySelector('input[name="notes"]').value;

        if (!accountId) {
          alert('Lütfen bir hesap seçin');
          return;
        }

        if (!amount || amount <= 0) {
          alert('Lütfen geçerli bir tutar girin');
          return;
        }

        if (!confirm(`${selected.length} siparişi tahsil etmek istediğinizden emin misiniz?`)) {
          return;
        }

        try {
          const res = await fetch('/income/bulk-collect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              account_id: parseInt(accountId),
              amount: amount,
              date: date,
              source: source,
              reference: reference,
              notes: notes,
              order_ids: selected,
            }),
          });

          const data = await res.json();
          if (data.error) {
            alert('Hata: ' + data.error);
            return;
          }

          alert(`Başarılı! ${data.orders_collected} sipariş tahsil edildi.`);
          selectedOrders.clear();
          loadUnpaidOrders();
          location.reload();
        } catch (e) {
          console.error('Failed to collect orders:', e);
          alert('Tahsilat işlemi başarısız');
        }
      }

      // Initialize
      document.getElementById('searchBox').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          loadUnpaidOrders();
        }
      });

      // Edit income entry
      async function editIncome(incomeId) {
        try {
          const res = await fetch(`/income/${incomeId}`);
          const data = await res.json();
          
          // Populate edit form
          document.getElementById('editIncomeId').value = data.id;
          document.getElementById('editAccountId').value = data.account_id;
          document.getElementById('editAmount').value = data.amount;
          document.getElementById('editDate').value = data.date || '';
          document.getElementById('editSource').value = data.source;
          document.getElementById('editReference').value = data.reference || '';
          document.getElementById('editNotes').value = data.notes || '';
          
          // Show modal
          document.getElementById('editModal').style.display = 'block';
        } catch (e) {
          console.error('Failed to load income:', e);
          alert('Gelir bilgisi yüklenemedi');
        }
      }

      // Delete income entry
      async function deleteIncome(incomeId) {
        if (!confirm('Bu gelir kaydını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz ve bağlı sipariş tahsilat kayıtları da silinecektir.')) {
          return;
        }

        const params = new URLSearchParams(window.location.search);
        
        try {
          const url = `/income/${incomeId}?${params.toString()}`;
          const res = await fetch(url, {
            method: 'DELETE',
          });

          if (res.ok) {
            alert('Gelir kaydı başarıyla silindi.');
            location.reload();
          } else {
            const data = await res.json();
            alert('Hata: ' + (data.detail || 'Silme işlemi başarısız'));
          }
        } catch (e) {
          console.error('Failed to delete income:', e);
          alert('Silme işlemi başarısız');
        }
      }

      // Close modal
      function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }
    </script>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Gelir Düzenle</h3>
          <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <form id="editIncomeForm" method="post" action="/income/update" class="row">
          <input type="hidden" id="editIncomeId" name="income_id" />
          {% if start %}<input type="hidden" name="start" value="{{ start }}"/>{% endif %}
          {% if end %}<input type="hidden" name="end" value="{{ end }}"/>{% endif %}
          
          <div class="field">
            <label>Hesap</label>
            <select name="account_id" id="editAccountId" required>
              <option value="">Seçiniz...</option>
              {% for acc in accounts %}
              {% if acc.id %}
              <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.type }})</option>
              {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label>Tutar</label>
            <input type="number" step="0.01" name="amount" id="editAmount" required />
          </div>
          <div class="field">
            <label>Tarih</label>
            <input type="date" name="date" id="editDate" />
          </div>
          <div class="field">
            <label>Kaynak</label>
            <select name="source" id="editSource" required>
              <option value="shipment_firm">Kargo Firması</option>
              <option value="iban_customer">Müşteri IBAN</option>
              <option value="other">Diğer</option>
            </select>
          </div>
          <div class="field" style="min-width:280px; flex:1">
            <label>Referans / Açıklama</label>
            <input type="text" name="reference" id="editReference" placeholder="Opsiyonel" />
          </div>
          <div class="field" style="min-width:280px; flex:1">
            <label>Notlar</label>
            <input type="text" name="notes" id="editNotes" placeholder="Opsiyonel" />
          </div>
          <div style="display:flex; gap:8px; margin-top:12px;">
            <button class="btn" type="submit">Kaydet</button>
            <button class="btn" type="button" onclick="closeEditModal()">İptal</button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>

