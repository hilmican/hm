<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Edit</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
        .card { border:1px solid #e5e7eb; border-radius:10px; padding:16px; background:#fff; max-width: 1000px; }
        .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        label { display:block; font-size:12px; color:#6b7280; margin-bottom:4px; }
        input, select, textarea { width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; }
        textarea { min-height: 80px; }
        .toolbar { display:flex; gap:8px; margin-bottom:12px; }
        table { width:100%; border-collapse: collapse; }
        th, td { padding:8px 10px; border-bottom:1px solid #f0f0f0; text-align:left; font-size: 13px; }
    </style>
</head>
<body>
    {% include "_nav.html" %}
    <h2>Order #{{ order.id }} D√ºzenle</h2>
    {% if order.ig_conversation_id %}
    <div class="card" style="margin-bottom:12px; padding:12px;">
        <div style="font-size:13px; color:#374151;">
            <strong>Instagram Konu≈ümasƒ±:</strong>
            <a href="/ig/inbox/{{ order.ig_conversation_id }}" target="_blank" rel="noopener" style="color:#2563eb;">{{ order.ig_conversation_id }}</a>
        </div>
    </div>
    {% endif %}
    {% if order.merged_into_order_id %}
    <div class="card" style="margin-bottom:12px; padding:12px; background:#fff4e6; border-color:#ea580c;">
        <div style="font-size:13px; color:#92400e;">
            <strong>‚ö†Ô∏è Bu sipari≈ü birle≈ütirilmi≈ü:</strong>
            <a href="/orders/{{ order.merged_into_order_id }}/edit" style="color:#ea580c; font-weight:600;">Sipari≈ü #{{ order.merged_into_order_id }}</a> sipari≈üine birle≈ütirilmi≈ü.
        </div>
    </div>
    {% endif %}
    {% if order.is_partial_payment and order.partial_payment_group_id == order.id %}
    <div class="card" style="margin-bottom:12px; padding:12px; background:#fff4e6; border-color:#ea580c;">
        <div style="font-size:13px; color:#92400e;">
            <strong>üí∞ Kƒ±smi √ñdeme Grubu:</strong> Bu sipari≈ü kƒ±smi √∂deme grubunun birincil sipari≈üidir.
            {% if merged_orders %}
            <div style="margin-top:8px;">
                <strong>Birle≈ütirilmi≈ü sipari≈üler:</strong>
                {% for merged in merged_orders %}
                    <a href="/orders/{{ merged.id }}/edit" style="color:#ea580c;">#{{ merged.id }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    <div class="card">
        <form method="post" action="/orders/{{ order.id }}/edit">
            <div class="row">
                <div>
                    <label>M√º≈üteri</label>
                    <input name="client" list="clients" value="{{ client_disp or order.client_id }}" />
                    <datalist id="clients">
                        {% for c in clients %}
                        <option value="{{ c.id }} | {{ c.name }} | {{ c.phone }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div>
                    <label>Takip No</label>
                    <input name="tracking_no" value="{{ order.tracking_no or '' }}" />
                </div>
                <div>
                    <label>√úr√ºn (Item)</label>
                    <input name="item" list="items" value="{{ item_disp or (order.item_id or '') }}" />
                    <datalist id="items">
                        {% for it in items %}
                        <option value="{{ it.id }} | {{ it.sku }} | {{ it.name }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div>
                    <label>Adet</label>
                    <input name="quantity" type="number" step="1" value="{{ order.quantity or 1 }}" />
                </div>
                <div>
                    <label>Toplam</label>
                    <input name="total_amount" type="number" step="0.01" value="{{ order.total_amount or 0 }}" />
                </div>
                <div>
                    <label>√ñdeme ≈ûekli</label>
                    <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;">
                        <input id="ibanPaid" name="paid_by_bank_transfer" type="checkbox" {{ 'checked' if (order.paid_by_bank_transfer or False) else '' }} />
                        <label for="ibanPaid" style="margin:0;cursor:pointer;">IBAN √∂demesi (banka havalesi)</label>
                    </div>
                </div>
                <div>
                    <label>Durum</label>
                    <select name="status">
                        {% set st = order.status or '' %}
                        <option value="" {{ 'selected' if st=='' else '' }}>(bo≈ü)</option>
                        <option value="paid" {{ 'selected' if st=='paid' else '' }}>paid</option>
                        <option value="unpaid" {{ 'selected' if st=='unpaid' else '' }}>unpaid</option>
                        <option value="partial_paid" {{ 'selected' if st=='partial_paid' else '' }}>partial_paid (Kƒ±smi √ñdeme)</option>
                        <option value="refunded" {{ 'selected' if st=='refunded' else '' }}>refunded</option>
                        <option value="switched" {{ 'selected' if st=='switched' else '' }}>switched</option>
                        <option value="iade_bekliyor" {{ 'selected' if st=='iade_bekliyor' else '' }}>iade_bekliyor</option>
                        <option value="tanzim_bekliyor" {{ 'selected' if st=='tanzim_bekliyor' else '' }}>tanzim_bekliyor</option>
                        <option value="tanzim_basari" {{ 'selected' if st=='tanzim_basari' else '' }}>tanzim_basari</option>
                        <option value="tanzim_basarisiz" {{ 'selected' if st=='tanzim_basarisiz' else '' }}>tanzim_basarisiz</option>
                    </select>
                </div>
                <div>
                    <label>Tanzim Durumu</label>
                    {% set tz = order.tanzim_status or '' %}
                    <select name="tanzim_status">
                        <option value="" {{ 'selected' if tz=='' else '' }}>(bo≈ü)</option>
                        <option value="tanzim_bekliyor" {{ 'selected' if tz=='tanzim_bekliyor' else '' }}>tanzim_bekliyor</option>
                        <option value="tanzim_basari" {{ 'selected' if tz=='tanzim_basari' else '' }}>tanzim_basari</option>
                        <option value="tanzim_basarisiz" {{ 'selected' if tz=='tanzim_basarisiz' else '' }}>tanzim_basarisiz</option>
                    </select>
                </div>
                <div>
                    <label>Tanzim Manuel Tutar</label>
                    <input name="tanzim_amount_manual" type="number" step="0.01" value="{{ order.tanzim_amount_manual or '' }}" />
                </div>
                <div>
                    <label>Kaynak</label>
                    <select name="source">
                        {% set src = order.source or '' %}
                        <option value="bizim" {{ 'selected' if src=='bizim' else '' }}>bizim</option>
                        <option value="kargo" {{ 'selected' if src=='kargo' else '' }}>kargo</option>
                    </select>
                </div>
                <div>
                    <label>Satƒ±≈ü Kanalƒ±</label>
                    {% set ch = order.channel or 'instagram' %}
                    <select name="channel">
                        <option value="instagram" {{ 'selected' if ch=='instagram' else '' }}>instagram</option>
                        <option value="magaza" {{ 'selected' if ch=='magaza' else '' }}>magaza</option>
                        <option value="tiktok" {{ 'selected' if ch=='tiktok' else '' }}>tiktok</option>
                        <option value="whatsapp" {{ 'selected' if ch=='whatsapp' else '' }}>whatsapp</option>
                        <option value="other" {{ 'selected' if ch=='other' else '' }}>other</option>
                    </select>
                </div>
                <div>
                    <label>Kargo Tarihi</label>
                    <input name="shipment_date" type="date" value="{{ order.shipment_date }}" />
                </div>
                <div>
                    <label>Data Tarihi</label>
                    <input name="data_date" type="date" value="{{ order.data_date }}" />
                </div>
                <div style="grid-column:1/-1;">
                    <label>Notlar</label>
                    <textarea name="notes">{{ order.notes or '' }}</textarea>
                </div>
            </div>

            <h3 style="margin-top:16px;">Sipari≈ü Kalemleri</h3>
            <div>
                <table id="orderItemsTbl">
                    <thead>
                        <tr><th>Item</th><th>Adet</th><th></th></tr>
                    </thead>
                    <tbody>
                        {% for row in (order_items or []) %}
                        <tr>
                            <td><input name="item_display" list="items_all" value="{{ (row.item.id ~ ' | ' ~ row.item.sku ~ ' | ' ~ row.item.name) if row.item else '' }}" /></td>
                            <td><input name="item_qty" type="number" step="1" min="1" value="{{ row.quantity }}" /></td>
                            <td><button type="button" onclick="removeRow(this)">Sil</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="toolbar">
                    <button type="button" onclick="addRow()">Satƒ±r Ekle</button>
                    <span style="color:#6b7280;">Toplam tutar elle girilir, otomatik hesaplanmaz.</span>
                </div>
                <datalist id="items_all">
                    {% for it in (items_all or []) %}
                    <option value="{{ it.id }} | {{ it.sku }} | {{ it.name }}"></option>
                    {% endfor %}
                </datalist>
            </div>
            <div class="toolbar">
                <button type="submit">Kaydet</button>
                <a href="/orders/table" class="btn">Geri</a>
            </div>
        </form>
    </div>

    

    <h3>Deƒüi≈üiklik G√ºnl√ºƒü√º</h3>
    <div class="card">
        <table>
            <thead>
                <tr><th>Zaman</th><th>Kullanƒ±cƒ±</th><th>Aksiyon</th><th>Deƒüi≈üiklikler</th></tr>
            </thead>
            <tbody>
            {% for lg in logs %}
                <tr>
                    <td>{{ lg.created_at }}</td>
                    <td>{{ lg.editor_user_id or '-' }}</td>
                    <td>{{ lg.action }}</td>
                    <td><pre style="margin:0; white-space: pre-wrap;">{{ lg.changes_json }}</pre></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
    const form = document.querySelector('form[action="/orders/{{ order.id }}/edit"]');
    function addRow(itemDisplay='', qty=1){
        const tb = document.querySelector('#orderItemsTbl tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input name="item_display" list="items_all" value="${itemDisplay}" /></td>
            <td><input name="item_qty" type="number" step="1" min="1" value="${qty}" /></td>
            <td><button type="button" onclick="removeRow(this)">Sil</button></td>
        `;
        tb.appendChild(tr);
    }
    function removeRow(btn){
        const tr = btn.closest('tr');
        tr && tr.remove();
    }
    function clearHidden(form){
        for (const el of Array.from(form.querySelectorAll('input[name="item_ids[]"], input[name="qtys[]"]'))){ el.remove(); }
    }
    function serializeOrderItems(form){
        clearHidden(form);
        const rows = document.querySelectorAll('#orderItemsTbl tbody tr');
        for (const r of rows){
            const disp = r.querySelector('input[name="item_display"]').value.trim();
            const qty = parseInt(r.querySelector('input[name="item_qty"]').value || '0', 10);
            if (!disp || !isFinite(qty) || qty <= 0) continue;
            const hid1 = document.createElement('input');
            hid1.type = 'hidden'; hid1.name = 'item_ids[]'; hid1.value = disp;
            const hid2 = document.createElement('input');
            hid2.type = 'hidden'; hid2.name = 'qtys[]'; hid2.value = String(qty);
            form.appendChild(hid1); form.appendChild(hid2);
        }
    }
    if (form){
        form.addEventListener('submit', (e)=>{ serializeOrderItems(form); });
    }
    
    </script>
</body>
</html>


